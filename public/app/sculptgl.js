!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t():"function"==typeof define&&define.amd?define(t):t()}(this,function(){"use strict";if(window.Map||(window.Map=function(){this.map={}},window.Map.prototype={set:function(e,t){this.map[e]=t},get:function(e){return this.map[e]}}),!Float32Array.prototype.slice){var e=function(e,t){return new this.constructor(this.subarray(e,t))};Int8Array.prototype.slice=e,Uint8Array.prototype.slice=e,Uint8ClampedArray.prototype.slice=e,Int16Array.prototype.slice=e,Uint16Array.prototype.slice=e,Int32Array.prototype.slice=e,Uint32Array.prototype.slice=e,Float32Array.prototype.slice=e,Float64Array.prototype.slice=e}String.prototype.endsWith||(String.prototype.endsWith=function(e){return this.slice(-e.length)===e}),String.prototype.startsWith||(String.prototype.startsWith=function(e){return this.slice(0,e.length)===e});for(var t=["moz","webkit"],r=0;r<t.length&&!window.requestAnimationFrame;++r)window.requestAnimationFrame=window[t[r]+"RequestAnimationFrame"];window.requestAnimationFrame||window.alert("browser is too old. Probably no webgl there anyway"),function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var r=t();for(var i in r)("object"==typeof exports?exports:e)[i]=r[i]}}(self,function(){return function(e){function t(i){if(r[i])return r[i].exports;var a=r[i]={exports:{},id:i,loaded:!1};return e[i].call(a.exports,a,a.exports,t),a.loaded=!0,a.exports}var r={};return t.m=e,t.c=r,t.p="",t(0)}([function(e,t,r){t.glMatrix=r(1),t.mat2=r(2),t.mat2d=r(3),t.mat3=r(4),t.mat4=r(5),t.quat=r(6),t.vec2=r(9),t.vec3=r(7),t.vec4=r(8)},function(e,t){var r={};r.EPSILON=1e-6,r.ARRAY_TYPE="undefined"!=typeof Float32Array?Float32Array:Array,r.RANDOM=Math.random,r.ENABLE_SIMD=!1,r.SIMD_AVAILABLE=r.ARRAY_TYPE===this.Float32Array&&"SIMD"in this,r.USE_SIMD=r.ENABLE_SIMD&&r.SIMD_AVAILABLE,r.setMatrixArrayType=function(e){r.ARRAY_TYPE=e};var i=Math.PI/180;r.toRadian=function(e){return e*i},r.equals=function(e,t){return Math.abs(e-t)<=r.EPSILON*Math.max(1,Math.abs(e),Math.abs(t))},e.exports=r},function(e,t,r){var i=r(1),a={};a.create=function(){var e=new i.ARRAY_TYPE(4);return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e},a.clone=function(e){var t=new i.ARRAY_TYPE(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},a.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},a.identity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e},a.fromValues=function(e,t,r,a){var n=new i.ARRAY_TYPE(4);return n[0]=e,n[1]=t,n[2]=r,n[3]=a,n},a.set=function(e,t,r,i,a){return e[0]=t,e[1]=r,e[2]=i,e[3]=a,e},a.transpose=function(e,t){if(e===t){var r=t[1];e[1]=t[2],e[2]=r}else e[0]=t[0],e[1]=t[2],e[2]=t[1],e[3]=t[3];return e},a.invert=function(e,t){var r=t[0],i=t[1],a=t[2],n=t[3],s=r*n-a*i;return s?(s=1/s,e[0]=n*s,e[1]=-i*s,e[2]=-a*s,e[3]=r*s,e):null},a.adjoint=function(e,t){var r=t[0];return e[0]=t[3],e[1]=-t[1],e[2]=-t[2],e[3]=r,e},a.determinant=function(e){return e[0]*e[3]-e[2]*e[1]},a.multiply=function(e,t,r){var i=t[0],a=t[1],n=t[2],s=t[3],o=r[0],l=r[1],u=r[2],h=r[3];return e[0]=i*o+n*l,e[1]=a*o+s*l,e[2]=i*u+n*h,e[3]=a*u+s*h,e},a.mul=a.multiply,a.rotate=function(e,t,r){var i=t[0],a=t[1],n=t[2],s=t[3],o=Math.sin(r),l=Math.cos(r);return e[0]=i*l+n*o,e[1]=a*l+s*o,e[2]=i*-o+n*l,e[3]=a*-o+s*l,e},a.scale=function(e,t,r){var i=t[0],a=t[1],n=t[2],s=t[3],o=r[0],l=r[1];return e[0]=i*o,e[1]=a*o,e[2]=n*l,e[3]=s*l,e},a.fromRotation=function(e,t){var r=Math.sin(t),i=Math.cos(t);return e[0]=i,e[1]=r,e[2]=-r,e[3]=i,e},a.fromScaling=function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=t[1],e},a.str=function(e){return"mat2("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},a.frob=function(e){return Math.sqrt(Math.pow(e[0],2)+Math.pow(e[1],2)+Math.pow(e[2],2)+Math.pow(e[3],2))},a.LDU=function(e,t,r,i){return e[2]=i[2]/i[0],r[0]=i[0],r[1]=i[1],r[3]=i[3]-e[2]*r[1],[e,t,r]},a.add=function(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e[3]=t[3]+r[3],e},a.subtract=function(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e[3]=t[3]-r[3],e},a.sub=a.subtract,a.exactEquals=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]},a.equals=function(e,t){var r=e[0],a=e[1],n=e[2],s=e[3],o=t[0],l=t[1],u=t[2],h=t[3];return Math.abs(r-o)<=i.EPSILON*Math.max(1,Math.abs(r),Math.abs(o))&&Math.abs(a-l)<=i.EPSILON*Math.max(1,Math.abs(a),Math.abs(l))&&Math.abs(n-u)<=i.EPSILON*Math.max(1,Math.abs(n),Math.abs(u))&&Math.abs(s-h)<=i.EPSILON*Math.max(1,Math.abs(s),Math.abs(h))},a.multiplyScalar=function(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e},a.multiplyScalarAndAdd=function(e,t,r,i){return e[0]=t[0]+r[0]*i,e[1]=t[1]+r[1]*i,e[2]=t[2]+r[2]*i,e[3]=t[3]+r[3]*i,e},e.exports=a},function(e,t,r){var i=r(1),a={};a.create=function(){var e=new i.ARRAY_TYPE(6);return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e[4]=0,e[5]=0,e},a.clone=function(e){var t=new i.ARRAY_TYPE(6);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t},a.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e},a.identity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e[4]=0,e[5]=0,e},a.fromValues=function(e,t,r,a,n,s){var o=new i.ARRAY_TYPE(6);return o[0]=e,o[1]=t,o[2]=r,o[3]=a,o[4]=n,o[5]=s,o},a.set=function(e,t,r,i,a,n,s){return e[0]=t,e[1]=r,e[2]=i,e[3]=a,e[4]=n,e[5]=s,e},a.invert=function(e,t){var r=t[0],i=t[1],a=t[2],n=t[3],s=t[4],o=t[5],l=r*n-i*a;return l?(l=1/l,e[0]=n*l,e[1]=-i*l,e[2]=-a*l,e[3]=r*l,e[4]=(a*o-n*s)*l,e[5]=(i*s-r*o)*l,e):null},a.determinant=function(e){return e[0]*e[3]-e[1]*e[2]},a.multiply=function(e,t,r){var i=t[0],a=t[1],n=t[2],s=t[3],o=t[4],l=t[5],u=r[0],h=r[1],c=r[2],d=r[3],g=r[4],f=r[5];return e[0]=i*u+n*h,e[1]=a*u+s*h,e[2]=i*c+n*d,e[3]=a*c+s*d,e[4]=i*g+n*f+o,e[5]=a*g+s*f+l,e},a.mul=a.multiply,a.rotate=function(e,t,r){var i=t[0],a=t[1],n=t[2],s=t[3],o=t[4],l=t[5],u=Math.sin(r),h=Math.cos(r);return e[0]=i*h+n*u,e[1]=a*h+s*u,e[2]=i*-u+n*h,e[3]=a*-u+s*h,e[4]=o,e[5]=l,e},a.scale=function(e,t,r){var i=t[0],a=t[1],n=t[2],s=t[3],o=t[4],l=t[5],u=r[0],h=r[1];return e[0]=i*u,e[1]=a*u,e[2]=n*h,e[3]=s*h,e[4]=o,e[5]=l,e},a.translate=function(e,t,r){var i=t[0],a=t[1],n=t[2],s=t[3],o=t[4],l=t[5],u=r[0],h=r[1];return e[0]=i,e[1]=a,e[2]=n,e[3]=s,e[4]=i*u+n*h+o,e[5]=a*u+s*h+l,e},a.fromRotation=function(e,t){var r=Math.sin(t),i=Math.cos(t);return e[0]=i,e[1]=r,e[2]=-r,e[3]=i,e[4]=0,e[5]=0,e},a.fromScaling=function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=t[1],e[4]=0,e[5]=0,e},a.fromTranslation=function(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e[4]=t[0],e[5]=t[1],e},a.str=function(e){return"mat2d("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+")"},a.frob=function(e){return Math.sqrt(Math.pow(e[0],2)+Math.pow(e[1],2)+Math.pow(e[2],2)+Math.pow(e[3],2)+Math.pow(e[4],2)+Math.pow(e[5],2)+1)},a.add=function(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e[3]=t[3]+r[3],e[4]=t[4]+r[4],e[5]=t[5]+r[5],e},a.subtract=function(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e[3]=t[3]-r[3],e[4]=t[4]-r[4],e[5]=t[5]-r[5],e},a.sub=a.subtract,a.multiplyScalar=function(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e[4]=t[4]*r,e[5]=t[5]*r,e},a.multiplyScalarAndAdd=function(e,t,r,i){return e[0]=t[0]+r[0]*i,e[1]=t[1]+r[1]*i,e[2]=t[2]+r[2]*i,e[3]=t[3]+r[3]*i,e[4]=t[4]+r[4]*i,e[5]=t[5]+r[5]*i,e},a.exactEquals=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]},a.equals=function(e,t){var r=e[0],a=e[1],n=e[2],s=e[3],o=e[4],l=e[5],u=t[0],h=t[1],c=t[2],d=t[3],g=t[4],f=t[5];return Math.abs(r-u)<=i.EPSILON*Math.max(1,Math.abs(r),Math.abs(u))&&Math.abs(a-h)<=i.EPSILON*Math.max(1,Math.abs(a),Math.abs(h))&&Math.abs(n-c)<=i.EPSILON*Math.max(1,Math.abs(n),Math.abs(c))&&Math.abs(s-d)<=i.EPSILON*Math.max(1,Math.abs(s),Math.abs(d))&&Math.abs(o-g)<=i.EPSILON*Math.max(1,Math.abs(o),Math.abs(g))&&Math.abs(l-f)<=i.EPSILON*Math.max(1,Math.abs(l),Math.abs(f))},e.exports=a},function(e,t,r){var i=r(1),a={};a.create=function(){var e=new i.ARRAY_TYPE(9);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},a.fromMat4=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10],e},a.clone=function(e){var t=new i.ARRAY_TYPE(9);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},a.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},a.fromValues=function(e,t,r,a,n,s,o,l,u){var h=new i.ARRAY_TYPE(9);return h[0]=e,h[1]=t,h[2]=r,h[3]=a,h[4]=n,h[5]=s,h[6]=o,h[7]=l,h[8]=u,h},a.set=function(e,t,r,i,a,n,s,o,l,u){return e[0]=t,e[1]=r,e[2]=i,e[3]=a,e[4]=n,e[5]=s,e[6]=o,e[7]=l,e[8]=u,e},a.identity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},a.transpose=function(e,t){if(e===t){var r=t[1],i=t[2],a=t[5];e[1]=t[3],e[2]=t[6],e[3]=r,e[5]=t[7],e[6]=i,e[7]=a}else e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8];return e},a.invert=function(e,t){var r=t[0],i=t[1],a=t[2],n=t[3],s=t[4],o=t[5],l=t[6],u=t[7],h=t[8],c=h*s-o*u,d=-h*n+o*l,g=u*n-s*l,f=r*c+i*d+a*g;return f?(f=1/f,e[0]=c*f,e[1]=(-h*i+a*u)*f,e[2]=(o*i-a*s)*f,e[3]=d*f,e[4]=(h*r-a*l)*f,e[5]=(-o*r+a*n)*f,e[6]=g*f,e[7]=(-u*r+i*l)*f,e[8]=(s*r-i*n)*f,e):null},a.adjoint=function(e,t){var r=t[0],i=t[1],a=t[2],n=t[3],s=t[4],o=t[5],l=t[6],u=t[7],h=t[8];return e[0]=s*h-o*u,e[1]=a*u-i*h,e[2]=i*o-a*s,e[3]=o*l-n*h,e[4]=r*h-a*l,e[5]=a*n-r*o,e[6]=n*u-s*l,e[7]=i*l-r*u,e[8]=r*s-i*n,e},a.determinant=function(e){var t=e[0],r=e[1],i=e[2],a=e[3],n=e[4],s=e[5],o=e[6],l=e[7],u=e[8];return t*(u*n-s*l)+r*(-u*a+s*o)+i*(l*a-n*o)},a.multiply=function(e,t,r){var i=t[0],a=t[1],n=t[2],s=t[3],o=t[4],l=t[5],u=t[6],h=t[7],c=t[8],d=r[0],g=r[1],f=r[2],v=r[3],m=r[4],p=r[5],_=r[6],y=r[7],M=r[8];return e[0]=d*i+g*s+f*u,e[1]=d*a+g*o+f*h,e[2]=d*n+g*l+f*c,e[3]=v*i+m*s+p*u,e[4]=v*a+m*o+p*h,e[5]=v*n+m*l+p*c,e[6]=_*i+y*s+M*u,e[7]=_*a+y*o+M*h,e[8]=_*n+y*l+M*c,e},a.mul=a.multiply,a.translate=function(e,t,r){var i=t[0],a=t[1],n=t[2],s=t[3],o=t[4],l=t[5],u=t[6],h=t[7],c=t[8],d=r[0],g=r[1];return e[0]=i,e[1]=a,e[2]=n,e[3]=s,e[4]=o,e[5]=l,e[6]=d*i+g*s+u,e[7]=d*a+g*o+h,e[8]=d*n+g*l+c,e},a.rotate=function(e,t,r){var i=t[0],a=t[1],n=t[2],s=t[3],o=t[4],l=t[5],u=t[6],h=t[7],c=t[8],d=Math.sin(r),g=Math.cos(r);return e[0]=g*i+d*s,e[1]=g*a+d*o,e[2]=g*n+d*l,e[3]=g*s-d*i,e[4]=g*o-d*a,e[5]=g*l-d*n,e[6]=u,e[7]=h,e[8]=c,e},a.scale=function(e,t,r){var i=r[0],a=r[1];return e[0]=i*t[0],e[1]=i*t[1],e[2]=i*t[2],e[3]=a*t[3],e[4]=a*t[4],e[5]=a*t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},a.fromTranslation=function(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=t[0],e[7]=t[1],e[8]=1,e},a.fromRotation=function(e,t){var r=Math.sin(t),i=Math.cos(t);return e[0]=i,e[1]=r,e[2]=0,e[3]=-r,e[4]=i,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},a.fromScaling=function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=t[1],e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},a.fromMat2d=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=0,e[3]=t[2],e[4]=t[3],e[5]=0,e[6]=t[4],e[7]=t[5],e[8]=1,e},a.fromQuat=function(e,t){var r=t[0],i=t[1],a=t[2],n=t[3],s=r+r,o=i+i,l=a+a,u=r*s,h=i*s,c=i*o,d=a*s,g=a*o,f=a*l,v=n*s,m=n*o,p=n*l;return e[0]=1-c-f,e[3]=h-p,e[6]=d+m,e[1]=h+p,e[4]=1-u-f,e[7]=g-v,e[2]=d-m,e[5]=g+v,e[8]=1-u-c,e},a.normalFromMat4=function(e,t){var r=t[0],i=t[1],a=t[2],n=t[3],s=t[4],o=t[5],l=t[6],u=t[7],h=t[8],c=t[9],d=t[10],g=t[11],f=t[12],v=t[13],m=t[14],p=t[15],_=r*o-i*s,y=r*l-a*s,M=r*u-n*s,T=i*l-a*o,S=i*u-n*o,b=a*u-n*l,A=h*v-c*f,x=h*m-d*f,k=h*p-g*f,w=c*m-d*v,E=c*p-g*v,R=d*p-g*m,F=_*R-y*E+M*w+T*k-S*x+b*A;return F?(F=1/F,e[0]=(o*R-l*E+u*w)*F,e[1]=(l*k-s*R-u*x)*F,e[2]=(s*E-o*k+u*A)*F,e[3]=(a*E-i*R-n*w)*F,e[4]=(r*R-a*k+n*x)*F,e[5]=(i*k-r*E-n*A)*F,e[6]=(v*b-m*S+p*T)*F,e[7]=(m*M-f*b-p*y)*F,e[8]=(f*S-v*M+p*_)*F,e):null},a.str=function(e){return"mat3("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+")"},a.frob=function(e){return Math.sqrt(Math.pow(e[0],2)+Math.pow(e[1],2)+Math.pow(e[2],2)+Math.pow(e[3],2)+Math.pow(e[4],2)+Math.pow(e[5],2)+Math.pow(e[6],2)+Math.pow(e[7],2)+Math.pow(e[8],2))},a.add=function(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e[3]=t[3]+r[3],e[4]=t[4]+r[4],e[5]=t[5]+r[5],e[6]=t[6]+r[6],e[7]=t[7]+r[7],e[8]=t[8]+r[8],e},a.subtract=function(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e[3]=t[3]-r[3],e[4]=t[4]-r[4],e[5]=t[5]-r[5],e[6]=t[6]-r[6],e[7]=t[7]-r[7],e[8]=t[8]-r[8],e},a.sub=a.subtract,a.multiplyScalar=function(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e[4]=t[4]*r,e[5]=t[5]*r,e[6]=t[6]*r,e[7]=t[7]*r,e[8]=t[8]*r,e},a.multiplyScalarAndAdd=function(e,t,r,i){return e[0]=t[0]+r[0]*i,e[1]=t[1]+r[1]*i,e[2]=t[2]+r[2]*i,e[3]=t[3]+r[3]*i,e[4]=t[4]+r[4]*i,e[5]=t[5]+r[5]*i,e[6]=t[6]+r[6]*i,e[7]=t[7]+r[7]*i,e[8]=t[8]+r[8]*i,e},a.exactEquals=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]&&e[8]===t[8]},a.equals=function(e,t){var r=e[0],a=e[1],n=e[2],s=e[3],o=e[4],l=e[5],u=e[6],h=e[7],c=e[8],d=t[0],g=t[1],f=t[2],v=t[3],m=t[4],p=t[5],_=e[6],y=t[7],M=t[8];return Math.abs(r-d)<=i.EPSILON*Math.max(1,Math.abs(r),Math.abs(d))&&Math.abs(a-g)<=i.EPSILON*Math.max(1,Math.abs(a),Math.abs(g))&&Math.abs(n-f)<=i.EPSILON*Math.max(1,Math.abs(n),Math.abs(f))&&Math.abs(s-v)<=i.EPSILON*Math.max(1,Math.abs(s),Math.abs(v))&&Math.abs(o-m)<=i.EPSILON*Math.max(1,Math.abs(o),Math.abs(m))&&Math.abs(l-p)<=i.EPSILON*Math.max(1,Math.abs(l),Math.abs(p))&&Math.abs(u-_)<=i.EPSILON*Math.max(1,Math.abs(u),Math.abs(_))&&Math.abs(h-y)<=i.EPSILON*Math.max(1,Math.abs(h),Math.abs(y))&&Math.abs(c-M)<=i.EPSILON*Math.max(1,Math.abs(c),Math.abs(M))},e.exports=a},function(e,t,r){var i=r(1),a={scalar:{},SIMD:{}};a.create=function(){var e=new i.ARRAY_TYPE(16);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},a.clone=function(e){var t=new i.ARRAY_TYPE(16);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},a.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},a.fromValues=function(e,t,r,a,n,s,o,l,u,h,c,d,g,f,v,m){var p=new i.ARRAY_TYPE(16);return p[0]=e,p[1]=t,p[2]=r,p[3]=a,p[4]=n,p[5]=s,p[6]=o,p[7]=l,p[8]=u,p[9]=h,p[10]=c,p[11]=d,p[12]=g,p[13]=f,p[14]=v,p[15]=m,p},a.set=function(e,t,r,i,a,n,s,o,l,u,h,c,d,g,f,v,m){return e[0]=t,e[1]=r,e[2]=i,e[3]=a,e[4]=n,e[5]=s,e[6]=o,e[7]=l,e[8]=u,e[9]=h,e[10]=c,e[11]=d,e[12]=g,e[13]=f,e[14]=v,e[15]=m,e},a.identity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},a.scalar.transpose=function(e,t){if(e===t){var r=t[1],i=t[2],a=t[3],n=t[6],s=t[7],o=t[11];e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=r,e[6]=t[9],e[7]=t[13],e[8]=i,e[9]=n,e[11]=t[14],e[12]=a,e[13]=s,e[14]=o}else e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15];return e},a.SIMD.transpose=function(e,t){var r,i,a,n,s,o,l,u,h,c;return r=SIMD.Float32x4.load(t,0),i=SIMD.Float32x4.load(t,4),a=SIMD.Float32x4.load(t,8),n=SIMD.Float32x4.load(t,12),s=SIMD.Float32x4.shuffle(r,i,0,1,4,5),o=SIMD.Float32x4.shuffle(a,n,0,1,4,5),l=SIMD.Float32x4.shuffle(s,o,0,2,4,6),u=SIMD.Float32x4.shuffle(s,o,1,3,5,7),SIMD.Float32x4.store(e,0,l),SIMD.Float32x4.store(e,4,u),s=SIMD.Float32x4.shuffle(r,i,2,3,6,7),o=SIMD.Float32x4.shuffle(a,n,2,3,6,7),h=SIMD.Float32x4.shuffle(s,o,0,2,4,6),c=SIMD.Float32x4.shuffle(s,o,1,3,5,7),SIMD.Float32x4.store(e,8,h),SIMD.Float32x4.store(e,12,c),e},a.transpose=i.USE_SIMD?a.SIMD.transpose:a.scalar.transpose,a.scalar.invert=function(e,t){var r=t[0],i=t[1],a=t[2],n=t[3],s=t[4],o=t[5],l=t[6],u=t[7],h=t[8],c=t[9],d=t[10],g=t[11],f=t[12],v=t[13],m=t[14],p=t[15],_=r*o-i*s,y=r*l-a*s,M=r*u-n*s,T=i*l-a*o,S=i*u-n*o,b=a*u-n*l,A=h*v-c*f,x=h*m-d*f,k=h*p-g*f,w=c*m-d*v,E=c*p-g*v,R=d*p-g*m,F=_*R-y*E+M*w+T*k-S*x+b*A;return F?(F=1/F,e[0]=(o*R-l*E+u*w)*F,e[1]=(a*E-i*R-n*w)*F,e[2]=(v*b-m*S+p*T)*F,e[3]=(d*S-c*b-g*T)*F,e[4]=(l*k-s*R-u*x)*F,e[5]=(r*R-a*k+n*x)*F,e[6]=(m*M-f*b-p*y)*F,e[7]=(h*b-d*M+g*y)*F,e[8]=(s*E-o*k+u*A)*F,e[9]=(i*k-r*E-n*A)*F,e[10]=(f*S-v*M+p*_)*F,e[11]=(c*M-h*S-g*_)*F,e[12]=(o*x-s*w-l*A)*F,e[13]=(r*w-i*x+a*A)*F,e[14]=(v*y-f*T-m*_)*F,e[15]=(h*T-c*y+d*_)*F,e):null},a.SIMD.invert=function(e,t){var r,i,a,n,s,o,l,u,h,c,d=SIMD.Float32x4.load(t,0),g=SIMD.Float32x4.load(t,4),f=SIMD.Float32x4.load(t,8),v=SIMD.Float32x4.load(t,12);return s=SIMD.Float32x4.shuffle(d,g,0,1,4,5),i=SIMD.Float32x4.shuffle(f,v,0,1,4,5),r=SIMD.Float32x4.shuffle(s,i,0,2,4,6),i=SIMD.Float32x4.shuffle(i,s,1,3,5,7),s=SIMD.Float32x4.shuffle(d,g,2,3,6,7),n=SIMD.Float32x4.shuffle(f,v,2,3,6,7),a=SIMD.Float32x4.shuffle(s,n,0,2,4,6),n=SIMD.Float32x4.shuffle(n,s,1,3,5,7),s=SIMD.Float32x4.mul(a,n),s=SIMD.Float32x4.swizzle(s,1,0,3,2),o=SIMD.Float32x4.mul(i,s),l=SIMD.Float32x4.mul(r,s),s=SIMD.Float32x4.swizzle(s,2,3,0,1),o=SIMD.Float32x4.sub(SIMD.Float32x4.mul(i,s),o),l=SIMD.Float32x4.sub(SIMD.Float32x4.mul(r,s),l),l=SIMD.Float32x4.swizzle(l,2,3,0,1),s=SIMD.Float32x4.mul(i,a),s=SIMD.Float32x4.swizzle(s,1,0,3,2),o=SIMD.Float32x4.add(SIMD.Float32x4.mul(n,s),o),h=SIMD.Float32x4.mul(r,s),s=SIMD.Float32x4.swizzle(s,2,3,0,1),o=SIMD.Float32x4.sub(o,SIMD.Float32x4.mul(n,s)),h=SIMD.Float32x4.sub(SIMD.Float32x4.mul(r,s),h),h=SIMD.Float32x4.swizzle(h,2,3,0,1),s=SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(i,2,3,0,1),n),s=SIMD.Float32x4.swizzle(s,1,0,3,2),a=SIMD.Float32x4.swizzle(a,2,3,0,1),o=SIMD.Float32x4.add(SIMD.Float32x4.mul(a,s),o),u=SIMD.Float32x4.mul(r,s),s=SIMD.Float32x4.swizzle(s,2,3,0,1),o=SIMD.Float32x4.sub(o,SIMD.Float32x4.mul(a,s)),u=SIMD.Float32x4.sub(SIMD.Float32x4.mul(r,s),u),u=SIMD.Float32x4.swizzle(u,2,3,0,1),s=SIMD.Float32x4.mul(r,i),s=SIMD.Float32x4.swizzle(s,1,0,3,2),u=SIMD.Float32x4.add(SIMD.Float32x4.mul(n,s),u),h=SIMD.Float32x4.sub(SIMD.Float32x4.mul(a,s),h),s=SIMD.Float32x4.swizzle(s,2,3,0,1),u=SIMD.Float32x4.sub(SIMD.Float32x4.mul(n,s),u),h=SIMD.Float32x4.sub(h,SIMD.Float32x4.mul(a,s)),s=SIMD.Float32x4.mul(r,n),s=SIMD.Float32x4.swizzle(s,1,0,3,2),l=SIMD.Float32x4.sub(l,SIMD.Float32x4.mul(a,s)),u=SIMD.Float32x4.add(SIMD.Float32x4.mul(i,s),u),s=SIMD.Float32x4.swizzle(s,2,3,0,1),l=SIMD.Float32x4.add(SIMD.Float32x4.mul(a,s),l),u=SIMD.Float32x4.sub(u,SIMD.Float32x4.mul(i,s)),s=SIMD.Float32x4.mul(r,a),s=SIMD.Float32x4.swizzle(s,1,0,3,2),l=SIMD.Float32x4.add(SIMD.Float32x4.mul(n,s),l),h=SIMD.Float32x4.sub(h,SIMD.Float32x4.mul(i,s)),s=SIMD.Float32x4.swizzle(s,2,3,0,1),l=SIMD.Float32x4.sub(l,SIMD.Float32x4.mul(n,s)),h=SIMD.Float32x4.add(SIMD.Float32x4.mul(i,s),h),c=SIMD.Float32x4.mul(r,o),c=SIMD.Float32x4.add(SIMD.Float32x4.swizzle(c,2,3,0,1),c),c=SIMD.Float32x4.add(SIMD.Float32x4.swizzle(c,1,0,3,2),c),s=SIMD.Float32x4.reciprocalApproximation(c),c=SIMD.Float32x4.sub(SIMD.Float32x4.add(s,s),SIMD.Float32x4.mul(c,SIMD.Float32x4.mul(s,s))),(c=SIMD.Float32x4.swizzle(c,0,0,0,0))?(SIMD.Float32x4.store(e,0,SIMD.Float32x4.mul(c,o)),SIMD.Float32x4.store(e,4,SIMD.Float32x4.mul(c,l)),SIMD.Float32x4.store(e,8,SIMD.Float32x4.mul(c,u)),SIMD.Float32x4.store(e,12,SIMD.Float32x4.mul(c,h)),e):null},a.invert=i.USE_SIMD?a.SIMD.invert:a.scalar.invert,a.scalar.adjoint=function(e,t){var r=t[0],i=t[1],a=t[2],n=t[3],s=t[4],o=t[5],l=t[6],u=t[7],h=t[8],c=t[9],d=t[10],g=t[11],f=t[12],v=t[13],m=t[14],p=t[15];return e[0]=o*(d*p-g*m)-c*(l*p-u*m)+v*(l*g-u*d),e[1]=-(i*(d*p-g*m)-c*(a*p-n*m)+v*(a*g-n*d)),e[2]=i*(l*p-u*m)-o*(a*p-n*m)+v*(a*u-n*l),e[3]=-(i*(l*g-u*d)-o*(a*g-n*d)+c*(a*u-n*l)),e[4]=-(s*(d*p-g*m)-h*(l*p-u*m)+f*(l*g-u*d)),e[5]=r*(d*p-g*m)-h*(a*p-n*m)+f*(a*g-n*d),e[6]=-(r*(l*p-u*m)-s*(a*p-n*m)+f*(a*u-n*l)),e[7]=r*(l*g-u*d)-s*(a*g-n*d)+h*(a*u-n*l),e[8]=s*(c*p-g*v)-h*(o*p-u*v)+f*(o*g-u*c),e[9]=-(r*(c*p-g*v)-h*(i*p-n*v)+f*(i*g-n*c)),e[10]=r*(o*p-u*v)-s*(i*p-n*v)+f*(i*u-n*o),e[11]=-(r*(o*g-u*c)-s*(i*g-n*c)+h*(i*u-n*o)),e[12]=-(s*(c*m-d*v)-h*(o*m-l*v)+f*(o*d-l*c)),e[13]=r*(c*m-d*v)-h*(i*m-a*v)+f*(i*d-a*c),e[14]=-(r*(o*m-l*v)-s*(i*m-a*v)+f*(i*l-a*o)),e[15]=r*(o*d-l*c)-s*(i*d-a*c)+h*(i*l-a*o),e},a.SIMD.adjoint=function(e,t){var r,i,a,n,s,o,l,u,h,c,d,g,f;return r=SIMD.Float32x4.load(t,0),i=SIMD.Float32x4.load(t,4),a=SIMD.Float32x4.load(t,8),n=SIMD.Float32x4.load(t,12),h=SIMD.Float32x4.shuffle(r,i,0,1,4,5),o=SIMD.Float32x4.shuffle(a,n,0,1,4,5),s=SIMD.Float32x4.shuffle(h,o,0,2,4,6),o=SIMD.Float32x4.shuffle(o,h,1,3,5,7),h=SIMD.Float32x4.shuffle(r,i,2,3,6,7),u=SIMD.Float32x4.shuffle(a,n,2,3,6,7),l=SIMD.Float32x4.shuffle(h,u,0,2,4,6),u=SIMD.Float32x4.shuffle(u,h,1,3,5,7),h=SIMD.Float32x4.mul(l,u),h=SIMD.Float32x4.swizzle(h,1,0,3,2),c=SIMD.Float32x4.mul(o,h),d=SIMD.Float32x4.mul(s,h),h=SIMD.Float32x4.swizzle(h,2,3,0,1),c=SIMD.Float32x4.sub(SIMD.Float32x4.mul(o,h),c),d=SIMD.Float32x4.sub(SIMD.Float32x4.mul(s,h),d),d=SIMD.Float32x4.swizzle(d,2,3,0,1),h=SIMD.Float32x4.mul(o,l),h=SIMD.Float32x4.swizzle(h,1,0,3,2),c=SIMD.Float32x4.add(SIMD.Float32x4.mul(u,h),c),f=SIMD.Float32x4.mul(s,h),h=SIMD.Float32x4.swizzle(h,2,3,0,1),c=SIMD.Float32x4.sub(c,SIMD.Float32x4.mul(u,h)),f=SIMD.Float32x4.sub(SIMD.Float32x4.mul(s,h),f),f=SIMD.Float32x4.swizzle(f,2,3,0,1),h=SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(o,2,3,0,1),u),h=SIMD.Float32x4.swizzle(h,1,0,3,2),l=SIMD.Float32x4.swizzle(l,2,3,0,1),c=SIMD.Float32x4.add(SIMD.Float32x4.mul(l,h),c),g=SIMD.Float32x4.mul(s,h),h=SIMD.Float32x4.swizzle(h,2,3,0,1),c=SIMD.Float32x4.sub(c,SIMD.Float32x4.mul(l,h)),g=SIMD.Float32x4.sub(SIMD.Float32x4.mul(s,h),g),g=SIMD.Float32x4.swizzle(g,2,3,0,1),h=SIMD.Float32x4.mul(s,o),h=SIMD.Float32x4.swizzle(h,1,0,3,2),g=SIMD.Float32x4.add(SIMD.Float32x4.mul(u,h),g),f=SIMD.Float32x4.sub(SIMD.Float32x4.mul(l,h),f),h=SIMD.Float32x4.swizzle(h,2,3,0,1),g=SIMD.Float32x4.sub(SIMD.Float32x4.mul(u,h),g),f=SIMD.Float32x4.sub(f,SIMD.Float32x4.mul(l,h)),h=SIMD.Float32x4.mul(s,u),h=SIMD.Float32x4.swizzle(h,1,0,3,2),d=SIMD.Float32x4.sub(d,SIMD.Float32x4.mul(l,h)),g=SIMD.Float32x4.add(SIMD.Float32x4.mul(o,h),g),h=SIMD.Float32x4.swizzle(h,2,3,0,1),d=SIMD.Float32x4.add(SIMD.Float32x4.mul(l,h),d),g=SIMD.Float32x4.sub(g,SIMD.Float32x4.mul(o,h)),h=SIMD.Float32x4.mul(s,l),h=SIMD.Float32x4.swizzle(h,1,0,3,2),d=SIMD.Float32x4.add(SIMD.Float32x4.mul(u,h),d),f=SIMD.Float32x4.sub(f,SIMD.Float32x4.mul(o,h)),h=SIMD.Float32x4.swizzle(h,2,3,0,1),d=SIMD.Float32x4.sub(d,SIMD.Float32x4.mul(u,h)),f=SIMD.Float32x4.add(SIMD.Float32x4.mul(o,h),f),SIMD.Float32x4.store(e,0,c),SIMD.Float32x4.store(e,4,d),SIMD.Float32x4.store(e,8,g),SIMD.Float32x4.store(e,12,f),e},a.adjoint=i.USE_SIMD?a.SIMD.adjoint:a.scalar.adjoint,a.determinant=function(e){var t=e[0],r=e[1],i=e[2],a=e[3],n=e[4],s=e[5],o=e[6],l=e[7],u=e[8],h=e[9],c=e[10],d=e[11],g=e[12],f=e[13],v=e[14],m=e[15],p=t*s-r*n,_=t*o-i*n,y=t*l-a*n,M=r*o-i*s,T=r*l-a*s,S=i*l-a*o,b=u*f-h*g,A=u*v-c*g,x=u*m-d*g,k=h*v-c*f,w=h*m-d*f,E=c*m-d*v;return p*E-_*w+y*k+M*x-T*A+S*b},a.SIMD.multiply=function(e,t,r){var i=SIMD.Float32x4.load(t,0),a=SIMD.Float32x4.load(t,4),n=SIMD.Float32x4.load(t,8),s=SIMD.Float32x4.load(t,12),o=SIMD.Float32x4.load(r,0),l=SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(o,0,0,0,0),i),SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(o,1,1,1,1),a),SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(o,2,2,2,2),n),SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(o,3,3,3,3),s))));SIMD.Float32x4.store(e,0,l);var u=SIMD.Float32x4.load(r,4),h=SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(u,0,0,0,0),i),SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(u,1,1,1,1),a),SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(u,2,2,2,2),n),SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(u,3,3,3,3),s))));SIMD.Float32x4.store(e,4,h);var c=SIMD.Float32x4.load(r,8),d=SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(c,0,0,0,0),i),SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(c,1,1,1,1),a),SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(c,2,2,2,2),n),SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(c,3,3,3,3),s))));SIMD.Float32x4.store(e,8,d);var g=SIMD.Float32x4.load(r,12),f=SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(g,0,0,0,0),i),SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(g,1,1,1,1),a),SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(g,2,2,2,2),n),SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(g,3,3,3,3),s))));return SIMD.Float32x4.store(e,12,f),e},a.scalar.multiply=function(e,t,r){var i=t[0],a=t[1],n=t[2],s=t[3],o=t[4],l=t[5],u=t[6],h=t[7],c=t[8],d=t[9],g=t[10],f=t[11],v=t[12],m=t[13],p=t[14],_=t[15],y=r[0],M=r[1],T=r[2],S=r[3];return e[0]=y*i+M*o+T*c+S*v,e[1]=y*a+M*l+T*d+S*m,e[2]=y*n+M*u+T*g+S*p,e[3]=y*s+M*h+T*f+S*_,y=r[4],M=r[5],T=r[6],S=r[7],e[4]=y*i+M*o+T*c+S*v,e[5]=y*a+M*l+T*d+S*m,e[6]=y*n+M*u+T*g+S*p,e[7]=y*s+M*h+T*f+S*_,y=r[8],M=r[9],T=r[10],S=r[11],e[8]=y*i+M*o+T*c+S*v,e[9]=y*a+M*l+T*d+S*m,e[10]=y*n+M*u+T*g+S*p,e[11]=y*s+M*h+T*f+S*_,y=r[12],M=r[13],T=r[14],S=r[15],e[12]=y*i+M*o+T*c+S*v,e[13]=y*a+M*l+T*d+S*m,e[14]=y*n+M*u+T*g+S*p,e[15]=y*s+M*h+T*f+S*_,e},a.multiply=i.USE_SIMD?a.SIMD.multiply:a.scalar.multiply,a.mul=a.multiply,a.scalar.translate=function(e,t,r){var i,a,n,s,o,l,u,h,c,d,g,f,v=r[0],m=r[1],p=r[2];return t===e?(e[12]=t[0]*v+t[4]*m+t[8]*p+t[12],e[13]=t[1]*v+t[5]*m+t[9]*p+t[13],e[14]=t[2]*v+t[6]*m+t[10]*p+t[14],e[15]=t[3]*v+t[7]*m+t[11]*p+t[15]):(i=t[0],a=t[1],n=t[2],s=t[3],o=t[4],l=t[5],u=t[6],h=t[7],c=t[8],d=t[9],g=t[10],f=t[11],e[0]=i,e[1]=a,e[2]=n,e[3]=s,e[4]=o,e[5]=l,e[6]=u,e[7]=h,e[8]=c,e[9]=d,e[10]=g,e[11]=f,e[12]=i*v+o*m+c*p+t[12],e[13]=a*v+l*m+d*p+t[13],e[14]=n*v+u*m+g*p+t[14],e[15]=s*v+h*m+f*p+t[15]),e},a.SIMD.translate=function(e,t,r){var i=SIMD.Float32x4.load(t,0),a=SIMD.Float32x4.load(t,4),n=SIMD.Float32x4.load(t,8),s=SIMD.Float32x4.load(t,12),o=SIMD.Float32x4(r[0],r[1],r[2],0);t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11]),i=SIMD.Float32x4.mul(i,SIMD.Float32x4.swizzle(o,0,0,0,0)),a=SIMD.Float32x4.mul(a,SIMD.Float32x4.swizzle(o,1,1,1,1)),n=SIMD.Float32x4.mul(n,SIMD.Float32x4.swizzle(o,2,2,2,2));var l=SIMD.Float32x4.add(i,SIMD.Float32x4.add(a,SIMD.Float32x4.add(n,s)));return SIMD.Float32x4.store(e,12,l),e},a.translate=i.USE_SIMD?a.SIMD.translate:a.scalar.translate,a.scalar.scale=function(e,t,r){var i=r[0],a=r[1],n=r[2];return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e[4]=t[4]*a,e[5]=t[5]*a,e[6]=t[6]*a,e[7]=t[7]*a,e[8]=t[8]*n,e[9]=t[9]*n,e[10]=t[10]*n,e[11]=t[11]*n,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},a.SIMD.scale=function(e,t,r){var i,a,n,s=SIMD.Float32x4(r[0],r[1],r[2],0);return i=SIMD.Float32x4.load(t,0),SIMD.Float32x4.store(e,0,SIMD.Float32x4.mul(i,SIMD.Float32x4.swizzle(s,0,0,0,0))),a=SIMD.Float32x4.load(t,4),SIMD.Float32x4.store(e,4,SIMD.Float32x4.mul(a,SIMD.Float32x4.swizzle(s,1,1,1,1))),n=SIMD.Float32x4.load(t,8),SIMD.Float32x4.store(e,8,SIMD.Float32x4.mul(n,SIMD.Float32x4.swizzle(s,2,2,2,2))),e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},a.scale=i.USE_SIMD?a.SIMD.scale:a.scalar.scale,a.rotate=function(e,t,r,a){var n,s,o,l,u,h,c,d,g,f,v,m,p,_,y,M,T,S,b,A,x,k,w,E,R=a[0],F=a[1],D=a[2],I=Math.sqrt(R*R+F*F+D*D);return Math.abs(I)<i.EPSILON?null:(I=1/I,R*=I,F*=I,D*=I,n=Math.sin(r),s=Math.cos(r),o=1-s,l=t[0],u=t[1],h=t[2],c=t[3],d=t[4],g=t[5],f=t[6],v=t[7],m=t[8],p=t[9],_=t[10],y=t[11],M=R*R*o+s,T=F*R*o+D*n,S=D*R*o-F*n,b=R*F*o-D*n,A=F*F*o+s,x=D*F*o+R*n,k=R*D*o+F*n,w=F*D*o-R*n,E=D*D*o+s,e[0]=l*M+d*T+m*S,e[1]=u*M+g*T+p*S,e[2]=h*M+f*T+_*S,e[3]=c*M+v*T+y*S,e[4]=l*b+d*A+m*x,e[5]=u*b+g*A+p*x,e[6]=h*b+f*A+_*x,e[7]=c*b+v*A+y*x,e[8]=l*k+d*w+m*E,e[9]=u*k+g*w+p*E,e[10]=h*k+f*w+_*E,e[11]=c*k+v*w+y*E,t!==e&&(e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e)},a.scalar.rotateX=function(e,t,r){var i=Math.sin(r),a=Math.cos(r),n=t[4],s=t[5],o=t[6],l=t[7],u=t[8],h=t[9],c=t[10],d=t[11];return t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[4]=n*a+u*i,e[5]=s*a+h*i,e[6]=o*a+c*i,e[7]=l*a+d*i,e[8]=u*a-n*i,e[9]=h*a-s*i,e[10]=c*a-o*i,e[11]=d*a-l*i,e},a.SIMD.rotateX=function(e,t,r){var i=SIMD.Float32x4.splat(Math.sin(r)),a=SIMD.Float32x4.splat(Math.cos(r));t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]);var n=SIMD.Float32x4.load(t,4),s=SIMD.Float32x4.load(t,8);return SIMD.Float32x4.store(e,4,SIMD.Float32x4.add(SIMD.Float32x4.mul(n,a),SIMD.Float32x4.mul(s,i))),SIMD.Float32x4.store(e,8,SIMD.Float32x4.sub(SIMD.Float32x4.mul(s,a),SIMD.Float32x4.mul(n,i))),e},a.rotateX=i.USE_SIMD?a.SIMD.rotateX:a.scalar.rotateX,a.scalar.rotateY=function(e,t,r){var i=Math.sin(r),a=Math.cos(r),n=t[0],s=t[1],o=t[2],l=t[3],u=t[8],h=t[9],c=t[10],d=t[11];return t!==e&&(e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=n*a-u*i,e[1]=s*a-h*i,e[2]=o*a-c*i,e[3]=l*a-d*i,e[8]=n*i+u*a,e[9]=s*i+h*a,e[10]=o*i+c*a,e[11]=l*i+d*a,e},a.SIMD.rotateY=function(e,t,r){var i=SIMD.Float32x4.splat(Math.sin(r)),a=SIMD.Float32x4.splat(Math.cos(r));t!==e&&(e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]);var n=SIMD.Float32x4.load(t,0),s=SIMD.Float32x4.load(t,8);return SIMD.Float32x4.store(e,0,SIMD.Float32x4.sub(SIMD.Float32x4.mul(n,a),SIMD.Float32x4.mul(s,i))),SIMD.Float32x4.store(e,8,SIMD.Float32x4.add(SIMD.Float32x4.mul(n,i),SIMD.Float32x4.mul(s,a))),e},a.rotateY=i.USE_SIMD?a.SIMD.rotateY:a.scalar.rotateY,a.scalar.rotateZ=function(e,t,r){var i=Math.sin(r),a=Math.cos(r),n=t[0],s=t[1],o=t[2],l=t[3],u=t[4],h=t[5],c=t[6],d=t[7];return t!==e&&(e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=n*a+u*i,e[1]=s*a+h*i,e[2]=o*a+c*i,e[3]=l*a+d*i,e[4]=u*a-n*i,e[5]=h*a-s*i,e[6]=c*a-o*i,e[7]=d*a-l*i,e},a.SIMD.rotateZ=function(e,t,r){var i=SIMD.Float32x4.splat(Math.sin(r)),a=SIMD.Float32x4.splat(Math.cos(r));t!==e&&(e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]);var n=SIMD.Float32x4.load(t,0),s=SIMD.Float32x4.load(t,4);return SIMD.Float32x4.store(e,0,SIMD.Float32x4.add(SIMD.Float32x4.mul(n,a),SIMD.Float32x4.mul(s,i))),SIMD.Float32x4.store(e,4,SIMD.Float32x4.sub(SIMD.Float32x4.mul(s,a),SIMD.Float32x4.mul(n,i))),e},a.rotateZ=i.USE_SIMD?a.SIMD.rotateZ:a.scalar.rotateZ,a.fromTranslation=function(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1,e},a.fromScaling=function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t[1],e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t[2],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},a.fromRotation=function(e,t,r){var a,n,s,o=r[0],l=r[1],u=r[2],h=Math.sqrt(o*o+l*l+u*u);return Math.abs(h)<i.EPSILON?null:(h=1/h,o*=h,l*=h,u*=h,a=Math.sin(t),n=Math.cos(t),s=1-n,e[0]=o*o*s+n,e[1]=l*o*s+u*a,e[2]=u*o*s-l*a,e[3]=0,e[4]=o*l*s-u*a,e[5]=l*l*s+n,e[6]=u*l*s+o*a,e[7]=0,e[8]=o*u*s+l*a,e[9]=l*u*s-o*a,e[10]=u*u*s+n,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e)},a.fromXRotation=function(e,t){var r=Math.sin(t),i=Math.cos(t);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=i,e[6]=r,e[7]=0,e[8]=0,e[9]=-r,e[10]=i,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},a.fromYRotation=function(e,t){var r=Math.sin(t),i=Math.cos(t);return e[0]=i,e[1]=0,e[2]=-r,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=r,e[9]=0,e[10]=i,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},a.fromZRotation=function(e,t){var r=Math.sin(t),i=Math.cos(t);return e[0]=i,e[1]=r,e[2]=0,e[3]=0,e[4]=-r,e[5]=i,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},a.fromRotationTranslation=function(e,t,r){var i=t[0],a=t[1],n=t[2],s=t[3],o=i+i,l=a+a,u=n+n,h=i*o,c=i*l,d=i*u,g=a*l,f=a*u,v=n*u,m=s*o,p=s*l,_=s*u;return e[0]=1-(g+v),e[1]=c+_,
e[2]=d-p,e[3]=0,e[4]=c-_,e[5]=1-(h+v),e[6]=f+m,e[7]=0,e[8]=d+p,e[9]=f-m,e[10]=1-(h+g),e[11]=0,e[12]=r[0],e[13]=r[1],e[14]=r[2],e[15]=1,e},a.getTranslation=function(e,t){return e[0]=t[12],e[1]=t[13],e[2]=t[14],e},a.getRotation=function(e,t){var r=t[0]+t[5]+t[10],i=0;return r>0?(i=2*Math.sqrt(r+1),e[3]=.25*i,e[0]=(t[6]-t[9])/i,e[1]=(t[8]-t[2])/i,e[2]=(t[1]-t[4])/i):t[0]>t[5]&t[0]>t[10]?(i=2*Math.sqrt(1+t[0]-t[5]-t[10]),e[3]=(t[6]-t[9])/i,e[0]=.25*i,e[1]=(t[1]+t[4])/i,e[2]=(t[8]+t[2])/i):t[5]>t[10]?(i=2*Math.sqrt(1+t[5]-t[0]-t[10]),e[3]=(t[8]-t[2])/i,e[0]=(t[1]+t[4])/i,e[1]=.25*i,e[2]=(t[6]+t[9])/i):(i=2*Math.sqrt(1+t[10]-t[0]-t[5]),e[3]=(t[1]-t[4])/i,e[0]=(t[8]+t[2])/i,e[1]=(t[6]+t[9])/i,e[2]=.25*i),e},a.fromRotationTranslationScale=function(e,t,r,i){var a=t[0],n=t[1],s=t[2],o=t[3],l=a+a,u=n+n,h=s+s,c=a*l,d=a*u,g=a*h,f=n*u,v=n*h,m=s*h,p=o*l,_=o*u,y=o*h,M=i[0],T=i[1],S=i[2];return e[0]=(1-(f+m))*M,e[1]=(d+y)*M,e[2]=(g-_)*M,e[3]=0,e[4]=(d-y)*T,e[5]=(1-(c+m))*T,e[6]=(v+p)*T,e[7]=0,e[8]=(g+_)*S,e[9]=(v-p)*S,e[10]=(1-(c+f))*S,e[11]=0,e[12]=r[0],e[13]=r[1],e[14]=r[2],e[15]=1,e},a.fromRotationTranslationScaleOrigin=function(e,t,r,i,a){var n=t[0],s=t[1],o=t[2],l=t[3],u=n+n,h=s+s,c=o+o,d=n*u,g=n*h,f=n*c,v=s*h,m=s*c,p=o*c,_=l*u,y=l*h,M=l*c,T=i[0],S=i[1],b=i[2],A=a[0],x=a[1],k=a[2];return e[0]=(1-(v+p))*T,e[1]=(g+M)*T,e[2]=(f-y)*T,e[3]=0,e[4]=(g-M)*S,e[5]=(1-(d+p))*S,e[6]=(m+_)*S,e[7]=0,e[8]=(f+y)*b,e[9]=(m-_)*b,e[10]=(1-(d+v))*b,e[11]=0,e[12]=r[0]+A-(e[0]*A+e[4]*x+e[8]*k),e[13]=r[1]+x-(e[1]*A+e[5]*x+e[9]*k),e[14]=r[2]+k-(e[2]*A+e[6]*x+e[10]*k),e[15]=1,e},a.fromQuat=function(e,t){var r=t[0],i=t[1],a=t[2],n=t[3],s=r+r,o=i+i,l=a+a,u=r*s,h=i*s,c=i*o,d=a*s,g=a*o,f=a*l,v=n*s,m=n*o,p=n*l;return e[0]=1-c-f,e[1]=h+p,e[2]=d-m,e[3]=0,e[4]=h-p,e[5]=1-u-f,e[6]=g+v,e[7]=0,e[8]=d+m,e[9]=g-v,e[10]=1-u-c,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},a.frustum=function(e,t,r,i,a,n,s){var o=1/(r-t),l=1/(a-i),u=1/(n-s);return e[0]=2*n*o,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=2*n*l,e[6]=0,e[7]=0,e[8]=(r+t)*o,e[9]=(a+i)*l,e[10]=(s+n)*u,e[11]=-1,e[12]=0,e[13]=0,e[14]=s*n*2*u,e[15]=0,e},a.perspective=function(e,t,r,i,a){var n=1/Math.tan(t/2),s=1/(i-a);return e[0]=n/r,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=n,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=(a+i)*s,e[11]=-1,e[12]=0,e[13]=0,e[14]=2*a*i*s,e[15]=0,e},a.perspectiveFromFieldOfView=function(e,t,r,i){var a=Math.tan(t.upDegrees*Math.PI/180),n=Math.tan(t.downDegrees*Math.PI/180),s=Math.tan(t.leftDegrees*Math.PI/180),o=Math.tan(t.rightDegrees*Math.PI/180),l=2/(s+o),u=2/(a+n);return e[0]=l,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=u,e[6]=0,e[7]=0,e[8]=-((s-o)*l*.5),e[9]=(a-n)*u*.5,e[10]=i/(r-i),e[11]=-1,e[12]=0,e[13]=0,e[14]=i*r/(r-i),e[15]=0,e},a.ortho=function(e,t,r,i,a,n,s){var o=1/(t-r),l=1/(i-a),u=1/(n-s);return e[0]=-2*o,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*l,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=2*u,e[11]=0,e[12]=(t+r)*o,e[13]=(a+i)*l,e[14]=(s+n)*u,e[15]=1,e},a.lookAt=function(e,t,r,n){var s,o,l,u,h,c,d,g,f,v,m=t[0],p=t[1],_=t[2],y=n[0],M=n[1],T=n[2],S=r[0],b=r[1],A=r[2];return Math.abs(m-S)<i.EPSILON&&Math.abs(p-b)<i.EPSILON&&Math.abs(_-A)<i.EPSILON?a.identity(e):(d=m-S,g=p-b,f=_-A,v=1/Math.sqrt(d*d+g*g+f*f),d*=v,g*=v,f*=v,s=M*f-T*g,o=T*d-y*f,l=y*g-M*d,v=Math.sqrt(s*s+o*o+l*l),v?(v=1/v,s*=v,o*=v,l*=v):(s=0,o=0,l=0),u=g*l-f*o,h=f*s-d*l,c=d*o-g*s,v=Math.sqrt(u*u+h*h+c*c),v?(v=1/v,u*=v,h*=v,c*=v):(u=0,h=0,c=0),e[0]=s,e[1]=u,e[2]=d,e[3]=0,e[4]=o,e[5]=h,e[6]=g,e[7]=0,e[8]=l,e[9]=c,e[10]=f,e[11]=0,e[12]=-(s*m+o*p+l*_),e[13]=-(u*m+h*p+c*_),e[14]=-(d*m+g*p+f*_),e[15]=1,e)},a.str=function(e){return"mat4("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+", "+e[9]+", "+e[10]+", "+e[11]+", "+e[12]+", "+e[13]+", "+e[14]+", "+e[15]+")"},a.frob=function(e){return Math.sqrt(Math.pow(e[0],2)+Math.pow(e[1],2)+Math.pow(e[2],2)+Math.pow(e[3],2)+Math.pow(e[4],2)+Math.pow(e[5],2)+Math.pow(e[6],2)+Math.pow(e[7],2)+Math.pow(e[8],2)+Math.pow(e[9],2)+Math.pow(e[10],2)+Math.pow(e[11],2)+Math.pow(e[12],2)+Math.pow(e[13],2)+Math.pow(e[14],2)+Math.pow(e[15],2))},a.add=function(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e[3]=t[3]+r[3],e[4]=t[4]+r[4],e[5]=t[5]+r[5],e[6]=t[6]+r[6],e[7]=t[7]+r[7],e[8]=t[8]+r[8],e[9]=t[9]+r[9],e[10]=t[10]+r[10],e[11]=t[11]+r[11],e[12]=t[12]+r[12],e[13]=t[13]+r[13],e[14]=t[14]+r[14],e[15]=t[15]+r[15],e},a.subtract=function(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e[3]=t[3]-r[3],e[4]=t[4]-r[4],e[5]=t[5]-r[5],e[6]=t[6]-r[6],e[7]=t[7]-r[7],e[8]=t[8]-r[8],e[9]=t[9]-r[9],e[10]=t[10]-r[10],e[11]=t[11]-r[11],e[12]=t[12]-r[12],e[13]=t[13]-r[13],e[14]=t[14]-r[14],e[15]=t[15]-r[15],e},a.sub=a.subtract,a.multiplyScalar=function(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e[4]=t[4]*r,e[5]=t[5]*r,e[6]=t[6]*r,e[7]=t[7]*r,e[8]=t[8]*r,e[9]=t[9]*r,e[10]=t[10]*r,e[11]=t[11]*r,e[12]=t[12]*r,e[13]=t[13]*r,e[14]=t[14]*r,e[15]=t[15]*r,e},a.multiplyScalarAndAdd=function(e,t,r,i){return e[0]=t[0]+r[0]*i,e[1]=t[1]+r[1]*i,e[2]=t[2]+r[2]*i,e[3]=t[3]+r[3]*i,e[4]=t[4]+r[4]*i,e[5]=t[5]+r[5]*i,e[6]=t[6]+r[6]*i,e[7]=t[7]+r[7]*i,e[8]=t[8]+r[8]*i,e[9]=t[9]+r[9]*i,e[10]=t[10]+r[10]*i,e[11]=t[11]+r[11]*i,e[12]=t[12]+r[12]*i,e[13]=t[13]+r[13]*i,e[14]=t[14]+r[14]*i,e[15]=t[15]+r[15]*i,e},a.exactEquals=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]&&e[8]===t[8]&&e[9]===t[9]&&e[10]===t[10]&&e[11]===t[11]&&e[12]===t[12]&&e[13]===t[13]&&e[14]===t[14]&&e[15]===t[15]},a.equals=function(e,t){var r=e[0],a=e[1],n=e[2],s=e[3],o=e[4],l=e[5],u=e[6],h=e[7],c=e[8],d=e[9],g=e[10],f=e[11],v=e[12],m=e[13],p=e[14],_=e[15],y=t[0],M=t[1],T=t[2],S=t[3],b=t[4],A=t[5],x=t[6],k=t[7],w=t[8],E=t[9],R=t[10],F=t[11],D=t[12],I=t[13],C=t[14],N=t[15];return Math.abs(r-y)<=i.EPSILON*Math.max(1,Math.abs(r),Math.abs(y))&&Math.abs(a-M)<=i.EPSILON*Math.max(1,Math.abs(a),Math.abs(M))&&Math.abs(n-T)<=i.EPSILON*Math.max(1,Math.abs(n),Math.abs(T))&&Math.abs(s-S)<=i.EPSILON*Math.max(1,Math.abs(s),Math.abs(S))&&Math.abs(o-b)<=i.EPSILON*Math.max(1,Math.abs(o),Math.abs(b))&&Math.abs(l-A)<=i.EPSILON*Math.max(1,Math.abs(l),Math.abs(A))&&Math.abs(u-x)<=i.EPSILON*Math.max(1,Math.abs(u),Math.abs(x))&&Math.abs(h-k)<=i.EPSILON*Math.max(1,Math.abs(h),Math.abs(k))&&Math.abs(c-w)<=i.EPSILON*Math.max(1,Math.abs(c),Math.abs(w))&&Math.abs(d-E)<=i.EPSILON*Math.max(1,Math.abs(d),Math.abs(E))&&Math.abs(g-R)<=i.EPSILON*Math.max(1,Math.abs(g),Math.abs(R))&&Math.abs(f-F)<=i.EPSILON*Math.max(1,Math.abs(f),Math.abs(F))&&Math.abs(v-D)<=i.EPSILON*Math.max(1,Math.abs(v),Math.abs(D))&&Math.abs(m-I)<=i.EPSILON*Math.max(1,Math.abs(m),Math.abs(I))&&Math.abs(p-C)<=i.EPSILON*Math.max(1,Math.abs(p),Math.abs(C))&&Math.abs(_-N)<=i.EPSILON*Math.max(1,Math.abs(_),Math.abs(N))},e.exports=a},function(e,t,r){var i=r(1),a=r(4),n=r(7),s=r(8),o={};o.create=function(){var e=new i.ARRAY_TYPE(4);return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e},o.rotationTo=function(){var e=n.create(),t=n.fromValues(1,0,0),r=n.fromValues(0,1,0);return function(i,a,s){var l=n.dot(a,s);return l<-.999999?(n.cross(e,t,a),n.length(e)<1e-6&&n.cross(e,r,a),n.normalize(e,e),o.setAxisAngle(i,e,Math.PI),i):l>.999999?(i[0]=0,i[1]=0,i[2]=0,i[3]=1,i):(n.cross(e,a,s),i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=1+l,o.normalize(i,i))}}(),o.setAxes=function(){var e=a.create();return function(t,r,i,a){return e[0]=i[0],e[3]=i[1],e[6]=i[2],e[1]=a[0],e[4]=a[1],e[7]=a[2],e[2]=-r[0],e[5]=-r[1],e[8]=-r[2],o.normalize(t,o.fromMat3(t,e))}}(),o.clone=s.clone,o.fromValues=s.fromValues,o.copy=s.copy,o.set=s.set,o.identity=function(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e},o.setAxisAngle=function(e,t,r){r=.5*r;var i=Math.sin(r);return e[0]=i*t[0],e[1]=i*t[1],e[2]=i*t[2],e[3]=Math.cos(r),e},o.getAxisAngle=function(e,t){var r=2*Math.acos(t[3]),i=Math.sin(r/2);return 0!=i?(e[0]=t[0]/i,e[1]=t[1]/i,e[2]=t[2]/i):(e[0]=1,e[1]=0,e[2]=0),r},o.add=s.add,o.multiply=function(e,t,r){var i=t[0],a=t[1],n=t[2],s=t[3],o=r[0],l=r[1],u=r[2],h=r[3];return e[0]=i*h+s*o+a*u-n*l,e[1]=a*h+s*l+n*o-i*u,e[2]=n*h+s*u+i*l-a*o,e[3]=s*h-i*o-a*l-n*u,e},o.mul=o.multiply,o.scale=s.scale,o.rotateX=function(e,t,r){r*=.5;var i=t[0],a=t[1],n=t[2],s=t[3],o=Math.sin(r),l=Math.cos(r);return e[0]=i*l+s*o,e[1]=a*l+n*o,e[2]=n*l-a*o,e[3]=s*l-i*o,e},o.rotateY=function(e,t,r){r*=.5;var i=t[0],a=t[1],n=t[2],s=t[3],o=Math.sin(r),l=Math.cos(r);return e[0]=i*l-n*o,e[1]=a*l+s*o,e[2]=n*l+i*o,e[3]=s*l-a*o,e},o.rotateZ=function(e,t,r){r*=.5;var i=t[0],a=t[1],n=t[2],s=t[3],o=Math.sin(r),l=Math.cos(r);return e[0]=i*l+a*o,e[1]=a*l-i*o,e[2]=n*l+s*o,e[3]=s*l-n*o,e},o.calculateW=function(e,t){var r=t[0],i=t[1],a=t[2];return e[0]=r,e[1]=i,e[2]=a,e[3]=Math.sqrt(Math.abs(1-r*r-i*i-a*a)),e},o.dot=s.dot,o.lerp=s.lerp,o.slerp=function(e,t,r,i){var a,n,s,o,l,u=t[0],h=t[1],c=t[2],d=t[3],g=r[0],f=r[1],v=r[2],m=r[3];return n=u*g+h*f+c*v+d*m,n<0&&(n=-n,g=-g,f=-f,v=-v,m=-m),1-n>1e-6?(a=Math.acos(n),s=Math.sin(a),o=Math.sin((1-i)*a)/s,l=Math.sin(i*a)/s):(o=1-i,l=i),e[0]=o*u+l*g,e[1]=o*h+l*f,e[2]=o*c+l*v,e[3]=o*d+l*m,e},o.sqlerp=function(){var e=o.create(),t=o.create();return function(r,i,a,n,s,l){return o.slerp(e,i,s,l),o.slerp(t,a,n,l),o.slerp(r,e,t,2*l*(1-l)),r}}(),o.invert=function(e,t){var r=t[0],i=t[1],a=t[2],n=t[3],s=r*r+i*i+a*a+n*n,o=s?1/s:0;return e[0]=-r*o,e[1]=-i*o,e[2]=-a*o,e[3]=n*o,e},o.conjugate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=t[3],e},o.length=s.length,o.len=o.length,o.squaredLength=s.squaredLength,o.sqrLen=o.squaredLength,o.normalize=s.normalize,o.fromMat3=function(e,t){var r,i=t[0]+t[4]+t[8];if(i>0)r=Math.sqrt(i+1),e[3]=.5*r,r=.5/r,e[0]=(t[5]-t[7])*r,e[1]=(t[6]-t[2])*r,e[2]=(t[1]-t[3])*r;else{var a=0;t[4]>t[0]&&(a=1),t[8]>t[3*a+a]&&(a=2);var n=(a+1)%3,s=(a+2)%3;r=Math.sqrt(t[3*a+a]-t[3*n+n]-t[3*s+s]+1),e[a]=.5*r,r=.5/r,e[3]=(t[3*n+s]-t[3*s+n])*r,e[n]=(t[3*n+a]+t[3*a+n])*r,e[s]=(t[3*s+a]+t[3*a+s])*r}return e},o.str=function(e){return"quat("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},o.exactEquals=s.exactEquals,o.equals=s.equals,e.exports=o},function(e,t,r){var i=r(1),a={};a.create=function(){var e=new i.ARRAY_TYPE(3);return e[0]=0,e[1]=0,e[2]=0,e},a.clone=function(e){var t=new i.ARRAY_TYPE(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},a.fromValues=function(e,t,r){var a=new i.ARRAY_TYPE(3);return a[0]=e,a[1]=t,a[2]=r,a},a.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e},a.set=function(e,t,r,i){return e[0]=t,e[1]=r,e[2]=i,e},a.add=function(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e},a.subtract=function(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e},a.sub=a.subtract,a.multiply=function(e,t,r){return e[0]=t[0]*r[0],e[1]=t[1]*r[1],e[2]=t[2]*r[2],e},a.mul=a.multiply,a.divide=function(e,t,r){return e[0]=t[0]/r[0],e[1]=t[1]/r[1],e[2]=t[2]/r[2],e},a.div=a.divide,a.ceil=function(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2]),e},a.floor=function(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2]),e},a.min=function(e,t,r){return e[0]=Math.min(t[0],r[0]),e[1]=Math.min(t[1],r[1]),e[2]=Math.min(t[2],r[2]),e},a.max=function(e,t,r){return e[0]=Math.max(t[0],r[0]),e[1]=Math.max(t[1],r[1]),e[2]=Math.max(t[2],r[2]),e},a.round=function(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e[2]=Math.round(t[2]),e},a.scale=function(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e},a.scaleAndAdd=function(e,t,r,i){return e[0]=t[0]+r[0]*i,e[1]=t[1]+r[1]*i,e[2]=t[2]+r[2]*i,e},a.distance=function(e,t){var r=t[0]-e[0],i=t[1]-e[1],a=t[2]-e[2];return Math.sqrt(r*r+i*i+a*a)},a.dist=a.distance,a.squaredDistance=function(e,t){var r=t[0]-e[0],i=t[1]-e[1],a=t[2]-e[2];return r*r+i*i+a*a},a.sqrDist=a.squaredDistance,a.length=function(e){var t=e[0],r=e[1],i=e[2];return Math.sqrt(t*t+r*r+i*i)},a.len=a.length,a.squaredLength=function(e){var t=e[0],r=e[1],i=e[2];return t*t+r*r+i*i},a.sqrLen=a.squaredLength,a.negate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e},a.inverse=function(e,t){return e[0]=1/t[0],e[1]=1/t[1],e[2]=1/t[2],e},a.normalize=function(e,t){var r=t[0],i=t[1],a=t[2],n=r*r+i*i+a*a;return n>0&&(n=1/Math.sqrt(n),e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n),e},a.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]},a.cross=function(e,t,r){var i=t[0],a=t[1],n=t[2],s=r[0],o=r[1],l=r[2];return e[0]=a*l-n*o,e[1]=n*s-i*l,e[2]=i*o-a*s,e},a.lerp=function(e,t,r,i){var a=t[0],n=t[1],s=t[2];return e[0]=a+i*(r[0]-a),e[1]=n+i*(r[1]-n),e[2]=s+i*(r[2]-s),e},a.hermite=function(e,t,r,i,a,n){var s=n*n,o=s*(2*n-3)+1,l=s*(n-2)+n,u=s*(n-1),h=s*(3-2*n);return e[0]=t[0]*o+r[0]*l+i[0]*u+a[0]*h,e[1]=t[1]*o+r[1]*l+i[1]*u+a[1]*h,e[2]=t[2]*o+r[2]*l+i[2]*u+a[2]*h,e},a.bezier=function(e,t,r,i,a,n){var s=1-n,o=s*s,l=n*n,u=o*s,h=3*n*o,c=3*l*s,d=l*n;return e[0]=t[0]*u+r[0]*h+i[0]*c+a[0]*d,e[1]=t[1]*u+r[1]*h+i[1]*c+a[1]*d,e[2]=t[2]*u+r[2]*h+i[2]*c+a[2]*d,e},a.random=function(e,t){t=t||1;var r=2*i.RANDOM()*Math.PI,a=2*i.RANDOM()-1,n=Math.sqrt(1-a*a)*t;return e[0]=Math.cos(r)*n,e[1]=Math.sin(r)*n,e[2]=a*t,e},a.transformMat4=function(e,t,r){var i=t[0],a=t[1],n=t[2],s=r[3]*i+r[7]*a+r[11]*n+r[15];return s=s||1,e[0]=(r[0]*i+r[4]*a+r[8]*n+r[12])/s,e[1]=(r[1]*i+r[5]*a+r[9]*n+r[13])/s,e[2]=(r[2]*i+r[6]*a+r[10]*n+r[14])/s,e},a.transformMat3=function(e,t,r){var i=t[0],a=t[1],n=t[2];return e[0]=i*r[0]+a*r[3]+n*r[6],e[1]=i*r[1]+a*r[4]+n*r[7],e[2]=i*r[2]+a*r[5]+n*r[8],e},a.transformQuat=function(e,t,r){var i=t[0],a=t[1],n=t[2],s=r[0],o=r[1],l=r[2],u=r[3],h=u*i+o*n-l*a,c=u*a+l*i-s*n,d=u*n+s*a-o*i,g=-s*i-o*a-l*n;return e[0]=h*u+g*-s+c*-l-d*-o,e[1]=c*u+g*-o+d*-s-h*-l,e[2]=d*u+g*-l+h*-o-c*-s,e},a.rotateX=function(e,t,r,i){var a=[],n=[];return a[0]=t[0]-r[0],a[1]=t[1]-r[1],a[2]=t[2]-r[2],n[0]=a[0],n[1]=a[1]*Math.cos(i)-a[2]*Math.sin(i),n[2]=a[1]*Math.sin(i)+a[2]*Math.cos(i),e[0]=n[0]+r[0],e[1]=n[1]+r[1],e[2]=n[2]+r[2],e},a.rotateY=function(e,t,r,i){var a=[],n=[];return a[0]=t[0]-r[0],a[1]=t[1]-r[1],a[2]=t[2]-r[2],n[0]=a[2]*Math.sin(i)+a[0]*Math.cos(i),n[1]=a[1],n[2]=a[2]*Math.cos(i)-a[0]*Math.sin(i),e[0]=n[0]+r[0],e[1]=n[1]+r[1],e[2]=n[2]+r[2],e},a.rotateZ=function(e,t,r,i){var a=[],n=[];return a[0]=t[0]-r[0],a[1]=t[1]-r[1],a[2]=t[2]-r[2],n[0]=a[0]*Math.cos(i)-a[1]*Math.sin(i),n[1]=a[0]*Math.sin(i)+a[1]*Math.cos(i),n[2]=a[2],e[0]=n[0]+r[0],e[1]=n[1]+r[1],e[2]=n[2]+r[2],e},a.forEach=function(){var e=a.create();return function(t,r,i,a,n,s){var o,l;for(r||(r=3),i||(i=0),l=a?Math.min(a*r+i,t.length):t.length,o=i;o<l;o+=r)e[0]=t[o],e[1]=t[o+1],e[2]=t[o+2],n(e,e,s),t[o]=e[0],t[o+1]=e[1],t[o+2]=e[2];return t}}(),a.angle=function(e,t){var r=a.fromValues(e[0],e[1],e[2]),i=a.fromValues(t[0],t[1],t[2]);a.normalize(r,r),a.normalize(i,i);var n=a.dot(r,i);return n>1?0:Math.acos(n)},a.str=function(e){return"vec3("+e[0]+", "+e[1]+", "+e[2]+")"},a.exactEquals=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]},a.equals=function(e,t){var r=e[0],a=e[1],n=e[2],s=t[0],o=t[1],l=t[2];return Math.abs(r-s)<=i.EPSILON*Math.max(1,Math.abs(r),Math.abs(s))&&Math.abs(a-o)<=i.EPSILON*Math.max(1,Math.abs(a),Math.abs(o))&&Math.abs(n-l)<=i.EPSILON*Math.max(1,Math.abs(n),Math.abs(l))},e.exports=a},function(e,t,r){var i=r(1),a={};a.create=function(){var e=new i.ARRAY_TYPE(4);return e[0]=0,e[1]=0,e[2]=0,e[3]=0,e},a.clone=function(e){var t=new i.ARRAY_TYPE(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},a.fromValues=function(e,t,r,a){var n=new i.ARRAY_TYPE(4);return n[0]=e,n[1]=t,n[2]=r,n[3]=a,n},a.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},a.set=function(e,t,r,i,a){return e[0]=t,e[1]=r,e[2]=i,e[3]=a,e},a.add=function(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e[3]=t[3]+r[3],e},a.subtract=function(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e[3]=t[3]-r[3],e},a.sub=a.subtract,a.multiply=function(e,t,r){return e[0]=t[0]*r[0],e[1]=t[1]*r[1],e[2]=t[2]*r[2],e[3]=t[3]*r[3],e},a.mul=a.multiply,a.divide=function(e,t,r){return e[0]=t[0]/r[0],e[1]=t[1]/r[1],e[2]=t[2]/r[2],e[3]=t[3]/r[3],e},a.div=a.divide,a.ceil=function(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2]),e[3]=Math.ceil(t[3]),e},a.floor=function(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2]),e[3]=Math.floor(t[3]),e},a.min=function(e,t,r){return e[0]=Math.min(t[0],r[0]),e[1]=Math.min(t[1],r[1]),e[2]=Math.min(t[2],r[2]),e[3]=Math.min(t[3],r[3]),e},a.max=function(e,t,r){return e[0]=Math.max(t[0],r[0]),e[1]=Math.max(t[1],r[1]),e[2]=Math.max(t[2],r[2]),e[3]=Math.max(t[3],r[3]),e},a.round=function(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e[2]=Math.round(t[2]),e[3]=Math.round(t[3]),e},a.scale=function(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e},a.scaleAndAdd=function(e,t,r,i){return e[0]=t[0]+r[0]*i,e[1]=t[1]+r[1]*i,e[2]=t[2]+r[2]*i,e[3]=t[3]+r[3]*i,e},a.distance=function(e,t){var r=t[0]-e[0],i=t[1]-e[1],a=t[2]-e[2],n=t[3]-e[3];return Math.sqrt(r*r+i*i+a*a+n*n)},a.dist=a.distance,a.squaredDistance=function(e,t){var r=t[0]-e[0],i=t[1]-e[1],a=t[2]-e[2],n=t[3]-e[3];return r*r+i*i+a*a+n*n},a.sqrDist=a.squaredDistance,a.length=function(e){var t=e[0],r=e[1],i=e[2],a=e[3];return Math.sqrt(t*t+r*r+i*i+a*a)},a.len=a.length,a.squaredLength=function(e){var t=e[0],r=e[1],i=e[2],a=e[3];return t*t+r*r+i*i+a*a},a.sqrLen=a.squaredLength,a.negate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e},a.inverse=function(e,t){return e[0]=1/t[0],e[1]=1/t[1],e[2]=1/t[2],e[3]=1/t[3],e},a.normalize=function(e,t){var r=t[0],i=t[1],a=t[2],n=t[3],s=r*r+i*i+a*a+n*n;return s>0&&(s=1/Math.sqrt(s),e[0]=r*s,e[1]=i*s,e[2]=a*s,e[3]=n*s),e},a.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]},a.lerp=function(e,t,r,i){var a=t[0],n=t[1],s=t[2],o=t[3];return e[0]=a+i*(r[0]-a),e[1]=n+i*(r[1]-n),e[2]=s+i*(r[2]-s),e[3]=o+i*(r[3]-o),e},a.random=function(e,t){return t=t||1,e[0]=i.RANDOM(),e[1]=i.RANDOM(),e[2]=i.RANDOM(),e[3]=i.RANDOM(),a.normalize(e,e),a.scale(e,e,t),e},a.transformMat4=function(e,t,r){var i=t[0],a=t[1],n=t[2],s=t[3];return e[0]=r[0]*i+r[4]*a+r[8]*n+r[12]*s,e[1]=r[1]*i+r[5]*a+r[9]*n+r[13]*s,e[2]=r[2]*i+r[6]*a+r[10]*n+r[14]*s,e[3]=r[3]*i+r[7]*a+r[11]*n+r[15]*s,e},a.transformQuat=function(e,t,r){var i=t[0],a=t[1],n=t[2],s=r[0],o=r[1],l=r[2],u=r[3],h=u*i+o*n-l*a,c=u*a+l*i-s*n,d=u*n+s*a-o*i,g=-s*i-o*a-l*n;return e[0]=h*u+g*-s+c*-l-d*-o,e[1]=c*u+g*-o+d*-s-h*-l,e[2]=d*u+g*-l+h*-o-c*-s,e[3]=t[3],e},a.forEach=function(){var e=a.create();return function(t,r,i,a,n,s){var o,l;for(r||(r=4),i||(i=0),l=a?Math.min(a*r+i,t.length):t.length,o=i;o<l;o+=r)e[0]=t[o],e[1]=t[o+1],e[2]=t[o+2],e[3]=t[o+3],n(e,e,s),t[o]=e[0],t[o+1]=e[1],t[o+2]=e[2],t[o+3]=e[3];return t}}(),a.str=function(e){return"vec4("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},a.exactEquals=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]},a.equals=function(e,t){var r=e[0],a=e[1],n=e[2],s=e[3],o=t[0],l=t[1],u=t[2],h=t[3];return Math.abs(r-o)<=i.EPSILON*Math.max(1,Math.abs(r),Math.abs(o))&&Math.abs(a-l)<=i.EPSILON*Math.max(1,Math.abs(a),Math.abs(l))&&Math.abs(n-u)<=i.EPSILON*Math.max(1,Math.abs(n),Math.abs(u))&&Math.abs(s-h)<=i.EPSILON*Math.max(1,Math.abs(s),Math.abs(h))},e.exports=a},function(e,t,r){var i=r(1),a={};a.create=function(){var e=new i.ARRAY_TYPE(2);return e[0]=0,e[1]=0,e},a.clone=function(e){var t=new i.ARRAY_TYPE(2);return t[0]=e[0],t[1]=e[1],t},a.fromValues=function(e,t){var r=new i.ARRAY_TYPE(2);return r[0]=e,r[1]=t,r},a.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e},a.set=function(e,t,r){return e[0]=t,e[1]=r,e},a.add=function(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e},a.subtract=function(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e},a.sub=a.subtract,a.multiply=function(e,t,r){return e[0]=t[0]*r[0],e[1]=t[1]*r[1],e},a.mul=a.multiply,a.divide=function(e,t,r){return e[0]=t[0]/r[0],e[1]=t[1]/r[1],e},a.div=a.divide,a.ceil=function(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e},a.floor=function(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e},a.min=function(e,t,r){return e[0]=Math.min(t[0],r[0]),e[1]=Math.min(t[1],r[1]),e},a.max=function(e,t,r){return e[0]=Math.max(t[0],r[0]),e[1]=Math.max(t[1],r[1]),e},a.round=function(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e},a.scale=function(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e},a.scaleAndAdd=function(e,t,r,i){return e[0]=t[0]+r[0]*i,e[1]=t[1]+r[1]*i,e},a.distance=function(e,t){var r=t[0]-e[0],i=t[1]-e[1];return Math.sqrt(r*r+i*i)},a.dist=a.distance,a.squaredDistance=function(e,t){var r=t[0]-e[0],i=t[1]-e[1];return r*r+i*i},a.sqrDist=a.squaredDistance,a.length=function(e){var t=e[0],r=e[1];return Math.sqrt(t*t+r*r)},a.len=a.length,a.squaredLength=function(e){var t=e[0],r=e[1];return t*t+r*r},a.sqrLen=a.squaredLength,a.negate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e},a.inverse=function(e,t){return e[0]=1/t[0],e[1]=1/t[1],e},a.normalize=function(e,t){var r=t[0],i=t[1],a=r*r+i*i;return a>0&&(a=1/Math.sqrt(a),e[0]=t[0]*a,e[1]=t[1]*a),e},a.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]},a.cross=function(e,t,r){var i=t[0]*r[1]-t[1]*r[0];return e[0]=e[1]=0,e[2]=i,e},a.lerp=function(e,t,r,i){var a=t[0],n=t[1];return e[0]=a+i*(r[0]-a),e[1]=n+i*(r[1]-n),e},a.random=function(e,t){t=t||1;var r=2*i.RANDOM()*Math.PI;return e[0]=Math.cos(r)*t,e[1]=Math.sin(r)*t,e},a.transformMat2=function(e,t,r){var i=t[0],a=t[1];return e[0]=r[0]*i+r[2]*a,e[1]=r[1]*i+r[3]*a,e},a.transformMat2d=function(e,t,r){var i=t[0],a=t[1];return e[0]=r[0]*i+r[2]*a+r[4],e[1]=r[1]*i+r[3]*a+r[5],e},a.transformMat3=function(e,t,r){var i=t[0],a=t[1];return e[0]=r[0]*i+r[3]*a+r[6],e[1]=r[1]*i+r[4]*a+r[7],e},a.transformMat4=function(e,t,r){var i=t[0],a=t[1];return e[0]=r[0]*i+r[4]*a+r[12],e[1]=r[1]*i+r[5]*a+r[13],e},a.forEach=function(){var e=a.create();return function(t,r,i,a,n,s){var o,l;for(r||(r=2),i||(i=0),l=a?Math.min(a*r+i,t.length):t.length,o=i;o<l;o+=r)e[0]=t[o],e[1]=t[o+1],n(e,e,s),t[o]=e[0],t[o+1]=e[1];return t}}(),a.str=function(e){return"vec2("+e[0]+", "+e[1]+")"},a.exactEquals=function(e,t){return e[0]===t[0]&&e[1]===t[1]},a.equals=function(e,t){var r=e[0],a=e[1],n=t[0],s=t[1];return Math.abs(r-n)<=i.EPSILON*Math.max(1,Math.abs(r),Math.abs(n))&&Math.abs(a-s)<=i.EPSILON*Math.max(1,Math.abs(a),Math.abs(s))},e.exports=a}])});var i={glMatrix:window.glMatrix,vec2:window.vec2,vec3:window.vec3,vec4:window.vec4,mat2:window.mat2,mat2d:window.mat2d,mat3:window.mat3,mat4:window.mat4,quat:window.quat};!function(e,t,r,i){function a(e,t,r){return setTimeout(u(e,r),t)}function n(e,t,r){return!!Array.isArray(e)&&(s(e,r[t],r),!0)}function s(e,t,r){var a;if(e)if(e.forEach)e.forEach(t,r);else if(e.length!==i)for(a=0;a<e.length;)t.call(r,e[a],a,e),a++;else for(a in e)e.hasOwnProperty(a)&&t.call(r,e[a],a,e)}function o(t,r,i){var a="DEPRECATED METHOD: "+r+"\n"+i+" AT \n";return function(){var r=new Error("get-stack-trace"),i=r&&r.stack?r.stack.replace(/^[^\(]+?[\n$]/gm,"").replace(/^\s+at\s+/gm,"").replace(/^Object.<anonymous>\s*\(/gm,"{anonymous}()@"):"Unknown Stack Trace",n=e.console&&(e.console.warn||e.console.log);return n&&n.call(e.console,a,i),t.apply(this,arguments)}}function l(e,t,r){var i,a=t.prototype;i=e.prototype=Object.create(a),i.constructor=e,i._super=a,r&&ce(i,r)}function u(e,t){return function(){return e.apply(t,arguments)}}function h(e,t){return typeof e==fe?e.apply(t?t[0]||i:i,t):e}function c(e,t){return e===i?t:e}function d(e,t,r){s(m(t),function(t){e.addEventListener(t,r,!1)})}function g(e,t,r){s(m(t),function(t){e.removeEventListener(t,r,!1)})}function f(e,t){for(;e;){if(e==t)return!0;e=e.parentNode}return!1}function v(e,t){return e.indexOf(t)>-1}function m(e){return e.trim().split(/\s+/g)}function p(e,t,r){if(e.indexOf&&!r)return e.indexOf(t);for(var i=0;i<e.length;){if(r&&e[i][r]==t||!r&&e[i]===t)return i;i++}return-1}function _(e){return Array.prototype.slice.call(e,0)}function y(e,t,r){for(var i=[],a=[],n=0;n<e.length;){var s=t?e[n][t]:e[n];p(a,s)<0&&i.push(e[n]),a[n]=s,n++}return r&&(i=t?i.sort(function(e,r){return e[t]>r[t]}):i.sort()),i}function M(e,t){for(var r,a,n=t[0].toUpperCase()+t.slice(1),s=0;s<de.length;){if(r=de[s],a=r?r+n:t,a in e)return a;s++}return i}function T(){return Me++}function S(t){var r=t.ownerDocument||t;return r.defaultView||r.parentWindow||e}function b(e,t){var r=this;this.manager=e,this.callback=t,this.element=e.element,this.target=e.options.inputTarget,this.domHandler=function(t){h(e.options.enable,[e])&&r.handler(t)},this.init()}function A(e){var t,r=e.options.inputClass;return new(t=r?r:be?U:Ae?G:Se?X:L)(e,x)}function x(e,t,r){var i=r.pointers.length,a=r.changedPointers.length,n=t&Fe&&i-a===0,s=t&(Ie|Ce)&&i-a===0;r.isFirst=!!n,r.isFinal=!!s,n&&(e.session={}),r.eventType=t,k(e,r),e.emit("hammer.input",r),e.recognize(r),e.session.prevInput=r}function k(e,t){var r=e.session,i=t.pointers,a=i.length;r.firstInput||(r.firstInput=R(t)),a>1&&!r.firstMultiple?r.firstMultiple=R(t):1===a&&(r.firstMultiple=!1);var n=r.firstInput,s=r.firstMultiple,o=s?s.center:n.center,l=t.center=F(i);t.timeStamp=pe(),t.deltaTime=t.timeStamp-n.timeStamp,t.angle=N(o,l),t.distance=C(o,l),w(r,t),t.offsetDirection=I(t.deltaX,t.deltaY);var u=D(t.deltaTime,t.deltaX,t.deltaY);t.overallVelocityX=u.x,t.overallVelocityY=u.y,t.overallVelocity=me(u.x)>me(u.y)?u.x:u.y,t.scale=s?P(s.pointers,i):1,t.rotation=s?V(s.pointers,i):0,t.maxPointers=r.prevInput?t.pointers.length>r.prevInput.maxPointers?t.pointers.length:r.prevInput.maxPointers:t.pointers.length,E(r,t);var h=e.element;f(t.srcEvent.target,h)&&(h=t.srcEvent.target),t.target=h}function w(e,t){var r=t.center,i=e.offsetDelta||{},a=e.prevDelta||{},n=e.prevInput||{};t.eventType!==Fe&&n.eventType!==Ie||(a=e.prevDelta={x:n.deltaX||0,y:n.deltaY||0},i=e.offsetDelta={x:r.x,y:r.y}),t.deltaX=a.x+(r.x-i.x),t.deltaY=a.y+(r.y-i.y)}function E(e,t){var r,a,n,s,o=e.lastInterval||t,l=t.timeStamp-o.timeStamp;if(t.eventType!=Ce&&(l>Re||o.velocity===i)){var u=t.deltaX-o.deltaX,h=t.deltaY-o.deltaY,c=D(l,u,h);a=c.x,n=c.y,r=me(c.x)>me(c.y)?c.x:c.y,s=I(u,h),e.lastInterval=t}else r=o.velocity,a=o.velocityX,n=o.velocityY,s=o.direction;t.velocity=r,t.velocityX=a,t.velocityY=n,t.direction=s}function R(e){for(var t=[],r=0;r<e.pointers.length;)t[r]={clientX:ve(e.pointers[r].clientX),clientY:ve(e.pointers[r].clientY)},r++;return{timeStamp:pe(),pointers:t,center:F(t),deltaX:e.deltaX,deltaY:e.deltaY}}function F(e){var t=e.length;if(1===t)return{x:ve(e[0].clientX),y:ve(e[0].clientY)};for(var r=0,i=0,a=0;a<t;)r+=e[a].clientX,i+=e[a].clientY,a++;return{x:ve(r/t),y:ve(i/t)}}function D(e,t,r){return{x:t/e||0,y:r/e||0}}function I(e,t){return e===t?Ne:me(e)>=me(t)?e<0?Ve:Pe:t<0?Le:Ue}function C(e,t,r){r||(r=ze);var i=t[r[0]]-e[r[0]],a=t[r[1]]-e[r[1]];return Math.sqrt(i*i+a*a)}function N(e,t,r){r||(r=ze);var i=t[r[0]]-e[r[0]],a=t[r[1]]-e[r[1]];return 180*Math.atan2(a,i)/Math.PI}function V(e,t){return N(t[1],t[0],Xe)+N(e[1],e[0],Xe)}function P(e,t){return C(t[0],t[1],Xe)/C(e[0],e[1],Xe)}function L(){this.evEl=Ye,this.evWin=He,this.pressed=!1,b.apply(this,arguments)}function U(){this.evEl=Ke,this.evWin=Ze,b.apply(this,arguments),this.store=this.manager.session.pointerEvents=[]}function B(){this.evTarget=Je,this.evWin=$e,this.started=!1,b.apply(this,arguments)}function O(e,t){var r=_(e.touches),i=_(e.changedTouches);return t&(Ie|Ce)&&(r=y(r.concat(i),"identifier",!0)),[r,i]}function G(){this.evTarget=tt,this.targetIds={},b.apply(this,arguments)}function z(e,t){var r=_(e.touches),i=this.targetIds;if(t&(Fe|De)&&1===r.length)return i[r[0].identifier]=!0,[r,r];var a,n,s=_(e.changedTouches),o=[],l=this.target;if(n=r.filter(function(e){return f(e.target,l)}),t===Fe)for(a=0;a<n.length;)i[n[a].identifier]=!0,a++;for(a=0;a<s.length;)i[s[a].identifier]&&o.push(s[a]),t&(Ie|Ce)&&delete i[s[a].identifier],a++;return o.length?[y(n.concat(o),"identifier",!0),o]:void 0}function X(){b.apply(this,arguments);var e=u(this.handler,this);this.touch=new G(this.manager,e),this.mouse=new L(this.manager,e),this.primaryTouch=null,this.lastTouches=[]}function W(e,t){e&Fe?(this.primaryTouch=t.changedPointers[0].identifier,Y.call(this,t)):e&(Ie|Ce)&&Y.call(this,t)}function Y(e){var t=e.changedPointers[0];if(t.identifier===this.primaryTouch){var r={x:t.clientX,y:t.clientY};this.lastTouches.push(r);var i=this.lastTouches,a=function(){var e=i.indexOf(r);e>-1&&i.splice(e,1)};setTimeout(a,rt)}}function H(e){for(var t=e.srcEvent.clientX,r=e.srcEvent.clientY,i=0;i<this.lastTouches.length;i++){var a=this.lastTouches[i],n=Math.abs(t-a.x),s=Math.abs(r-a.y);if(n<=it&&s<=it)return!0}return!1}function j(e,t){this.manager=e,this.set(t)}function q(e){if(v(e,ut))return ut;var t=v(e,ht),r=v(e,ct);return t&&r?ut:t||r?t?ht:ct:v(e,lt)?lt:ot}function K(){if(!nt)return!1;var t={},r=e.CSS&&e.CSS.supports;return["auto","manipulation","pan-y","pan-x","pan-x pan-y","none"].forEach(function(i){t[i]=!r||e.CSS.supports("touch-action",i)}),t}function Z(e){this.options=ce({},this.defaults,e||{}),this.id=T(),this.manager=null,this.options.enable=c(this.options.enable,!0),this.state=gt,this.simultaneous={},this.requireFail=[]}function Q(e){return e&_t?"cancel":e&mt?"end":e&vt?"move":e&ft?"start":""}function J(e){return e==Ue?"down":e==Le?"up":e==Ve?"left":e==Pe?"right":""}function $(e,t){var r=t.manager;return r?r.get(e):e}function ee(){Z.apply(this,arguments)}function te(){ee.apply(this,arguments),this.pX=null,this.pY=null}function re(){ee.apply(this,arguments)}function ie(){Z.apply(this,arguments),this._timer=null,this._input=null}function ae(){ee.apply(this,arguments)}function ne(){ee.apply(this,arguments)}function se(){Z.apply(this,arguments),this.pTime=!1,this.pCenter=!1,this._timer=null,this._input=null,this.count=0}function oe(e,t){return t=t||{},t.recognizers=c(t.recognizers,oe.defaults.preset),new le(e,t)}function le(e,t){this.options=ce({},oe.defaults,t||{}),this.options.inputTarget=this.options.inputTarget||e,this.handlers={},this.session={},this.recognizers=[],this.oldCssProps={},this.element=e,this.input=A(this),this.touchAction=new j(this,this.options.touchAction),ue(this,!0),s(this.options.recognizers,function(e){var t=this.add(new e[0](e[1]));e[2]&&t.recognizeWith(e[2]),e[3]&&t.requireFailure(e[3])},this)}function ue(e,t){var r=e.element;if(r.style){var i;s(e.options.cssProps,function(a,n){i=M(r.style,n),t?(e.oldCssProps[i]=r.style[i],r.style[i]=a):r.style[i]=e.oldCssProps[i]||""}),t||(e.oldCssProps={})}}function he(e,r){var i=t.createEvent("Event");i.initEvent(e,!0,!0),i.gesture=r,r.target.dispatchEvent(i)}var ce,de=["","webkit","Moz","MS","ms","o"],ge=t.createElement("div"),fe="function",ve=Math.round,me=Math.abs,pe=Date.now;ce="function"!=typeof Object.assign?function(e){if(e===i||null===e)throw new TypeError("Cannot convert undefined or null to object");for(var t=Object(e),r=1;r<arguments.length;r++){var a=arguments[r];if(a!==i&&null!==a)for(var n in a)a.hasOwnProperty(n)&&(t[n]=a[n])}return t}:Object.assign;var _e=o(function(e,t,r){for(var a=Object.keys(t),n=0;n<a.length;)(!r||r&&e[a[n]]===i)&&(e[a[n]]=t[a[n]]),n++;return e},"extend","Use `assign`."),ye=o(function(e,t){return _e(e,t,!0)},"merge","Use `assign`."),Me=1,Te=/mobile|tablet|ip(ad|hone|od)|android/i,Se="ontouchstart"in e,be=M(e,"PointerEvent")!==i,Ae=Se&&Te.test(navigator.userAgent),xe="touch",ke="pen",we="mouse",Ee="kinect",Re=25,Fe=1,De=2,Ie=4,Ce=8,Ne=1,Ve=2,Pe=4,Le=8,Ue=16,Be=Ve|Pe,Oe=Le|Ue,Ge=Be|Oe,ze=["x","y"],Xe=["clientX","clientY"];b.prototype={handler:function(){},init:function(){this.evEl&&d(this.element,this.evEl,this.domHandler),this.evTarget&&d(this.target,this.evTarget,this.domHandler),this.evWin&&d(S(this.element),this.evWin,this.domHandler)},destroy:function(){this.evEl&&g(this.element,this.evEl,this.domHandler),this.evTarget&&g(this.target,this.evTarget,this.domHandler),this.evWin&&g(S(this.element),this.evWin,this.domHandler)}};var We={mousedown:Fe,mousemove:De,mouseup:Ie},Ye="mousedown",He="mousemove mouseup";l(L,b,{handler:function(e){var t=We[e.type];t&Fe&&0===e.button&&(this.pressed=!0),t&De&&1!==e.which&&(t=Ie),this.pressed&&(t&Ie&&(this.pressed=!1),this.callback(this.manager,t,{pointers:[e],changedPointers:[e],pointerType:we,srcEvent:e}))}});var je={pointerdown:Fe,pointermove:De,pointerup:Ie,pointercancel:Ce,
pointerout:Ce},qe={2:xe,3:ke,4:we,5:Ee},Ke="pointerdown",Ze="pointermove pointerup pointercancel";e.MSPointerEvent&&!e.PointerEvent&&(Ke="MSPointerDown",Ze="MSPointerMove MSPointerUp MSPointerCancel"),l(U,b,{handler:function(e){var t=this.store,r=!1,i=e.type.toLowerCase().replace("ms",""),a=je[i],n=qe[e.pointerType]||e.pointerType,s=n==xe,o=p(t,e.pointerId,"pointerId");a&Fe&&(0===e.button||s)?o<0&&(t.push(e),o=t.length-1):a&(Ie|Ce)&&(r=!0),o<0||(t[o]=e,this.callback(this.manager,a,{pointers:t,changedPointers:[e],pointerType:n,srcEvent:e}),r&&t.splice(o,1))}});var Qe={touchstart:Fe,touchmove:De,touchend:Ie,touchcancel:Ce},Je="touchstart",$e="touchstart touchmove touchend touchcancel";l(B,b,{handler:function(e){var t=Qe[e.type];if(t===Fe&&(this.started=!0),this.started){var r=O.call(this,e,t);t&(Ie|Ce)&&r[0].length-r[1].length===0&&(this.started=!1),this.callback(this.manager,t,{pointers:r[0],changedPointers:r[1],pointerType:xe,srcEvent:e})}}});var et={touchstart:Fe,touchmove:De,touchend:Ie,touchcancel:Ce},tt="touchstart touchmove touchend touchcancel";l(G,b,{handler:function(e){var t=et[e.type],r=z.call(this,e,t);r&&this.callback(this.manager,t,{pointers:r[0],changedPointers:r[1],pointerType:xe,srcEvent:e})}});var rt=2500,it=25;l(X,b,{handler:function(e,t,r){var i=r.pointerType==xe,a=r.pointerType==we;if(!(a&&r.sourceCapabilities&&r.sourceCapabilities.firesTouchEvents)){if(i)W.call(this,t,r);else if(a&&H.call(this,r))return;this.callback(e,t,r)}},destroy:function(){this.touch.destroy(),this.mouse.destroy()}});var at=M(ge.style,"touchAction"),nt=at!==i,st="compute",ot="auto",lt="manipulation",ut="none",ht="pan-x",ct="pan-y",dt=K();j.prototype={set:function(e){e==st&&(e=this.compute()),nt&&this.manager.element.style&&dt[e]&&(this.manager.element.style[at]=e),this.actions=e.toLowerCase().trim()},update:function(){this.set(this.manager.options.touchAction)},compute:function(){var e=[];return s(this.manager.recognizers,function(t){h(t.options.enable,[t])&&(e=e.concat(t.getTouchAction()))}),q(e.join(" "))},preventDefaults:function(e){var t=e.srcEvent,r=e.offsetDirection;if(this.manager.session.prevented)return void t.preventDefault();var i=this.actions,a=v(i,ut)&&!dt[ut],n=v(i,ct)&&!dt[ct],s=v(i,ht)&&!dt[ht];if(a){var o=1===e.pointers.length,l=e.distance<2,u=e.deltaTime<250;if(o&&l&&u)return}return s&&n?void 0:a||n&&r&Be||s&&r&Oe?this.preventSrc(t):void 0},preventSrc:function(e){this.manager.session.prevented=!0,e.preventDefault()}};var gt=1,ft=2,vt=4,mt=8,pt=mt,_t=16,yt=32;Z.prototype={defaults:{},set:function(e){return ce(this.options,e),this.manager&&this.manager.touchAction.update(),this},recognizeWith:function(e){if(n(e,"recognizeWith",this))return this;var t=this.simultaneous;return e=$(e,this),t[e.id]||(t[e.id]=e,e.recognizeWith(this)),this},dropRecognizeWith:function(e){return n(e,"dropRecognizeWith",this)?this:(e=$(e,this),delete this.simultaneous[e.id],this)},requireFailure:function(e){if(n(e,"requireFailure",this))return this;var t=this.requireFail;return e=$(e,this),p(t,e)===-1&&(t.push(e),e.requireFailure(this)),this},dropRequireFailure:function(e){if(n(e,"dropRequireFailure",this))return this;e=$(e,this);var t=p(this.requireFail,e);return t>-1&&this.requireFail.splice(t,1),this},hasRequireFailures:function(){return this.requireFail.length>0},canRecognizeWith:function(e){return!!this.simultaneous[e.id]},emit:function(e){function t(t){r.manager.emit(t,e)}var r=this,i=this.state;i<mt&&t(r.options.event+Q(i)),t(r.options.event),e.additionalEvent&&t(e.additionalEvent),i>=mt&&t(r.options.event+Q(i))},tryEmit:function(e){return this.canEmit()?this.emit(e):void(this.state=yt)},canEmit:function(){for(var e=0;e<this.requireFail.length;){if(!(this.requireFail[e].state&(yt|gt)))return!1;e++}return!0},recognize:function(e){var t=ce({},e);return h(this.options.enable,[this,t])?(this.state&(pt|_t|yt)&&(this.state=gt),this.state=this.process(t),void(this.state&(ft|vt|mt|_t)&&this.tryEmit(t))):(this.reset(),void(this.state=yt))},process:function(e){},getTouchAction:function(){},reset:function(){}},l(ee,Z,{defaults:{pointers:1},attrTest:function(e){var t=this.options.pointers;return 0===t||e.pointers.length===t},process:function(e){var t=this.state,r=e.eventType,i=t&(ft|vt),a=this.attrTest(e);return i&&(r&Ce||!a)?t|_t:i||a?r&Ie?t|mt:t&ft?t|vt:ft:yt}}),l(te,ee,{defaults:{event:"pan",threshold:10,pointers:1,direction:Ge},getTouchAction:function(){var e=this.options.direction,t=[];return e&Be&&t.push(ct),e&Oe&&t.push(ht),t},directionTest:function(e){var t=this.options,r=!0,i=e.distance,a=e.direction,n=e.deltaX,s=e.deltaY;return a&t.direction||(t.direction&Be?(a=0===n?Ne:n<0?Ve:Pe,r=n!=this.pX,i=Math.abs(e.deltaX)):(a=0===s?Ne:s<0?Le:Ue,r=s!=this.pY,i=Math.abs(e.deltaY))),e.direction=a,r&&i>t.threshold&&a&t.direction},attrTest:function(e){return ee.prototype.attrTest.call(this,e)&&(this.state&ft||!(this.state&ft)&&this.directionTest(e))},emit:function(e){this.pX=e.deltaX,this.pY=e.deltaY;var t=J(e.direction);t&&(e.additionalEvent=this.options.event+t),this._super.emit.call(this,e)}}),l(re,ee,{defaults:{event:"pinch",threshold:0,pointers:2},getTouchAction:function(){return[ut]},attrTest:function(e){return this._super.attrTest.call(this,e)&&(Math.abs(e.scale-1)>this.options.threshold||this.state&ft)},emit:function(e){if(1!==e.scale){var t=e.scale<1?"in":"out";e.additionalEvent=this.options.event+t}this._super.emit.call(this,e)}}),l(ie,Z,{defaults:{event:"press",pointers:1,time:251,threshold:9},getTouchAction:function(){return[ot]},process:function(e){var t=this.options,r=e.pointers.length===t.pointers,i=e.distance<t.threshold,n=e.deltaTime>t.time;if(this._input=e,!i||!r||e.eventType&(Ie|Ce)&&!n)this.reset();else if(e.eventType&Fe)this.reset(),this._timer=a(function(){this.state=pt,this.tryEmit()},t.time,this);else if(e.eventType&Ie)return pt;return yt},reset:function(){clearTimeout(this._timer)},emit:function(e){this.state===pt&&(e&&e.eventType&Ie?this.manager.emit(this.options.event+"up",e):(this._input.timeStamp=pe(),this.manager.emit(this.options.event,this._input)))}}),l(ae,ee,{defaults:{event:"rotate",threshold:0,pointers:2},getTouchAction:function(){return[ut]},attrTest:function(e){return this._super.attrTest.call(this,e)&&(Math.abs(e.rotation)>this.options.threshold||this.state&ft)}}),l(ne,ee,{defaults:{event:"swipe",threshold:10,velocity:.3,direction:Be|Oe,pointers:1},getTouchAction:function(){return te.prototype.getTouchAction.call(this)},attrTest:function(e){var t,r=this.options.direction;return r&(Be|Oe)?t=e.overallVelocity:r&Be?t=e.overallVelocityX:r&Oe&&(t=e.overallVelocityY),this._super.attrTest.call(this,e)&&r&e.offsetDirection&&e.distance>this.options.threshold&&e.maxPointers==this.options.pointers&&me(t)>this.options.velocity&&e.eventType&Ie},emit:function(e){var t=J(e.offsetDirection);t&&this.manager.emit(this.options.event+t,e),this.manager.emit(this.options.event,e)}}),l(se,Z,{defaults:{event:"tap",pointers:1,taps:1,interval:300,time:250,threshold:9,posThreshold:10},getTouchAction:function(){return[lt]},process:function(e){var t=this.options,r=e.pointers.length===t.pointers,i=e.distance<t.threshold,n=e.deltaTime<t.time;if(this.reset(),e.eventType&Fe&&0===this.count)return this.failTimeout();if(i&&n&&r){if(e.eventType!=Ie)return this.failTimeout();var s=!this.pTime||e.timeStamp-this.pTime<t.interval,o=!this.pCenter||C(this.pCenter,e.center)<t.posThreshold;this.pTime=e.timeStamp,this.pCenter=e.center,o&&s?this.count+=1:this.count=1,this._input=e;var l=this.count%t.taps;if(0===l)return this.hasRequireFailures()?(this._timer=a(function(){this.state=pt,this.tryEmit()},t.interval,this),ft):pt}return yt},failTimeout:function(){return this._timer=a(function(){this.state=yt},this.options.interval,this),yt},reset:function(){clearTimeout(this._timer)},emit:function(){this.state==pt&&(this._input.tapCount=this.count,this.manager.emit(this.options.event,this._input))}}),oe.VERSION="2.0.8",oe.defaults={domEvents:!1,touchAction:st,enable:!0,inputTarget:null,inputClass:null,preset:[[ae,{enable:!1}],[re,{enable:!1},["rotate"]],[ne,{direction:Be}],[te,{direction:Be},["swipe"]],[se],[se,{event:"doubletap",taps:2},["tap"]],[ie]],cssProps:{userSelect:"none",touchSelect:"none",touchCallout:"none",contentZooming:"none",userDrag:"none",tapHighlightColor:"rgba(0,0,0,0)"}};var Mt=1,Tt=2;le.prototype={set:function(e){return ce(this.options,e),e.touchAction&&this.touchAction.update(),e.inputTarget&&(this.input.destroy(),this.input.target=e.inputTarget,this.input.init()),this},stop:function(e){this.session.stopped=e?Tt:Mt},recognize:function(e){var t=this.session;if(!t.stopped){this.touchAction.preventDefaults(e);var r,i=this.recognizers,a=t.curRecognizer;(!a||a&&a.state&pt)&&(a=t.curRecognizer=null);for(var n=0;n<i.length;)r=i[n],t.stopped===Tt||a&&r!=a&&!r.canRecognizeWith(a)?r.reset():r.recognize(e),!a&&r.state&(ft|vt|mt)&&(a=t.curRecognizer=r),n++}},get:function(e){if(e instanceof Z)return e;for(var t=this.recognizers,r=0;r<t.length;r++)if(t[r].options.event==e)return t[r];return null},add:function(e){if(n(e,"add",this))return this;var t=this.get(e.options.event);return t&&this.remove(t),this.recognizers.push(e),e.manager=this,this.touchAction.update(),e},remove:function(e){if(n(e,"remove",this))return this;if(e=this.get(e)){var t=this.recognizers,r=p(t,e);r!==-1&&(t.splice(r,1),this.touchAction.update())}return this},on:function(e,t){if(e!==i&&t!==i){var r=this.handlers;return s(m(e),function(e){r[e]=r[e]||[],r[e].push(t)}),this}},off:function(e,t){if(e!==i){var r=this.handlers;return s(m(e),function(e){t?r[e]&&r[e].splice(p(r[e],t),1):delete r[e]}),this}},emit:function(e,t){this.options.domEvents&&he(e,t);var r=this.handlers[e]&&this.handlers[e].slice();if(r&&r.length){t.type=e,t.preventDefault=function(){t.srcEvent.preventDefault()};for(var i=0;i<r.length;)r[i](t),i++}},destroy:function(){this.element&&ue(this,!1),this.handlers={},this.session={},this.input.destroy(),this.element=null}},ce(oe,{INPUT_START:Fe,INPUT_MOVE:De,INPUT_END:Ie,INPUT_CANCEL:Ce,STATE_POSSIBLE:gt,STATE_BEGAN:ft,STATE_CHANGED:vt,STATE_ENDED:mt,STATE_RECOGNIZED:pt,STATE_CANCELLED:_t,STATE_FAILED:yt,DIRECTION_NONE:Ne,DIRECTION_LEFT:Ve,DIRECTION_RIGHT:Pe,DIRECTION_UP:Le,DIRECTION_DOWN:Ue,DIRECTION_HORIZONTAL:Be,DIRECTION_VERTICAL:Oe,DIRECTION_ALL:Ge,Manager:le,Input:b,TouchAction:j,TouchInput:G,MouseInput:L,PointerEventInput:U,TouchMouseInput:X,SingleTouchInput:B,Recognizer:Z,AttrRecognizer:ee,Tap:se,Pan:te,Swipe:ne,Pinch:re,Rotate:ae,Press:ie,on:d,off:g,each:s,merge:ye,extend:_e,assign:ce,inherit:l,bindFn:u,prefixed:M});var St="undefined"!=typeof e?e:"undefined"!=typeof self?self:{};St.Hammer=oe,"function"==typeof define&&define.amd?define(function(){return oe}):"undefined"!=typeof module&&module.exports?module.exports=oe:e[r]=oe}(window,document,"Hammer");var a=window.Hammer,n={};n.SCALE=100,n.TAG_FLAG=1,n.SCULPT_FLAG=1,n.STATE_FLAG=1,n.TRI_INDEX=4294967295,n.cursors={},n.cursors.dropper="url(resources/dropper.png) 5 25, auto",n.linearToSRGB1=function(e){return e<.0031308?12.92*e:1.055*Math.pow(e,1/2.4)-.055},n.sRGBToLinear1=function(e){return e<.04045?e*(1/12.92):Math.pow((e+.055)*(1/1.055),2.4)},n.extend=function(e,t){for(var r=Object.keys(t),i=0,a=r.length;i<a;++i){var n=r[i];void 0===e[n]&&(e[n]=t[n])}return e},n.invert=function(e){for(var t=Object.keys(e),r={},i=0,a=t.length;i<a;++i)r[e[t[i]]]=t[i];return r},n.replaceElement=function(e,t,r){for(var i=0,a=e.length;i<a;++i)if(e[i]===t)return void(e[i]=r)},n.removeElement=function(e,t){for(var r=0,i=e.length;r<i;++r)if(e[r]===t)return e[r]=e[i-1],void e.pop()},n.appendArray=function(e,t){var r=e.length,i=t.length;e.length+=i;for(var a=0;a<i;++a)e[r+a]=t[a]},n.isPowerOfTwo=function(e){return 0!==e&&0===(e&e-1)},n.nextHighestPowerOfTwo=function(e){--e;for(var t=1;t<32;t<<=1)e|=e>>t;return e+1};var s=function(e,t){return e-t};n.tidy=function(e){e.sort(s);var t=e.length,r=0,i=0;for(r=1;r<t;++r)e[i]!==e[r]&&(e[++i]=e[r]);r>1&&(e.length=i+1)},n.intersectionArrays=function(e,t){for(var r=0,i=0,a=[],n=e.length,s=t.length;r<n&&i<s;)e[r]<t[i]?r++:e[r]>t[i]?i++:(a.push(e[r]),++r,++i);return a},n.littleEndian=function(){var e=new ArrayBuffer(2);return new DataView(e).setInt16(0,256,!0),256===new Int16Array(e)[0]}(),n.getBytes=function(e,t){return[e[t].charCodeAt(),e[t+1].charCodeAt(),e[t+2].charCodeAt(),e[t+3].charCodeAt()]},n.getUint32=function(e,t){var r=n.getBytes(e,t);return r[0]<<0|r[1]<<8|r[2]<<16|r[3]<<24},n.getFloat32=function(e,t){var r=n.getBytes(e,t),i=1-2*(r[3]>>7),a=(r[3]<<1&255|r[2]>>7)-127,s=(127&r[2])<<16|r[1]<<8|r[0];return 128===a?0!==s?NaN:i*(1/0):a===-127?i*s*Math.pow(2,-149):i*(1+s*Math.pow(2,-23))*Math.pow(2,a)},n.ab2str=function(e){for(var t="",r=new Uint8Array(e),i=65535,a=0,n=r.length;a<n;a+=i){var s=r.subarray(a,i<n-a?i+a:n);t+=String.fromCharCode.apply(null,s)}return t},n.getMemory=function(){var e=new ArrayBuffer(1e5);return function(t){return e.byteLength>=t?e:e=new ArrayBuffer(t)}}(),n.now=Date.now||function(){return(new Date).getTime()},n.throttle=function(e,t){var r,i=[],a=null,s=0,o=function(){s=n.now(),a=null,r=e.apply(e,i)};return function(){for(var l=n.now(),u=t-(l-s),h=i.length=arguments.length,c=0;c<h;++c)i[c]=arguments[c];return u<=0||u>t?(window.clearTimeout(a),a=null,s=l,r=e.apply(e,i)):a||(a=window.setTimeout(o,u)),r}},n.normalizeArrayVec3=function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e,r=0,i=e.length/3;r<i;++r){var a=3*r,n=e[a],s=e[a+1],o=e[a+2],l=n*n+s*s+o*o;0!==l?(l=1/Math.sqrt(l),t[a]=n*l,t[a+1]=s*l,t[a+2]=o*l):t[a]=1}return t},n.convertArrayVec3toSRGB=function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e,r=0,i=e.length;r<i;++r)t[r]=n.linearToSRGB1(e[r]);return t},n.convertArrayVec3toLinear=function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e,r=0,i=e.length;r<i;++r)t[r]=n.sRGBToLinear1(e[r]);return t};var o={};o.Action={NOTHING:0,MASK_EDIT:1,SCULPT_EDIT:2,CAMERA_ZOOM:3,CAMERA_ROTATE:4,CAMERA_PAN:5,CAMERA_PAN_ZOOM_ALT:6},o.Tools={BRUSH:0,INFLATE:1,TWIST:2,SMOOTH:3,FLATTEN:4,PINCH:5,CREASE:6,DRAG:7,PAINT:8,MOVE:9,MASKING:10,LOCALSCALE:11,TRANSFORM:12},o.Shader={PBR:0,FLAT:1,NORMAL:2,WIREFRAME:3,UV:4,MATCAP:5,SELECTION:6,BACKGROUND:7,MERGE:8,FXAA:9,CONTOUR:10},o.Projection={PERSPECTIVE:0,ORTHOGRAPHIC:1},o.CameraMode={ORBIT:0,SPHERICAL:1,PLANE:2},o.MultiState={NONE:0,SCULPT:1,CAMERA:2,PICKING:3};var l=Object.keys(o.Tools).length;o.KeyAction=n.extend({INTENSITY:l++,RADIUS:l++,NEGATIVE:l++,PICKER:l++,DELETE:l++,CAMERA_FRONT:l++,CAMERA_TOP:l++,CAMERA_LEFT:l++,CAMERA_RESET:l++,STRIFE_LEFT:l++,STRIFE_RIGHT:l++,STRIFE_UP:l++,STRIFE_DOWN:l++,WIREFRAME:l++},o.Tools);var u,h=o.KeyAction,c=function(e,t){return void 0===e?t:"false"!==e&&"0"!==e},d=function(e,t,r,i){var a=parseFloat(e);return a||0===a?Math.max(t,Math.min(r,a)):i},g=function(e,t,r,i){var a=parseInt(e,10);return a||0===a?Math.max(t,Math.min(r,a)):i},f=function(e,t){if(!e)return t;var r=e.split(",");if(r.length<3)return t;var i=t.slice();return i[0]=parseInt(r[0]||0,10)/255,i[1]=parseInt(r[1]||0,10)/255,i[2]=parseInt(r[2]||0,10)/255,void 0!==r[3]&&(i[3]=parseFloat(r[3])),i},v=function(e){var t={};if(t["0".charCodeAt(0)]=h.MOVE,t["1".charCodeAt(0)]=h.BRUSH,t["2".charCodeAt(0)]=h.INFLATE,t["3".charCodeAt(0)]=h.TWIST,t["4".charCodeAt(0)]=h.SMOOTH,t["5".charCodeAt(0)]=h.FLATTEN,t["6".charCodeAt(0)]=h.PINCH,t["7".charCodeAt(0)]=h.CREASE,t["8".charCodeAt(0)]=h.DRAG,t["9".charCodeAt(0)]=h.PAINT,t["E".charCodeAt(0)]=h.TRANSFORM,t["C".charCodeAt(0)]=h.INTENSITY,t["X".charCodeAt(0)]=h.RADIUS,t["N".charCodeAt(0)]=h.NEGATIVE,t["S".charCodeAt(0)]=h.PICKER,t[46]=h.DELETE,t["F".charCodeAt(0)]=h.CAMERA_FRONT,t["T".charCodeAt(0)]=h.CAMERA_TOP,t["L".charCodeAt(0)]=h.CAMERA_LEFT,t[32]=h.CAMERA_RESET,t[37]=h.STRIFE_LEFT,t[39]=h.STRIFE_RIGHT,t[38]=h.STRIFE_UP,t[40]=h.STRIFE_DOWN,t["W".charCodeAt(0)]=h.WIREFRAME,!e)return t;for(var r=e.split(","),i=0,a=r.length;i<a;i++){var n=r[i].split(":",2);if(2===n.length){var s=n[1].toUpperCase(),o=parseInt(s,10);s=o===o&&o>=10?o:s.charCodeAt(0);var l=h[n[0].toUpperCase()];void 0!==l&&(t[s]=l)}}return t},m=function(){for(var e=window.location.search.substr(1).split("&"),t={},r=0,i=e.length;r<i;r++){var a=e[r].split("=",2);2===a.length&&(t[a[0].toLowerCase()]=a[1])}return t},p=function(e,t,r){if(t){var i=e[t.toUpperCase()];if(void 0!==i)return i}return r},_=function(){if(u)return u;u={};var e=m();return u.language=e.language,u.scalecenter=c(e.scalecenter,!0),u.wacom=c(e.wacom,!1),u.grid=c(e.grid,!0),u.outline=c(e.outline,!1),u.outlinecolor=f(e.outlinecolor,[.3,0,0,1]),u.mirrorline=c(e.mirrorline,!1),u.darkenunselected=c(e.darkenunselected,!1),u.projection=p(o.Projection,e.projection,o.Projection.PERSPECTIVE),u.cameramode=p(o.CameraMode,e.cameramode,o.Projection.ORBIT),u.pivot=c(e.pivot,!0),u.fov=d(e.fov,10,90,45),u.flatshading=c(e.flatshading,!1),u.wireframe=c(e.wireframe,!1),u.curvature=d(e.curvature,0,5,0),u.exposure=d(e.exposure,0,5,1),u.environment=g(e.environment,0,1/0,0),u.matcap=g(e.matcap,0,1/0,3),u.shader=p(o.Shader,e.shader,o.Shader.MATCAP),u.filmic=c(e.filmic,!1),u.modelurl=e.modelurl,u.shortcuts=v(e.shortcuts),u};_(),_.getShortKey=function(e){return e>=96&&e<=105&&(e-=48),_().shortcuts[e]};var y=(function(){function e(e){this.value=e}function t(t){function r(e,t){return new Promise(function(r,a){var o={key:e,arg:t,resolve:r,reject:a,next:null};s?s=s.next=o:(n=s=o,i(e,t))})}function i(r,n){try{var s=t[r](n),o=s.value;o instanceof e?Promise.resolve(o.value).then(function(e){i("next",e)},function(e){i("throw",e)}):a(s.done?"return":"normal",s.value)}catch(e){a("throw",e)}}function a(e,t){switch(e){case"return":n.resolve({value:t,done:!0});break;case"throw":n.reject(t);break;default:n.resolve({value:t,done:!1})}n=n.next,n?i(n.key,n.arg):s=null}var n,s;this._invoke=r,"function"!=typeof t.return&&(this.return=void 0)}return"function"==typeof Symbol&&Symbol.asyncIterator&&(t.prototype[Symbol.asyncIterator]=function(){return this}),t.prototype.next=function(e){return this._invoke("next",e)},t.prototype.throw=function(e){return this._invoke("throw",e)},t.prototype.return=function(e){return this._invoke("return",e)},{wrap:function(e){return function(){return new t(e.apply(this,arguments))}},await:function(t){return new e(t)}}}(),function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}),M=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),T=function e(t,r,i){null===t&&(t=Function.prototype);var a=Object.getOwnPropertyDescriptor(t,r);if(void 0===a){var n=Object.getPrototypeOf(t);return null===n?void 0:e(n,r,i)}if("value"in a)return a.value;var s=a.get;if(void 0!==s)return s.call(i)},S=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},b=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},A=function(){function e(t,r,i){y(this,e),this._gl=t,this._buffer=t.createBuffer(),this._type=r,this._hint=i,this._size=0}return M(e,[{key:"bind",value:function(){this._gl.bindBuffer(this._type,this._buffer)}},{key:"release",value:function(){this._gl.deleteBuffer(this._buffer)}},{key:"update",value:function(e,t){this._gl.bindBuffer(this._type,this._buffer),void 0!==t&&t!==e.length&&(e=e.subarray(0,t)),e.length>this._size?(this._gl.bufferData(this._type,e,this._hint),this._size=e.length):this._gl.bufferSubData(this._type,0,e)}}]),e}(),x=function(){function e(t,r,i,a,n){y(this,e),this._gl=t,this._location=t.getAttribLocation(r,i),this._size=a,this._type=n}return M(e,[{key:"bindToBuffer",value:function(e){var t=this._gl;e.bind(),t.enableVertexAttribArray(this._location),t.vertexAttribPointer(this._location,this._size,this._type,!1,0,0)}}]),e}(),k="// reference\n// https://www.khronos.org/registry/gles/extensions/EXT/EXT_sRGB.txt\n\n#define LIN_SRGB(x) x < 0.0031308 ? x * 12.92 : 1.055 * pow(x, 1.0/2.4) - 0.055\nfloat linearTosRGB(const in float c) {\n    return LIN_SRGB(c);\n}\nvec3 linearTosRGB(const in vec3 c) {\n    return vec3(LIN_SRGB(c.r), LIN_SRGB(c.g), LIN_SRGB(c.b));\n}\nvec4 linearTosRGB(const in vec4 c) {\n    return vec4(LIN_SRGB(c.r), LIN_SRGB(c.g), LIN_SRGB(c.b), c.a);\n}\n\n#define SRGB_LIN(x) x < 0.04045 ? x * (1.0 / 12.92) : pow((x + 0.055) * (1.0 / 1.055), 2.4)\nfloat sRGBToLinear(const in float c) {\n    return SRGB_LIN(c);\n}\nvec3 sRGBToLinear(const in vec3 c) {\n    return vec3(SRGB_LIN(c.r), SRGB_LIN(c.g), SRGB_LIN(c.b));\n}\nvec4 sRGBToLinear(const in vec4 c) {\n    return vec4(SRGB_LIN(c.r), SRGB_LIN(c.g), SRGB_LIN(c.b), c.a);\n}\n\n#define RANGE 5.0\n// http://graphicrants.blogspot.fr/2009/04/rgbm-color-encoding.html\nvec4 encodeRGBM(const in vec3 col) {\n    vec4 rgbm;\n    vec3 color = col / RANGE;\n    rgbm.a = clamp( max( max( color.r, color.g ), max( color.b, 1e-6 ) ), 0.0, 1.0 );\n    rgbm.a = ceil( rgbm.a * 255.0 ) / 255.0;\n    rgbm.rgb = color / rgbm.a;\n    return rgbm;\n}\n\nvec3 decodeRGBM(const in vec4 col) {\n  return RANGE * col.rgb * col.a;\n}\n",w="// http://madebyevan.com/shaders/curvature/\n#extension GL_OES_standard_derivatives : enable\nvec3 computeCurvature( const in vec3 vertex, const in vec3 normal, const in vec3 color, const in float str, const in float fov) {\n  if(str < 1e-3)\n    return color;\n#ifndef GL_OES_standard_derivatives\n    return color * pow(length(normal), str * 100.0);\n#else\n  vec3 n = normalize(normal);\n  // Compute curvature\n  vec3 dx = dFdx(n);\n  vec3 dy = dFdy(n);\n  vec3 xneg = n - dx;\n  vec3 xpos = n + dx;\n  vec3 yneg = n - dy;\n  vec3 ypos = n + dy;\n  // fov < 0.0 means ortho\n  float depth = fov > 0.0 ? length(vertex) * fov : -fov;\n  float cur = (cross(xneg, xpos).y - cross(yneg, ypos).x) * str * 80.0 / depth;\n  return mix(mix(color, color * 0.3, clamp(-cur * 15.0, 0.0, 1.0)), color * 2.0, clamp(cur * 25.0, 0.0, 1.0));\n#endif\n}\n",E=i.vec3,R={};R.vertexName="VertexName",R.fragmentName="FragmentName",R.activeAttributes={vertex:!0,normal:!0,material:!0,color:!0},R.showSymmetryLine=_().mirrorline,R.darkenUnselected=_().darkenunselected,R.uniformNames={},R.uniformNames.commonUniforms=["uMV","uMVP","uN","uEM","uEN","uFlat","uPlaneO","uPlaneN","uSym","uCurvature","uAlpha","uFov","uDarken"],R.strings={},R.strings.colorSpaceGLSL=k,R.strings.vertUniforms=["uniform mat4 uMV;","uniform mat4 uMVP;","uniform mat3 uN;","uniform mat4 uEM;","uniform mat3 uEN;","uniform float uAlpha;"].join("\n"),R.strings.fragColorUniforms=["uniform vec3 uPlaneN;","uniform vec3 uPlaneO;","uniform int uSym;","uniform int uDarken;","uniform float uCurvature;","uniform float uFov;","varying float vMasking;","uniform int uFlat;"].join("\n"),R.strings.fragColorFunction=[w,k,"#extension GL_OES_standard_derivatives : enable","vec3 getNormal() {","  #ifndef GL_OES_standard_derivatives","    return normalize(gl_FrontFacing ? vNormal : -vNormal);","  #else","    return uFlat == 0 ? normalize(gl_FrontFacing ? vNormal : -vNormal) : -normalize(cross(dFdy(vVertex), dFdx(vVertex)));","  #endif","}","vec4 encodeFragColor(const in vec3 frag, const in float alpha) {","  vec3 col = computeCurvature(vVertex, vNormal, frag, uCurvature, uFov);","  if(uDarken == 1) col *= 0.3;","  col *= (0.3 + 0.7 * vMasking);","  if(uSym == 1 && abs(dot(uPlaneN, vVertex - uPlaneO)) < 0.15)","      col = min(col * 1.5, 1.0);","  return alpha != 1.0 ? vec4(col * alpha, alpha) : encodeRGBM(col);","}"].join("\n");var F=function(e){var t=e.match(/^\s*(#extension).*/gm);if(!t)return e;for(var r={},i="",a=0,n=t.length;a<n;++a){var s=t[a].substr(t[a].indexOf("#extension"));e=e.replace(t[a],""),r[s]||(r[s]=!0,i+=s+"\n")}return e=i+e};R.getOrCreate=function(e){if(this.program)return this;var t="\n#define SHADER_NAME "+this.vertexName+"\n",r="\n#define SHADER_NAME "+this.fragmentName+"\n",i=e.createShader(e.VERTEX_SHADER);e.shaderSource(i,F(this.vertex+t)),e.compileShader(i);var a=e.createShader(e.FRAGMENT_SHADER);e.shaderSource(a,F(this.fragment+r)),e.compileShader(a);var n=this.program=e.createProgram();e.attachShader(n,i),e.attachShader(n,a),e.linkProgram(n),e.useProgram(n);var s=e.getShaderInfoLog(i),o=e.getShaderInfoLog(a),l=e.getProgramInfoLog(n);return s&&console.warn(this.vertexName+" (vertex)\n"+s),o&&console.warn(this.fragmentName+" (fragment)\n"+o),l&&console.warn(this.fragmentName+" (program)\n"+l),this.initAttributes(e),this.initUniforms(e),this},R.initUniforms=function(e){for(var t=this.program,r=this.uniformNames,i=this.uniforms,a=0,n=r.length;a<n;++a){var s=r[a];i[s]=e.getUniformLocation(t,s)}},R.updateUniforms=function(){var e=[0,0,0];return function(t,r){var i=t.getGL(),a=R.darkenUnselected&&r.getIndexSelectMesh(t)<0,n=R.showSymmetryLine&&t.getID()===r.getMesh().getID()&&r.getSculptManager().getSymmetry(),s=this.uniforms;i.uniformMatrix4fv(s.uEM,!1,t.getEditMatrix()),i.uniformMatrix3fv(s.uEN,!1,t.getEN()),i.uniformMatrix4fv(s.uMV,!1,t.getMV()),i.uniformMatrix4fv(s.uMVP,!1,t.getMVP()),i.uniformMatrix3fv(s.uN,!1,t.getN()),i.uniform1i(s.uDarken,a?1:0),i.uniform1i(s.uFlat,t.getFlatShading()),i.uniform3fv(s.uPlaneO,E.transformMat4(e,t.getSymmetryOrigin(),t.getMV())),i.uniform3fv(s.uPlaneN,E.normalize(e,E.transformMat3(e,t.getSymmetryNormal(),t.getN()))),i.uniform1i(s.uSym,n?1:0),i.uniform1f(s.uAlpha,t.getOpacity()),i.uniform1f(s.uCurvature,t.getCurvature());var o=r.getCamera();i.uniform1f(s.uFov,o.isOrthographic()?25*-Math.abs(o._trans[2]):o.getFov())}}(),R.draw=function(e,t){var r=e.getGL();r.useProgram(this.program),this.bindAttributes(e),this.updateUniforms(e,t),this.drawBuffer(e)},R.drawBuffer=function(e){var t=e.getGL();e.isUsingDrawArrays()?t.drawArrays(e.getMode(),0,e.getCount()):(e.getIndexBuffer().bind(),t.drawElements(e.getMode(),e.getCount(),t.UNSIGNED_INT,0)),t.bindBuffer(t.ARRAY_BUFFER,null),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null)},R.setTextureParameters=function(e,t){e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),n.isPowerOfTwo(t.width)&&n.isPowerOfTwo(t.height)?(e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR_MIPMAP_LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.REPEAT),e.generateMipmap(e.TEXTURE_2D)):(e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE))},R.onLoadTexture0=function(e,t,r){this.texture0=e.createTexture(),e.bindTexture(e.TEXTURE_2D,this.texture0),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),R.setTextureParameters(e,t),e.bindTexture(e.TEXTURE_2D,null),r&&r.render()},R.getDummyTexture=function(e){return this._dummyTex?this._dummyTex:(this._dummyTex=e.createTexture(),e.bindTexture(e.TEXTURE_2D,this._dummyTex),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,new Uint8Array(4)),e.bindTexture(e.TEXTURE_2D,null),this._dummyTex)},R.getOrCreateTexture0=function(e,t,r){if(void 0!==this.texture0)return this.texture0;this.texture0=null;var i=new Image;return i.src=t,i.onload=this.onLoadTexture0.bind(this,e,i,r),!1},R.initAttributes=function(e){var t=this.program,r=this.attributes;r.aVertex=new x(e,t,"aVertex",3,e.FLOAT),r.aNormal=new x(e,t,"aNormal",3,e.FLOAT),r.aColor=new x(e,t,"aColor",3,e.FLOAT),r.aMaterial=new x(e,t,"aMaterial",3,e.FLOAT)},R.bindAttributes=function(e){var t=this.attributes,r=this.activeAttributes;r.vertex&&t.aVertex.bindToBuffer(e.getVertexBuffer()),r.normal&&t.aNormal.bindToBuffer(e.getNormalBuffer()),r.color&&t.aColor.bindToBuffer(e.getColorBuffer()),r.material&&t.aMaterial.bindToBuffer(e.getMaterialBuffer())},R.getCopy=function(){for(var e=Object.keys(R),t={},r=0,i=e.length;r<i;++r)t[e[r]]=this[e[r]];return t.program=null,t};var D="#define PI 3.1415926535897932384626433832795\n#define PI_2 (2.0*3.1415926535897932384626433832795)\n#define INV_PI 1.0/PI\n#define INV_LOG2 1.4426950408889634073599246810019\n\nuniform sampler2D uTexture0;\nuniform float uExposure;\nuniform mat3 uIblTransform;\n\nvec2 environmentSize = vec2(1024, 512);\nvec2 environmentLodRange = vec2(10, 5);\n\nconst mat3 LUVInverse = mat3( 6.0013, -2.700, -1.7995, -1.332, 3.1029, -5.7720, 0.3007, -1.088, 5.6268 );\nvec3 LUVToRGB( const in vec4 vLogLuv ) {\n  float Le = vLogLuv.z * 255.0 + vLogLuv.w;\n  vec3 Xp_Y_XYZp;\n  Xp_Y_XYZp.y = exp2((Le - 127.0) / 2.0);\n  Xp_Y_XYZp.z = Xp_Y_XYZp.y / vLogLuv.y;\n  Xp_Y_XYZp.x = vLogLuv.x * Xp_Y_XYZp.z;\n  return max(LUVInverse * Xp_Y_XYZp, 0.0);\n}\n\nvec2 computeUVForMipmap( const in float level, const in vec2 uv, const in float size, const in float maxLOD ) {\n  float widthForLevel = exp2( maxLOD - level);\n  vec2 uvSpaceLocal =  vec2(1.0) + uv * vec2(widthForLevel - 2.0, widthForLevel * 0.5 - 2.0);\n  uvSpaceLocal.y += size - widthForLevel;\n  return uvSpaceLocal / size;\n}\n\nvec2 normalToPanoramaUVY( const in vec3 dir ) {\n  float n = length(dir.xz);\n  vec2 pos = vec2( (n>0.0000001) ? max(-1.0,dir.x / n) : 0.0, dir.y);\n  if ( pos.x > 0.0 ) pos.x = min( 0.999999, pos.x );\n  pos = acos(pos)*INV_PI;\n  pos.x = (dir.z > 0.0) ? pos.x*0.5 : 1.0-(pos.x*0.5);\n  pos.x = mod(pos.x-0.25+1.0, 1.0 );\n  pos.y = 1.0-pos.y;\n  return pos;\n}\n\nvec3 texturePanoramaLod(const in sampler2D texture, const in vec2 size , const in vec3 direction, const in float lodInput, const in float maxLOD ) {\n  float lod = min( maxLOD, lodInput );\n  vec2 uvBase = normalToPanoramaUVY( direction );\n  vec3 texel0 = LUVToRGB(texture2D( texture, computeUVForMipmap(floor(lod), uvBase, size.x, maxLOD )));\n  vec3 texel1 = LUVToRGB(texture2D( texture, computeUVForMipmap(ceil(lod), uvBase, size.x, maxLOD )));\n  return mix(texel0, texel1, fract( lod ) );\n}\n\nvec3 integrateBRDFApprox(const in vec3 specular, float roughness, float NoV) {\n  const vec4 c0 = vec4(-1, -0.0275, -0.572, 0.022);\n  const vec4 c1 = vec4(1, 0.0425, 1.04, -0.04);\n  vec4 r = roughness * c0 + c1;\n  float a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\n  vec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\n  return specular * AB.x + AB.y;\n}\n\nvec3 getSpecularDominantDir( const in vec3 N, const in vec3 R, const in float realRoughness ) {\n    float smoothness = 1.0 - realRoughness;\n    return mix( N, R, smoothness * ( sqrt( smoothness ) + realRoughness ) );\n}\n\nvec3 approximateSpecularIBL( const in vec3 specularColor, float rLinear, const in vec3 N, const in vec3 V ) {\n  float NoV = clamp( dot( N, V ), 0.0, 1.0 );\n  vec3 R = normalize( (2.0 * NoV ) * N - V);\n  R = getSpecularDominantDir(N, R, rLinear);\n  vec3 prefilteredColor = texturePanoramaLod( uTexture0, environmentSize, uIblTransform * R, rLinear * environmentLodRange[1], environmentLodRange[0] );\n  return prefilteredColor * integrateBRDFApprox(specularColor, rLinear, NoV);\n}\n\n// expect shCoefs uniform\n// https://github.com/cedricpinson/envtools/blob/master/Cubemap.cpp#L523\nvec3 sphericalHarmonics( const in vec3 N ) {\n  float x = N.x;\n  float y = N.y;\n  float z = N.z;\n  vec3 result = uSPH[0] + uSPH[1] * y + uSPH[2] * z + uSPH[3] * x + uSPH[4] * y * x + uSPH[5] * y * z + uSPH[6] * (3.0 * z * z - 1.0) + uSPH[7] * (z * x) + uSPH[8] * (x*x - y*y);\n  return max(result, vec3(0.0));\n}\n\nvec3 computeIBL_UE4( const in vec3 N, const in vec3 V, const in vec3 albedo, const in float roughness, const in vec3 specular) {\n  vec3 color = vec3(0.0);\n  if ( albedo != color )\n    color += albedo * sphericalHarmonics( uIblTransform * N );\n  color += approximateSpecularIBL(specular, roughness, N, V);\n  return color;\n}\n",I={backgroundTitle:"Background",backgroundReset:"Reset",backgroundImport:"Import (jpg, png...)",
backgroundFill:"Fill",cameraTitle:"Camera",cameraReset:"View",cameraCenter:"Reset (bar)",cameraFront:"Front (F)",cameraLeft:"Left (L)",cameraTop:"Top (T)",cameraMode:"Mode",cameraOrbit:"Orbit (Turntable)",cameraSpherical:"Spherical (Trackball)",cameraPlane:"Plane (Trackball)",cameraProjection:"Projection",cameraPerspective:"Perspective",cameraOrthographic:"Orthographic",cameraFov:"Fov",cameraPivot:"Picking pivot",fileTitle:"Files (import/export)",fileImportTitle:"Import",fileAdd:"Add (obj, sgl, ply, stl)",fileAutoMatrix:"Scale and center",fileVertexSRGB:"sRGB vertex color",fileExportMeshTitle:"Export Mesh",fileExportSceneTitle:"Export Scene",fileExportSGL:"Save .sgl (SculptGL)",fileExportOBJ:"Save .obj",fileExportPLY:"Save .ply",fileExportSTL:"Save .stl",sceneTitle:"Scene",sceneReset:"Clear scene",sceneAddSphere:"Add sphere",sceneAddCube:"Add cube",sceneAddCylinder:"Add cylinder",sceneAddTorus:"Add torus",sceneSelection:"Selection",sceneMerge:"Merge selection",meshTitle:"Mesh",meshNbVertices:"Vertex : ",meshNbFaces:"Faces : ",topologyTitle:"Topology",multiresTitle:"Multiresolution",multiresSubdivide:"Subdivide",multiresReverse:"Reverse",multiresResolution:"Resolution",multiresNoLower:"There is no lower resolution level.",multiresNoHigher:"There is no higher resolution level.",multiresDelHigher:"Delete higher",multiresDelLower:"Delete lower",multiresSelectLowest:"Select the lowest resolution before reversing.",multiresSelectHighest:"Select the highest resolution before subdividing.",multiresWarnBigMesh:function(e){return"The next subdivision level will reach "+e+' faces.\nIf you know what you are doing, click again on "subdivide".'},multiresNotReversible:"Sorry it is not possile to reverse this mesh.\nThe mesh is not a product of a (loop-catmull) subdivision surface on a manifold mesh.",remeshTitle:"Voxel Remeshing",remeshRemesh:"Remesh",remeshResolution:"Resolution",remeshBlock:"Block",dynamicTitle:"Dynamic Topology",dynamicActivated:"Activated (no quads)",dynamicSubdivision:"Subdivision",dynamicDecimation:"Decimation",dynamicLinear:"Linear subdivision",sculptTitle:"Sculpting & Painting",sculptBrush:"Brush",sculptInflate:"Inflate",sculptTwist:"Twist",sculptSmooth:"Smooth (-Shift)",sculptFlatten:"Flatten",sculptPinch:"Pinch",sculptCrease:"Crease",sculptDrag:"Drag",sculptPaint:"Paint",sculptMasking:"Masking (-Ctrl)",sculptMove:"Move",sculptLocalScale:"Local scale",sculptTransform:"Transform (E)",sculptCommon:"Common",sculptTool:"Tool",sculptSymmetry:"Symmetry",sculptContinuous:"Continuous",sculptRadius:"Radius (-X)",sculptIntensity:"Intensity (-C)",sculptHardness:"Hardness",sculptCulling:"Thin surface (front vertex only)",sculptAlphaTitle:"Alpha",sculptLockPositon:"Lock position",sculptAlphaTex:"Texture",sculptImportAlpha:"Import alpha tex (jpg, png...)",sculptNegative:"Negative (N or -Alt)",sculptColor:"Albedo",sculptRoughness:"Roughness",sculptMetallic:"Metallic",sculptClay:"Clay",sculptAccumulate:"Accumulate (no limit per stroke)",sculptColorGlobal:"Global",sculptPickColor:"Material / Color picker (-S)",sculptTangentialSmoothing:"Relax only",sculptTopologicalCheck:"Topological check",sculptMoveAlongNormal:"Move along normal (N or -Alt)",sculptMaskingClear:"Clear (-Ctrl + Drag)",sculptMaskingInvert:"Invert (-Ctrl + Click)",sculptMaskingBlur:"Blur",sculptMaskingSharpen:"Sharpen",sculptPBRTitle:"PBR materials",sculptPaintAll:"Paint all",sculptExtractTitle:"Extract",sculptExtractThickness:"Thickness",sculptExtractAction:"Extract !",stateTitle:"History",stateUndo:"Undo",stateRedo:"Redo",stateMaxStack:"Max Stack",wacomTitle:"Wacom tablet",wacomRadius:"Pressure radius",wacomIntensity:"Pressure intensity",renderingTitle:"Rendering",renderingGrid:"Show grid",renderingSymmetryLine:"Show mirror line",renderingMatcap:"Matcap",renderingCurvature:"Curvature",renderingPBR:"PBR",renderingTransparency:"Transparency",renderingNormal:"Normal shader",renderingUV:"UV shader",renderingShader:"Shader",renderingMaterial:"Material",renderingImportUV:"Import (jpg, png...)",renderingImportMatcap:"Import (jpg, png...)",renderingExtra:"Extra",renderingFlat:"Flat shading",renderingWireframe:"Wireframe (W)",renderingExposure:"Exposure",renderingEnvironment:"Environment",renderingIsolate:"Isolate/Show (I)",renderingFilmic:"Filmic tonemapping",contour:"Contour",contourShow:"Show contour",contourColor:"Color",darkenUnselected:"Darken unselected",resolution:"Resolution",matcapPearl:"Pearl",matcapClay:"Clay",matcapSkin:"Skin",matcapGreen:"Green",matcapWhite:"White",sketchfabTitle:"Go to Sketchfab !",sketchfabUpload:"Upload",sketchfabUploadMessage:'Please enter your sketchfab API Key.\nYou can also leave "guest" to upload anonymously.\n(a new window will pop up when the uploading and processing is finished)',sketchfabUploadError:function(e){return"Sketchfab upload error :\n"+e},sketchfabUploadSuccess:"Upload success !\nHere is your link :",sketchfabAbort:"Abort the last upload ?",sketchfabUploadProcessing:"Processing...\nYour model will be available at :",about:"About & Help",alphaNone:"None",alphaSquare:"Square",alphaSkin:"Skin",envFootPrint:"Foot Print",envGlazedPatio:"Glazed Patio",envNicolausChurch:"St Nicolaus church",envTerrace:"Terrace",envBryantPark:"BryantPark"},C={backgroundTitle:"",backgroundReset:"",backgroundImport:" (jpg, png...)",backgroundFill:"",cameraTitle:"",cameraReset:"",cameraCenter:" ()",cameraFront:" (F)",cameraLeft:" (L)",cameraTop:" (T)",cameraMode:"",cameraOrbit:" ()",cameraSpherical:" ()",cameraPlane:" ()",cameraProjection:"",cameraPerspective:"",cameraOrthographic:"",cameraFov:"",cameraPivot:"",fileTitle:" (/)",fileImportTitle:"",fileAdd:" (obj, sgl, ply, stl)",fileAutoMatrix:null,fileVertexSRGB:null,fileExportMeshTitle:"",fileExportSceneTitle:"",fileExportSGL:" .sgl (SculptGL)",fileExportOBJ:" .obj",fileExportPLY:" .ply",fileExportSTL:" .stl",sceneTitle:"",sceneReset:"",sceneAddSphere:"",sceneAddCube:null,sceneAddCylinder:null,sceneAddTorus:null,sceneSelection:null,sceneMerge:null,meshTitle:"",meshNbVertices:" : ",meshNbFaces:" : ",topologyTitle:"",multiresTitle:"",multiresSubdivide:"",multiresReverse:"",multiresResolution:"",multiresNoLower:"",multiresNoHigher:"",multiresDelHigher:"",multiresDelLower:"",multiresSelectLowest:"",multiresSelectHighest:"",multiresWarnBigMesh:function(e){return" "+e+" \n"},multiresNotReversible:"\n (loop-catmull) ",remeshTitle:"",remeshRemesh:"",remeshResolution:"",remeshBlock:null,dynamicTitle:"",dynamicActivated:" ()",dynamicSubdivision:"",dynamicDecimation:"",dynamicLinear:"",sculptTitle:"",sculptBrush:"",sculptInflate:"",sculptTwist:"",sculptSmooth:" (-Shift)",sculptFlatten:"",sculptPinch:"",sculptCrease:"",sculptDrag:"",sculptPaint:"",sculptMasking:null,sculptMove:null,sculptLocalScale:null,sculptTransform:"   (E)",sculptCommon:null,sculptTool:"",sculptSymmetry:"",sculptContinuous:"",sculptRadius:" (-X)",sculptIntensity:" (-C)",sculptHardness:null,sculptCulling:" ()",sculptAlphaTitle:null,sculptLockPositon:null,sculptAlphaTex:null,sculptImportAlpha:null,sculptNegative:" (N or -Alt)",sculptColor:"",sculptRoughness:"",sculptMetallic:"",sculptClay:"",sculptAccumulate:" ()",sculptColorGlobal:"",sculptPickColor:" (-S)",sculptTangentialSmoothing:"",sculptTopologicalCheck:null,sculptMoveAlongNormal:null,sculptMaskingClear:null,sculptMaskingInvert:null,sculptMaskingBlur:null,sculptMaskingSharpen:null,sculptPBRTitle:null,sculptPaintAll:null,sculptExtractTitle:null,sculptExtractThickness:null,sculptExtractAction:null,stateTitle:"",stateUndo:"",stateRedo:"",stateMaxStack:"",wacomTitle:"Wacom ",wacomRadius:"",wacomIntensity:"",renderingTitle:"",renderingGrid:"",renderingSymmetryLine:null,renderingMatcap:null,renderingCurvature:null,renderingPBR:"(PBR)",renderingTransparency:"",renderingNormal:"",renderingUV:"UV ",renderingShader:"",renderingMaterial:"",renderingImportUV:" (jpg, png...)",renderingImportMatcap:" (jpg, png...)",renderingExtra:"",renderingFlat:" ()",renderingWireframe:" () (W)",renderingExposure:null,renderingEnvironment:null,renderingIsolate:null,renderingFilmic:null,contour:null,contourShow:null,contourColor:null,darkenUnselected:null,resolution:null,matcapPearl:"",matcapClay:"",matcapSkin:"",matcapGreen:"",matcapWhite:"",sketchfabTitle:" Sketchfab !",sketchfabUpload:"",sketchfabUploadMessage:' sketchfab API \n "guest" \n()',sketchfabUploadError:function(e){return"Sketchfab  :\n"+e},sketchfabUploadSuccess:" !\n :",sketchfabAbort:" ?",sketchfabUploadProcessing:null,about:null,alphaNone:null,alphaSquare:null,alphaSkin:null,envFootPrint:null,envGlazedPatio:null,envNicolausChurch:null,envTerrace:null,envBryantPark:null},N={backgroundTitle:"",backgroundReset:"",backgroundImport:"  (jpg, png...)",backgroundFill:null,cameraTitle:"",cameraReset:"View",cameraCenter:null,cameraFront:null,cameraLeft:null,cameraTop:null,cameraMode:"",cameraOrbit:null,cameraSpherical:" (Trackball)",cameraPlane:" (Trackball)",cameraProjection:"",cameraPerspective:"",cameraOrthographic:"",cameraFov:"",cameraPivot:"",fileTitle:" (/)",fileImportTitle:null,fileAdd:"Add (obj, sgl, ply, stl)",fileAutoMatrix:null,fileVertexSRGB:null,fileExportMeshTitle:null,fileExportSceneTitle:null,fileExportSGL:null,fileExportOBJ:null,fileExportPLY:null,fileExportSTL:null,sceneTitle:null,sceneReset:null,sceneAddSphere:null,sceneAddCube:null,sceneAddCylinder:null,sceneAddTorus:null,sceneSelection:null,sceneMerge:null,meshTitle:"",meshNbVertices:null,meshNbFaces:null,topologyTitle:null,multiresTitle:null,multiresSubdivide:null,multiresReverse:null,multiresResolution:null,multiresNoLower:null,multiresNoHigher:null,multiresDelHigher:null,multiresDelLower:null,multiresSelectLowest:null,multiresSelectHighest:null,multiresWarnBigMesh:null,multiresNotReversible:null,remeshTitle:null,remeshRemesh:null,remeshResolution:null,remeshBlock:null,dynamicTitle:null,dynamicActivated:null,dynamicSubdivision:null,dynamicDecimation:null,dynamicLinear:null,sculptTitle:null,sculptBrush:"",sculptInflate:"",sculptTwist:"",sculptSmooth:" (-Shift)",sculptFlatten:"",sculptPinch:"",sculptCrease:"",sculptDrag:"",sculptPaint:"",sculptMasking:null,sculptMove:null,sculptLocalScale:null,sculptTransform:null,sculptCommon:null,sculptTool:"",sculptSymmetry:"",sculptContinuous:"",sculptRadius:" (-X)",sculptIntensity:" (-C)",sculptHardness:null,sculptCulling:null,sculptAlphaTitle:null,sculptLockPositon:null,sculptAlphaTex:null,sculptImportAlpha:null,sculptNegative:" (N or -Alt)",sculptColor:null,sculptRoughness:null,sculptMetallic:null,sculptClay:"",sculptAccumulate:null,sculptColorGlobal:null,sculptPickColor:null,sculptTangentialSmoothing:null,sculptTopologicalCheck:null,sculptMoveAlongNormal:null,sculptMaskingClear:null,sculptMaskingInvert:null,sculptMaskingBlur:null,sculptMaskingSharpen:null,sculptPBRTitle:null,sculptPaintAll:null,sculptExtractTitle:null,sculptExtractThickness:null,sculptExtractAction:null,stateTitle:"",stateUndo:"",stateRedo:"",stateMaxStack:null,wacomTitle:"",wacomRadius:"",wacomIntensity:"",renderingTitle:null,renderingGrid:null,renderingSymmetryLine:null,renderingMatcap:null,renderingCurvature:null,renderingPBR:null,renderingTransparency:"",renderingNormal:"",renderingUV:null,renderingShader:"",renderingMaterial:null,renderingImportUV:null,renderingImportMatcap:null,renderingExtra:null,renderingFlat:"",renderingWireframe:" (W)",renderingExposure:null,renderingEnvironment:null,renderingIsolate:null,renderingFilmic:null,contour:null,contourShow:null,contourColor:null,darkenUnselected:null,resolution:null,matcapPearl:null,matcapClay:"",matcapSkin:"",matcapGreen:null,matcapWhite:null,sketchfabTitle:"Sketchfab",sketchfabUpload:"",sketchfabUploadMessage:null,sketchfabUploadError:null,sketchfabUploadSuccess:null,sketchfabAbort:null,sketchfabUploadProcessing:null,about:null,alphaNone:null,alphaSquare:null,alphaSkin:null,envFootPrint:null,envGlazedPatio:null,envNicolausChurch:null,envTerrace:null,envBryantPark:null},V={backgroundTitle:"",backgroundReset:"",backgroundImport:" (jpg, png...)",backgroundFill:"",cameraTitle:"",cameraReset:"",cameraCenter:" (bar)",cameraFront:" (F)",cameraLeft:" (L)",cameraTop:" (T)",cameraMode:"",cameraOrbit:" (Turntable)",cameraSpherical:" (Trackball)",cameraPlane:" (Trackball)",cameraProjection:"",cameraPerspective:"",cameraOrthographic:"",cameraFov:"",cameraPivot:" ",fileTitle:" (/)",fileImportTitle:"",fileAdd:" (obj, sgl, ply, stl)",fileAutoMatrix:null,fileVertexSRGB:null,fileExportMeshTitle:" ",fileExportSceneTitle:" ",fileExportSGL:"sgl ",fileExportOBJ:"obj ",fileExportPLY:"ply ",fileExportSTL:"stl ",sceneTitle:"",sceneReset:" ",sceneAddSphere:"  ",sceneAddCube:null,sceneAddCylinder:null,sceneAddTorus:null,sceneSelection:null,sceneMerge:null,meshTitle:"",meshNbVertices:" : ",meshNbFaces:" : ",topologyTitle:"",multiresTitle:" ",multiresSubdivide:"",multiresReverse:"",multiresResolution:"",multiresNoLower:"    .",multiresNoHigher:"    .",multiresDelHigher:"   ",multiresDelLower:"   ",multiresSelectLowest:"      .",multiresSelectHighest:"      ",multiresWarnBigMesh:function(e){return"   "+e+'   .\n     ""  .'},multiresNotReversible:"    .\n      product  .(loop-catmull)",remeshTitle:null,remeshRemesh:null,remeshResolution:null,remeshBlock:null,dynamicTitle:null,dynamicActivated:null,dynamicSubdivision:null,dynamicDecimation:null,dynamicLinear:null,sculptTitle:null,sculptBrush:"",sculptInflate:null,sculptTwist:null,sculptSmooth:null,sculptFlatten:null,sculptPinch:null,sculptCrease:null,sculptDrag:null,sculptPaint:null,sculptMasking:null,sculptMove:null,sculptLocalScale:null,sculptTransform:null,sculptCommon:null,sculptTool:null,sculptSymmetry:null,sculptContinuous:null,sculptRadius:null,sculptIntensity:null,sculptHardness:null,sculptCulling:null,sculptAlphaTitle:null,sculptLockPositon:null,sculptAlphaTex:null,sculptImportAlpha:null,sculptNegative:null,sculptColor:null,sculptRoughness:null,sculptMetallic:null,sculptClay:null,sculptAccumulate:null,sculptColorGlobal:null,sculptPickColor:null,sculptTangentialSmoothing:null,sculptTopologicalCheck:null,sculptMoveAlongNormal:null,sculptMaskingClear:null,sculptMaskingInvert:null,sculptMaskingBlur:null,sculptMaskingSharpen:null,sculptPBRTitle:null,sculptPaintAll:null,sculptExtractTitle:null,sculptExtractThickness:null,sculptExtractAction:null,stateTitle:"",stateUndo:"",stateRedo:"",stateMaxStack:" ",wacomTitle:" ",wacomRadius:" ",wacomIntensity:" ",renderingTitle:"",renderingGrid:" ",renderingSymmetryLine:" ",renderingMatcap:null,renderingCurvature:null,renderingPBR:null,renderingTransparency:"",renderingNormal:" ",renderingUV:"UV ",renderingShader:"",renderingMaterial:"",renderingImportUV:" (jpg, png...)",renderingImportMatcap:" (jpg, png...)",renderingExtra:"",renderingFlat:" ()",renderingWireframe:" () (W)",renderingExposure:null,renderingEnvironment:null,renderingIsolate:null,renderingFilmic:null,contour:null,contourShow:null,contourColor:null,darkenUnselected:null,resolution:null,matcapPearl:null,matcapClay:null,matcapSkin:null,matcapGreen:null,matcapWhite:null,sketchfabTitle:"Sketchfab  !",sketchfabUpload:"",sketchfabUploadMessage:null,sketchfabUploadError:null,sketchfabUploadSuccess:null,sketchfabAbort:null,sketchfabUploadProcessing:null,about:null,alphaNone:null,alphaSquare:null,alphaSkin:null,envFootPrint:null,envGlazedPatio:null,envNicolausChurch:null,envTerrace:null,envBryantPark:null},P={backgroundTitle:"",backgroundReset:"",backgroundImport:" (jpg, png...)",backgroundFill:"",cameraTitle:"",cameraReset:"",cameraCenter:" (bar)",cameraFront:" (F)",cameraLeft:" (L)",cameraTop:" (T)",cameraMode:" ",cameraOrbit:" ()",cameraSpherical:" ()",cameraPlane:" ()",cameraProjection:"",cameraPerspective:"",cameraOrthographic:"",cameraFov:" ",cameraPivot:" ",fileTitle:"",fileImportTitle:"",fileAdd:"(obj,sgl,ply,stl)",fileAutoMatrix:"-",fileVertexSRGB:"  sRGB",fileExportMeshTitle:" ",fileExportSceneTitle:" ",fileExportSGL:" .sgl",fileExportOBJ:" .obj",fileExportPLY:" .ply",fileExportSTL:" .stl",sceneTitle:"",sceneReset:" ",sceneAddSphere:" ",sceneAddCube:" ",sceneAddCylinder:" ",sceneAddTorus:" ",sceneSelection:"",sceneMerge:"",meshTitle:"",meshNbVertices:" : ",meshNbFaces:" : ",topologyTitle:"",multiresTitle:"",multiresSubdivide:"",multiresReverse:"",multiresResolution:"",multiresNoLower:"   .",multiresNoHigher:"   .",multiresDelHigher:" ",multiresDelLower:" ",multiresSelectLowest:"   .",multiresSelectHighest:"   .",multiresWarnBigMesh:function(e){return"  "+e+' faces.\n  ,    "".'},multiresNotReversible:"    ,    .\n  .",remeshTitle:" ",remeshRemesh:"",remeshResolution:"",remeshBlock:"-",dynamicTitle:" ",dynamicActivated:" ( )",dynamicSubdivision:"",dynamicDecimation:"",dynamicLinear:" ",sculptTitle:"  ",sculptBrush:"3D ",sculptInflate:"3D ",sculptTwist:"3D ",sculptSmooth:"3D  (-Shift)",sculptFlatten:"3D ",sculptPinch:"3D ",sculptCrease:"3D ",sculptDrag:"3D ",sculptMove:"3D ",sculptLocalScale:"3D ",sculptPaint:"2D ",sculptMasking:"2D  (-Ctrl)",sculptTransform:"",sculptCommon:"",sculptTool:"",sculptSymmetry:"",sculptContinuous:"",sculptRadius:" (-X)",sculptIntensity:" (-C)",sculptHardness:"",sculptCulling:" ( )",sculptAlphaTitle:"",sculptLockPositon:"",sculptAlphaTex:"",sculptImportAlpha:"   (jpg, png...)",sculptNegative:" (N  -Alt)",sculptColor:"",sculptRoughness:"",sculptMetallic:"",sculptClay:"  ",sculptAccumulate:"  ",sculptColorGlobal:"",sculptPickColor:"  (-S)",sculptTangentialSmoothing:"  ",sculptTopologicalCheck:" ",sculptMoveAlongNormal:"  ",sculptMaskingClear:" (-Ctrl + Drag)",sculptMaskingInvert:" (-Ctrl + Click)",sculptMaskingBlur:"",sculptMaskingSharpen:"",sculptPBRTitle:"PBR ",sculptPaintAll:"",sculptExtractTitle:"",sculptExtractThickness:"",sculptExtractAction:"!",stateTitle:"",stateUndo:"",stateRedo:"",stateMaxStack:" ",wacomTitle:" Wacom",wacomRadius:"-",wacomIntensity:"-",renderingTitle:"",renderingGrid:" ",renderingSymmetryLine:" ",renderingMatcap:null,renderingCurvature:"",renderingPBR:"PBR",renderingTransparency:"",renderingNormal:" ",renderingUV:"UV",renderingShader:"",renderingMaterial:"",renderingImportUV:" (jpg, png...)",renderingImportMatcap:" (jpg, png...)",renderingExtra:"",renderingFlat:"",renderingWireframe:" (W)",renderingExposure:"",renderingEnvironment:"",renderingIsolate:" /  (I)",renderingFilmic:"",contour:"",contourShow:" ",contourColor:"",darkenUnselected:" ",resolution:"",matcapPearl:"",matcapClay:"",matcapSkin:"",matcapGreen:"",matcapWhite:"",sketchfabTitle:" Sketchfab.com ",sketchfabUpload:"",sketchfabUploadMessage:" API- sketchfab.\n  guest,    .\n(       )",sketchfabUploadError:function(e){return"   Sketchfab :\n"+e},sketchfabUploadSuccess:"  !\n :",sketchfabAbort:" ?",sketchfabUploadProcessing:"...\n    :",about:" ",alphaNone:"",alphaSquare:"",alphaSkin:"",envFootPrint:"  ",envGlazedPatio:" ",envNicolausChurch:"  ",envTerrace:"",envBryantPark:"-"},L={backgroundTitle:"Arka plan",backgroundReset:"Temizle",backgroundImport:"e Aktar (jpg, png...)",backgroundFill:"Doldur",cameraTitle:"Kamera",cameraReset:"Grnm",cameraCenter:"Temizle (boluk)",cameraFront:"n (F)",cameraLeft:"Sol (L)",cameraTop:"st (T)",cameraMode:"Mod",cameraOrbit:"Eksen (Dner Tabla)",cameraSpherical:"Kresel (Trackball)",cameraPlane:"Dzlem (Trackball)",cameraProjection:"z Dm",cameraPerspective:"Perspektif",cameraOrthographic:"Orthografik",cameraFov:"Gr Alan",cameraPivot:"Eksen",fileTitle:"Dosyalar (ieri/dar)",fileImportTitle:"e Aktar",fileAdd:"Aktar (obj, sgl, ply, stl)",fileAutoMatrix:"lekle ve ortala",fileVertexSRGB:"sRGB verteks renk",fileExportMeshTitle:"Nesneyi Da Aktar",fileExportSceneTitle:"Sahneyi Da Aktar",fileExportSGL:"Kaydet .sgl (SculptGL)",fileExportOBJ:"Kaydet .obj",fileExportPLY:"Kaydet .ply",fileExportSTL:"Kaydet .stl",sceneTitle:"Sahne",sceneReset:"Sahneyi temizle",sceneAddSphere:"Kre ekle",sceneAddCube:"Kp ekle",sceneAddCylinder:"Silindir ekle",sceneAddTorus:"Halka ekle",sceneSelection:"Seim",sceneMerge:"Seimi birletir",meshTitle:"Nesne",meshNbVertices:"Verteks : ",meshNbFaces:"Cephe : ",topologyTitle:"Topoloji",multiresTitle:"oklu znrlk",multiresSubdivide:"Bl",multiresReverse:"Ters",multiresResolution:"znrlk",multiresNoLower:"Daha dk znrlk yok.",multiresNoHigher:"Daha yksek znrlk yok.",multiresDelHigher:"st znrl sil",multiresDelLower:"Alt znrl sil",multiresSelectLowest:"Tersine evirmeden nce en dk znrl se.",multiresSelectHighest:"Tesine evirmeden nce en yksek znrl se.",multiresWarnBigMesh:function(e){return"Sonraki znrlk "+e+' cepheden oluacak.\nEer devam etmek istiyorsanz, tekrar "bl" butonuna basn.'},multiresNotReversible:"Malesef bu nesneyi tersine evirmek mmkn deil.\nThe mesh is not a product of a (loop-catmull) subdivision surface on a manifold mesh.",remeshTitle:"Voksel Remeshing",remeshRemesh:"Remesh",remeshResolution:"znrlk",remeshBlock:"Engelle",dynamicTitle:"Dinamik Topoloji",dynamicActivated:"Aktifletirildi (no quads)",dynamicSubdivision:"Altblm",dynamicDecimation:"stblm",dynamicLinear:"Dorusal altblm",sculptTitle:"Oyma & Boyama",sculptBrush:"Fra",sculptInflate:"iir",sculptTwist:"Bklme",sculptSmooth:"Yumuat (-Shift)",sculptFlatten:"Dzletir",sculptPinch:"imdik",sculptCrease:"Kvrm",sculptDrag:"Srkle",sculptPaint:"Boya",sculptMasking:"Maskeleme (-Ctrl)",sculptMove:"Ta",sculptLocalScale:"Yerel lek",sculptTransform:"Transform (E)",sculptCommon:"Genel",sculptTool:"Ara",sculptSymmetry:"Simetri",sculptContinuous:"Srekli",sculptRadius:"Yara (-X)",sculptIntensity:"Younluk (-C)",sculptHardness:"Sertlik",sculptCulling:"nce yzey (front vertex only)",sculptAlphaTitle:"Alfa",sculptLockPositon:"Pozisyonu kilitle",sculptAlphaTex:"Kaplama",sculptImportAlpha:"Alfa kaplama ykle (jpg, png...)",sculptNegative:"Negatif (N or -Alt)",sculptColor:"Aklk",sculptRoughness:"Przllk",sculptMetallic:"Metalik",sculptClay:"Kil",sculptAccumulate:"Biriktir (limitsiz)",sculptColorGlobal:"Evrensel",sculptPickColor:"Materyal / Renk seici (-S)",sculptTangentialSmoothing:"Rahatlat",sculptTopologicalCheck:"Topoloji kontrol",sculptMoveAlongNormal:"Normal boyunca ta (N or -Alt)",sculptMaskingClear:"Temizle (-Ctrl + Drag)",sculptMaskingInvert:"Tersine evir (-Ctrl + Click)",sculptMaskingBlur:"Bulanklatr",sculptMaskingSharpen:"Keskinletir",sculptPBRTitle:"PBR materyali",sculptPaintAll:"Tmn boya",sculptExtractTitle:"kar",sculptExtractThickness:"Kalnlk",sculptExtractAction:"kar !",stateTitle:"Gemi",stateUndo:"Geri Al",stateRedo:"leri Al",stateMaxStack:"Maksimum Yn",wacomTitle:"Wacom tablet",wacomRadius:"Basn ap",wacomIntensity:"Basn hassasiyeti",renderingTitle:"Sahneleme",renderingGrid:"Izgaray gster",renderingSymmetryLine:"aynalama izgisini gster",renderingMatcap:"Matcap",renderingCurvature:"Erilik",renderingPBR:"PBR",renderingTransparency:"Transparanlk",renderingNormal:"Normal shader",renderingUV:"UV shader",renderingShader:"Shader",renderingMaterial:"Materyal",renderingImportUV:"e AKtar (jpg, png...)",renderingImportMatcap:"e AKtar (jpg, png...)",renderingExtra:"Ekstra",renderingFlat:"Dz glgeleme",renderingWireframe:"Tel kafes (W)",renderingExposure:"Teir",renderingEnvironment:"Ortam",renderingIsolate:"zole/Gster (I)",renderingFilmic:"Film Ton Elemesi",contour:"Kontr",contourShow:"Kontr gster",contourColor:"Renk",darkenUnselected:"Seilmeyenleri koyu yap",resolution:"znrlk",matcapPearl:"nci",matcapClay:"Kil",matcapSkin:"Deri",matcapGreen:"Yeil",matcapWhite:"Beyaz",sketchfabTitle:"Sketchfab'a git !",sketchfabUpload:"Ykle",sketchfabUploadMessage:'Ltfen sketchfab entegrasyon anahtarn giriniz.\nAnonim olarak kullanmak iin "guest" olarak braknz.\n(leme ve ykleme tamamlandnda yeni bir pencere alacak)',sketchfabUploadError:function(e){return"Sketchfab ykleme hatas :\n"+e},sketchfabUploadSuccess:"Ykleme baarl !\nAdresiniz burada :",sketchfabAbort:"Son yklemeyi iptal et ?",sketchfabUploadProcessing:"Hesaplanyor...\nModeliniz u adreste olacak :",about:"Hakknda & Yardm",alphaNone:"Hi Biri",alphaSquare:"Kare",alphaSkin:"Deri",envFootPrint:"Foot Print",envGlazedPatio:"Glazed Patio",envNicolausChurch:"St Nicolaus church",envTerrace:"Terrace",envBryantPark:"BryantPark"},U={backgroundTitle:"Bakgrund",backgroundReset:"terstll",backgroundImport:"Importera (jpg, png...)",backgroundFill:"Fyll",cameraTitle:"Kamera",cameraReset:"Vy",cameraCenter:"terstll (bar)",cameraFront:"Fram (F)",cameraLeft:"Vnster (L)",cameraTop:"ver (T)",cameraMode:"Lge",cameraOrbit:"Omloppsbana (skivtallrik)",cameraSpherical:"Sfrisk (trackball)",cameraPlane:"Plan (trackball)",cameraProjection:"Projektion",cameraPerspective:"Perspektiv",cameraOrthographic:"Ortografisk",cameraFov:"Fov",cameraPivot:"Plocka pivot",fileTitle:"Filer (import/export)",fileImportTitle:"Importera",fileAdd:"Lgg till (obj, sgl, ply, stl)",fileAutoMatrix:"Skala och centrera",fileVertexSRGB:"sRGB vertexfrg",fileExportMeshTitle:"Exportera Mesh",fileExportSceneTitle:"Exportera Scen",fileExportSGL:"Spara .sgl (SculptGL)",fileExportOBJ:"Spara .obj",fileExportPLY:"Spara .ply",fileExportSTL:"Spara .stl",sceneTitle:"Scen",sceneReset:"Rensa scen",sceneAddSphere:"Lgg till sfr",sceneAddCube:"Lgg till kub",sceneAddCylinder:"Lgg till cylinder",sceneAddTorus:"Lgg till torus",sceneSelection:"Urval",sceneMerge:"Sammanfoga urval",meshTitle:"Mesh",meshNbVertices:"Vertex : ",meshNbFaces:"Faces : ",topologyTitle:"Topologi",multiresTitle:"Upplsningar",multiresSubdivide:"Dela upp yta",multiresReverse:"Omvnd",multiresResolution:"Upplsning",multiresNoLower:"Det finns ingen lgre upplsningsniv.",multiresNoHigher:"Det finns ingen hgre upplsningsniv.",multiresDelHigher:"Ta bort hgre",multiresDelLower:"Ta bort lgre",multiresSelectLowest:"Vlj den lgsta upplsningen innan omvndning.",multiresSelectHighest:"Vlj den hgsta upplsningen innan uppdelning.",multiresWarnBigMesh:function(e){return"Nsta underavdelning niv kommer att ha "+e+' faces.\nOm du vet vad du gr, klicka igen p "dela upp yta".'},multiresNotReversible:"Tyvrr, det gr inte att omvnda denna mesh.\nMeshen r inte en produkt av en (loop-calmull) mngfaldsytindelning.",remeshTitle:"Voxel Meshombyggnation",remeshRemesh:"Bygg om mesh",remeshResolution:"Upplsning",remeshBlock:"Kuber",dynamicTitle:"Dynamisk Topologi",dynamicActivated:"Aktiverad (inga quads)",dynamicSubdivision:"Ytindelning",dynamicDecimation:"Decimering",dynamicLinear:"Linjr ytindelning",sculptTitle:"Skulptering & Mleri",sculptBrush:"Pensel",sculptInflate:"Bls upp",sculptTwist:"Tvista",sculptSmooth:"Jmna ut (-Shift)",sculptFlatten:"Platta till",sculptPinch:"Nyp",sculptCrease:"Vecka",sculptDrag:"Dra",sculptPaint:"Mla",sculptMasking:"Maskera (-Ctrl)",sculptMove:"Flytta",sculptLocalScale:"Skala lokalt",sculptTransform:"Transformera (E)",sculptCommon:"Generellt",sculptTool:"Verktyg",sculptSymmetry:"Symmetri",sculptContinuous:"Kontinuerlig",sculptRadius:"Radie (-X)",sculptIntensity:"Intensitet (-C)",sculptHardness:"Hrdhet",sculptCulling:"Tunn yta (endast frmre vertex)",sculptAlphaTitle:"Alfa",sculptLockPositon:"Ls position",sculptAlphaTex:"Textur",sculptImportAlpha:"Importera alfatextur (jpg, png...)",sculptNegative:"Negativ (N or -Alt)",sculptColor:"Albedo",sculptRoughness:"Ytjmnhet",sculptMetallic:"Metallisk",sculptClay:"Lera",sculptAccumulate:"Ackumulera (ingen grns per strykning)",sculptColorGlobal:"Global",sculptPickColor:"Material / Frgvlgare (-S)",sculptTangentialSmoothing:"Tangentiell utjmning",sculptTopologicalCheck:"Topologisk check",sculptMoveAlongNormal:"Flytta lngsmed normal (N or -Alt)",sculptMaskingClear:"Rensa (-Ctrl + Drag)",sculptMaskingInvert:"Invertera (-Ctrl + Click)",sculptMaskingBlur:"Gr suddig",sculptMaskingSharpen:"Gr skarp",sculptPBRTitle:"PBR-material",sculptPaintAll:"Mla allt",sculptExtractTitle:"Extrahera",sculptExtractThickness:"Tjocklek",sculptExtractAction:"Extrahera!",stateTitle:"Historia",stateUndo:"ngra",stateRedo:"Gr om",stateMaxStack:"gra antal steg",wacomTitle:"Wacomplatta",wacomRadius:"Tryckradie",wacomIntensity:"Tryckintensitet",renderingTitle:"Rendering",renderingGrid:"Visa rutnt",renderingSymmetryLine:"Visa speglingslinje",renderingMatcap:"MatCap",renderingCurvature:"Kurvatur",renderingPBR:"PBR",renderingTransparency:"Genomskinlighet",renderingNormal:"Normal shader",renderingUV:"UV-shader",renderingShader:"Shader",renderingMaterial:"Material",renderingImportUV:"Importera (jpg, png...)",renderingImportMatcap:"Importera (jpg, png...)",renderingExtra:"Extra",renderingFlat:"Platt shading",renderingWireframe:"Wireframe (W)",renderingExposure:"Exponering",renderingEnvironment:"Milj",renderingIsolate:"Isolera/Visa (I)",renderingFilmic:"Filmiska frgtoner",contour:"Kontur",contourShow:"Visa kontur",contourColor:"Frg",darkenUnselected:"Skym ej valda",resolution:"Upplsning",matcapPearl:"Prla",matcapClay:"Lera",matcapSkin:"Hud",matcapGreen:"Grn",matcapWhite:"Vit",sketchfabTitle:"G till Sketchfab!",sketchfabUpload:"Ladda upp",sketchfabUploadMessage:'Vnligen fyll i din sketchfab API-nyckel.\nDu kan ven ange "guest" fr att ladda upp anonymt.\n(ett nytt fnster kommer att ppnas nr uppladdning och bearbetning r klar)',
sketchfabUploadError:function(e){return"Sketchfab uppladdningsfel:\n"+e},sketchfabUploadSuccess:"Uppladdning lyckades!\nHr r din lnk:",sketchfabAbort:"Avbryta senaste uppladdningen?",sketchfabUploadProcessing:"Bearbetar...\nDin modell kommer bli tillgnglig hr:",about:"Om & Hjlp",alphaNone:"Ingen",alphaSquare:"Fyrkant",alphaSkin:"Hud",envFootPrint:"Fotavtryck",envGlazedPatio:"Inglasad uteplats",envNicolausChurch:"S:t Nikolauskyrkan",envTerrace:"Terrass",envBryantPark:"Bryant Park"},B=function e(t){var r=e.languages[e.select][t]||e.languages.english[t];return"string"==typeof r?r:"function"==typeof r?r.apply(this,Array.prototype.slice.call(arguments,1)):(console.error("No TR found for : "+t),t)};B.languages={english:I,"":N,"":C,"":V,"":P,turkish:L,svenska:U},B.select="english";var O=window.navigator.language||window.navigator.userLanguage;switch(O&&(O=O.substr(0,2)),"ja"===O?B.select="":"zh"===O?B.select="":"ko"===O?B.select="":"tr"===O?B.select="turkish":"sv"===O&&(B.select="svenska"),_().language){case"english":B.select="english";break;case"chinese":B.select="";break;case"korean":B.select="";break;case"japanese":B.select="";break;case"russian":B.select="";break;case"turkish":B.select="turkish";break;case"swedish":B.select="svenska"}var G=i.mat3,z=R.getCopy();z.vertexName=z.fragmentName="ShadingPBR",z.textures={};var X="resources/environments/";z.environments=[{path:X+"footPrint.bin",sph:[.96097,.856821,1.11124,-.313999,-.358144,-.625599,.0870941,.1109,.171528,-.100569,-.0498991,-.0302566,.02047,.0151743,.0182682,-.00652953,-.0188746,-.0525354,.00192821,-.0279455,-.110808,-.0180287,-.0227345,-.0422744,.0139192,-.0187345,-.0812033],name:B("envFootPrint")},{path:X+"glazedPatio.bin",sph:[.475424,.460106,.407626,-.0626622,-.0978501,-.148369,-.029662,-.022522,-.0109794,-.0893952,-.116715,-.139033,.0450059,.0514445,.0619667,.00471057,.00393219,.00522881,-.0508041,-.0540791,-.0530655,-.0278953,-.0258599,-.0191718,-.0137735,-.0186312,-.0286948],name:B("envGlazedPatio")},{path:X+"nicolausChurch.bin",sph:[1.67609,1.52776,1.05807,-.261794,-.293249,-.225056,.0371792,.0263728,-.0174064,.142577,.121132,.0724402,.00827981,.00263222,.00184229,.0208164,.0128967,.0139606,.0795516,.0909961,.0897778,.058084,.0541786,.0401144,-.0664757,-.0587091,-.0386655],name:B("envNicolausChurch")},{path:X+"terrace.bin",sph:[.688602,.636799,.515733,-.192892,-.219448,-.242244,.126328,.124547,.0928089,.308754,.307826,.214901,-.0713295,-.0740211,-.0583892,-.0283229,-.0290954,-.0224256,-.030012,-.0302393,-.0280645,.0766113,.0653549,.0388244,.104034,.0751443,.0221583],name:B("envTerrace")},{path:X+"bryantPark.bin",sph:[.583073,.794556,.966801,-.218899,-.334516,-.690954,-.0581536,-.0912214,-.13112,.0180201,.0683966,.157536,-.0427475,-.073612,-.112892,.0490024,.06527,.0841072,-.0243839,-.0429701,-.0792229,-.0441213,-.0562622,-.0728875,-.0267015,-.0586719,-.11978],name:B("envBryantPark")}];var W=_();z.idEnv=Math.min(W.environment,z.environments.length-1),z.exposure=Math.min(W.exposure,5),z.uniforms={},z.attributes={},z.uniformNames=["uIblTransform","uTexture0","uAlbedo","uRoughness","uMetallic","uExposure","uSPH"],Array.prototype.push.apply(z.uniformNames,R.uniformNames.commonUniforms),z.vertex=["precision mediump float;","attribute vec3 aVertex;","attribute vec3 aNormal;","attribute vec3 aColor;","attribute vec3 aMaterial;",R.strings.vertUniforms,"uniform float uRoughness;","uniform float uMetallic;","uniform vec3 uAlbedo;","varying vec3 vVertex;","varying vec3 vNormal;","varying vec3 vAlbedo;","varying float vRoughness;","varying float vMetallic;","varying float vMasking;","void main() {","  vAlbedo = uAlbedo.x >= 0.0 ? uAlbedo : aColor;","  vRoughness = uRoughness >= 0.0 ? uRoughness : aMaterial.x;","  vMetallic = uMetallic >= 0.0 ? uMetallic : aMaterial.y;","  vMasking = aMaterial.z;","  vNormal = mix(aNormal, uEN * aNormal, vMasking);","  vNormal = normalize(uN * vNormal);","  vec4 vertex4 = vec4(aVertex, 1.0);","  vertex4 = mix(vertex4, uEM * vertex4, vMasking);","  vVertex = vec3(uMV * vertex4);","  gl_Position = uMVP * vertex4;","}"].join("\n"),z.fragment=["precision mediump float;","varying vec3 vVertex;","varying vec3 vNormal;","varying vec3 vAlbedo;","varying float vRoughness;","varying float vMetallic;","uniform float uAlpha;","uniform vec3 uSPH[9];",R.strings.fragColorUniforms,R.strings.fragColorFunction,D,"","void main(void) {","  vec3 normal = getNormal();","  float roughness = max( 0.0001, vRoughness );","  vec3 linColor = sRGBToLinear(vAlbedo);","  vec3 albedo = linColor * (1.0 - vMetallic);","  vec3 specular = mix( vec3(0.04), linColor, vMetallic);","","  vec3 color = uExposure * computeIBL_UE4( normal, -normalize(vVertex), albedo, roughness, specular );","  gl_FragColor = encodeFragColor(color, uAlpha);","}"].join("\n"),z.onLoadEnvironment=function(e,t,r,i){(200===e.status||e.response&&e.response.byteLength)&&(i.texture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,i.texture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,1024,1024,0,t.RGBA,t.UNSIGNED_BYTE,new Uint8Array(e.response)),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.bindTexture(t.TEXTURE_2D,null),r&&r.render())},z.getOrCreateEnvironment=function(e,t,r){if(void 0!==r.texture)return r.texture;r.texture=null;var i=new XMLHttpRequest;return i.open("GET",r.path,!0),i.responseType="arraybuffer",i.onload=z.onLoadEnvironment.bind(this,i,e,t,r),i.send(null),null},z.getOrCreateSPH=function(e){if(e.sphCoef)return e.sphCoef;for(var t=1/(2*Math.sqrt(Math.PI)),r=-(.5*Math.sqrt(3/Math.PI)),i=-r,a=r,n=.5*Math.sqrt(15/Math.PI),s=-n,o=.25*Math.sqrt(5/Math.PI),l=s,u=.25*Math.sqrt(15/Math.PI),h=[t,t,t,r,r,r,i,i,i,a,a,a,n,n,n,s,s,s,o,o,o,l,l,l,u,u,u],c=e.sphCoef=new Float32Array(27),d=e.sph,g=0;g<27;++g)c[g]=d[g]*h[g];return c};var Y=G.create();z.updateUniforms=function(e,t){var r=e.getGL(),i=this.uniforms;G.fromMat4(Y,t.getCamera().getView()),r.uniformMatrix3fv(i.uIblTransform,!1,G.transpose(Y,Y)),r.uniform3fv(i.uAlbedo,e.getAlbedo()),r.uniform1f(i.uRoughness,e.getRoughness()),r.uniform1f(i.uMetallic,e.getMetallic()),r.uniform1f(i.uExposure,z.exposure);var a=z.environments[z.idEnv];r.uniform3fv(i.uSPH,z.getOrCreateSPH(a)),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,z.getOrCreateEnvironment(r,t,a)||this.getDummyTexture(r)),r.uniform1i(i.uTexture0,0),R.updateUniforms.call(this,e,t)};var H=R.getCopy();H.vertexName=H.fragmentName="Matcap",H.textures={},H.createTexture=function(e,t,r){var i=e.createTexture();e.bindTexture(e.TEXTURE_2D,i),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),H.setTextureParameters(e,t),e.bindTexture(e.TEXTURE_2D,null),H.textures[r]=i};var j="resources/matcaps/";H.matcaps=[{path:j+"matcapFV.jpg",name:"matcap FV"},{path:j+"redClay.jpg",name:"Red clay"},{path:j+"skinHazardousarts.jpg",name:"Skin hazardousarts"},{path:j+"skinHazardousarts2.jpg",name:"Skin Hazardousarts2"},{path:j+"pearl.jpg",name:B("matcapPearl")},{path:j+"clay.jpg",name:B("matcapClay")},{path:j+"skin.jpg",name:B("matcapSkin")},{path:j+"green.jpg",name:B("matcapGreen")},{path:j+"white.jpg",name:B("matcapWhite")}],H.uniforms={},H.attributes={},H.uniformNames=["uTexture0","uAlbedo"],Array.prototype.push.apply(H.uniformNames,R.uniformNames.commonUniforms),H.vertex=["precision mediump float;","attribute vec3 aVertex;","attribute vec3 aNormal;","attribute vec3 aColor;","attribute vec3 aMaterial;",R.strings.vertUniforms,"varying vec3 vVertex;","varying vec3 vNormal;","varying vec3 vColor;","varying float vMasking;","varying vec3 vVertexPres;","uniform vec3 uAlbedo;","void main() {","  vColor = uAlbedo.x >= 0.0 ? uAlbedo : aColor;","  vMasking = aMaterial.z;","  vNormal = mix(aNormal, uEN * aNormal, vMasking);","  vNormal = normalize(uN * vNormal);","  vec4 vertex4 = vec4(aVertex, 1.0);","  vertex4 = mix(vertex4, uEM * vertex4, vMasking);","  vVertex = vec3(uMV * vertex4);","  vVertexPres = vVertex / max(1.0, abs(uMV[3][2]));","  gl_Position = uMVP * vertex4;","}"].join("\n"),H.fragment=["precision mediump float;","uniform sampler2D uTexture0;","varying vec3 vVertex;","varying vec3 vVertexPres;","varying vec3 vNormal;","varying vec3 vColor;","uniform float uAlpha;",R.strings.fragColorUniforms,R.strings.fragColorFunction,"void main() {","  vec3 normal = getNormal();","  vec3 nm_z = normalize(vVertexPres);","  vec3 nm_x = vec3(-nm_z.z, 0.0, nm_z.x);","  vec3 nm_y = cross(nm_x, nm_z);","  vec2 texCoord = 0.5 + 0.5 * vec2(dot(normal, nm_x), dot(normal, nm_y));","  vec3 color = sRGBToLinear(texture2D(uTexture0, texCoord).rgb) * sRGBToLinear(vColor);","  gl_FragColor = encodeFragColor(color, uAlpha);","}"].join("\n"),H.updateUniforms=function(e,t){var r=e.getGL(),i=this.uniforms;r.activeTexture(r.TEXTURE0),e.setTexture0(H.textures[e.getMatcap()]),r.bindTexture(r.TEXTURE_2D,e.getTexture0()||this.getDummyTexture(r)),r.uniform1i(i.uTexture0,0),r.uniform3fv(i.uAlbedo,e.getAlbedo()),R.updateUniforms.call(this,e,t)};var q=R.getCopy();q.vertexName=q.fragmentName="ShowNormal",q.uniforms={},q.attributes={},q.activeAttributes={vertex:!0,normal:!0,material:!0},q.uniformNames=[],Array.prototype.push.apply(q.uniformNames,R.uniformNames.commonUniforms),q.vertex=["precision mediump float;","attribute vec3 aVertex;","attribute vec3 aNormal;","attribute vec3 aMaterial;",R.strings.vertUniforms,"varying vec3 vVertex;","varying vec3 vNormal;","varying float vMasking;","void main() {","  vMasking = aMaterial.z;","  vNormal = mix(aNormal, uEN * aNormal, vMasking);","  vNormal = normalize(uN * vNormal);","  vec4 vertex4 = vec4(aVertex, 1.0);","  vertex4 = mix(vertex4, uEM *vertex4, vMasking);","  vVertex = vec3(uMV * vertex4);","  gl_Position = uMVP * vertex4;","}"].join("\n"),q.fragment=["precision mediump float;","varying vec3 vVertex;","varying vec3 vNormal;","uniform float uAlpha;",R.strings.fragColorUniforms,R.strings.fragColorFunction,"void main() {","  gl_FragColor = encodeFragColor(sRGBToLinear(getNormal() * 0.5 + 0.5), uAlpha);","}"].join("\n");var K=R.getCopy();K.vertexName=K.fragmentName="ShowUV",K.texPath="resources/uv.jpg",K.uniforms={},K.attributes={},K.uniformNames=["uTexture0","uAlbedo"],Array.prototype.push.apply(K.uniformNames,R.uniformNames.commonUniforms),K.vertex=["precision mediump float;","attribute vec3 aVertex;","attribute vec3 aNormal;","attribute vec3 aColor;","attribute vec2 aTexCoord;","attribute vec3 aMaterial;",R.strings.vertUniforms,"varying vec3 vVertex;","varying vec3 vNormal;","varying vec3 vColor;","varying vec2 vTexCoord;","varying float vMasking;","uniform vec3 uAlbedo;","void main() {","  vColor = uAlbedo.x >= 0.0 ? uAlbedo : aColor;","  vTexCoord = aTexCoord;","  vMasking = aMaterial.z;","  vNormal = mix(aNormal, uEN * aNormal, vMasking);","  vNormal = normalize(uN * vNormal);","  vec4 vertex4 = vec4(aVertex, 1.0);","  vertex4 = mix(vertex4, uEM *vertex4, vMasking);","  vVertex = vec3(uMV * vertex4);","  gl_Position = uMVP * vertex4;","}"].join("\n"),K.fragment=["precision mediump float;","uniform sampler2D uTexture0;","varying vec3 vVertex;","varying vec3 vNormal;","varying vec3 vColor;","varying vec2 vTexCoord;","uniform float uAlpha;",R.strings.fragColorUniforms,R.strings.fragColorFunction,"void main() {","  vec3 color = sRGBToLinear(texture2D(uTexture0, vTexCoord).rgb) * sRGBToLinear(vColor);","  gl_FragColor = encodeFragColor(color, uAlpha);","}"].join("\n"),K.draw=R.draw,K.drawBuffer=R.drawBuffer,K.getOrCreate=R.getOrCreate,K.initUniforms=R.initUniforms,K.initAttributes=function(e){R.initAttributes.call(this,e),K.attributes.aTexCoord=new x(e,K.program,"aTexCoord",2,e.FLOAT)},K.bindAttributes=function(e){R.bindAttributes.call(this,e),K.attributes.aTexCoord.bindToBuffer(e.getTexCoordBuffer())},K.updateUniforms=function(e,t){var r=e.getGL(),i=this.uniforms;r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,this.getOrCreateTexture0(r,K.texPath,t)||this.getDummyTexture(r)),r.uniform1i(i.uTexture0,0),r.uniform3fv(i.uAlbedo,e.getAlbedo()),R.updateUniforms.call(this,e,t)};var Z=R.getCopy();Z.vertexName=Z.fragmentName="Wireframe",Z.uniforms={},Z.attributes={},Z.activeAttributes={vertex:!0,material:!0},Z.uniformNames=["uMVP","uEM"],Z.vertex=["attribute vec3 aVertex;","attribute vec3 aMaterial;","uniform mat4 uMVP;","uniform mat4 uEM;","void main() {","  vec4 vertex4 = vec4(aVertex, 1.0);","  vec4 pos = uMVP * mix(vertex4, uEM * vertex4, aMaterial.z);","  pos[3] += 0.0001;","  gl_Position = pos;","}"].join("\n"),Z.fragment=["precision mediump float;","void main() {","  gl_FragColor = vec4(0.0, 0.0, 0.0, 0.4);","}"].join("\n"),Z.getOrCreate=R.getOrCreate,Z.draw=function(e){var t=e.getGL();t.useProgram(this.program),this.bindAttributes(e),this.updateUniforms(e),e.getWireframeBuffer().bind(),t.drawElements(t.LINES,2*e.getRenderNbEdges(),t.UNSIGNED_INT,0)},Z.updateUniforms=function(e){var t=e.getGL();t.uniformMatrix4fv(this.uniforms.uMVP,!1,e.getMVP()),t.uniformMatrix4fv(this.uniforms.uEM,!1,e.getEditMatrix())};var Q=R.getCopy();Q.vertexName=Q.fragmentName="FlatColor",Q.uniforms={},Q.attributes={},Q.activeAttributes={vertex:!0,material:!0},Q.uniformNames=["uColor"],Array.prototype.push.apply(Q.uniformNames,R.uniformNames.commonUniforms),Q.vertex=["precision mediump float;","attribute vec3 aVertex;","attribute vec3 aMaterial;",R.strings.vertUniforms,"varying vec3 vVertex;","void main() {","  vec4 vertex4 = vec4(aVertex, 1.0);","  gl_Position = uMVP * mix(vertex4, uEM * vertex4, aMaterial.z);","}"].join("\n"),Q.fragment=["precision mediump float;","uniform vec3 uColor;","void main() {","  gl_FragColor = vec4(uColor, 1.0);","}"].join("\n"),Q.updateUniforms=function(e,t){e.getGL().uniform3fv(this.uniforms.uColor,e.getFlatColor()),R.updateUniforms.call(this,e,t)};var J=R.getCopy();J.vertexName=J.fragmentName="ShowSelection",J.uniforms={},J.attributes={},J.activeAttributes={vertex:!0},J.uniformNames=["uMVP","uColor"],J.vertex=["attribute vec3 aVertex;","uniform mat4 uMVP;","void main() {","  gl_Position = uMVP * vec4(aVertex, 1.0);","}"].join("\n"),J.fragment=["precision mediump float;","uniform vec3 uColor;","void main() {","  gl_FragColor = vec4(uColor, 1.0);","}"].join("\n"),J.draw=function(e,t,r){var i=e.getGL();i.useProgram(this.program),i.uniform3fv(this.uniforms.uColor,e.getColor()),t&&(i.uniformMatrix4fv(this.uniforms.uMVP,!1,e.getCircleMVP()),J.attributes.aVertex.bindToBuffer(e.getCircleBuffer()),i.drawArrays(i.LINE_LOOP,0,e.getCircleBuffer()._size/3)),i.uniformMatrix4fv(this.uniforms.uMVP,!1,e.getDotMVP()),J.attributes.aVertex.bindToBuffer(e.getDotBuffer()),i.drawArrays(i.TRIANGLE_FAN,0,e.getDotBuffer()._size/3),r&&(i.uniformMatrix4fv(this.uniforms.uMVP,!1,e.getDotSymmetryMVP()),i.drawArrays(i.TRIANGLE_FAN,0,e.getDotBuffer()._size/3))};var $=R.getCopy();$.vertexName=$.fragmentName="Background",$.uniforms={},$.attributes={},$.uniformNames=["uTexture0"],$.vertex=["attribute vec2 aVertex;","attribute vec2 aTexCoord;","varying vec2 vTexCoord;","void main() {","  vTexCoord = aTexCoord;","  gl_Position = vec4(aVertex, 1.0, 1.0);","}"].join("\n"),$.fragment=["precision mediump float;","uniform sampler2D uTexture0;","varying vec2 vTexCoord;",R.strings.colorSpaceGLSL,"void main() {","  gl_FragColor = encodeRGBM(sRGBToLinear(texture2D(uTexture0, vTexCoord)).rgb);","}"].join("\n"),$.draw=function(e){var t=e.getGL();t.useProgram(this.program),this.bindAttributes(e),this.updateUniforms(e),t.drawArrays(t.TRIANGLE_STRIP,0,4)},$.initAttributes=function(e){var t=$.program,r=$.attributes;r.aVertex=new x(e,t,"aVertex",2,e.FLOAT),r.aTexCoord=new x(e,t,"aTexCoord",2,e.FLOAT)},$.bindAttributes=function(e){var t=$.attributes;t.aVertex.bindToBuffer(e.getVertexBuffer()),t.aTexCoord.bindToBuffer(e.getTexCoordBuffer())},$.updateUniforms=function(e){var t=e.getGL();t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,e.getTexture()),t.uniform1i(this.uniforms.uTexture0,0)};var ee=R.getCopy();ee.vertexName=ee.fragmentName="Merge",ee.FILMIC=_().filmic,ee.uniforms={},ee.attributes={},ee.uniformNames=["uTexture0","uTexture1","uFilmic"],ee.vertex=["precision mediump float;","attribute vec2 aVertex;","varying vec2 vTexCoord;","void main() {","  vTexCoord = aVertex * 0.5 + 0.5;","  gl_Position = vec4(aVertex, 0.5, 1.0);","}"].join("\n"),ee.fragment=["precision mediump float;","uniform sampler2D uTexture0;","uniform sampler2D uTexture1;","uniform int uFilmic;","varying vec2 vTexCoord;",R.strings.colorSpaceGLSL,"void main() {","  vec4 transparent = texture2D(uTexture1, vTexCoord);","  vec3 color = decodeRGBM(texture2D(uTexture0, vTexCoord))*(1.0-transparent.a) + transparent.rgb;","  if(uFilmic == 1){","    vec3 x = max(vec3(0.0), color - vec3(0.004));","    gl_FragColor = vec4((x*(6.2*x+0.5))/(x*(6.2*x+1.7)+0.06), 1.0);","  }else{","    gl_FragColor = vec4(linearTosRGB(color), 1.0);","  }","}"].join("\n"),ee.draw=function(e,t){var r=e.getGL();r.useProgram(this.program),ee.attributes.aVertex.bindToBuffer(e.getVertexBuffer()),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,t._rttOpaque.getTexture()),r.uniform1i(this.uniforms.uTexture0,0),r.activeTexture(r.TEXTURE1),r.bindTexture(r.TEXTURE_2D,t._rttTransparent.getTexture()),r.uniform1i(this.uniforms.uTexture1,1),r.uniform1i(this.uniforms.uFilmic,ee.FILMIC),r.drawArrays(r.TRIANGLES,0,3)},ee.initAttributes=function(e){ee.attributes.aVertex=new x(e,ee.program,"aVertex",2,e.FLOAT)};var te="// https://github.com/mattdesl/glsl-fxaa\n#define FXAA_REDUCE_MIN (1.0/ 128.0)\n#define FXAA_REDUCE_MUL (1.0 / 8.0)\n#define FXAA_SPAN_MAX 8.0\n\nvec3 fxaa(const in sampler2D tex, const in vec2 uvNW, const in vec2 uvNE, const in vec2 uvSW, const in vec2 uvSE, const in vec2 uvM, const in vec2 invRes) {\n    const vec3 luma = vec3(0.299, 0.587, 0.114);\n    float lumaNW = dot(texture2D(tex, uvNW).xyz, luma);\n    float lumaNE = dot(texture2D(tex, uvNE).xyz, luma);\n    float lumaSW = dot(texture2D(tex, uvSW).xyz, luma);\n    float lumaSE = dot(texture2D(tex, uvSE).xyz, luma);\n    float lumaM  = dot(texture2D(tex, uvM).xyz,  luma);\n    float lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\n    float lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\n\n    vec2 dir = vec2(-((lumaNW + lumaNE) - (lumaSW + lumaSE)), ((lumaNW + lumaSW) - (lumaNE + lumaSE)));\n    float dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) * (0.25 * FXAA_REDUCE_MUL), FXAA_REDUCE_MIN);\n    float rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\n    dir = min(vec2(FXAA_SPAN_MAX, FXAA_SPAN_MAX), max(vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX), dir * rcpDirMin)) * invRes;\n    \n    vec3 rgbA = 0.5 * ( texture2D(tex, uvM + dir * (1.0 / 3.0 - 0.5)).xyz + texture2D(tex, uvM + dir * (2.0 / 3.0 - 0.5)).xyz);\n    vec3 rgbB = rgbA * 0.5 + 0.25 * ( texture2D(tex, uvM - dir * 0.5).xyz + texture2D(tex, uvM + dir * 0.5).xyz);\n    \n    float lumaB = dot(rgbB, luma);\n    if((lumaB < lumaMin) || (lumaB > lumaMax))\n      return rgbA;\n    return rgbB;\n}",re=R.getCopy();re.vertexName=re.fragmentName="Fxaa",re.FILMIC=_().filmic,re.uniforms={},re.attributes={},re.uniformNames=["uTexture0","uInvSize"],re.vertex=["precision mediump float;","attribute vec2 aVertex;","uniform vec2 uInvSize;","varying vec2 vUVNW;","varying vec2 vUVNE;","varying vec2 vUVSW;","varying vec2 vUVSE;","varying vec2 vUVM;","void main() {","  vUVM = aVertex * 0.5 + 0.5;","  vUVNW = vUVM + vec2(-1.0, -1.0) * uInvSize;","  vUVNE = vUVM + vec2(1.0, -1.0) * uInvSize;","  vUVSW = vUVM + vec2(-1.0, 1.0) * uInvSize;","  vUVSE = vUVM + vec2(1.0, 1.0) * uInvSize;","  gl_Position = vec4(aVertex, 0.5, 1.0);","}"].join("\n"),re.fragment=["precision mediump float;","uniform sampler2D uTexture0;","uniform vec2 uInvSize;","varying vec2 vUVNW;","varying vec2 vUVNE;","varying vec2 vUVSW;","varying vec2 vUVSE;","varying vec2 vUVM;",te,R.strings.colorSpaceGLSL,"void main() {","  gl_FragColor = vec4(fxaa(uTexture0, vUVNW, vUVNE, vUVSW, vUVSE, vUVM, uInvSize), 1.0);","}"].join("\n"),re.draw=function(e,t){var r=e.getGL();r.useProgram(this.program),re.attributes.aVertex.bindToBuffer(e.getVertexBuffer()),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,t._rttMerge.getTexture()),r.uniform1i(this.uniforms.uTexture0,0),r.uniform2fv(this.uniforms.uInvSize,e.getInverseSize()),r.drawArrays(r.TRIANGLES,0,3)},re.initAttributes=function(e){re.attributes.aVertex=new x(e,re.program,"aVertex",2,e.FLOAT)};var ie="\nfloat outlineDistance( const in vec2 uv, const in sampler2D tex, const in vec2 invSize ) {\n  float fac0 = 2.0;\n  float fac1 = 1.0;\n  float ox = invSize.x;\n  float oy = invSize.y;\n  vec4 texel0 = texture2D(tex, uv + vec2(ox, oy));\n  vec4 texel1 = texture2D(tex, uv + vec2(ox, 0.0));\n  vec4 texel2 = texture2D(tex, uv + vec2(ox, -oy));\n  vec4 texel3 = texture2D(tex, uv + vec2(0.0, -oy));\n  vec4 texel4 = texture2D(tex, uv + vec2(-ox, -oy));\n  vec4 texel5 = texture2D(tex, uv + vec2(-ox, 0.0));\n  vec4 texel6 = texture2D(tex, uv + vec2(-ox, oy));\n  vec4 texel7 = texture2D(tex, uv + vec2(0.0, oy));\n  vec4 rowx = -fac0 * texel5 + fac0 * texel1 + -fac1 * texel6 + fac1 * texel0 + -fac1 * texel4 + fac1 * texel2;\n  vec4 rowy = -fac0 * texel3 + fac0 * texel7 + -fac1 * texel4 + fac1 * texel6 + -fac1 * texel2 + fac1 * texel0;\n  return dot(rowy, rowy) + dot(rowx, rowx);\n}\n",ae=R.getCopy();ae.vertexName=ae.fragmentName="SobelContour",ae.color=_().outlinecolor,ae.uniforms={},ae.attributes={},ae.uniformNames=["uTexture0","uColor","uInvSize"],ae.vertex=["attribute vec2 aVertex;","varying vec2 vTexCoord;","void main() {","  vTexCoord = aVertex * 0.5 + 0.5;","  gl_Position = vec4(aVertex, 0.0, 1.0);","}"].join("\n"),ae.fragment=["#extension GL_OES_standard_derivatives : enable","precision mediump float;","uniform sampler2D uTexture0;","uniform vec4 uColor;","varying vec2 vTexCoord;","uniform vec2 uInvSize;",ie,R.strings.colorSpaceGLSL,"void main() {","  float mag = outlineDistance(vTexCoord, uTexture0, uInvSize);","  if (mag < 1.5) discard;","  gl_FragColor = vec4(sRGBToLinear(uColor.rgb) * uColor.a, uColor.a);","}"].join("\n"),ae.draw=function(e){var t=e.getGL();t.useProgram(this.program),ae.attributes.aVertex.bindToBuffer(e.getVertexBuffer()),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,e.getTexture()),t.uniform1i(this.uniforms.uTexture0,0),t.uniform4fv(this.uniforms.uColor,ae.color),t.uniform2fv(this.uniforms.uInvSize,e.getInverseSize()),t.drawArrays(t.TRIANGLES,0,3)},ae.initAttributes=function(e){ae.attributes.aVertex=new x(e,ae.program,"aVertex",2,e.FLOAT)};var ne=[];ne[o.Shader.PBR]=z,ne[o.Shader.MATCAP]=H,ne[o.Shader.NORMAL]=q,ne[o.Shader.UV]=K,ne[o.Shader.WIREFRAME]=Z,ne[o.Shader.FLAT]=Q,ne[o.Shader.SELECTION]=J,ne[o.Shader.BACKGROUND]=$,ne[o.Shader.MERGE]=ee,ne[o.Shader.FXAA]=re,ne[o.Shader.CONTOUR]=ae;var se,oe=i.mat3,le=i.mat4,ue=i.vec3,he=le.create(),ce=le.create(),de=[0,0,0],ge=[0,0,0],fe=[0,0,1],ve=50,me=function(){function e(t){y(this,e),this._gl=t,this._circleBuffer=new A(t,t.ARRAY_BUFFER,t.STATIC_DRAW),this._dotBuffer=new A(t,t.ARRAY_BUFFER,t.STATIC_DRAW),this._cacheDotMVP=le.create(),this._cacheDotSymMVP=le.create(),this._cacheCircleMVP=le.create(),this._color=new Float32Array([.8,0,0]),this._offsetX=0,this._isEditMode=!1,this.init()}return M(e,[{key:"getGL",value:function(){return this._gl}},{key:"getCircleBuffer",value:function(){return this._circleBuffer}},{key:"getDotBuffer",value:function(){return this._dotBuffer}},{key:"getCircleMVP",value:function(){return this._cacheCircleMVP}},{key:"getDotMVP",value:function(){return this._cacheDotMVP}},{key:"getDotSymmetryMVP",value:function(){return this._cacheDotSymMVP}},{key:"getColor",value:function(){return this._color}},{key:"setIsEditMode",value:function(e){this._isEditMode=e}},{key:"getIsEditMode",value:function(){return this._isEditMode}},{key:"setOffsetX",value:function(e){this._offsetX=e}},{key:"getOffsetX",value:function(){return this._offsetX}},{key:"init",value:function(){this.getCircleBuffer().update(this._getCircleVertices(1)),this.getDotBuffer().update(this._getDotVertices(.05,10))}},{key:"release",value:function(){this.getCircleBuffer().release(),this.getDotBuffer().release()}},{key:"_getCircleVertices",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:50,r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=2*Math.PI,a=r?1:0,n=r?t+2:t,s=new Float32Array(3*n),o=a;o<n;++o){var l=3*o,u=i*o/t;s[l]=Math.cos(u)*e,s[l+1]=Math.sin(u)*e}return s}},{key:"_getDotVertices",value:function(e,t){return this._getCircleVertices(e,t,!0)}},{key:"_updateMatricesBackground",value:function(e,t){var r=t.getSculptManager().getCurrentTool().getScreenRadius(),i=.5*e._width,a=.5*e._height;le.ortho(he,-i,i,-a,a,-10,10),le.identity(ce),le.translate(ce,ce,ue.set(de,-i+t._mouseX+this._offsetX,a-t._mouseY,0)),le.scale(this._cacheCircleMVP,ce,ue.set(de,r,r,r)),le.mul(this._cacheCircleMVP,he,this._cacheCircleMVP),le.scale(this._cacheDotMVP,ce,ue.set(de,ve,ve,ve)),le.mul(this._cacheDotMVP,he,this._cacheDotMVP),le.scale(this._cacheDotSymMVP,this._cacheDotSymMVP,[0,0,0])}},{key:"_updateMatricesMesh",value:function(e,t){var r=t.getPicking(),i=t.getPickingSymmetry(),a=Math.sqrt(r.computeWorldRadius2(!0)),n=t.getSculptManager().getCurrentTool().getScreenRadius(),s=r.getMesh(),o=ve*(a/n);r.polyLerp(s.getNormals(),ge),ue.transformMat3(ge,ge,oe.normalFromMat4(ce,s.getMatrix())),ue.normalize(ge,ge);var l=Math.acos(ue.dot(fe,ge));ue.cross(ge,fe,ge),le.identity(ce),le.translate(ce,ce,ue.transformMat4(de,r.getIntersectionPoint(),s.getMatrix())),le.rotate(ce,ce,l,ge),le.mul(he,e.getProjection(),e.getView()),le.scale(this._cacheCircleMVP,ce,ue.set(de,a,a,a)),le.mul(this._cacheCircleMVP,he,this._cacheCircleMVP),le.scale(this._cacheDotMVP,ce,ue.set(de,o,o,o)),le.mul(this._cacheDotMVP,he,this._cacheDotMVP),ue.transformMat4(de,i.getIntersectionPoint(),s.getMatrix()),le.identity(ce),le.translate(ce,ce,de),le.rotate(ce,ce,l,ge),le.scale(ce,ce,ue.set(de,o,o,o)),le.mul(this._cacheDotSymMVP,he,ce)}},{key:"render",value:function(e){var t=e.getPicking().getMesh()&&!this._isEditMode;t?this._updateMatricesMesh(e.getCamera(),e):this._updateMatricesBackground(e.getCamera(),e);var r=e._action===o.Action.NOTHING;ue.set(this._color,.8,r&&t?0:.4,0),ne[o.Shader.SELECTION].getOrCreate(this._gl).draw(this,r,e.getSculptManager().getSymmetry()),this._isEditMode=!1}}]),e}();_().wacom&&(se=document.createElement("object"),se.setAttribute("id","tablet-plugin"),se.setAttribute("type","application/x-wacomtabletplugin"),document.body.appendChild(se));var pe={useOnRadius:!0,useOnIntensity:!1};pe.pressure=function(){if(!se)return 1;var e=se.penAPI;return e&&e.pointerType?e.pressure:1},pe.getPressureIntensity=function(){return pe.useOnIntensity===!0?.25+.75*pe.pressure():1},pe.getPressureRadius=function(){return pe.useOnRadius===!0?.25+.75*pe.pressure():1};var _e=function(){function e(t){y(this,e),this._main=t,this._cbContinuous=this.updateContinuous.bind(this),this._lastMouseX=0,this._lastMouseY=0}return M(e,[{key:"setToolMesh",value:function(e){this._forceToolMesh=e}},{key:"getMesh",value:function(){return this._forceToolMesh||this._main.getMesh()}},{key:"start",value:function(e){var t=this._main,r=t.getPicking();if(!r.intersectionMouseMeshes())return!1;var i=t.setOrUnsetMesh(r.getMesh(),e);if(!i)return!1;r.initAlpha();var a=t.getSculptManager().getSymmetry()?t.getPickingSymmetry():null;return a&&(a.intersectionMouseMesh(i),a.initAlpha()),this.pushState(),this._lastMouseX=t._mouseX,this._lastMouseY=t._mouseY,this.startSculpt(),!0}},{key:"end",value:function(){this.getMesh()&&this.getMesh().balanceOctree()}},{key:"pushState",value:function(){this._main.getStateManager().pushStateGeometry(this.getMesh())}},{key:"startSculpt",value:function(){this._lockPosition!==!0&&this.sculptStroke()}},{key:"preUpdate",value:function(e){var t=this._main,r=t.getPicking(),i=t._action===o.Action.SCULPT_EDIT;if(!i||e){i?r.intersectionMouseMesh():r.intersectionMouseMeshes();var a=r.getMesh();a&&t.getSculptManager().getSymmetry()&&t.getPickingSymmetry().intersectionMouseMesh(a)}}},{key:"update",value:function(e){return this._lockPosition===!0?this.updateSculptLock(e):void this.sculptStroke()}},{key:"updateSculptLock",value:function(e){var t=this._main;e||this._main.getStateManager().getCurrentState().undo();var r=t.getPicking(),i=this._radius,a=t.getSculptManager().getSymmetry()?t.getPickingSymmetry():null,n=t._mouseX-this._lastMouseX,s=t._mouseY-this._lastMouseY;this._radius=Math.sqrt(n*n+s*s);var o=n/this._radius,l=s/this._radius;this.makeStroke(this._lastMouseX+.001*o,this._lastMouseY+.001*l,r,a),this._radius=i,this.updateRender(),t.setCanvasCursor("default")}},{key:"sculptStroke",value:function(){var e=this._main,t=e.getPicking(),r=e.getSculptManager().getSymmetry()?e.getPickingSymmetry():null,i=e._mouseX-this._lastMouseX,a=e._mouseY-this._lastMouseY,n=Math.sqrt(i*i+a*a),s=.15*this._radius*e.getPixelRatio();if(!(n<=s)){var o=1/Math.floor(n/s);i*=o,a*=o;for(var l=this._lastMouseX+i,u=this._lastMouseY+a,h=o;h<=1&&this.makeStroke(l,u,t,r);h+=o)l+=i,u+=a;this.updateRender(),this._lastMouseX=e._mouseX,this._lastMouseY=e._mouseY}}},{key:"updateRender",value:function(){this.updateMeshBuffers(),this._main.render()}},{key:"makeStroke",value:function(e,t,r,i){var a=this.getMesh();r.intersectionMouseMesh(a,e,t);var n=r.getMesh();n&&(r.pickVerticesInSphere(r.getLocalRadius2()),r.computePickedNormal());var s=a.isDynamic&&!this._lockPosition;s&&n&&this.stroke(r,!1);var o;return i&&(i.intersectionMouseMesh(a,e,t),o=i.getMesh(),o&&(i.setLocalRadius2(r.getLocalRadius2()),i.pickVerticesInSphere(i.getLocalRadius2()),i.computePickedNormal())),!s&&n&&this.stroke(r,!1),o&&this.stroke(i,!0),n||o}},{key:"updateMeshBuffers",value:function(){var e=this.getMesh();e.isDynamic?e.updateBuffers():e.updateGeometryBuffers()}},{key:"updateContinuous",value:function(){if(this._lockPosition)return this.update(!0);var e=this._main,t=e.getPicking(),r=e.getSculptManager().getSymmetry()?e.getPickingSymmetry():null;this.makeStroke(e._mouseX,e._mouseY,t,r),this.updateRender()}},{key:"getFrontVertices",value:function(e,t){for(var r=e.length,i=new Uint32Array(n.getMemory(4*r),0,r),a=0,s=this.getMesh().getNormals(),o=t[0],l=t[1],u=t[2],h=0;h<r;++h){var c=e[h],d=3*c;s[d]*o+s[d+1]*l+s[d+2]*u<=0&&(i[a++]=c)}return new Uint32Array(i.subarray(0,a))}},{key:"areaNormal",value:function(e){for(var t=this.getMesh(),r=t.getNormals(),i=t.getMaterials(),a=0,n=0,s=0,o=0,l=e.length;o<l;++o){var u=3*e[o],h=i[u+2];a+=r[u]*h,n+=r[u+1]*h,s+=r[u+2]*h}var c=Math.sqrt(a*a+n*n+s*s);if(0!==c)return c=1/c,[a*c,n*c,s*c]}},{key:"areaCenter",value:function(e){for(var t=this.getMesh(),r=t.getVertices(),i=t.getMaterials(),a=e.length,n=0,s=0,o=0,l=0,u=0;u<a;++u){var h=3*e[u],c=i[h+2];l+=c,n+=r[h]*c,s+=r[h+1]*c,o+=r[h+2]*c}return[n/l,s/l,o/l]}},{key:"updateProxy",value:function(e){var t=this.getMesh(),r=t.getVertices(),i=t.getVerticesProxy();if(r!==i)for(var a=t.getVerticesStateFlags(),s=n.STATE_FLAG,o=0,l=e.length;o<l;++o){var u=e[o];if(a[u]!==s){var h=3*u;i[h]=r[h],i[h+1]=r[h+1],i[h+2]=r[h+2]}}}},{key:"laplacianSmooth",value:function(e,t,r){for(var i=this.getMesh(),a=i.getVerticesRingVertStartCount(),n=i.getVerticesRingVert(),s=n instanceof Array?n:null,o=i.getVerticesOnEdge(),l=r||i.getVertices(),u=e.length,h=0;h<u;++h){var c,d,g=3*h,f=e[h];s?(n=s[f],c=0,d=n.length):(c=a[2*f],d=c+a[2*f+1]);var v=0,m=d-c;if(m<=2)v=3*f,t[g]=l[v],t[g+1]=l[v+1],t[g+2]=l[v+2];else{var p=0,_=0,y=0,M=0;if(1===o[f]){var T=0;for(M=c;M<d;++M)v=n[M],1===o[v]&&(v*=3,p+=l[v],_+=l[v+1],y+=l[v+2],++T);if(T>=2){t[g]=p/T,t[g+1]=_/T,t[g+2]=y/T;continue}p=_=y=0}for(M=c;M<d;++M)v=3*n[M],p+=l[v],_+=l[v+1],y+=l[v+2];t[g]=p/m,t[g+1]=_/m,t[g+2]=y/m}}}},{key:"dynamicTopology",value:function(e){var t=this.getMesh(),r=e.getPickedVertices();if(!t.isDynamic)return r;var i=t.getSubdivisionFactor(),a=t.getDecimationFactor();
if(0===i&&0===a)return r;0===r.length&&(r=t.getVerticesFromFaces([e.getPickedFace()]),this._main.getStateManager().pushVertices(r));var s=t.getFacesFromVertices(r),o=e.getLocalRadius2(),l=e.getIntersectionPoint(),u=o*(1.1-i)*.2,h=u/4.2025*a;this._main.getStateManager().pushFaces(s),i&&(s=t.subdivide(s,l,o,u,this._main.getStateManager())),a&&(s=t.decimate(s,l,o,h,this._main.getStateManager())),r=t.getVerticesFromFaces(s);for(var c=r.length,d=n.SCULPT_FLAG,g=t.getVerticesSculptFlags(),f=new Uint32Array(n.getMemory(4*c),0,c),v=0,m=0;m<c;++m){var p=r[m];g[p]===d&&(f[v++]=p)}return f=new Uint32Array(f.subarray(0,v)),t.updateTopology(s,r),t.updateGeometry(s,r),f}},{key:"getUnmaskedVertices",value:function(){return this.filterMaskedVertices(0,1/0)}},{key:"getMaskedVertices",value:function(){return this.filterMaskedVertices(-(1/0),1)}},{key:"filterMaskedVertices",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:-(1/0),t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1/0,r=this.getMesh(),i=r.getMaterials(),a=r.getNbVertices(),s=new Uint32Array(n.getMemory(4*a),0,a),o=0,l=0;l<a;++l){var u=i[3*l+2];u>e&&u<t&&(s[o++]=l)}return new Uint32Array(s.subarray(0,o))}},{key:"postRender",value:function(e){e.render(this._main)}},{key:"addSculptToScene",value:function(){}},{key:"getScreenRadius",value:function(){return(this._radius||1)*this._main.getPixelRatio()}}]),e}(),ye=function(e){function t(e){y(this,t);var r=b(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return r._radius=50,r._intensity=.75,r._negative=!0,r._culling=!1,r._idAlpha=0,r._lockPosition=!1,r}return S(t,e),M(t,[{key:"stroke",value:function(e){var t=e.getPickedVertices(),r=this._intensity*pe.getPressureIntensity();this._main.getStateManager().pushVertices(t),t=this.dynamicTopology(e);var i=this.getFrontVertices(t,e.getEyeDirection());this._culling&&(t=i);var a=this.areaNormal(i);if(a){var n=this.areaCenter(i);e.updateAlpha(this._lockPosition),e.setIdAlpha(this._idAlpha),this.flatten(t,a,n,e.getIntersectionPoint(),e.getLocalRadius2(),r,e);var s=this.getMesh();s.updateGeometry(s.getFacesFromVertices(t),t)}}},{key:"flatten",value:function(e,t,r,i,a,n,s){for(var o=this.getMesh(),l=o.getVertices(),u=o.getMaterials(),h=Math.sqrt(a),c=this._accumulate===!1&&this._lockPosition===!1?o.getVerticesProxy():l,d=i[0],g=i[1],f=i[2],v=r[0],m=r[1],p=r[2],_=t[0],y=t[1],M=t[2],T=this._negative?-1:1,S=0,b=e.length;S<b;++S){var A=3*e[S],x=l[A],k=l[A+1],w=l[A+2],E=(x-v)*_+(k-m)*y+(w-p)*M;if(!(E*T>0)){var R=c[A]-d,F=c[A+1]-g,D=c[A+2]-f,I=Math.sqrt(R*R+F*F+D*D)/h;if(!(I>=1)){var C=I*I;C=3*C*C-4*C*I+1,C*=E*n*u[A+2]*s.getAlpha(x,k,w),l[A]-=_*C,l[A+1]-=y*C,l[A+2]-=M*C}}}}}]),t}(_e),Me=i.vec3,Te=function(e){function t(e){y(this,t);var r=b(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return r._radius=50,r._intensity=.5,r._negative=!1,r._clay=!0,r._culling=!1,r._accumulate=!0,r._idAlpha=0,r._lockPosition=!1,r}return S(t,e),M(t,[{key:"stroke",value:function(e){var t=e.getPickedVertices(),r=this._intensity*pe.getPressureIntensity();this._accumulate||this._lockPosition||this.updateProxy(t),this._main.getStateManager().pushVertices(t),this._lockPosition||(t=this.dynamicTopology(e));var i=this.getFrontVertices(t,e.getEyeDirection());this._culling&&(t=i);var a=e.getLocalRadius2();if(e.updateAlpha(this._lockPosition),e.setIdAlpha(this._idAlpha),this._clay){var n=this.areaNormal(i);if(!n)return;var s=this._lockPosition?e.getIntersectionPoint():this.areaCenter(i),o=.1*Math.sqrt(a);Me.scaleAndAdd(s,s,n,this._negative?-o:o),ye.prototype.flatten.call(this,t,n,s,e.getIntersectionPoint(),a,r,e)}else this.brush(t,e.getPickedNormal(),e.getIntersectionPoint(),a,r,e);var l=this.getMesh();l.updateGeometry(l.getFacesFromVertices(t),t)}},{key:"brush",value:function(e,t,r,i,a,n){var s=this.getMesh(),o=s.getVertices(),l=s.getMaterials(),u=this._accumulate||this._lockPosition?o:s.getVerticesProxy(),h=Math.sqrt(i),c=a*h*.1;this._negative&&(c=-c);for(var d=r[0],g=r[1],f=r[2],v=t[0],m=t[1],p=t[2],_=0,y=e.length;_<y;++_){var M=3*e[_],T=u[M]-d,S=u[M+1]-g,b=u[M+2]-f,A=Math.sqrt(T*T+S*S+b*b)/h;if(!(A>=1)){var x=o[M],k=o[M+1],w=o[M+2],E=A*A;E=3*E*E-4*E*A+1,E*=l[M+2]*c*n.getAlpha(x,k,w),o[M]=x+v*E,o[M+1]=k+m*E,o[M+2]=w+p*E}}}}]),t}(_e),Se=function(e){function t(e){y(this,t);var r=b(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return r._radius=50,r._intensity=.3,r._negative=!1,r._culling=!1,r._idAlpha=0,r._lockPosition=!1,r}return S(t,e),M(t,[{key:"stroke",value:function(e){var t=e.getPickedVertices(),r=this._intensity*pe.getPressureIntensity();this.updateProxy(t),this._main.getStateManager().pushVertices(t),t=this.dynamicTopology(e),this._culling&&(t=this.getFrontVertices(t,e.getEyeDirection())),e.updateAlpha(this._lockPosition),e.setIdAlpha(this._idAlpha),this.inflate(t,e.getIntersectionPoint(),e.getLocalRadius2(),r,e);var i=this.getMesh();i.updateGeometry(i.getFacesFromVertices(t),t)}},{key:"inflate",value:function(e,t,r,i,a){var n=this.getMesh(),s=n.getVertices(),o=n.getMaterials(),l=n.getVerticesProxy(),u=n.getNormals(),h=Math.sqrt(r),c=i*h*.1;this._negative&&(c=-c);for(var d=t[0],g=t[1],f=t[2],v=0,m=e.length;v<m;++v){var p=3*e[v],_=l[p]-d,y=l[p+1]-g,M=l[p+2]-f,T=Math.sqrt(_*_+y*y+M*M)/h;if(!(T>=1)){var S=T*T;S=3*S*S-4*S*T+1,S=c*S;var b=s[p],A=s[p+1],x=s[p+2],k=u[p],w=u[p+1],E=u[p+2];S/=Math.sqrt(k*k+w*w+E*E),S*=o[p+2]*a.getAlpha(b,A,x),s[p]=b+k*S,s[p+1]=A+w*S,s[p+2]=x+E*S}}}}]),t}(_e),be=i.vec3,Ae={};Ae.normalizedMouse=function(e,t,r,i){return[2*e/r-1,1-2*t/i]},Ae.mouseOnUnitSphere=function(e){var t=e[0],r=e[1],i=1-t*t-r*r,a=i>0?Math.sqrt(i):0,n=[t,r,a];return be.normalize(n,n)},Ae.intersectionRayTriangleEdges=function(){var e=1e-15,t=1+e,r=0-e,i=[0,0,0],a=[0,0,0],n=[0,0,0];return function(s,o,l,u,h,c){be.cross(i,o,u);var d=be.dot(l,i);if(d>-e&&d<e)return-1;var g=1/d;be.sub(a,s,h);var f=be.dot(a,i)*g;if(f<r||f>t)return-1;be.cross(n,a,l);var v=be.dot(o,n)*g;if(v<r||f+v>t)return-1;var m=be.dot(u,n)*g;return m<r?-1:(c&&be.scaleAndAdd(c,s,o,m),m)}}(),Ae.intersectionRayTriangle=function(){var e=[0,0,0],t=[0,0,0];return function(r,i,a,n,s,o){return be.sub(e,n,a),be.sub(t,s,a),Ae.intersectionRayTriangleEdges(r,i,e,t,a,o)}}(),Ae.distance2PointTriangleEdges=function(){var e=[0,0,0];return function(t,r,i,a,n,s,o,l){be.sub(e,a,t);var u,h=be.dot(e,r),c=be.dot(e,i),d=be.sqrLen(e),g=Math.abs(n*o-s*s),f=s*c-o*h,v=s*h-n*c,m=4;if(f+v<=g)if(f<0)v<0?(m=4,h<0?(v=0,-h>=n?(f=1,u=n+2*h+d):(f=-h/n,u=h*f+d)):(f=0,c>=0?(v=0,u=d):-c>=o?(v=1,u=o+2*c+d):(v=-c/o,u=c*v+d))):(m=3,f=0,c>=0?(v=0,u=d):-c>=o?(v=1,u=o+2*c+d):(v=-c/o,u=c*v+d));else if(v<0)m=5,v=0,h>=0?(f=0,u=d):-h>=n?(f=1,u=n+2*h+d):(f=-h/n,u=h*f+d);else{m=0;var p=1/g;f*=p,v*=p,u=f*(n*f+s*v+2*h)+v*(s*f+o*v+2*c)+d}else{var _,y,M,T;f<0?(m=2,_=s+h,y=o+c,y>_?(M=y-_,T=n-2*s+o,M>=T?(f=1,v=0,u=n+2*h+d):(f=M/T,v=1-f,u=f*(n*f+s*v+2*h)+v*(s*f+o*v+2*c)+d)):(f=0,y<=0?(v=1,u=o+2*c+d):c>=0?(v=0,u=d):(v=-c/o,u=c*v+d))):v<0?(m=6,_=s+c,y=n+h,y>_?(M=y-_,T=n-2*s+o,M>=T?(v=1,f=0,u=o+2*c+d):(v=M/T,f=1-v,u=f*(n*f+s*v+2*h)+v*(s*f+o*v+2*c)+d)):(v=0,y<=0?(f=1,u=n+2*h+d):h>=0?(f=0,u=d):(f=-h/n,u=h*f+d))):(m=1,M=o+c-s-h,M<=0?(f=0,v=1,u=o+2*c+d):(T=n-2*s+o,M>=T?(f=1,v=0,u=n+2*h+d):(f=M/T,v=1-f,u=f*(n*f+s*v+2*h)+v*(s*f+o*v+2*c)+d)))}return u<0&&(u=0),l&&(l[0]=a[0]+f*r[0]+v*i[0],l[1]=a[1]+f*r[1]+v*i[1],l[2]=a[2]+f*r[2]+v*i[2],l[3]=m),u}}(),Ae.distance2PointTriangle=function(){var e=[0,0,0],t=[0,0,0];return function(r,i,a,n,s){be.sub(e,a,i),be.sub(t,n,i);var o=be.sqrLen(e),l=be.dot(e,t),u=be.sqrLen(t);return Ae.distance2PointTriangleEdges(r,e,t,i,o,l,u,s)}}(),Ae.pointInsideTriangle=function(){var e=[0,0,0],t=[0,0,0],r=[0,0,0],i=[0,0,0],a=[0,0,0];return function(n,s,o,l){be.sub(e,s,o),be.sub(t,s,l),be.sub(r,n,o),be.sub(i,n,l);var u=be.len(be.cross(a,e,t)),h=be.len(be.cross(a,e,r)),c=be.len(be.cross(a,t,i)),d=be.len(be.cross(a,r,i));return Math.abs(u-(h+c+d))<1e-20}}(),Ae.triangleInsideSphere=function(e,t,r,i,a){return Ae.distanceSqToSegment(e,r,i)<t||(Ae.distanceSqToSegment(e,i,a)<t||Ae.distanceSqToSegment(e,r,a)<t)},Ae.distanceSqToSegment=function(){var e=[0,0,0],t=[0,0,0];return function(r,i,a){be.sub(e,r,i),be.sub(t,a,i);var n=be.sqrLen(t),s=be.dot(e,t)/n;return s<0?be.sqrLen(e):s>1?be.sqrLen(be.sub(e,r,a)):(e[0]=r[0]-i[0]-s*t[0],e[1]=r[1]-i[1]-s*t[1],e[2]=r[2]-i[2]-s*t[2],be.sqrLen(e))}}(),Ae.signedAngle2d=function(e,t){var r=e[0],i=e[1],a=t[0],n=t[1];return Math.atan2(r*n-i*a,r*a+i*n)},Ae.pointPlaneDistance=function(){var e=[0,0,0];return function(t,r,i){return be.dot(be.sub(e,t,r),i)}}(),Ae.mirrorPoint=function(){var e=[0,0,0];return function(t,r,i){return be.sub(t,t,be.scale(e,i,2*Ae.pointPlaneDistance(t,r,i)))}}(),Ae.vertexOnLine=function(){var e=[0,0,0];return function(t,r,i){be.sub(e,i,r);var a=[0,0,0],n=be.dot(e,be.sub(a,t,r));return be.scaleAndAdd(a,r,e,n/be.sqrLen(e))}}(),Ae.intersectLinePlane=function(e,t,r,i,a){var n=be.dot(be.sub(a,e,r),i),s=be.dot(be.sub(a,t,r),i);if(n===s)return t;var o=-n/(s-n);return be.scaleAndAdd(a,e,be.sub(a,t,e),o)},Ae.getPerpendicularVector=function(e){var t=[0,0,0];return 0===e[0]?t[0]=1:0===e[1]?t[1]=1:0===e[2]?t[2]=1:(t[0]=e[2],t[1]=e[2],t[2]=-e[0]-e[1],be.normalize(t,t)),t};var xe=i.vec2,ke=i.vec3,we=i.quat,Ee=function(e){function t(e){y(this,t);var r=b(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return r._radius=75,r._culling=!1,r._twistData={normal:[0,0,0],center:[0,0]},r._twistDataSym={normal:[0,0,0],center:[0,0]},r._idAlpha=0,r}return S(t,e),M(t,[{key:"startSculpt",value:function(){var e=this._main,t=e._mouseX,r=e._mouseY,i=e.getPicking();if(this.initTwistData(i,t,r,this._twistData),e.getSculptManager().getSymmetry()){var a=e.getPickingSymmetry();a.intersectionMouseMesh(),a.setLocalRadius2(i.getLocalRadius2()),a.getMesh()&&this.initTwistData(a,t,r,this._twistDataSym)}}},{key:"initTwistData",value:function(e,t,r,i){e.pickVerticesInSphere(e.getLocalRadius2()),ke.negate(i.normal,e.getEyeDirection()),xe.set(i.center,t,r)}},{key:"sculptStroke",value:function(){var e=this._main,t=e._mouseX,r=e._mouseY,i=e._lastMouseX,a=e._lastMouseY,n=e.getPicking(),s=n.getLocalRadius2();if(n.pickVerticesInSphere(s),this.stroke(n,t,r,i,a,this._twistData),e.getSculptManager().getSymmetry()){var o=e.getPickingSymmetry();o.getMesh()&&(o.pickVerticesInSphere(s),this.stroke(o,i,a,t,r,this._twistDataSym))}this.updateRender(),e.setCanvasCursor("default")}},{key:"stroke",value:function(e,t,r,i,a,n){var s=e.getPickedVertices();this._main.getStateManager().pushVertices(s),s=this.dynamicTopology(e),this._culling&&(s=this.getFrontVertices(s,e.getEyeDirection())),e.updateAlpha(!1),e.setIdAlpha(this._idAlpha),this.twist(s,e.getIntersectionPoint(),e.getLocalRadius2(),t,r,i,a,n,e);var o=this.getMesh();o.updateGeometry(o.getFacesFromVertices(s),s)}},{key:"twist",value:function(e,t,r,i,a,n,s,o,l){var u=this.getMesh(),h=o.center,c=[i-h[0],a-h[1]];if(!(xe.len(c)<30)){xe.normalize(c,c);var d=o.normal,g=[0,0,0,0],f=[n-h[0],s-h[1]];xe.normalize(f,f);for(var v=Ae.signedAngle2d(c,f),m=u.getVertices(),p=u.getMaterials(),_=1/Math.sqrt(r),y=t[0],M=t[1],T=t[2],S=[0,0,0],b=0,A=e.length;b<A;++b){var x=3*e[b],k=m[x],w=m[x+1],E=m[x+2],R=k-y,F=w-M,D=E-T,I=Math.sqrt(R*R+F*F+D*D)*_,C=I*I;C=3*C*C-4*C*I+1,C*=v*p[x+2]*l.getAlpha(k,w,E),we.setAxisAngle(g,d,C),ke.set(S,k,w,E),ke.sub(S,S,t),ke.transformQuat(S,S,g),ke.add(S,S,t),m[x]=S[0],m[x+1]=S[1],m[x+2]=S[2]}}}}]),t}(_e),Re=function(e){function t(e){y(this,t);var r=b(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return r._radius=50,r._intensity=.75,r._culling=!1,r._tangent=!1,r._idAlpha=0,r._lockPosition=!1,r}return S(t,e),M(t,[{key:"stroke",value:function(e){var t=e.getPickedVertices(),r=this._intensity*pe.getPressureIntensity();this._main.getStateManager().pushVertices(t),this._culling&&(t=this.getFrontVertices(t,e.getEyeDirection())),e.updateAlpha(this._lockPosition),e.setIdAlpha(this._idAlpha),this._tangent?this.smoothTangent(t,r,e):this.smooth(t,r,e);var i=this.getMesh();i.updateGeometry(i.getFacesFromVertices(t),t)}},{key:"smooth",value:function(e,t,r){var i=this.getMesh(),a=i.getVertices(),s=i.getMaterials(),o=e.length,l=new Float32Array(n.getMemory(4*o*3),0,3*o);this.laplacianSmooth(e,l);for(var u=0;u<o;++u){var h=3*e[u],c=a[h],d=a[h+1],g=a[h+2],f=3*u,v=t*s[h+2];r&&(v*=r.getAlpha(c,d,g));var m=1-v;a[h]=c*m+l[f]*v,a[h+1]=d*m+l[f+1]*v,a[h+2]=g*m+l[f+2]*v}}},{key:"smoothTangent",value:function(e,t,r){var i=this.getMesh(),a=i.getVertices(),s=i.getMaterials(),o=i.getNormals(),l=e.length,u=new Float32Array(n.getMemory(4*l*3),0,3*l);this.laplacianSmooth(e,u);for(var h=0;h<l;++h){var c=3*e[h],d=a[c],g=a[c+1],f=a[c+2],v=o[c],m=o[c+1],p=o[c+2],_=v*v+m*m+p*p;if(0!==_){_=1/Math.sqrt(_),v*=_,m*=_,p*=_;var y=3*h,M=u[y],T=u[y+1],S=u[y+2],b=v*(M-d)+m*(T-g)+p*(S-f),A=t*s[c+2];r&&(A*=r.getAlpha(d,g,f)),a[c]=d+(M-v*b-d)*A,a[c+1]=g+(T-m*b-g)*A,a[c+2]=f+(S-p*b-f)*A}}}},{key:"smoothAlongNormals",value:function(e,t,r){var i=this.getMesh(),a=i.getVertices(),s=i.getMaterials(),o=i.getNormals(),l=e.length,u=new Float32Array(n.getMemory(4*l*3),0,3*l);this.laplacianSmooth(e,u);for(var h=0;h<l;++h){var c=3*e[h],d=a[c],g=a[c+1],f=a[c+2],v=o[c],m=o[c+1],p=o[c+2],_=3*h,y=1/(v*v+m*m+p*p),M=v*(u[_]-d)+m*(u[_+1]-g)+p*(u[_+2]-f);M*=y*t*s[c+2],r&&(M*=r.getAlpha(d,g,f)),a[c]=d+v*M,a[c+1]=g+m*M,a[c+2]=f+p*M}}}]),t}(_e),Fe=function(e){function t(e){y(this,t);var r=b(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return r._radius=50,r._intensity=.75,r._negative=!1,r._culling=!1,r._idAlpha=0,r._lockPosition=!1,r}return S(t,e),M(t,[{key:"stroke",value:function(e){var t=e.getPickedVertices(),r=this._intensity*pe.getPressureIntensity();this._main.getStateManager().pushVertices(t),t=this.dynamicTopology(e),this._culling&&(t=this.getFrontVertices(t,e.getEyeDirection())),e.updateAlpha(this._lockPosition),e.setIdAlpha(this._idAlpha),this.pinch(t,e.getIntersectionPoint(),e.getLocalRadius2(),r,e);var i=this.getMesh();i.updateGeometry(i.getFacesFromVertices(t),t)}},{key:"pinch",value:function(e,t,r,i,a){var n=this.getMesh(),s=n.getVertices(),o=n.getMaterials(),l=Math.sqrt(r),u=t[0],h=t[1],c=t[2],d=.05*i;this._negative&&(d=-d);for(var g=0,f=e.length;g<f;++g){var v=3*e[g],m=s[v],p=s[v+1],_=s[v+2],y=u-m,M=h-p,T=c-_,S=Math.sqrt(y*y+M*M+T*T)/l,b=S*S;b=3*b*b-4*b*S+1,b*=d*o[v+2]*a.getAlpha(m,p,_),s[v]=m+y*b,s[v+1]=p+M*b,s[v+2]=_+T*b}}}]),t}(_e),De=function(e){function t(e){y(this,t);var r=b(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return r._radius=25,r._intensity=.75,r._negative=!0,r._culling=!1,r._idAlpha=0,r._lockPosition=!1,r}return S(t,e),M(t,[{key:"stroke",value:function(e){var t=e.getPickedVertices(),r=this._intensity*pe.getPressureIntensity();this.updateProxy(t),this._main.getStateManager().pushVertices(t),t=this.dynamicTopology(e),this._culling&&(t=this.getFrontVertices(t,e.getEyeDirection())),e.updateAlpha(this._lockPosition),e.setIdAlpha(this._idAlpha),this.crease(t,e.getPickedNormal(),e.getIntersectionPoint(),e.getLocalRadius2(),r,e);var i=this.getMesh();i.updateGeometry(i.getFacesFromVertices(t),t)}},{key:"crease",value:function(e,t,r,i,a,n){var s=this.getMesh(),o=s.getVertices(),l=s.getMaterials(),u=s.getVerticesProxy(),h=Math.sqrt(i),c=r[0],d=r[1],g=r[2],f=t[0],v=t[1],m=t[2],p=.07*a,_=p*h;this._negative&&(_=-_);for(var y=0,M=e.length;y<M;++y){var T=3*e[y],S=c-u[T],b=d-u[T+1],A=g-u[T+2],x=Math.sqrt(S*S+b*b+A*A)/h;if(!(x>=1)){var k=o[T],w=o[T+1],E=o[T+2],R=x*x;R=3*R*R-4*R*x+1,R*=l[T+2]*n.getAlpha(k,w,E);var F=Math.pow(R,5)*_;R*=p,o[T]=k+S*R+f*F,o[T+1]=w+b*R+v*F,o[T+2]=E+A*R+m*F}}}}]),t}(_e),Ie=i.vec3,Ce=i.mat4,Ne=function(e){function t(e){y(this,t);var r=b(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return r._radius=150,r._dragDir=[0,0,0],r._dragDirSym=[0,0,0],r._idAlpha=0,r}return S(t,e),M(t,[{key:"sculptStroke",value:function(){var e=this._main,t=this.getMesh(),r=e.getPicking(),i=e.getSculptManager().getSymmetry()?e.getPickingSymmetry():null,a=e._mouseX-this._lastMouseX,n=e._mouseY-this._lastMouseY,s=Math.sqrt(a*a+n*n),o=.15*this._radius,l=1/Math.floor(s/o);a*=l,n*=l;var u=this._lastMouseX,h=this._lastMouseY;if(r.getMesh()){r._mesh=t,i&&(i._mesh=t,Ie.copy(i.getIntersectionPoint(),r.getIntersectionPoint()),Ae.mirrorPoint(i.getIntersectionPoint(),t.getSymmetryOrigin(),t.getSymmetryNormal()));for(var c=0;c<1&&this.makeStroke(u,h,r,i);c+=l)u+=a,h+=n;this.updateRender(),this._lastMouseX=e._mouseX,this._lastMouseY=e._mouseY}}},{key:"makeStroke",value:function(e,t,r,i){var a=this.getMesh();return this.updateDragDir(r,e,t),r.pickVerticesInSphere(r.getLocalRadius2()),r.computePickedNormal(),a.isDynamic&&this.stroke(r,!1),i&&(this.updateDragDir(i,e,t,!0),i.setLocalRadius2(r.getLocalRadius2()),i.pickVerticesInSphere(i.getLocalRadius2())),a.isDynamic||this.stroke(r,!1),i&&this.stroke(i,!0),!0}},{key:"stroke",value:function(e,t){var r=e.getPickedVertices();this._main.getStateManager().pushVertices(r),r=this.dynamicTopology(e),e.updateAlpha(this._lockPosition),e.setIdAlpha(this._idAlpha),this.drag(r,e.getIntersectionPoint(),e.getLocalRadius2(),t,e);var i=this.getMesh();i.updateGeometry(i.getFacesFromVertices(r),r)}},{key:"drag",value:function(e,t,r,i,a){for(var n=this.getMesh(),s=n.getVertices(),o=n.getMaterials(),l=Math.sqrt(r),u=t[0],h=t[1],c=t[2],d=i?this._dragDirSym:this._dragDir,g=d[0],f=d[1],v=d[2],m=0,p=e.length;m<p;++m){var _=3*e[m],y=s[_],M=s[_+1],T=s[_+2],S=y-u,b=M-h,A=T-c,x=Math.sqrt(S*S+b*b+A*A)/l,k=x*x;k=3*k*k-4*k*x+1,k*=o[_+2]*a.getAlpha(y,M,T),s[_]=y+g*k,s[_+1]=M+f*k,s[_+2]=T+v*k}}},{key:"updateDragDir",value:function(e,t,r,i){var a=this.getMesh(),n=e.unproject(t,r,0),s=e.unproject(t,r,.1),o=Ce.create();Ce.invert(o,a.getMatrix()),Ie.transformMat4(n,n,o),Ie.transformMat4(s,s,o);var l=this._dragDir;if(i){l=this._dragDirSym;var u=a.getSymmetryOrigin(),h=a.getSymmetryNormal();Ae.mirrorPoint(n,u,h),Ae.mirrorPoint(s,u,h)}var c=e.getIntersectionPoint();e.setIntersectionPoint(Ae.vertexOnLine(c,n,s)),Ie.sub(l,e.getIntersectionPoint(),c),e._mesh=a,e.updateLocalAndWorldRadius2();var d=e.getEyeDirection();Ie.sub(d,s,n),Ie.normalize(d,d)}}]),t}(_e),Ve=i.vec3,Pe=function(e){function t(e){y(this,t);var r=b(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return r._radius=50,r._hardness=.75,r._intensity=.75,r._culling=!1,r._color=Ve.fromValues(1,.766,.336),r._material=Ve.fromValues(.3,.95,0),r._pickColor=!1,r._pickCallback=null,r._idAlpha=0,r._lockPosition=!1,r}return S(t,e),M(t,[{key:"end",value:function(){this._pickColor=!1,T(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"end",this).call(this)}},{key:"pushState",value:function(e){this._pickColor&&!e||this._main.getStateManager().pushStateColorAndMaterial(this.getMesh())}},{key:"startSculpt",value:function(){return this._pickColor?this.pickColor(this._main.getPicking()):void T(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"startSculpt",this).call(this)}},{key:"update",value:function(e){return this._pickColor===!0?this.updatePickColor():void T(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"update",this).call(this,e)}},{key:"updateContinuous",value:function(){return this._pickColor===!0?this.updatePickColor():void T(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"updateContinuous",this).call(this)}},{key:"updateMeshBuffers",value:function(){var e=this.getMesh();e.isDynamic?e.updateBuffers():(e.updateColorBuffer(),e.updateMaterialBuffer())}},{key:"updatePickColor",value:function(){var e=this._main.getPicking();e.intersectionMouseMesh()&&this.pickColor(e)}},{key:"setPickCallback",value:function(e){this._pickCallback=e}},{key:"pickColor",value:function(e){var t=this.getMesh(),r=this._color;e.polyLerp(t.getMaterials(),r);var i=r[0],a=r[1];e.polyLerp(t.getColors(),r),this._pickCallback(r,i,a)}},{key:"stroke",value:function(e){var t=e.getPickedVertices(),r=this._intensity*pe.getPressureIntensity();this._main.getStateManager().pushVertices(t),t=this.dynamicTopology(e),this._culling&&(t=this.getFrontVertices(t,e.getEyeDirection())),e.updateAlpha(this._lockPosition),e.setIdAlpha(this._idAlpha),this.paint(t,e.getIntersectionPoint(),e.getLocalRadius2(),r,this._hardness,e);var i=this.getMesh();i.updateDuplicateColorsAndMaterials(t),i.isUsingDrawArrays()&&i.updateDrawArrays(i.getFacesFromVertices(t))}},{key:"paint",value:function(e,t,r,i,a,n){for(var s=this.getMesh(),o=s.getVertices(),l=s.getColors(),u=s.getMaterials(),h=this._color,c=this._material[0],d=this._material[1],g=Math.sqrt(r),f=h[0],v=h[1],m=h[2],p=t[0],_=t[1],y=t[2],M=2*(1-a),T=0,S=e.length;T<S;++T){var b=3*e[T],A=o[b],x=o[b+1],k=o[b+2],w=A-p,E=x-_,R=k-y,F=Math.sqrt(w*w+E*E+R*R)/g,D=Math.pow(1-F,M);D*=i*u[b+2]*n.getAlpha(A,x,k);var I=1-D;l[b]=l[b]*I+f*D,l[b+1]=l[b+1]*I+v*D,l[b+2]=l[b+2]*I+m*D,u[b]=u[b]*I+c*D,u[b+1]=u[b+1]*I+d*D}}},{key:"paintAll",value:function(){var e=this.getMesh(),t=this.getUnmaskedVertices();if(0!==t.length){this.pushState(!0),this._main.getStateManager().pushVertices(t);for(var r=e.getColors(),i=e.getMaterials(),a=this._color,n=this._material[0],s=this._material[1],o=a[0],l=a[1],u=a[2],h=0,c=t.length;h<c;++h){var d=3*t[h],g=i[d+2],f=1-g;r[d]=r[d]*f+o*g,r[d+1]=r[d+1]*f+l*g,r[d+2]=r[d+2]*f+u*g,i[d]=i[d]*f+n*g,i[d+1]=i[d+1]*f+s*g}e.updateDuplicateColorsAndMaterials(),e.updateDrawArrays(),this.updateRender()}}}]),t}(_e),Le=i.vec3,Ue=i.mat4,Be=function(e){function t(e){y(this,t);var r=b(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return r._radius=150,r._intensity=1,r._topoCheck=!0,r._negative=!1,r._moveData={center:[0,0,0],dir:[0,0],vProxy:null},r._moveDataSym={center:[0,0,0],dir:[0,0],vProxy:null},r._idAlpha=0,r}return S(t,e),M(t,[{key:"startSculpt",value:function(){var e=this._main,t=e.getPicking();if(this.initMoveData(t,this._moveData),e.getSculptManager().getSymmetry()){var r=e.getPickingSymmetry();r.intersectionMouseMesh(),r.setLocalRadius2(t.getLocalRadius2()),r.getMesh()&&this.initMoveData(r,this._moveDataSym)}}},{key:"initMoveData",value:function(e,t){this._topoCheck?e.pickVerticesInSphereTopological(e.getLocalRadius2()):e.pickVerticesInSphere(e.getLocalRadius2()),Le.copy(t.center,e.getIntersectionPoint());var r=e.getPickedVertices();this._main.getStateManager().pushVertices(r);for(var i=e.getMesh().getVertices(),a=r.length,n=t.vProxy=new Float32Array(3*a),s=0;s<a;++s){var o=3*r[s],l=3*s;n[l]=i[o],n[l+1]=i[o+1],n[l+2]=i[o+2]}}},{key:"copyVerticesProxy",value:function(e,t){for(var r=e.getPickedVertices(),i=this.getMesh().getVertices(),a=t.vProxy,n=0,s=r.length;n<s;++n){var o=3*r[n],l=3*n;i[o]=a[l],i[o+1]=a[l+1],i[o+2]=a[l+2]}}},{key:"sculptStroke",value:function(){var e=this._main,t=e.getPicking(),r=e.getPickingSymmetry(),i=e.getSculptManager().getSymmetry()&&r.getMesh();t.updateAlpha(this._lockPosition),t.setIdAlpha(this._idAlpha),i&&(r.updateAlpha(!1),r.setIdAlpha(this._idAlpha)),this.copyVerticesProxy(t,this._moveData),i&&this.copyVerticesProxy(r,this._moveDataSym);var a=e._mouseX,n=e._mouseY;this.updateMoveDir(t,a,n),this.move(t.getPickedVertices(),t.getIntersectionPoint(),t.getLocalRadius2(),this._moveData,t),i&&(this.updateMoveDir(r,a,n,!0),this.move(r.getPickedVertices(),r.getIntersectionPoint(),r.getLocalRadius2(),this._moveDataSym,r));var s=this.getMesh();s.updateGeometry(s.getFacesFromVertices(t.getPickedVertices()),t.getPickedVertices()),i&&s.updateGeometry(s.getFacesFromVertices(r.getPickedVertices()),r.getPickedVertices()),this.updateRender(),e.setCanvasCursor("default")}},{key:"move",value:function(e,t,r,i,a){for(var n=this.getMesh(),s=n.getVertices(),o=n.getMaterials(),l=Math.sqrt(r),u=i.vProxy,h=t[0],c=t[1],d=t[2],g=i.dir,f=g[0],v=g[1],m=g[2],p=0,_=e.length;p<_;++p){var y=3*e[p],M=3*p,T=u[M],S=u[M+1],b=u[M+2],A=T-h,x=S-c,k=b-d,w=Math.sqrt(A*A+x*x+k*k)/l,E=w*w;E=3*E*E-4*E*w+1,E*=o[y+2]*a.getAlpha(T,S,b),s[y]+=f*E,s[y+1]+=v*E,s[y+2]+=m*E}}},{key:"updateMoveDir",value:function(e,t,r,i){var a=this.getMesh(),n=e.unproject(t,r,0),s=e.unproject(t,r,.1),o=Ue.create();Ue.invert(o,a.getMatrix()),Le.transformMat4(n,n,o),Le.transformMat4(s,s,o);var l=i?this._moveDataSym:this._moveData;if(i){var u=a.getSymmetryOrigin(),h=a.getSymmetryNormal();Ae.mirrorPoint(n,u,h),Ae.mirrorPoint(s,u,h)}if(this._negative){var c=Le.dist(Ae.vertexOnLine(l.center,n,s),l.center);Le.normalize(l.dir,e.computePickedNormal()),Le.scale(l.dir,l.dir,t<this._lastMouseX?-c:c)}else Le.sub(l.dir,Ae.vertexOnLine(l.center,n,s),l.center);Le.scale(l.dir,l.dir,this._intensity);var d=e.getEyeDirection();Le.sub(d,s,n),Le.normalize(d,d)}}]),t}(_e),Oe=function(){function e(t){y(this,e),this._parent=t?t:null,this._depth=t?t._depth+1:0,this._children=[],this._aabbLoose=[1/0,1/0,1/0,-(1/0),-(1/0),-(1/0)],this._aabbSplit=[1/0,1/0,1/0,-(1/0),-(1/0),-(1/0)],this._iFaces=[],this._flag=0}return M(e,[{key:"resetNbFaces",value:function(e){var t=this._iFaces;t.length=e;for(var r=0;r<e;++r)t[r]=r}},{key:"build",value:function(t){var r=0,i=e.STACK;i[0]=this;for(var a=1,n=[];a>0;){var s=i[--a],o=s._iFaces.length;if(o>e.MAX_FACES&&s._depth<e.MAX_DEPTH){s.constructChildren(t);var l=s._children;for(r=0;r<8;++r)i[a+r]=l[r];a+=8}else o>0&&n.push(s)}var u=n.length;for(r=0;r<u;++r)n[r].constructLeaf(t)}},{key:"constructLeaf",value:function(e){for(var t=this._iFaces,r=t.length,i=1/0,a=1/0,n=1/0,s=-(1/0),o=-(1/0),l=-(1/0),u=e.getFaceBoxes(),h=e.getFacePosInLeaf(),c=e.getFaceLeaf(),d=0;d<r;++d){var g=t[d];c[g]=this,h[g]=d,g*=6;var f=u[g],v=u[g+1],m=u[g+2],p=u[g+3],_=u[g+4],y=u[g+5];f<i&&(i=f),p>s&&(s=p),v<a&&(a=v),_>o&&(o=_),m<n&&(n=m),y>l&&(l=y)}this.expandsAabbLoose(i,a,n,s,o,l)}},{key:"constructChildren",value:function(t){for(var r=this._aabbSplit,i=r[0],a=r[1],n=r[2],s=r[3],o=r[4],l=r[5],u=.5*(s-i),h=.5*(o-a),c=.5*(l-n),d=.5*(s+i),g=.5*(o+a),f=.5*(l+n),v=new e(this),m=new e(this),p=new e(this),_=new e(this),y=new e(this),M=new e(this),T=new e(this),S=new e(this),b=v._iFaces,A=m._iFaces,x=p._iFaces,k=_._iFaces,w=y._iFaces,E=M._iFaces,R=T._iFaces,F=S._iFaces,D=t.getFaceCenters(),I=this._iFaces,C=I.length,N=0;N<C;++N){var V=I[N],P=3*V,L=D[P],U=D[P+1],B=D[P+2];L>d?U>g?B>f?R.push(V):E.push(V):B>f?x.push(V):A.push(V):U>g?B>f?F.push(V):w.push(V):B>f?k.push(V):b.push(V)}v.setAabbSplit(i,a,n,d,g,f),m.setAabbSplit(i+u,a,n,d+u,g,f),p.setAabbSplit(d,g-h,f,s,o-h,l),_.setAabbSplit(i,a,n+c,d,g,f+c),y.setAabbSplit(i,a+h,n,d,g+h,f),M.setAabbSplit(d,g,f-c,s,o,l-c),T.setAabbSplit(d,g,f,s,o,l),S.setAabbSplit(d-u,g,f,s-u,o,l),this._children.length=0,this._children.push(v,m,p,_,y,M,T,S),I.length=0}},{key:"setAabbSplit",value:function(e,t,r,i,a,n){var s=this._aabbSplit;s[0]=e,s[1]=t,s[2]=r,s[3]=i,s[4]=a,s[5]=n}},{key:"setAabbLoose",value:function(e,t,r,i,a,n){var s=this._aabbLoose;s[0]=e,s[1]=t,s[2]=r,s[3]=i,s[4]=a,s[5]=n}},{key:"collectIntersectRay",value:function(t,r,i,a){var n=t[0],s=t[1],o=t[2],l=1/r[0],u=1/r[1],h=1/r[2],c=0,d=e.STACK;d[0]=this;for(var g=1;g>0;){var f=d[--g],v=f._aabbLoose,m=(v[0]-n)*l,p=(v[3]-n)*l,_=(v[1]-s)*u,y=(v[4]-s)*u,M=(v[2]-o)*h,T=(v[5]-o)*h,S=Math.max(Math.min(m,p),Math.min(_,y),Math.min(M,T)),b=Math.min(Math.max(m,p),Math.max(_,y),Math.max(M,T));if(!(b<0||S>b)){var A=f._children;if(8===A.length){for(var x=0;x<8;++x)d[g+x]=A[x];g+=8}else{a&&a.push(f);var k=f._iFaces;i.set(k,c),c+=k.length}}}return new Uint32Array(i.subarray(0,c))}},{key:"collectIntersectSphere",value:function(t,r,i,a){var n=t[0],s=t[1],o=t[2],l=0,u=e.STACK;u[0]=this;for(var h=1;h>0;){var c=u[--h],d=c._aabbLoose,g=0,f=0,v=0;if(g=d[0]>n?d[0]-n:d[3]<n?d[3]-n:0,f=d[1]>s?d[1]-s:d[4]<s?d[4]-s:0,v=d[2]>o?d[2]-o:d[5]<o?d[5]-o:0,!(g*g+f*f+v*v>r)){var m=c._children;if(8===m.length){for(var p=0;p<8;++p)u[h+p]=m[p];h+=8}else{a&&a.push(c);var _=c._iFaces;i.set(_,l),l+=_.length}}}return new Uint32Array(i.subarray(0,l))}},{key:"addFace",value:function(t,r,i,a,n,s,o,l,u,h){var c=e.STACK;c[0]=this;for(var d=1;d>0;){var g=c[--d],f=g._aabbSplit;if(!(l<=f[0]||u<=f[1]||h<=f[2]||l>f[3]||u>f[4]||h>f[5])){var v=g._aabbLoose;r<v[0]&&(v[0]=r),i<v[1]&&(v[1]=i),a<v[2]&&(v[2]=a),n>v[3]&&(v[3]=n),s>v[4]&&(v[4]=s),o>v[5]&&(v[5]=o);var m=g._children;if(8!==m.length)return g._iFaces.push(t),g;for(var p=0;p<8;++p)c[d+p]=m[p];d+=8}}}},{key:"pruneIfPossible",value:function(){for(var e=this;e._parent;){var t=e._parent,r=t._children;if(0===r.length)return;for(var i=0;i<8;++i){var a=r[i];if(a._iFaces.length>0||8===a._children.length)return}r.length=0,e=t}}},{key:"expandsAabbLoose",value:function(e,t,r,i,a,n){for(var s=this;s;){var o=s._aabbLoose,l=!1;e<o[0]&&(o[0]=e,l=!0),t<o[1]&&(o[1]=t,l=!0),r<o[2]&&(o[2]=r,l=!0),i>o[3]&&(o[3]=i,l=!0),a>o[4]&&(o[4]=a,l=!0),n>o[5]&&(o[5]=n,l=!0),s=l?s._parent:null}}}]),e}();Oe.FLAG=0,Oe.MAX_DEPTH=8,Oe.MAX_FACES=100,function(){for(var e=1+7*Oe.MAX_DEPTH,t=Oe.STACK=new Array(e),r=0;r<e;++r)t[r]=null}();var Ge=function(e){var t=_();return{_gl:e,_shaderType:t.shader,_flatShading:t.flatshading,_showWireframe:t.wireframe,_matcap:Math.min(t.matcap,H.matcaps.length-1),_curvature:Math.min(t.curvature,5),_texture0:null,_useDrawArrays:!1,_vertexBuffer:new A(e,e.ARRAY_BUFFER,e.DYNAMIC_DRAW),_normalBuffer:new A(e,e.ARRAY_BUFFER,e.DYNAMIC_DRAW),_colorBuffer:new A(e,e.ARRAY_BUFFER,e.DYNAMIC_DRAW),_materialBuffer:new A(e,e.ARRAY_BUFFER,e.DYNAMIC_DRAW),_texCoordBuffer:new A(e,e.ARRAY_BUFFER,e.STATIC_DRAW),_indexBuffer:new A(e,e.ELEMENT_ARRAY_BUFFER,e.STATIC_DRAW),_wireframeBuffer:new A(e,e.ELEMENT_ARRAY_BUFFER,e.STATIC_DRAW),_albedo:new Float32Array([-1,-1,-1]),_roughness:-.18,_metallic:-.78,_alpha:1,_flatColor:new Float32Array([1,0,0]),_mode:e.TRIANGLES}};Ge.ONLY_DRAW_ARRAYS=!1;var ze=i.vec3,Xe=i.mat3,We=i.mat4,Ye=function(){function e(){y(this,e),this._id=e.ID++,this._meshData=null,this._transformData=null,this._renderData=null}return M(e,[{key:"setID",value:function(e){this._id=e}},{key:"setVertices",value:function(e){this._meshData._verticesXYZ=e,this._meshData._nbVertices=e.length/3}},{key:"setFaces",value:function(e){this._meshData._facesABCD=e,this._meshData._nbFaces=e.length/4}},{key:"setTexCoords",value:function(e){this._meshData._texCoordsST=e,this._meshData._nbTexCoords=e.length/2}},{key:"setColors",value:function(e){this._meshData._colorsRGB=e}},{key:"setMaterials",value:function(e){this._meshData._materialsPBR=e}},{key:"setVerticesDuplicateStartCount",value:function(e){this._meshData._duplicateStartCount=e}},{key:"setFacesTexCoord",value:function(e){this._meshData._UVfacesABCD=e}},{key:"setMeshData",value:function(e){this._meshData=e}},{key:"setRenderData",value:function(e){this._renderData=e}},{key:"setTransformData",value:function(e){this._transformData=e}},{key:"setNbVertices",value:function(e){this._meshData._nbVertices=e}},{key:"setNbFaces",value:function(e){this._meshData._nbFaces=e}},{key:"getID",value:function(){return this._id}},{key:"getRenderData",value:function(){return this._renderData}},{key:"getMeshData",value:function(){return this._meshData}},{key:"getTransformData",value:function(){return this._transformData}},{key:"getNbVertices",value:function(){return this._meshData._nbVertices}},{key:"getNbFaces",value:function(){return this._meshData._nbFaces}},{key:"getNbQuads",value:function(){return this.getNbTriangles()-this.getNbFaces()}},{key:"getNbTriangles",value:function(){return this._meshData._trianglesABC.length/3}},{key:"getNbTexCoords",value:function(){return this._meshData._nbTexCoords}},{key:"hasUV",value:function(){return null!==this._meshData._texCoordsST}},{key:"getVertices",value:function(){return this._meshData._verticesXYZ}},{key:"getColors",value:function(){return this._meshData._colorsRGB}},{key:"getNormals",value:function(){return this._meshData._normalsXYZ}},{key:"getMaterials",value:function(){return this._meshData._materialsPBR}},{key:"getVerticesTagFlags",value:function(){return this._meshData._vertTagFlags}},{key:"getVerticesSculptFlags",value:function(){return this._meshData._vertSculptFlags}},{key:"getVerticesStateFlags",value:function(){return this._meshData._vertStateFlags}},{key:"getVerticesRingVertStartCount",value:function(){return this._meshData._vrvStartCount}},{key:"getVerticesRingVert",value:function(){return this._meshData._vertRingVert}},{key:"getVerticesRingFaceStartCount",value:function(){return this._meshData._vrfStartCount;
}},{key:"getVerticesRingFace",value:function(){return this._meshData._vertRingFace}},{key:"getVerticesOnEdge",value:function(){return this._meshData._vertOnEdge}},{key:"getVerticesProxy",value:function(){return this._meshData._vertProxy}},{key:"getFaces",value:function(){return this._meshData._facesABCD}},{key:"hasOnlyTriangles",value:function(){return this.getNbTriangles()===this.getNbFaces()}},{key:"hasOnlyQuads",value:function(){return this.getNbTriangles()===2*this.getNbFaces()}},{key:"getFaceNormals",value:function(){return this._meshData._faceNormalsXYZ}},{key:"getFaceBoxes",value:function(){return this._meshData._faceBoxes}},{key:"getFaceCenters",value:function(){return this._meshData._faceCentersXYZ}},{key:"getFacesTagFlags",value:function(){return this._meshData._facesTagFlags}},{key:"getFaceEdges",value:function(){return this._meshData._faceEdges}},{key:"getFacesToTriangles",value:function(){return this._meshData._facesToTriangles}},{key:"getTrianglesTexCoord",value:function(){return this._meshData._UVtrianglesABC}},{key:"getTriangles",value:function(){return this._meshData._trianglesABC}},{key:"getEdges",value:function(){return this._meshData._edges}},{key:"getNbEdges",value:function(){return this._meshData._edges.length}},{key:"getTexCoords",value:function(){return this._meshData._texCoordsST}},{key:"getVerticesDuplicateStartCount",value:function(){return this._meshData._duplicateStartCount}},{key:"getFacesTexCoord",value:function(){return this._meshData._UVfacesABCD}},{key:"getVerticesDrawArrays",value:function(){return this._meshData._DAverticesXYZ||this.updateDrawArrays(),this._meshData._DAverticesXYZ}},{key:"getNormalsDrawArrays",value:function(){return this._meshData._DAnormalsXYZ}},{key:"getColorsDrawArrays",value:function(){return this._meshData._DAcolorsRGB}},{key:"getMaterialsDrawArrays",value:function(){return this._meshData._DAmaterialsPBR}},{key:"getTexCoordsDrawArrays",value:function(){return this._meshData._DAtexCoordsST}},{key:"getOctree",value:function(){return this._meshData._octree}},{key:"getCenter",value:function(){return this._transformData._center}},{key:"getMV",value:function(){return this._transformData._lastComputedMV}},{key:"getMVP",value:function(){return this._transformData._lastComputedMVP}},{key:"getN",value:function(){return this._transformData._lastComputedN}},{key:"getEN",value:function(){return this._transformData._lastComputedEN}},{key:"getDepth",value:function(){return this._transformData._lastComputedDepth}},{key:"getMatrix",value:function(){return this._transformData._matrix}},{key:"getEditMatrix",value:function(){return this._transformData._editMatrix}},{key:"getScale2",value:function(){var e=this._transformData._matrix;return e[0]*e[0]+e[4]*e[4]+e[8]*e[8]}},{key:"getScale",value:function(){return Math.sqrt(this.getScale2())}},{key:"getSymmetryOrigin",value:function(){return this._transformData._center}},{key:"getSymmetryNormal",value:function(){return this._transformData._symmetryNormal}},{key:"getFacePosInLeaf",value:function(){return this._meshData._facePosInLeaf}},{key:"getFaceLeaf",value:function(){return this._meshData._faceLeaf}},{key:"getLeavesToUpdate",value:function(){return this._meshData._leavesToUpdate}},{key:"getLocalBound",value:function(){return this._meshData._octree._aabbLoose}},{key:"getRenderNbEdges",value:function(){return this.getNbEdges()}},{key:"init",value:function(){this.initColorsAndMaterials(),this.allocateArrays(),this.initTopology(),this.updateGeometry(),this._renderData&&this.updateDuplicateColorsAndMaterials(),this.updateCenter()}},{key:"initTopology",value:function(){this.initFaceRings(),this.optimize(),this.initEdges(),this.initVertexRings(),this.initRenderTriangles()}},{key:"updateGeometry",value:function(e,t){this.updateFacesAabbAndNormal(e),this.updateVerticesNormal(t),this.updateOctree(e),this._renderData&&(this.updateDuplicateGeometry(t),this.updateDrawArrays(e))}},{key:"allocateArrays",value:function(){var e=this.getNbVertices();if(this.hasUV()){var t=this._meshData._texCoordsST.length/2,r=new Float32Array(3*t);r.set(this._meshData._verticesXYZ),this._meshData._verticesXYZ=r,this._meshData._normalsXYZ=new Float32Array(3*t),r=new Float32Array(3*t),this._meshData._colorsRGB&&r.set(this._meshData._colorsRGB),this._meshData._colorsRGB=r,r=new Float32Array(3*t),this._meshData._materialsPBR&&r.set(this._meshData._materialsPBR),this._meshData._materialsPBR=r}else this._meshData._normalsXYZ=this._meshData._normalsXYZ||new Float32Array(3*e),this._meshData._colorsRGB=this._meshData._colorsRGB||new Float32Array(3*e),this._meshData._materialsPBR=this._meshData._materialsPBR||new Float32Array(3*e);this._meshData._vertOnEdge=new Uint8Array(e),this._meshData._vrvStartCount=new Uint32Array(2*e),this._meshData._vrfStartCount=new Uint32Array(2*e),this._meshData._vertTagFlags=new Int32Array(e),this._meshData._vertSculptFlags=new Int32Array(e),this._meshData._vertStateFlags=new Int32Array(e),this._meshData._vertProxy=new Float32Array(3*e);var i=this.getNbFaces();this._meshData._faceEdges=new Uint32Array(4*i),this._meshData._facesToTriangles=new Uint32Array(i),this._meshData._faceBoxes=new Float32Array(6*i),this._meshData._faceNormalsXYZ=new Float32Array(3*i),this._meshData._faceCentersXYZ=new Float32Array(3*i),this._meshData._facesTagFlags=new Int32Array(i),this._meshData._facePosInLeaf=new Uint32Array(i);var a=this._meshData._faceLeaf;a.length=i;for(var n=0;n<i;++n)a[n]=null}},{key:"initColorsAndMaterials",value:function(){var e=this.getNbVertices(),t=0,r=3*e;if(!this._meshData._colorsRGB||this._meshData._colorsRGB.length!==r){var i=this._meshData._colorsRGB=new Float32Array(r);for(t=0;t<r;++t)i[t]=1}if(!this._meshData._materialsPBR||this._meshData._materialsPBR.length!==r){var a=this._meshData._materialsPBR=new Float32Array(r);for(t=0;t<r;++t){var n=3*t;a[n]=.18,a[n+1]=.08,a[n+2]=1}}}},{key:"initFaceRings",value:function(){var e=this.getFaces(),t=this.getNbVertices(),r=this.getNbFaces(),i=0,a=0,s=new Uint32Array(t);for(i=0;i<r;++i){a=4*i,s[e[a]]++,s[e[a+1]]++,s[e[a+2]]++;var o=e[a+3];o!==n.TRI_INDEX&&s[o]++}var l=this.getVerticesRingFaceStartCount(),u=0;for(i=0;i<t;++i){var h=s[i];l[2*i]=u,l[2*i+1]=h,u+=h}var c=new Uint32Array(n.getMemory(4*r*6),0,6*r);for(u=0,i=0;i<r;++i){a=4*i;var d=e[a],g=e[a+1],f=e[a+2],v=e[a+3];c[l[2*d]+--s[d]]=i,c[l[2*g]+--s[g]]=i,c[l[2*f]+--s[f]]=i,v!==n.TRI_INDEX&&(c[l[2*v]+--s[v]]=i,++u)}this._meshData._vertRingFace=new Uint32Array(c.subarray(0,3*r+u))}},{key:"updateVerticesNormal",value:function(e){for(var t=this.getVerticesRingFaceStartCount(),r=this.getVerticesRingFace(),i=r instanceof Array?r:null,a=this.getNormals(),n=this.getFaceNormals(),s=void 0===e,o=s?this.getNbVertices():e.length,l=0;l<o;++l){var u,h,c=s?l:e[l];i?(r=i[c],u=0,h=r.length):(u=t[2*c],h=u+t[2*c+1]);for(var d=0,g=0,f=0,v=u;v<h;++v){var m=3*r[v];d+=n[m],g+=n[m+1],f+=n[m+2]}var p=h-u;0!==p&&(p=1/p),c*=3,a[c]=d*p,a[c+1]=g*p,a[c+2]=f*p}}},{key:"initVertexRings",value:function(){for(var e=this.getVerticesRingVertStartCount(),t=this._meshData._vertRingVert=new Uint32Array(2*this.getNbEdges()),r=this.getVerticesRingFaceStartCount(),i=this.getVerticesRingFace(),a=this.getVerticesTagFlags(),s=this.getVerticesOnEdge(),o=this.getFaces(),l=0,u=0,h=this.getNbVertices();u<h;++u){for(var c=++n.TAG_FLAG,d=r[2*u],g=d+r[2*u+1],f=0,v=d;v<g;++v){var m=4*i[v],p=o[m],_=o[m+1],y=o[m+2],M=o[m+3];p===u?p=M!==n.TRI_INDEX?M:y:_===u||M===u?_=y:y===u&&M!==n.TRI_INDEX&&(p=M),a[p]!==c&&(t[l+f++]=p,a[p]=c),a[_]!==c&&(t[l+f++]=_,a[_]=c)}e[2*u]=l,e[2*u+1]=f,l+=f,g-d!==f&&(s[u]=1)}}},{key:"expandsVertices",value:function(e,t){var r=++n.TAG_FLAG,i=e.length,a=this.getVerticesRingVertStartCount(),s=this.getVerticesRingVert(),o=s instanceof Array?s:null,l=this.getVerticesTagFlags(),u=i,h=this.getNbVertices(),c=new Uint32Array(n.getMemory(4*h),0,h);c.set(e);var d=0;for(d=0;d<i;++d)l[c[d]]=r;for(var g=0;t;){for(--t,d=g;d<i;++d){var f,v,m=c[d];o?(s=o[m],f=0,v=s.length):(f=a[2*m],v=f+a[2*m+1]);for(var p=f;p<v;++p){var _=s[p];l[_]!==r&&(l[_]=r,c[u++]=_)}}g=i,i=u}return new Uint32Array(c.subarray(0,u))}},{key:"getVerticesFromFaces",value:function(e){for(var t=++n.TAG_FLAG,r=e.length,i=this.getVerticesTagFlags(),a=this.getFaces(),s=0,o=new Uint32Array(n.getMemory(4*e.length*4),0,4*e.length),l=0;l<r;++l){var u=4*e[l],h=a[u],c=a[u+1],d=a[u+2],g=a[u+3];i[h]!==t&&(i[h]=t,o[s++]=h),i[c]!==t&&(i[c]=t,o[s++]=c),i[d]!==t&&(i[d]=t,o[s++]=d),g!==n.TRI_INDEX&&i[g]!==t&&(i[g]=t,o[s++]=g)}return new Uint32Array(o.subarray(0,s))}},{key:"updateFacesAabbAndNormal",value:function(e){for(var t=this.getFaceNormals(),r=this.getFaceBoxes(),i=this.getFaceCenters(),a=this.getVertices(),s=this.getFaces(),o=void 0===e,l=o?this.getNbFaces():e.length,u=0;u<l;++u){var h=o?u:e[u],c=3*h,d=4*h,g=6*h,f=3*s[d],v=3*s[d+1],m=3*s[d+2],p=s[d+3],_=p!==n.TRI_INDEX;_&&(p*=3);var y=a[f],M=a[f+1],T=a[f+2],S=a[v],b=a[v+1],A=a[v+2],x=a[m],k=a[m+1],w=a[m+2],E=S-y,R=b-M,F=A-T,D=x-y,I=k-M,C=w-T,N=R*C-F*I,V=F*D-E*C,P=E*I-R*D,L=y<S?y<x?y:x:S<x?S:x,U=y>S?y>x?y:x:S>x?S:x,B=M<b?M<k?M:k:b<k?b:k,O=M>b?M>k?M:k:b>k?b:k,G=T<A?T<w?T:w:A<w?A:w,z=T>A?T>w?T:w:A>w?A:w;if(_){var X=a[p],W=a[p+1],Y=a[p+2];X<L&&(L=X),X>U&&(U=X),W<B&&(B=W),W>O&&(O=W),Y<G&&(G=Y),Y>z&&(z=Y),E=x-X,R=k-W,F=w-Y,N+=R*C-F*I,V+=F*D-E*C,P+=E*I-R*D}t[c]=N,t[c+1]=V,t[c+2]=P,r[g]=L,r[g+1]=B,r[g+2]=G,r[g+3]=U,r[g+4]=O,r[g+5]=z,i[c]=.5*(L+U),i[c+1]=.5*(B+O),i[c+2]=.5*(G+z)}}},{key:"expandsFaces",value:function(e,t){var r=++n.TAG_FLAG,i=e.length,a=this.getVerticesRingFaceStartCount(),s=this.getVerticesRingFace(),o=s instanceof Array?s:null,l=this.getFacesTagFlags(),u=this.getFaces(),h=i,c=new Uint32Array(n.getMemory(4*this.getNbFaces()),0,this.getNbFaces());c.set(e);var d=0;for(d=0;d<i;++d)l[c[d]]=r;for(var g=0;t;){for(--t,d=g;d<i;++d)for(var f=4*c[d],v=0;v<4;++v){var m=u[f+v];if(m!==n.TRI_INDEX){var p,_;o?(s=o[m],p=0,_=s.length):(p=a[2*m],_=p+a[2*m+1]);for(var y=p;y<_;++y){var M=s[y];l[M]!==r&&(l[M]=r,c[h++]=M)}}}g=i,i=h}return new Uint32Array(c.subarray(0,h))}},{key:"getFacesFromVertices",value:function(e){for(var t=++n.TAG_FLAG,r=e.length,i=this.getVerticesRingFaceStartCount(),a=this.getVerticesRingFace(),s=a instanceof Array?a:null,o=this.getFacesTagFlags(),l=0,u=new Uint32Array(n.getMemory(4*this.getNbFaces()),0,this.getNbFaces()),h=0;h<r;++h){var c,d,g=e[h];s?(a=s[g],c=0,d=a.length):(c=i[2*g],d=c+i[2*g+1]);for(var f=c;f<d;++f){var v=a[f];o[v]!==t&&(o[v]=t,u[l++]=v)}}return new Uint32Array(u.subarray(0,l))}},{key:"initRenderTriangles",value:function(){this.hasUV()&&(this._meshData._UVtrianglesABC=this.computeTrianglesFromFaces(this.getFacesTexCoord())),this._meshData._trianglesABC=this.computeTrianglesFromFaces(this.getFaces())}},{key:"computeTrianglesFromFaces",value:function(e){for(var t=this.getNbFaces(),r=this.getFacesToTriangles(),i=new Uint32Array(n.getMemory(4*t*6),0,6*t),a=0,s=0;s<t;++s){r[s]=a;var o=4*s,l=e[o],u=e[o+1],h=e[o+2],c=e[o+3],d=3*a;i[d]=l,i[d+1]=u,i[d+2]=h,++a,c!==n.TRI_INDEX&&(d=3*a,i[d]=l,i[d+1]=h,i[d+2]=c,++a)}return new Uint32Array(i.subarray(0,3*a))}},{key:"initEdges",value:function(){for(var e=this.getFaces(),t=this.getFaceEdges(),r=0,i=new Uint32Array(this.getNbVertices()),a=this.getVerticesRingFaceStartCount(),s=this.getVerticesRingFace(),o=0,l=this.getNbVertices();o<l;++o)for(var u=a[2*o],h=u+a[2*o+1],c=r,d=u;d<h;++d){var g=4*s[d],f=e[g],v=e[g+1],m=e[g+2],p=e[g+3],_=0,y=0;p===n.TRI_INDEX?(o>f&&(_=i[f],y=g+(o===v?0:2),_<=c?(t[y]=r,i[f]=++r):t[y]=_-1),o>v&&(_=i[v],y=g+(o===f?0:1),_<=c?(t[y]=r,i[v]=++r):t[y]=_-1),o>m&&(_=i[m],y=g+(o===f?2:1),_<=c?(t[y]=r,i[m]=++r):t[y]=_-1),t[g+3]=n.TRI_INDEX):(o>f&&o!==m&&(_=i[f],y=g+(o===v?0:3),_<=c?(t[y]=r,i[f]=++r):t[y]=_-1),o>v&&o!==p&&(_=i[v],y=g+(o===f?0:1),_<=c?(t[y]=r,i[v]=++r):t[y]=_-1),o>m&&o!==f&&(_=i[m],y=g+(o===v?1:2),_<=c?(t[y]=r,i[m]=++r):t[y]=_-1),o>p&&o!==v&&(_=i[p],y=g+(o===f?3:2),_<=c?(t[y]=r,i[p]=++r):t[y]=_-1))}for(var M=this._meshData._edges=new Uint8ClampedArray(r),T=0,S=this.getNbFaces();T<S;++T){var b=4*T;M[t[b]]++,M[t[b+1]]++,M[t[b+2]]++;var A=t[b+3];A!==n.TRI_INDEX&&M[A]++}}},{key:"getWireframe",value:function(){var e,t=this.getNbEdges(),r=this.isUsingDrawArrays();if(r){if(this._meshData._drawArraysWireframe&&this._meshData._drawArraysWireframe.length===2*t)return this._meshData._drawArraysWireframe;e=this._meshData._drawArraysWireframe=new Uint32Array(2*t)}else{if(this._meshData._drawElementsWireframe&&this._meshData._drawElementsWireframe.length===2*t)return this._meshData._drawElementsWireframe;e=this._meshData._drawElementsWireframe=new Uint32Array(2*t)}for(var i=this.getFaces(),a=this.getFaceEdges(),s=this.getNbFaces(),o=this.getFacesToTriangles(),l=0,u=new Uint8Array(t),h=0;h<s;++h){var c,d,g,f=4*h,v=i[f+3],m=v!==n.TRI_INDEX;if(r){var p=3*o[h];c=p,d=p+1,g=p+2,m&&(v=p+5)}else c=i[f],d=i[f+1],g=i[f+2];var _=a[f],y=a[f+1],M=a[f+2],T=a[f+3];0===u[_]&&(u[_]=1,e[2*l]=c,e[2*l+1]=d,l++),0===u[y]&&(u[y]=1,e[2*l]=d,e[2*l+1]=g,l++),0===u[M]&&(u[M]=1,e[2*l]=g,e[2*l+1]=m?v:c,l++),m&&0===u[T]&&(u[T]=1,e[2*l]=v,e[2*l+1]=c,l++)}return r?this._meshData._drawArraysWireframe:this._meshData._drawElementsWireframe}},{key:"updateDuplicateGeometry",value:function(e){if(this.isUsingTexCoords()&&this.hasUV())for(var t=this.getVertices(),r=this.getColors(),i=this.getMaterials(),a=this.getNormals(),n=this.getVerticesDuplicateStartCount(),s=void 0===e,o=s?this.getNbVertices():e.length,l=0;l<o;++l){var u=s?l:e[l],h=n[2*u];if(0!==h)for(var c=h+n[2*u+1],d=3*u,g=t[d],f=t[d+1],v=t[d+2],m=a[d],p=a[d+1],_=a[d+2],y=r[d],M=r[d+1],T=r[d+2],S=i[d],b=i[d+1],A=i[d+2],x=h;x<c;++x){var k=3*x;t[k]=g,t[k+1]=f,t[k+2]=v,a[k]=m,a[k+1]=p,a[k+2]=_,r[k]=y,r[k+1]=M,r[k+2]=T,i[k]=S,i[k+1]=b,i[k+2]=A}}}},{key:"updateDuplicateColorsAndMaterials",value:function(e){if(this.isUsingTexCoords()&&this.hasUV())for(var t=this.getColors(),r=this.getMaterials(),i=this.getVerticesDuplicateStartCount(),a=void 0===e,n=a?this.getNbVertices():e.length,s=0;s<n;++s){var o=a?s:e[s],l=i[2*o];if(0!==l)for(var u=l+i[2*o+1],h=3*o,c=t[h],d=t[h+1],g=t[h+2],f=r[h],v=r[h+1],m=r[h+2],p=l;p<u;++p){var _=3*p;t[_]=c,t[_+1]=d,t[_+2]=g,r[_]=f,r[_+1]=v,r[_+2]=m}}}},{key:"initTexCoordsDataFromOBJData",value:function(e,t){var r=this.getFaces(),i=this.getNbVertices(),a=0,s=0,o=0,l=0,u=new Int32Array(i),h=new Float32Array(n.getMemory(4*i*2),0,2*i),c=[],d=0,g=0,f=r.length;for(a=0;a<f;++a)if(o=r[a],o!==n.TRI_INDEX){var v=t[a];if(l=u[o],l!==v+1)if(0!==l)if(l>0)u[o]=--d,c.push([v]),++g;else{var m=c[-l-1],p=m.length;for(s=0;s<p&&m[s]!==v;++s);s===p&&(++g,m.push(v))}else u[o]=v+1,h[2*o]=e[2*v],h[2*o+1]=e[2*v+1]}var _=new Float32Array(2*(i+g));_.set(h);var y=this._meshData._duplicateStartCount=new Uint32Array(2*i);for(d=0,a=0;a<i;++a)if(l=u[a],!(l>=0)){var M=c[-l-1],T=M.length,S=i+d;for(y[2*a]=S,y[2*a+1]=T,d+=T,s=0;s<T;++s){var b=2*M[s],A=2*(S+s);_[A]=e[b],_[A+1]=e[b+1]}}var x=new Uint32Array(r);for(f=r.length,a=0;a<f;++a)if(o=x[a],o!==n.TRI_INDEX&&(l=u[o],!(l>0))){var k=t[a],w=c[-l-1],E=w.length;for(s=0;s<E;++s)if(k===w[s]){x[a]=y[2*o]+s;break}}this.setTexCoords(_),this.setFacesTexCoord(x)}},{key:"setAlreadyDrawArrays",value:function(){this._meshData._DAverticesXYZ=this.getVertices(),this._meshData._DAnormalsXYZ=this.getNormals(),this._meshData._DAcolorsRGB=this.getColors(),this._meshData._DAmaterialsPBR=this.getMaterials()}},{key:"updateDrawArrays",value:function(e){if(this.isUsingDrawArrays()){var t=this.getVertices(),r=this.getNormals(),i=this.getColors(),a=this.getMaterials(),s=this.getFaces(),o=this.getNbTriangles(),l=this.hasOnlyTriangles()?null:this.getFacesToTriangles(),u=void 0===e,h=this._meshData._DAverticesXYZ,c=this._meshData._DAnormalsXYZ,d=this._meshData._DAcolorsRGB,g=this._meshData._DAmaterialsPBR;(!h||h.length<9*o)&&(h=this._meshData._DAverticesXYZ=new Float32Array(9*o),c=this._meshData._DAnormalsXYZ=new Float32Array(9*o),d=this._meshData._DAcolorsRGB=new Float32Array(9*o),g=this._meshData._DAmaterialsPBR=new Float32Array(9*o));for(var f=u?this.getNbFaces():e.length,v=0;v<f;++v){var m=u?v:e[v],p=l?l[m]:m,_=9*p;m*=4;var y=3*s[m],M=3*s[m+1],T=3*s[m+2];h[_]=t[y],h[_+1]=t[y+1],h[_+2]=t[y+2],h[_+3]=t[M],h[_+4]=t[M+1],h[_+5]=t[M+2],h[_+6]=t[T],h[_+7]=t[T+1],h[_+8]=t[T+2],d[_]=i[y],d[_+1]=i[y+1],d[_+2]=i[y+2],d[_+3]=i[M],d[_+4]=i[M+1],d[_+5]=i[M+2],d[_+6]=i[T],d[_+7]=i[T+1],d[_+8]=i[T+2],g[_]=a[y],g[_+1]=a[y+1],g[_+2]=a[y+2],g[_+3]=a[M],g[_+4]=a[M+1],g[_+5]=a[M+2],g[_+6]=a[T],g[_+7]=a[T+1],g[_+8]=a[T+2],c[_]=r[y],c[_+1]=r[y+1],c[_+2]=r[y+2],c[_+3]=r[M],c[_+4]=r[M+1],c[_+5]=r[M+2],c[_+6]=r[T],c[_+7]=r[T+1],c[_+8]=r[T+2];var S=s[m+3];S!==n.TRI_INDEX&&(S*=3,_+=9,h[_]=t[y],h[_+1]=t[y+1],h[_+2]=t[y+2],h[_+3]=t[T],h[_+4]=t[T+1],h[_+5]=t[T+2],h[_+6]=t[S],h[_+7]=t[S+1],h[_+8]=t[S+2],d[_]=i[y],d[_+1]=i[y+1],d[_+2]=i[y+2],d[_+3]=i[T],d[_+4]=i[T+1],d[_+5]=i[T+2],d[_+6]=i[S],d[_+7]=i[S+1],d[_+8]=i[S+2],g[_]=a[y],g[_+1]=a[y+1],g[_+2]=a[y+2],g[_+3]=a[T],g[_+4]=a[T+1],g[_+5]=a[T+2],g[_+6]=a[S],g[_+7]=a[S+1],g[_+8]=a[S+2],c[_]=r[y],c[_+1]=r[y+1],c[_+2]=r[y+2],c[_+3]=r[T],c[_+4]=r[T+1],c[_+5]=r[T+2],c[_+6]=r[S],c[_+7]=r[S+1],c[_+8]=r[S+2])}this.isUsingTexCoords()&&this.updateDrawArraysTexCoord(e)}}},{key:"updateDrawArraysTexCoord",value:function(e){var t=this.getNbTriangles(),r=this.getFacesToTriangles(),i=void 0===e,a=this._meshData._DAtexCoordsST;a&&a.length===6*t||(a=this._meshData._DAtexCoordsST=new Float32Array(6*t));for(var s=this.getTexCoords(),o=this.getFacesTexCoord(),l=i?this.getNbFaces():e.length,u=0;u<l;++u){var h=i?u:e[u],c=r[h],d=6*c;h*=4;var g=2*o[h],f=2*o[h+1],v=2*o[h+2];a[d]=s[g],a[d+1]=s[g+1],a[d+2]=s[f],a[d+3]=s[f+1],a[d+4]=s[v],a[d+5]=s[v+1];var m=o[h+3];m!==n.TRI_INDEX&&(m*=3,d+=6,a[d]=s[g],a[d+1]=s[g+1],a[d+2]=s[v],a[d+3]=s[v+1],a[d+4]=s[m],a[d+5]=s[m+1])}}},{key:"updateCenter",value:function(){var e=this.getLocalBound();ze.set(this._transformData._center,.5*(e[0]+e[3]),.5*(e[1]+e[4]),.5*(e[2]+e[5]))}},{key:"updateMatrices",value:function(e){Xe.normalFromMat4(this._transformData._lastComputedEN,this._transformData._editMatrix),We.mul(this._transformData._lastComputedMV,e.getView(),this._transformData._matrix),Xe.normalFromMat4(this._transformData._lastComputedN,this._transformData._lastComputedMV),We.mul(this._transformData._lastComputedMVP,e.getProjection(),this._transformData._lastComputedMV);var t=this._transformData._center,r=this._transformData._lastComputedMVP;this._transformData._lastComputedDepth=r[2]*t[0]+r[6]*t[1]+r[10]*t[2]+r[14]}},{key:"normalizeSize",value:function(){var e=this.getLocalBound(),t=ze.dist([e[0],e[1],e[2]],[e[3],e[4],e[5]]),r=n.SCALE/t;We.scale(this._transformData._matrix,this._transformData._matrix,[r,r,r])}},{key:"computeWorldBound",value:function(){var e=this._meshData._worldBound,t=this.getLocalBound(),r=this.getMatrix();e[0]=e[3]=r[12],e[1]=e[4]=r[13],e[2]=e[5]=r[14];for(var i=0;i<3;++i)for(var a=4*i,n=t[i],s=t[i+3],o=0;o<3;++o){var l=r[a+o],u=l*s,h=l*n;u<h?(e[o]+=u,e[o+3]+=h):(e[o]+=h,e[o+3]+=u)}return e}},{key:"intersectRay",value:function(e,t,r){var i=this.getNbFaces(),a=new Uint32Array(n.getMemory(4*i),0,i);return this._meshData._octree.collectIntersectRay(e,t,a,r?this._meshData._leavesToUpdate:void 0)}},{key:"intersectSphere",value:function(e,t,r){var i=this.getNbFaces(),a=new Uint32Array(n.getMemory(4*i),0,i);return this._meshData._octree.collectIntersectSphere(e,t,a,r?this._meshData._leavesToUpdate:void 0)}},{key:"updateOctree",value:function(e){e?this.updateOctreeAdd(this.updateOctreeRemove(e)):this.computeOctree()}},{key:"computeAabb",value:function(){for(var e=this.getNbVertices(),t=this.getVertices(),r=1/0,i=1/0,a=1/0,n=-(1/0),s=-(1/0),o=-(1/0),l=0;l<e;++l){var u=3*l,h=t[u],c=t[u+1],d=t[u+2];h<r&&(r=h),h>n&&(n=h),c<i&&(i=c),c>s&&(s=c),d<a&&(a=d),d>o&&(o=d)}return[r,i,a,n,s,o]}},{key:"computeOctree",value:function(){var e=this.computeAabb(),t=e[0],r=e[1],i=e[2],a=e[3],n=e[4],s=e[5],o=a-t,l=n-r,u=s-i,h=.2*Math.sqrt(o*o+l*l+u*u),c=1e-16;a-t<c&&(t-=h,a+=h),n-r<c&&(r-=h,n+=h),s-i<c&&(i-=h,s+=h);var d=.3*o,g=.3*l,f=.3*u,v=t-d,m=a+d,p=r-g,_=n+g,y=i-f,M=s+f,T=this._meshData._octree=new Oe;T.resetNbFaces(this.getNbFaces()),T.setAabbLoose(t,r,i,a,n,s),T.setAabbSplit(v,p,y,m,_,M),T.build(this)}},{key:"updateOctreeRemove",value:function(e){for(var t=this.getFaceCenters(),r=this.getFaceBoxes(),i=this._meshData._facePosInLeaf,a=this._meshData._faceLeaf,s=e.length,o=0,l=new Uint32Array(n.getMemory(4*s),0,s),u=0;u<s;++u){var h=e[u],c=6*h,d=3*h,g=a[h],f=g._aabbSplit,v=t[d],m=t[d+1],p=t[d+2];if(v<=f[0]||m<=f[1]||p<=f[2]||v>f[3]||m>f[4]||p>f[5]){l[o++]=e[u];var _=g._iFaces;if(_.length>0){var y=_[_.length-1],M=i[h];_[M]=y,i[y]=M,_.pop()}}else g.expandsAabbLoose(r[c],r[c+1],r[c+2],r[c+3],r[c+4],r[c+5])}return new Uint32Array(l.subarray(0,o))}},{key:"updateOctreeAdd",value:function(e){for(var t=this.getFaceCenters(),r=this.getFaceBoxes(),i=this._meshData._facePosInLeaf,a=this._meshData._faceLeaf,n=e.length,s=this._meshData._octree,o=s._aabbSplit,l=o[0],u=o[1],h=o[2],c=o[3],d=o[4],g=o[5],f=0;f<n;++f){var v=e[f],m=6*v,p=r[m],_=r[m+1],y=r[m+2],M=r[m+3],T=r[m+4],S=r[m+5];if(p>c||M<l||_>d||T<u||y>g||S<h){this.computeOctree(),this._meshData._leavesToUpdate.length=0;break}var b=3*v,A=s.addFace(v,p,_,y,M,T,S,t[b],t[b+1],t[b+2]);if(A)i[v]=A._iFaces.length-1,a[v]=A;else{var x=a[v]._iFaces;i[v]=x.length,x.push(e[f])}}}},{key:"balanceOctree",value:function(){++Oe.FLAG;for(var e=this._meshData._leavesToUpdate,t=e.length,r=0;r<t;++r){var i=e[r];i._flag!==Oe.FLAG&&(0===i._iFaces.length?i.pruneIfPossible():i._iFaces.length>Oe.MAX_FACES&&i._depth<Oe.MAX_DEPTH&&i.build(this),i._flag=Oe.FLAG)}e.length=0}},{key:"setFlatColor",value:function(e){this.getFlatColor().set(e)}},{key:"setAlbedo",value:function(e){this.getAlbedo().set(e)}},{key:"setMode",value:function(e){this._renderData._mode=e}},{key:"setRoughness",value:function(e){this._renderData._roughness=e}},{key:"setMetallic",value:function(e){this._renderData._metallic=e}},{key:"setOpacity",value:function(e){this._renderData._alpha=e}},{key:"setTexture0",value:function(e){this._renderData._texture0=e}},{key:"setMatcap",value:function(e){this._renderData._matcap=e}},{key:"setCurvature",value:function(e){this._renderData._curvature=e}},{key:"setFlatShading",value:function(e){this._renderData._flatShading=e}},{key:"setShowWireframe",value:function(e){this._renderData._showWireframe=!Ge.ONLY_DRAW_ARRAYS&&e,this.updateWireframeBuffer()}},{key:"setUseDrawArrays",value:function(e){this._renderData._useDrawArrays=e}},{key:"getGL",value:function(){return this._renderData._gl}},{key:"getCount",value:function(){var e=this.getGL();return this.getMode()===e.TRIANGLES?3*this.getNbTriangles():this.getMode()===e.LINES?this.getNbVertices():0}},{key:"getVertexBuffer",value:function(){return this._renderData._vertexBuffer}},{key:"getNormalBuffer",value:function(){return this._renderData._normalBuffer}},{key:"getColorBuffer",value:function(){return this._renderData._colorBuffer}},{key:"getMaterialBuffer",value:function(){return this._renderData._materialBuffer}},{key:"getTexCoordBuffer",value:function(){return this._renderData._texCoordBuffer}},{key:"getIndexBuffer",value:function(){return this._renderData._indexBuffer}},{key:"getWireframeBuffer",value:function(){return this._renderData._wireframeBuffer}},{key:"getRoughness",value:function(){return this._renderData._roughness}},{key:"getMetallic",value:function(){return this._renderData._metallic}},{key:"getOpacity",value:function(){return this._renderData._alpha}},{key:"getFlatColor",value:function(){return this._renderData._flatColor}},{key:"getMode",value:function(){return this._renderData._mode}},{key:"getAlbedo",value:function(){return this._renderData._albedo}},{key:"getTexture0",value:function(){return this._renderData._texture0}},{key:"getMatcap",value:function(){return this._renderData._matcap}},{key:"getCurvature",value:function(){return this._renderData._curvature}},{key:"getFlatShading",value:function(){return this._renderData._flatShading}},{key:"getShowWireframe",value:function(){return this._renderData._showWireframe}},{key:"isUsingDrawArrays",value:function(){return this._renderData._useDrawArrays||Ge.ONLY_DRAW_ARRAYS}},{key:"isUsingTexCoords",value:function(){return this._renderData._shaderType===o.Shader.UV}},{key:"isTransparent",value:function(){return this._renderData._alpha<.99}},{key:"getShaderType",value:function(){return this._renderData._shaderType}},{key:"setShaderType",value:function(e){var t=this.hasUV();if(e===o.Shader.UV&&!t){if(this._renderData._shaderType!==o.Shader.UV)return;e=o.Shader.MATCAP}this._renderData._shaderType=e,t&&(this.updateDuplicateGeometry(),this.updateDrawArrays()),this.updateBuffers()}},{key:"initRender",value:function(){this.setShaderType(this._renderData._shaderType),this.setShowWireframe(this.getShowWireframe())}},{key:"render",value:function(e){ne[this.getShaderType()].getOrCreate(this.getGL()).draw(this,e)}},{key:"renderWireframe",value:function(e){ne[o.Shader.WIREFRAME].getOrCreate(this.getGL()).draw(this,e)}},{key:"renderFlatColor",value:function(e){ne[o.Shader.FLAT].getOrCreate(this.getGL()).draw(this,e)}},{key:"getRenderNbVertices",value:function(){return this.isUsingDrawArrays()?this.getCount():this.isUsingTexCoords()?this.getNbTexCoords():this.getNbVertices()}},{key:"updateVertexBuffer",value:function(){var e=this.isUsingDrawArrays()?this.getVerticesDrawArrays():this.getVertices();this.getVertexBuffer().update(e,3*this.getRenderNbVertices())}},{key:"updateNormalBuffer",value:function(){var e=this.isUsingDrawArrays()?this.getNormalsDrawArrays():this.getNormals();this.getNormalBuffer().update(e,3*this.getRenderNbVertices())}},{key:"updateColorBuffer",value:function(){var e=this.isUsingDrawArrays()?this.getColorsDrawArrays():this.getColors();this.getColorBuffer().update(e,3*this.getRenderNbVertices())}},{key:"updateMaterialBuffer",value:function(){var e=this.isUsingDrawArrays()?this.getMaterialsDrawArrays():this.getMaterials();this.getMaterialBuffer().update(e,3*this.getRenderNbVertices())}},{key:"updateTexCoordBuffer",value:function(){if(this.isUsingTexCoords()){var e=this.isUsingDrawArrays()?this.getTexCoordsDrawArrays():this.getTexCoords();this.getTexCoordBuffer().update(e,2*this.getRenderNbVertices())}}},{key:"updateIndexBuffer",value:function(){if(!this.isUsingDrawArrays()){var e=this.isUsingTexCoords()?this.getTrianglesTexCoord():this.getTriangles();this.getIndexBuffer().update(e,3*this.getNbTriangles())}}},{key:"updateWireframeBuffer",value:function(){this.getShowWireframe()&&this.getWireframeBuffer().update(this.getWireframe(),2*this.getNbEdges())}},{key:"updateGeometryBuffers",value:function(){this.updateVertexBuffer(),this.updateNormalBuffer()}},{key:"updateBuffers",value:function(){this.updateGeometryBuffers(),this.updateColorBuffer(),this.updateMaterialBuffer(),this.updateTexCoordBuffer(),this.updateIndexBuffer(),this.updateWireframeBuffer()}},{key:"release",value:function(){this.getTexture0()&&this.getGL().deleteTexture(this.getTexture0()),this.getVertexBuffer().release(),this.getNormalBuffer().release(),this.getColorBuffer().release(),this.getMaterialBuffer().release(),this.getIndexBuffer().release(),this.getWireframeBuffer().release()}},{key:"copyRenderConfig",value:function(e){this.setFlatShading(e.getFlatShading()),this.setShowWireframe(e.getShowWireframe()),this.setShaderType(e.getShaderType()),this.setMatcap(e.getMatcap()),this.setTexture0(e.getTexture0()),this.setCurvature(e.getCurvature()),this.setOpacity(e.getOpacity())}},{key:"optimize",value:function(){0!==this.getNbFaces()&&e.OPTIMIZE&&(this.optimizePostTransform(),this.optimizePreTransform(),this.initFaceRings())}},{key:"computeCacheScore",value:function(){var e=this.getFaces(),t=this.getNbFaces(),r=32,i=[];i.length=r;for(var a=0,s=0,o=0;o<t;++o)for(var l=3*o,u=e[l+3]!==n.TRI_INDEX?4:3,h=0;h<u;++h){var c=e[l+h];for(s=0;s<r;++s){if(void 0===i[s]){i[s]=c,a++;break}if(i[s]===c)break}s===r&&(a++,i.shift(),i.push(c))}return{ACMR:a/t,ACTVR:a/this.getNbVertices()}}},{key:"optimizePostTransform",value:function(){var e=0,t=32,r=this.hasUV(),i=this.getFaces(),a=r?this.getFacesTexCoord():i,s=this.getNbFaces(),o=this.getNbVertices(),l=r?this.getNbTexCoords():o,u=this.getVerticesDuplicateStartCount(),h=new Uint32Array(l-o);if(r)for(e=0;e<l;++e)for(var c=u[2*e],d=c+u[2*e+1],g=c;g<d;++g)h[g-o]=e;var f=this.getVerticesRingFaceStartCount(),v=this.getVerticesRingFace(),m=new Int32Array(l);for(e=0;e<o;++e)m[e]=f[2*e+1];for(e=o;e<l;++e)m[e]=f[2*h[e-o]+1];for(var p=new Uint32Array(l),_=t+1,y=0,M=new Uint32Array(n.getMemory(4*s*4),0,4*s),T=0,S=new Uint8Array(s),b=new Uint32Array(4*s),A=r?new Uint32Array(4*s):b,x=0,k=0;k>=0;){var w=[],E=k>=o?h[k-o]:k,R=f[2*E],F=R+f[2*E+1];for(e=R;e<F;++e){var D=v[e];if(!S[D]){S[D]=1;var I=4*D,C=M[T++]=b[x++]=a[I],N=M[T++]=b[x++]=a[I+1],V=M[T++]=b[x++]=a[I+2],P=b[x++]=a[I+3],L=P!==n.TRI_INDEX;r&&(A[x-4]=i[I],A[x-3]=i[I+1],A[x-2]=i[I+2],A[x-1]=i[I+3]),w.push(C,N,V),--m[C],--m[N],--m[V],_-p[C]>t&&(p[C]=_++),_-p[N]>t&&(p[N]=_++),_-p[V]>t&&(p[V]=_++),L&&(M[T++]=P,w.push(P),--m[P],_-p[P]>t&&(p[P]=_++))}}k=-1;var U=-1,B=w.length;for(e=0;e<B;++e){var O=w[e],G=m[O];if(!(G<=0)){var z=0,X=_-p[O];X+2*G<=t&&(z=X),z>U&&(U=z,k=O)}}if(k===-1){for(;T>0;){var W=M[--T];if(m[W]>0){k=W;break}}if(k===-1)for(;y<l;)if(m[y++]>0){k=y-1;break}}}a.set(b.subarray(0,4*s)),r&&i.set(A.subarray(0,4*s))}},{key:"optimizePreTransform",value:function(){var e=this.getVertices(),t=this.getColors(),r=this.getMaterials(),i=this.getNbVertices(),a=this.getFaces(),s=4*this.getNbFaces(),o=new Float32Array(3*i),l=new Float32Array(3*i),u=new Float32Array(3*i),h=new Uint32Array(i),c=0,d=0;for(d=0;d<s;++d){var g=a[d];if(g!==n.TRI_INDEX){var f=h[g]-1;if(f===-1){var v=3*c,m=3*g;o[v]=e[m],o[v+1]=e[m+1],o[v+2]=e[m+2],l[v]=t[m],l[v+1]=t[m+1],l[v+2]=t[m+2],u[v]=r[m],u[v+1]=r[m+1],u[v+2]=r[m+2],f=c++,h[g]=f+1}a[d]=f}}var p=i-c;if(p>0&&this.setNbVertices(c),this.hasUV()){var _=this.getFacesTexCoord();for(d=0;d<s;++d){var y=_[d];y<i?_[d]=h[y]-1:y!==n.TRI_INDEX&&(_[d]-=p)}var M=this.getNbTexCoords(),T=this.getNbTexCoords()-p,S=this.getTexCoords(),b=new Float32Array(2*T),A=new Uint32Array(2*c),x=this.getVerticesDuplicateStartCount();for(d=0;d<i;++d){var k=2*d,w=x[k],E=2*(h[d]-1);E<0||(w>0&&(A[E]=w-p,A[E+1]=x[k+1]),b[E]=S[k],b[E+1]=S[k+1])}for(d=i;d<M;++d){var R=2*d,F=2*(d-p);b[F]=S[R],b[F+1]=S[R+1]}this.setVerticesDuplicateStartCount(A),this.setTexCoords(b)}e.set(o),t.set(l),r.set(u)}}],[{key:"sortFunction",value:function(e,t){var r=e.isTransparent(),i=t.isTransparent();return r&&!i?1:!r&&i?-1:(t.getDepth()-e.getDepth())*(r&&i?1:-1)}}]),e}();Ye.OPTIMIZE=!0,Ye.ID=0;var He=i.vec3,je=i.mat3,qe=i.mat4,Ke=function(){return{_center:He.create(),_matrix:qe.create(),_editMatrix:qe.create(),_symmetryNormal:[1,0,0],_lastComputedMV:qe.create(),_lastComputedMVP:qe.create(),_lastComputedN:je.create(),_lastComputedEN:je.create(),_lastComputedDepth:0,_lastWorldBound:[1/0,1/0,1/0,-(1/0),-(1/0),-(1/0)]}},Ze=function(){return{_nbVertices:0,_nbFaces:0,_nbTexCoords:0,_verticesXYZ:null,_normalsXYZ:null,_colorsRGB:null,_materialsPBR:null,_vertOnEdge:null,_vertRingFace:null,_vrfStartCount:null,_vrvStartCount:null,_vertRingVert:null,_vertTagFlags:null,_vertSculptFlags:null,_vertStateFlags:null,_vertProxy:null,_facesABCD:null,_faceEdges:null,_faceNormalsXYZ:null,_facesToTriangles:null,_trianglesABC:null,_facesTagFlags:null,_edges:null,_drawArraysWireframe:null,_drawElementsWireframe:null,_texCoordsST:null,_duplicateStartCount:null,_UVfacesABCD:null,_UVtrianglesABC:null,_DAverticesXYZ:null,_DAnormalsXYZ:null,_DAcolorsRGB:null,_DAmaterialsPBR:null,_DAtexCoordsST:null,_octree:null,_faceBoxes:null,_faceCentersXYZ:null,_facePosInLeaf:null,_faceLeaf:[],_leavesToUpdate:[],_worldBound:[1/0,1/0,1/0,-(1/0),-(1/0),-(1/0)]}},Qe=function(e){function t(e){y(this,t);var r=b(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return r._id=Ye.ID++,e&&(r._renderData=new Ge(e,r)),r._meshData=Ze(),r._transformData=Ke(),r}return S(t,e),t}(Ye),Je=i.vec3,$e=i.mat3,et=function(e){function t(e){y(this,t);var r=b(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return r._radius=50,r._hardness=.25,r._intensity=1,
r._negative=!0,r._culling=!1,r._idAlpha=0,r._lockPosition=!1,r._thickness=1,r}return S(t,e),M(t,[{key:"pushState",value:function(){this._main.getStateManager().pushStateColorAndMaterial(this.getMesh())}},{key:"updateMeshBuffers",value:function(){var e=this.getMesh();e.isDynamic?e.updateBuffers():e.updateMaterialBuffer()}},{key:"stroke",value:function(e){Pe.prototype.stroke.call(this,e)}},{key:"paint",value:function(e,t,r,i,a,n){for(var s=this.getMesh(),o=s.getVertices(),l=s.getMaterials(),u=Math.sqrt(r),h=t[0],c=t[1],d=t[2],g=2*(1-a),f=this._negative?-i:i,v=0,m=e.length;v<m;++v){var p=3*e[v],_=o[p],y=o[p+1],M=o[p+2],T=_-h,S=y-c,b=M-d,A=Math.sqrt(T*T+S*S+b*b)/u,x=Math.pow(1-A,g);x*=f*n.getAlpha(_,y,M),l[p+2]=Math.min(Math.max(l[p+2]+x,0),1)}}},{key:"updateAndRenderMask",value:function(){var e=this.getMesh();e.updateDuplicateColorsAndMaterials(),e.updateDrawArrays(),this.updateRender()}},{key:"blur",value:function(){var e=this.getMesh(),t=this.getMaskedVertices();if(0!==t.length){t=e.expandsVertices(t,1),this.pushState(),this._main.getStateManager().pushVertices(t);var r=e.getMaterials(),i=t.length,a=new Float32Array(3*i);this.laplacianSmooth(t,a,r);for(var n=0;n<i;++n)r[3*t[n]+2]=a[3*n+2];this.updateAndRenderMask()}}},{key:"sharpen",value:function(){var e=this.getMesh(),t=this.getMaskedVertices();if(0!==t.length){this.pushState(),this._main.getStateManager().pushVertices(t);for(var r=e.getMaterials(),i=t.length,a=0;a<i;++a){var n=3*t[a]+2,s=r[n];r[n]=s>.5?Math.min(s+.1,1):Math.max(s-1,0)}this.updateAndRenderMask()}}},{key:"clear",value:function(){var e=this.getMesh(),t=this.getMaskedVertices();if(0!==t.length){this.pushState(),this._main.getStateManager().pushVertices(t);for(var r=e.getMaterials(),i=0,a=t.length;i<a;++i)r[3*t[i]+2]=1;this.updateAndRenderMask()}}},{key:"invert",value:function(e,t){var r=t;r||(r=this.getMesh()),e||this._main.getStateManager().pushStateCustom(this.invert.bind(this,!0,r));for(var i=r.getMaterials(),a=0,n=r.getNbVertices();a<n;++a)i[3*a+2]=1-i[3*a+2];this.updateAndRenderMask()}},{key:"remapAndMirrorIndices",value:function(e,t,r){var i=this.getMesh().getNbVertices(),a=new Uint32Array(n.getMemory(4*i),0,i),s=0,o=0,l=r.length;for(s=0;s<l;++s)a[r[s]]=s;var u=2*t;for(s=0;s<u;++s){o=4*s;var h=s<t?0:l;e[o]=a[e[o]]+h,e[o+1]=a[e[o+1]]+h,e[o+2]=a[e[o+2]]+h;var c=e[o+3];c!==n.TRI_INDEX&&(e[o+3]=a[c]+h)}var d=e.length/4;for(s=u;s<d;++s)o=4*s,e[o]=a[e[o]],e[o+1]=a[e[o+1]],e[o+2]=a[e[o+2]]+l,e[o+3]=a[e[o+3]]+l}},{key:"invertFaces",value:function(e){for(var t=0,r=e.length/4;t<r;++t){var i=4*t,a=e[i];e[i]=e[i+2],e[i+2]=a}}},{key:"extractFaces",value:function(e,t,r){for(var i=this.getMesh(),a=i.getFaces(),s=i.getMaterials(),o=i.getVerticesOnEdge(),l=0===this._thickness,u=e.length,h=new Uint32Array(n.getMemory(4*u*4*3),0,4*u*3),c=l?u:2*u,d=0;d<u;++d){var g=4*d,f=4*e[d],v=h[g]=a[f],m=h[g+1]=a[f+1],p=h[g+2]=a[f+2],_=h[g+3]=a[f+3];if(!l){var y=_!==n.TRI_INDEX,M=s[3*v+2]>=r||o[v]>=1,T=s[3*m+2]>=r||o[m]>=1,S=s[3*p+2]>=r||o[p]>=1,b=!!y&&(s[3*_+2]>=r||o[_]>=1);g+=4*u,h[g]=p,h[g+1]=m,h[g+2]=v,h[g+3]=_,T&&(M&&(g=4*c++,h[g]=h[g+3]=m,h[g+1]=h[g+2]=v),S&&(g=4*c++,h[g]=h[g+3]=p,h[g+1]=h[g+2]=m)),y?b&&(M&&(g=4*c++,h[g]=h[g+3]=v,h[g+1]=h[g+2]=_),S&&(g=4*c++,h[g]=h[g+3]=_,h[g+1]=h[g+2]=p)):M&&S&&(g=4*c++,h[g]=h[g+3]=v,h[g+1]=h[g+2]=p)}}var A=new Uint32Array(h.subarray(0,4*c));return this.remapAndMirrorIndices(A,u,t),this._thickness>0&&this.invertFaces(A),A}},{key:"extractVertices",value:function(e){var t=this.getMesh(),r=t.getVertices(),i=t.getNormals(),a=t.getMatrix(),n=$e.normalFromMat4($e.create(),a),s=e.length,o=new Float32Array(2*s*3),l=[0,0,0],u=[0,0,0],h=3*s,c=this._thickness,d=.01;c<0&&(d=-d);for(var g=0;g<s;++g){var f=3*g,v=3*e[g];l[0]=r[v],l[1]=r[v+1],l[2]=r[v+2],u[0]=i[v],u[1]=i[v+1],u[2]=i[v+2],Je.transformMat3(u,u,n),Je.normalize(u,u),Je.transformMat4(l,l,a),Je.scaleAndAdd(l,l,u,d),o[f]=l[0],o[f+1]=l[1],o[f+2]=l[2],Je.scaleAndAdd(l,l,u,c),f+=h,o[f]=l[0],o[f+1]=l[1],o[f+2]=l[2]}return o}},{key:"smoothBorder",value:function(e,t){for(var r=2*t.length,i=new Uint32Array(e.getNbFaces()-r),a=0,n=i.length;a<n;++a)i[a]=r+a;var s=e.expandsVertices(e.getVerticesFromFaces(i),1),o=new Re;o.setToolMesh(e),o.smooth(s,1),o.smooth(s,1),o.smooth(s,1)}},{key:"extract",value:function(){var e=this.getMesh(),t=.5,r=this.filterMaskedVertices(-(1/0),t);if(0!==r.length){var i=e.getFacesFromVertices(r);r=e.getVerticesFromFaces(i);var a=this.extractFaces(i,r,t),n=this.extractVertices(r),s=new Qe(e.getGL());s.setVertices(n),s.setFaces(a),s.initColorsAndMaterials(),s.allocateArrays(),s.initTopology(),0!==this._thickness&&this.smoothBorder(s,i),s.updateGeometry(),s.updateDuplicateColorsAndMaterials(),s.copyRenderConfig(e),s.initRender();var o=this._main;o.addNewMesh(s),o.setMesh(e)}}}]),t}(_e),tt=function(e){function t(e){y(this,t);var r=b(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return r._radius=50,r._culling=!1,r._idAlpha=0,r}return S(t,e),M(t,[{key:"startSculpt",value:function(){var e=this._main;if(e.getSculptManager().getSymmetry()){var t=e.getPickingSymmetry();t.intersectionMouseMesh(),t.setLocalRadius2(e.getPicking().getLocalRadius2())}}},{key:"sculptStroke",value:function(){var e=this._main,t=e._mouseX-e._lastMouseX,r=e.getPicking(),i=r.getLocalRadius2();if(r.pickVerticesInSphere(i),this.stroke(r,t),e.getSculptManager().getSymmetry()){var a=e.getPickingSymmetry();a.getMesh()&&(a.pickVerticesInSphere(i),this.stroke(a,t))}this.updateRender()}},{key:"stroke",value:function(e,t){var r=e.getPickedVertices();this._main.getStateManager().pushVertices(r),r=this.dynamicTopology(e),this._culling&&(r=this.getFrontVertices(r,e.getEyeDirection())),e.updateAlpha(!1),e.setIdAlpha(this._idAlpha),this.scale(r,e.getIntersectionPoint(),e.getLocalRadius2(),t,e);var i=this.getMesh();i.updateGeometry(i.getFacesFromVertices(r),r)}},{key:"scale",value:function(e,t,r,i,a){for(var n=this.getMesh(),s=n.getVertices(),o=n.getMaterials(),l=.01*i,u=Math.sqrt(r),h=t[0],c=t[1],d=t[2],g=0,f=e.length;g<f;++g){var v=3*e[g],m=s[v],p=s[v+1],_=s[v+2],y=m-h,M=p-c,T=_-d,S=Math.sqrt(y*y+M*M+T*T)/u,b=S*S;b=3*b*b-4*b*S+1,b*=l*o[v+2]*a.getAlpha(m,p,_),s[v]=m+y*b,s[v+1]=p+M*b,s[v+2]=_+T*b}}}]),t}(_e),rt=function(e,t){this.previous=null,this.next=null,this.v1=e,this.v2=t},it=function(e){if(!(e.length<=2)){var t=e.length,r=e[0].v1,i=e[0].v2,a=e[0],n=a;e[0]=e[--t];for(var s=0;s<t;){var o=e[s];if(o.v1===i){if(o.previous=n,n.next=o,n=o,i=e[s].v2,e[s]=e[--t],i===r)break;s=0}else s++}if(e.length=t,i===r)return a.previous=n,n.next=a,a}},at=function(e){for(var t=e.getEdges(),r=e.getFaces(),i=e.getFaceEdges(),a=[],s=0,o=e.getNbFaces();s<o;++s){var l=4*s,u=i[l+3],h=u!==n.TRI_INDEX;1===t[i[l]]&&a.push(new rt(r[l],r[l+1])),1===t[i[l+1]]&&a.push(new rt(r[l+1],r[l+2])),1===t[i[l+2]]&&a.push(new rt(r[l+2],r[h?l+3:l])),h&&1===t[u]&&a.push(new rt(r[l+3],r[l]))}for(var c=[];;){var d=it(a);if(!d)break;c.push(d)}return c},nt=function(e,t,r,i,a,s){var o=e.getVertices(),l=e.getColors(),u=e.getMaterials(),h=e.getNbVertices()+i.length/3,c=t,d=0,g=0,f=0,v=0,m=0,p=0,_=0,y=0,M=0,T=0;do{var S=c.next,b=c.v1,A=c.v2,x=S.v2;r.push(b,A,h,n.TRI_INDEX),b*=3,A*=3,x*=3,T++,d+=o[b],g+=o[b+1],f+=o[b+2],v+=l[b],m+=l[b+1],p+=l[b+2],_+=u[b],y+=u[b+1],M+=u[b+2];var k=o[A],w=o[A+1],E=o[A+2],R=o[b]-k,F=o[b+1]-w,D=o[b+2]-E,I=o[x]-k,C=o[x+1]-w,N=o[x+2]-E,V=R*R+F*F+D*D,P=I*I+C*C+N*N;c.angle=Math.acos((R*I+F*C+D*N)/Math.sqrt(V*P)),c=S}while(c!==t);i.push(d/T,g/T,f/T),a.push(v/T,m/T,p/T),s.push(_/T,y/T,M/T)},st=function(e,t,r,i,a){var n=new Qe;return n.setID(e.getID()),n.setVertices(t),i&&n.setColors(i),a&&n.setMaterials(a),n.setFaces(r),n.setTransformData(e.getTransformData()),n.setRenderData(e.getRenderData()),Ye.OPTIMIZE=!1,n.init(),Ye.OPTIMIZE=!0,n},ot=function(e){var t=at(e);if(0===t.length)return e;for(var r=[],i=[],a=[],n=[],s=0,o=t.length;s<o;++s)nt(e,t[s],r,i,a,n);var l=3*e.getNbVertices(),u=l+i.length,h=new Float32Array(u);h.set(e.getVertices().subarray(0,l));var c=new Float32Array(u);c.set(e.getColors().subarray(0,l));var d=new Float32Array(u);d.set(e.getMaterials().subarray(0,l)),u>l&&(h.set(i,l),c.set(a,l),d.set(n,l));var g=new Uint32Array(4*e.getNbFaces()+r.length);return g.set(e.getFaces()),r.length>0&&g.set(r,4*e.getNbFaces()),st(e,h,g,c,d)},lt={};lt.createClosedMesh=function(e){var t=ot(e);if(t===e){var r=new Float32Array(e.getVertices()),i=new Uint32Array(e.getFaces()),a=new Float32Array(e.getColors()),n=new Float32Array(e.getMaterials());t=st(e,r,i,a,n)}return t};var ut={};ut.BLOCK=!1;var ht=function(){for(var e=new Uint32Array(24),t=0,r=0;r<8;++r)for(var i=1;i<=4;i<<=1){var a=r^i;r<=a&&(e[t++]=r,e[t++]=a)}return e},ct=function(e){for(var t=new Uint32Array(256),r=0;r<256;++r){for(var i=0,a=0;a<24;a+=2){var n=!!(r&1<<e[a]),s=!!(r&1<<e[a+1]);i|=n!==s?1<<(a>>1):0}t[r]=i}return t},dt=ht(),gt=ct(dt),ft=function(e,t,r,i,a,n){for(var s=e.colorField,o=e.materialField,l=e.distanceField,u=0,h=0,c=0,d=0,g=0,f=0,v=0,m=0,p=0,_=r[0],y=r[0]*r[1],M=0;M<2;++M)for(var T=0;T<2;++T)for(var S=0;S<2;++S){var b=i+S+T*_+M*y,A=3*b,x=l[b];t[p]=x,m|=x<0?1<<p:0,p++,x!==1/0&&(x=Math.min(1/Math.abs(x),1e15),v+=x,u+=s[A]*x,h+=s[A+1]*x,c+=s[A+2]*x,d+=o[A]*x,g+=o[A+1]*x,f+=o[A+2]*x)}return 0!==m&&255!==m&&(v>0&&(v=1/v),a.push(u*v,h*v,c*v),n.push(d*v,g*v,f*v)),m},vt=[0,0,0],mt=function(e,t,r,i,a,n,s){vt[0]=vt[1]=vt[2]=0;for(var o=0,l=0;l<12;++l)if(e&1<<l&&(++o,!ut.BLOCK)){var u=t[l<<1],h=t[(l<<1)+1],c=r[u],d=c-r[h];if(!(Math.abs(d)<1e-7)){d=c/d;for(var g=0,f=1;g<3;++g,f<<=1){var v=u&f;v!==(h&f)?vt[g]+=v?1-d:d:vt[g]+=v?1:0}}}for(var m=1/o,p=0;p<3;++p)vt[p]=a[p]*(i[p]+m*vt[p])+n[p];s.push(vt[0],vt[1],vt[2])},pt=function(e,t,r,i,a,n,s){for(var o=0;o<3;++o)if(e&1<<o){var l=(o+1)%3,u=(o+2)%3;if(0!==n[l]&&0!==n[u]){var h=i[l],c=i[u];1&t?s.push(r[a],r[a-h],r[a-h-c],r[a-c]):s.push(r[a],r[a-c],r[a-h-c],r[a-h])}}};ut.computeSurface=function(e,t,r){var i=e.dims;t||(t=[0,0,0]),r||(r=i);for(var a=[0,0,0],n=[0,0,0],s=0;s<3;++s)a[s]=(r[s]-t[s])/i[s],n[s]=t[s];var o=[],l=[],u=[],h=[],c=0,d=new Int32Array(3),g=new Int32Array([1,i[0]+1,(i[0]+1)*(i[1]+1)]),f=new Float32Array(8),v=1,m=new Int32Array(2*g[2]);for(d[2]=0;d[2]<i[2]-1;++d[2],c+=i[0],v^=1,g[2]=-g[2]){var p=1+(i[0]+1)*(1+v*(i[1]+1));for(d[1]=0;d[1]<i[1]-1;++d[1],++c,p+=2)for(d[0]=0;d[0]<i[0]-1;++d[0],++c,++p){var _=ft(e,f,i,c,l,u);if(0!==_&&255!==_){var y=gt[_];m[p]=o.length/3,mt(y,dt,f,d,a,n,o),pt(y,_,m,g,p,d,h)}}}return{colors:new Float32Array(l),materials:new Float32Array(u),vertices:new Float32Array(o),faces:new Uint32Array(h)}};var _t=i.vec3,yt={};yt.RESOLUTION=150,yt.BLOCK=!1;var Mt=function(e,t){var r=e.dims,i=r[0],a=r[1],n=i*a,s=e.crossedEdges,o=e.distanceField,l=o.length,u=new Uint8Array(l),h=new Int32Array(l);h[0]=0;for(var c=1,d=[-1,1,-i,i,-n,n],g=[0,0,1,1,2,2],f=d.length,v=0,m=0;c>0;){var p=h[--c],_=o[p];if(_<t)for(v=0;v<f;++v){var y=d[v];m=p+y,m>=l||m<0||1!==u[m]&&o[m]!==1/0&&0===s[3*(y>=0?p:m)+g[v]]&&(u[m]=1,h[c++]=m)}else for(v=0;v<f;++v)m=p+d[v],m>=l||m<0||1!==u[m]&&(u[m]=1,h[c++]=m)}for(var M=0;M<l;++M)0===u[M]&&(o[M]=-o[M])},Tt=function(e,t,r,i){for(var a=1/i,n=r[0],s=r[1],o=r[2],l=t.dims[0],u=t.dims[1],h=t.distanceField,c=t.crossedEdges,d=t.colorField,g=t.materialField,f=e.getTriangles(),v=e.getVertices(),m=e.getColors(),p=e.getMaterials(),_=e.getNbTriangles(),y=[0,0,0],M=[0,0,0],T=[0,0,0],S=[0,0,0],b=[0,0,0],A=[0,0,0],x=[0,0,0,0],k=l*u,w=[[1,0,0],[0,1,0],[0,0,1]],E=1/3,R=0;R<_;++R)for(var F=3*R,D=3*f[F],I=3*f[F+1],C=3*f[F+2],N=y[0]=v[D],V=y[1]=v[D+1],P=y[2]=v[D+2],L=M[0]=v[I],U=M[1]=v[I+1],B=M[2]=v[I+2],O=T[0]=v[C],G=T[1]=v[C+1],z=T[2]=v[C+2],X=(m[D]+m[I]+m[C])*E,W=(m[D+1]+m[I+1]+m[C+1])*E,Y=(m[D+2]+m[I+2]+m[C+2])*E,H=(p[D]+p[I]+p[C])*E,j=(p[D+1]+p[I+1]+p[C+1])*E,q=(p[D+2]+p[I+2]+p[C+2])*E,K=N<L?N<O?N:O:L<O?L:O,Z=N>L?N>O?N:O:L>O?L:O,Q=V<U?V<G?V:G:U<G?U:G,J=V>U?V>G?V:G:U>G?U:G,$=P<B?P<z?P:z:B<z?B:z,ee=P>B?P>z?P:z:B>z?B:z,te=S[0]=L-N,re=S[1]=U-V,ie=S[2]=B-P,ae=b[0]=O-N,ne=b[1]=G-V,se=b[2]=z-P,oe=te*te+re*re+ie*ie,le=te*ae+re*ne+ie*se,ue=ae*ae+ne*ne+se*se,he=Math.floor((K-n)*a),ce=Math.floor((Q-s)*a),de=Math.floor(($-o)*a),ge=Math.ceil((Z-n)*a),fe=Math.ceil((J-s)*a),ve=Math.ceil((ee-o)*a),me=de;me<=ve;++me)for(var pe=ce;pe<=fe;++pe)for(var _e=he;_e<=ge;++_e){var ye=n+_e*i,Me=s+pe*i,Te=o+me*i,Se=_e+pe*l+me*k;A[0]=ye,A[1]=Me,A[2]=Te;var be=Ae.distance2PointTriangleEdges(A,S,b,y,oe,le,ue,x);if(be=Math.sqrt(be),be<h[Se]){h[Se]=be;var xe=3*Se;d[xe]=X,d[xe+1]=W,d[xe+2]=Y,g[xe]=H,g[xe+1]=j,g[xe+2]=q}if(!(be>i))for(var ke=0;ke<3;++ke){var we=x[ke]-A[ke];if(!(we<0||we>i)){var Ee=3*Se+ke;if(1!==c[Ee]){var Re=Ae.intersectionRayTriangleEdges(A,w[ke],S,b,y);Re<0||Re>i||(c[Ee]=1)}}}}},St=function(e,t,r){for(var i=1+Math.ceil((t[0]-e[0])/r),a=1+Math.ceil((t[1]-e[1])/r),s=1+Math.ceil((t[2]-e[2])/r),o=i*a*s,l=n.getMemory(31*o),u=new Float32Array(l,0,o),h=new Float32Array(l,4*o,3*o),c=new Float32Array(l,16*o,3*o),d=new Uint8Array(l,28*o,3*o),g=0;g<o;++g)u[g]=1/0;for(var f=0,v=3*o;f<v;++f)d[f]=0;for(var m=0,p=3*o;m<p;++m)h[m]=c[m]=-1;var _={};return _.dims=[i,a,s],_.crossedEdges=d,_.distanceField=u,_.colorField=h,_.materialField=c,_},bt=function(e,t,r,i,a){var n=new Qe(e.getGL());return n.setID(e.getID()),n.setFaces(t),n.setVertices(r),i&&n.setColors(i),a&&n.setMaterials(a),n.setRenderData(e.getRenderData()),n.init(),n.initRender(),n},At=function(e){for(var t=[1/0,1/0,1/0,-(1/0),-(1/0),-(1/0)],r=[0,0,0],i=0,a=e.length;i<a;++i){var n=e[i];n.isUsingTexCoords()&&n.setShaderType(o.Shader.MATCAP);var s=n.getMatrix();n=e[i]=lt.createClosedMesh(n);for(var l=n.getVertices(),u=0,h=n.getNbVertices();u<h;++u){var c=3*u;r[0]=l[c],r[1]=l[c+1],r[2]=l[c+2],_t.transformMat4(r,r,s);var d=l[c]=r[0],g=l[c+1]=r[1],f=l[c+2]=r[2];d<t[0]&&(t[0]=d),g<t[1]&&(t[1]=g),f<t[2]&&(t[2]=f),d>t[3]&&(t[3]=d),g>t[4]&&(t[4]=g),f>t[5]&&(t[5]=f)}}return t};yt.remesh=function(e,t){console.time("remesh total"),console.time("1. initMeshes"),e=e.slice();var r=At(e);console.timeEnd("1. initMeshes"),console.time("2. voxelization");for(var i=Math.max(r[3]-r[0],r[4]-r[1],r[5]-r[2])/yt.RESOLUTION,a=2.5*i,n=1.5*i,s=[r[0]-a,r[1]-a,r[2]-a],o=[r[3]+n,r[4]+n,r[5]+n],l=St(s,o,i),u=0,h=e.length;u<h;++u)Tt(e[u],l,s,i);console.timeEnd("2. voxelization"),console.time("3. flood"),Mt(l,i),console.timeEnd("3. flood"),console.time("4. surfaceNet"),o[0]+=n,o[1]+=n,o[2]+=n,ut.BLOCK=yt.BLOCK;var c=ut.computeSurface(l,s,o);console.timeEnd("4. surfaceNet"),console.time("5. createMesh");var d=bt(t,c.faces,c.vertices,c.colors,c.materials);return console.timeEnd("5. createMesh"),console.timeEnd("remesh total"),console.log("\n"),d},yt.mergeArrays=function(e,t){for(var r=0,i=0,a=0,s=0,o=e.length,l=0,u=0;u<o;++u)r+=e[u].getNbVertices(),i+=e[u].getNbFaces(),a+=e[u].getNbQuads(),s+=e[u].getNbTriangles();for(var h=t.vertices=void 0!==t.vertices?new Float32Array(3*r):null,c=t.colors=void 0!==t.colors?new Float32Array(3*r):null,d=t.materials=void 0!==t.materials?new Float32Array(3*r):null,g=t.faces=void 0!==t.faces?new Uint32Array(4*i):null,f=[0,0,0],v=0,m=0,p=0,u=0;u<o;++u){for(var _=e[u],y=_.getVertices(),M=_.getColors(),T=_.getMaterials(),S=_.getFaces(),b=_.getNbVertices(),A=_.getNbFaces(),x=_.getMatrix(),k=0;k<b;++k)l=3*k,f[0]=y[l],f[1]=y[l+1],f[2]=y[l+2],_t.transformMat4(f,f,x),h[v+l]=f[0],h[v+l+1]=f[1],h[v+l+2]=f[2],c&&(c[v+l]=M[l],c[v+l+1]=M[l+1],c[v+l+2]=M[l+2]),d&&(d[v+l]=T[l],d[v+l+1]=T[l+1],d[v+l+2]=T[l+2]);v+=3*b;for(var k=0;k<A;++k)l=4*k,g[m+l]=S[l]+p,g[m+l+1]=S[l+1]+p,g[m+l+2]=S[l+2]+p,g[m+l+3]=S[l+3]===n.TRI_INDEX?n.TRI_INDEX:S[l+3]+p;p+=b,m+=4*A}},yt.mergeMeshes=function(e,t){var r={vertices:null,colors:null,materials:null,faces:null};return yt.mergeArrays(e,r),bt(t,r.faces,r.vertices,r.colors,r.materials)};var xt={},kt=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:-.5,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:-.5,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,n=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,o=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:1,u=new Float32Array(4);u[0]=0,u[1]=1,u[2]=2,u[3]=3;var h=new Float32Array(12);return h[0]=e,h[1]=t,h[2]=r,h[3]=e+i,h[4]=t+a,h[5]=r+n,h[6]=e+i+s,h[7]=t+a+o,h[8]=r+n+l,h[9]=e+s,h[10]=t+o,h[11]=r+l,{faces:u,vertices:h}},wt=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=new Float32Array(24);t[1]=t[2]=t[4]=t[6]=t[7]=t[9]=t[10]=t[11]=t[14]=t[18]=t[21]=t[23]=.5*-e,t[0]=t[3]=t[5]=t[8]=t[12]=t[13]=t[15]=t[16]=t[17]=t[19]=t[20]=t[22]=.5*e;var r=new Float32Array(28);r[0]=r[6]=r[8]=r[10]=r[11]=r[13]=r[16]=r[23]=r[25]=.5,r[1]=r[3]=1,r[2]=r[4]=r[9]=r[12]=r[14]=r[15]=r[18]=.25,r[5]=r[7]=r[21]=r[24]=r[26]=r[27]=.75,r[17]=r[19]=r[20]=r[22]=0;var i=new Uint32Array(24),a=new Uint32Array(24);return i[0]=i[8]=i[21]=a[0]=0,i[1]=i[11]=i[12]=a[1]=1,i[2]=i[15]=i[16]=a[2]=a[15]=a[16]=2,i[3]=i[19]=i[22]=a[3]=a[19]=a[22]=3,i[4]=i[9]=i[20]=a[4]=a[9]=4,i[7]=i[10]=i[13]=a[5]=a[18]=a[23]=5,i[6]=i[14]=i[17]=a[6]=a[14]=a[17]=6,i[5]=i[18]=i[23]=a[7]=a[10]=7,a[8]=8,a[11]=9,a[12]=10,a[13]=11,a[20]=12,a[21]=13,{vertices:t,uv:r,faces:i,facesUV:a}},Et=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.5,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:64,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:64,s=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],o=!(arguments.length>6&&void 0!==arguments[6])||arguments[6],l=s&&0===e,u=o&&0===t,h=.5*r,c=(a+1)*i,d=a*i;s&&(c+=1,d+=i),o&&(c+=1,d+=i),(l||u)&&(c-=i,d-=i);var g=new Float32Array(3*c),f=new Uint32Array(4*d),v=0,m=0,p=0,_=0,y=l?1:0,M=u?a-1:a;for(p=y;p<=M;p++){var T=p/a,S=T*(t-e)+e;for(_=0;_<i;_++){var b=2*Math.PI*_/i;m=3*v++,g[m]=S*Math.sin(b),g[m+1]=-T*r+h,g[m+2]=S*Math.cos(b)}}for(v=0,_=0;_<i;_++){var A=_===i-1?0:_+1;for(p=y;p<M;p++)m=4*v++,f[m]=i*p+_,f[m+1]=i*(p+1)+_,f[m+2]=i*(p+1)+A,f[m+3]=i*p+A}var x;if(s)for(x=(o?g.length-6:g.length-3)/3,g[3*x+1]=h,_=0;_<i;_++)m=4*v++,f[m]=_,f[m+1]=_===i-1?0:_+1,f[m+2]=x,f[m+3]=n.TRI_INDEX;if(o){x=(g.length-3)/3,g[3*x+1]=-h,l&&--p;var k=i*p;for(_=0;_<i;_++)m=4*v++,f[m]=_===i-1?k:k+_+1,f[m+1]=k+_,f[m+2]=x,f[m+3]=n.TRI_INDEX}return{vertices:g,faces:f}},Rt=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.1,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2*Math.PI,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:32,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:128,s=2*Math.PI-r<.01,o=i*a,l=o;s||(o+=2,l+=i);var u=s?a:a-1,h=new Float32Array(3*o),c=new Uint32Array(4*l),d=0,g=0,f=0,v=0;for(f=0;f<a;++f)for(v=0;v<i;++v){var m=f/u*r,p=v/i*Math.PI*2;g=3*d++,h[g]=(e+t*Math.cos(p))*Math.cos(m),h[g+1]=t*Math.sin(p),h[g+2]=(e+t*Math.cos(p))*Math.sin(m)}for(d=0,f=0;f<u;++f){var _=f===a-1?0:f+1;for(v=0;v<i;++v){g=4*d++,c[g]=i*f+v;var y=v===i-1?0:v+1;c[g+1]=i*f+y,c[g+2]=i*_+y,c[g+3]=i*_+v}}if(!s){var M=(h.length-6)/3;for(h[3*M]=e,v=0;v<i;v++)g=4*d++,c[g]=M,c[g+1]=v===i-1?0:v+1,c[g+2]=v,c[g+3]=n.TRI_INDEX;++M,h[3*M]=e*Math.cos(r),h[3*M+2]=e*Math.sin(r);var T=i*f;for(v=0;v<i;v++)g=4*d++,c[g]=M,c[g+1]=T+v,c[g+2]=v===i-1?T:T+v+1,c[g+3]=n.TRI_INDEX}return{vertices:h,faces:c}},Ft=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:-.5,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:-.5,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,n=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,o=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:1,u=arguments.length>9&&void 0!==arguments[9]?arguments[9]:20,h=arguments.length>10&&void 0!==arguments[10]?arguments[10]:u;u+=2,h+=2;var c=new Float32Array(2*(u+h)*3),d=0,g=0,f=i/(u-1),v=a/(u-1),m=n/(u-1),p=e+i+s,_=t+a+o,y=r+n+l;for(d=0;d<u;++d)g=6*d,c[g]=e+f*d,c[g+1]=t+v*d,c[g+2]=r+m*d,c[g+3]=p-f*(u-d-1),c[g+4]=_-v*(u-d-1),c[g+5]=y-m*(u-d-1);for(f=s/(h-1),v=o/(h-1),m=l/(h-1),d=0;d<h;++d)g=6*(u+d),c[g]=e+f*d,c[g+1]=t+v*d,c[g+2]=r+m*d,c[g+3]=p-f*(h-d-1),c[g+4]=_-v*(h-d-1),c[g+5]=y-m*(h-d-1);return{vertices:c}},Dt=function(e,t){var r=new Qe(e);return r.setVertices(t.vertices),t.faces&&r.setFaces(t.faces),t.uv&&t.facesUV&&r.initTexCoordsDataFromOBJData(t.uv,t.facesUV),r.init(),e&&r.initRender(),r},It=Array.prototype.slice;xt.createGrid=function(e){var t=Dt(e,Ft.apply(this,It.call(arguments,1)));return e&&(t.setMode(e.LINES),t.setUseDrawArrays(!0),t.setAlreadyDrawArrays()),t},xt.createCube=function(e){return Dt(e,wt.apply(this,It.call(arguments,1)))},xt.createCylinder=function(e){return Dt(e,Et.apply(this,It.call(arguments,1)))},xt.createTorus=function(e){return Dt(e,Rt.apply(this,It.call(arguments,1)))},xt.createPlane=function(e){return Dt(e,kt.apply(this,It.call(arguments,1)))},xt.createArrow=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.5,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:5,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:.2,n=arguments.length>5&&void 0!==arguments[5]?arguments[5]:4,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1,o=Dt(null,Et(t,t,r,n,s)),l=Dt(null,Et(0,t*i,r*a,n,s));l.getMatrix()[13]=.5*r;var u={vertices:null,faces:null};return yt.mergeArrays([o,l],u),Dt(e,u)},xt.createLine2D=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,n=Dt(e,{vertices:new Float32Array([t,r,0,i,a,0])});return e&&(n.setMode(e.LINES),n.setUseDrawArrays(!0),n.setAlreadyDrawArrays()),n};var Ct=i.vec2,Nt=i.vec3,Vt=i.mat4,Pt=i.quat,Lt=Nt.fromValues(.7,.2,.2),Ut=Nt.fromValues(.2,.7,.2),Bt=Nt.fromValues(.2,.2,.7),Ot=Nt.fromValues(.4,.4,.4),Gt=Nt.fromValues(.8,.4,.2),zt=80,Xt=2.5,Wt=6,Yt=.25,Ht=.02,jt=5*Ht,qt=1.5,Kt=1.3*qt,Zt=.35,Qt=1.2*Zt,Jt=Pt.create(),$t=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1;return{_finalMatrix:Vt.create(),_baseMatrix:Vt.create(),_color:Nt.create(),_colorSelect:Nt.fromValues(1,1,0),_drawGeo:null,_pickGeo:null,_isSelected:!1,_type:e,_nbAxis:t,_lastInter:[0,0,0],updateMatrix:function(){Vt.copy(this._drawGeo.getMatrix(),this._finalMatrix),Vt.copy(this._pickGeo.getMatrix(),this._finalMatrix)},updateFinalMatrix:function(e){Vt.mul(this._finalMatrix,e,this._baseMatrix)}}},er=1,tr=2,rr=4,ir=8,ar=16,nr=32,sr=64,or=128,lr=256,ur=512,hr=1024,cr=2048,dr=4096,gr=8192,fr=er|tr|rr,vr=ir|ar|nr,mr=or|lr|ur,pr=hr|cr|dr|gr,_r=function(){function e(t){y(this,e),this._main=t,this._gl=t._gl,this._activatedType=e.TRANS_XYZ|e.ROT_XYZ|e.PLANE_XYZ|e.SCALE_XYZW|e.ROT_W,this._transX=$t(e.TRANS_X,0),this._transY=$t(e.TRANS_Y,1),this._transZ=$t(e.TRANS_Z,2),this._planeX=$t(e.PLANE_X,0),this._planeY=$t(e.PLANE_Y,1),this._planeZ=$t(e.PLANE_Z,2),this._scaleX=$t(e.SCALE_X,0),this._scaleY=$t(e.SCALE_Y,1),this._scaleZ=$t(e.SCALE_Z,2),this._scaleW=$t(e.SCALE_W),this._rotX=$t(e.ROT_X,0),this._rotY=$t(e.ROT_Y,1),this._rotZ=$t(e.ROT_Z,2),this._rotW=$t(e.ROT_W),this._lineHelper=xt.createLine2D(this._gl),this._lineHelper.setShaderType(o.Shader.FLAT),this._lastDistToEye=0,this._isEditing=!1,this._selected=null,this._pickables=[],this._editLineOrigin=[0,0,0],this._editLineDirection=[0,0,0],this._editOffset=[0,0,0],this._editLocal=Vt.create(),this._editTrans=Vt.create(),this._editScaleRot=Vt.create(),this._editLocalInv=Vt.create(),this._editTransInv=Vt.create(),this._editScaleRotInv=Vt.create(),this._initTranslate(),this._initRotate(),this._initScale(),this._initPickables()}return M(e,null,[{key:"TRANS_X",get:function(){return er}},{key:"TRANS_Y",get:function(){return tr}},{key:"TRANS_Z",get:function(){return rr}},{key:"ROT_X",get:function(){return ir}},{key:"ROT_Y",get:function(){return ar}},{key:"ROT_Z",get:function(){return nr}},{key:"ROT_W",get:function(){return sr}},{key:"PLANE_X",get:function(){return or}},{key:"PLANE_Y",get:function(){return lr}},{key:"PLANE_Z",get:function(){return ur}},{key:"SCALE_X",get:function(){return hr}},{key:"SCALE_Y",get:function(){return cr}},{key:"SCALE_Z",get:function(){return dr}},{key:"SCALE_W",get:function(){return gr}},{key:"TRANS_XYZ",get:function(){return fr}},{key:"ROT_XYZ",get:function(){return vr}},{key:"PLANE_XYZ",get:function(){return mr}},{key:"SCALE_XYZW",get:function(){return pr}}]),M(e,[{key:"setActivatedType",value:function(e){this._activatedType=e,this._initPickables()}},{key:"_initPickables",value:function(){var e=this._pickables;e.length=0;var t=this._activatedType;t&er&&e.push(this._transX._pickGeo),t&tr&&e.push(this._transY._pickGeo),t&rr&&e.push(this._transZ._pickGeo),t&or&&e.push(this._planeX._pickGeo),t&lr&&e.push(this._planeY._pickGeo),t&ur&&e.push(this._planeZ._pickGeo),t&ir&&e.push(this._rotX._pickGeo),t&ar&&e.push(this._rotY._pickGeo),t&nr&&e.push(this._rotZ._pickGeo),t&hr&&e.push(this._scaleX._pickGeo),t&cr&&e.push(this._scaleY._pickGeo),t&dr&&e.push(this._scaleZ._pickGeo),t&gr&&e.push(this._scaleW._pickGeo)}},{key:"_createArrow",value:function(e,t,r){var i=e._baseMatrix;Vt.rotate(i,i,.5*Math.PI,t),Vt.translate(i,i,[0,.5*Xt,0]),Nt.copy(e._color,r),e._pickGeo=xt.createArrow(this._gl,jt,Xt,.4*Wt),e._pickGeo._gizmo=e,e._drawGeo=xt.createArrow(this._gl,Ht,Xt,Wt,Yt),e._drawGeo.setShaderType(o.Shader.FLAT)}},{key:"_createPlane",value:function(e,t,r,i,a,n,s,l){Nt.copy(e._color,t),e._pickGeo=xt.createPlane(this._gl,0,0,0,r,i,a,n,s,l),e._pickGeo._gizmo=e,e._drawGeo=xt.createPlane(this._gl,0,0,0,r,i,a,n,s,l),e._drawGeo.setShaderType(o.Shader.FLAT)}},{key:"_initTranslate",value:function(){var e=[0,0,0];this._createArrow(this._transX,Nt.set(e,0,0,-1),Lt),this._createArrow(this._transY,Nt.set(e,0,1,0),Ut),this._createArrow(this._transZ,Nt.set(e,1,0,0),Bt);var t=.2*Xt;this._createPlane(this._planeX,Lt,0,t,0,0,0,t),this._createPlane(this._planeY,Ut,t,0,0,0,0,t),this._createPlane(this._planeZ,Bt,t,0,0,0,t,0)}},{key:"_createCircle",value:function(e,t,r){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:qt,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1;Nt.copy(e._color,r),e._pickGeo=xt.createTorus(this._gl,i,jt*a,t,6,64),e._pickGeo._gizmo=e,e._drawGeo=xt.createTorus(this._gl,i,Ht*a,t,6,64),e._drawGeo.setShaderType(o.Shader.FLAT)}},{key:"_initRotate",value:function(){this._createCircle(this._rotX,Math.PI,Lt),this._createCircle(this._rotY,Math.PI,Ut),this._createCircle(this._rotZ,Math.PI,Bt),this._createCircle(this._rotW,2*Math.PI,Ot)}},{key:"_createCube",value:function(e,t,r){var i=e._baseMatrix;Vt.rotate(i,i,.5*Math.PI,t),Vt.translate(i,i,[0,qt,0]),Nt.copy(e._color,r),e._pickGeo=xt.createCube(this._gl,Qt),e._pickGeo._gizmo=e,e._drawGeo=xt.createCube(this._gl,Zt),e._drawGeo.setShaderType(o.Shader.FLAT)}},{key:"_initScale",value:function(){var e=[0,0,0];this._createCube(this._scaleX,Nt.set(e,0,0,-1),Lt),this._createCube(this._scaleY,Nt.set(e,0,1,0),Ut),this._createCube(this._scaleZ,Nt.set(e,1,0,0),Bt),this._createCircle(this._scaleW,2*Math.PI,Gt,Kt,2)}},{key:"_updateArcRotation",value:function(e){Jt[0]=e[2],Jt[1]=0,Jt[2]=-e[0],Jt[3]=1+e[1],Pt.normalize(Jt,Jt),Vt.fromQuat(this._rotW._baseMatrix,Jt),Vt.fromQuat(this._scaleW._baseMatrix,Jt),Pt.rotateZ(Jt,Pt.identity(Jt),.5*Math.PI),Pt.rotateY(Jt,Jt,Math.atan2(-e[1],-e[2])),Vt.fromQuat(this._rotX._baseMatrix,Jt),Pt.rotateY(Jt,Pt.identity(Jt),Math.atan2(-e[0],-e[2])),Vt.fromQuat(this._rotY._baseMatrix,Jt),Pt.rotateX(Jt,Pt.identity(Jt),.5*Math.PI),Pt.rotateY(Jt,Jt,Math.atan2(-e[0],e[1])),Vt.fromQuat(this._rotZ._baseMatrix,Jt)}},{key:"_computeCenterGizmo",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[0,0,0],t=this._main.getMesh();return t&&(Nt.copy(e,t.getCenter()),Nt.transformMat4(e,e,t.getEditMatrix()),Nt.transformMat4(e,e,t.getMatrix())),e}},{key:"_updateMatrices",value:function(){var e=this._main.getCamera(),t=this._computeCenterGizmo(),r=e.computePosition();this._lastDistToEye=this._isEditing?this._lastDistToEye:Nt.dist(r,t);var i=this._lastDistToEye*zt/e.getConstantScreen(),a=Vt.create();Vt.translate(a,a,t),Vt.scale(a,a,[i,i,i]),this._updateArcRotation(Nt.normalize(r,Nt.sub(r,t,r))),this._transX.updateFinalMatrix(a),this._transY.updateFinalMatrix(a),this._transZ.updateFinalMatrix(a),this._planeX.updateFinalMatrix(a),this._planeY.updateFinalMatrix(a),this._planeZ.updateFinalMatrix(a),this._rotX.updateFinalMatrix(a),this._rotY.updateFinalMatrix(a),this._rotZ.updateFinalMatrix(a),this._rotW.updateFinalMatrix(a),this._scaleX.updateFinalMatrix(a),this._scaleY.updateFinalMatrix(a),this._scaleZ.updateFinalMatrix(a),this._scaleW.updateFinalMatrix(a)}},{key:"_drawGizmo",value:function(e){e.updateMatrix();var t=e._drawGeo;t.setFlatColor(e._isSelected?e._colorSelect:e._color),t.updateMatrices(this._main.getCamera()),t.render(this._main)}},{key:"_updateLineHelper",value:function(e,t,r,i){var a=this._lineHelper.getVertices(),n=this._main,s=n.getCanvasWidth(),o=n.getCanvasHeight();a[0]=e/s*2-1,a[1]=(o-t)/o*2-1,a[3]=r/s*2-1,a[4]=(o-i)/o*2-1,this._lineHelper.updateVertexBuffer()}},{key:"_saveEditMatrices",value:function(){Vt.copy(this._editLocal,this._main.getMesh().getMatrix());var e=this._computeCenterGizmo();Vt.translate(this._editTrans,Vt.identity(this._editTrans),e),Vt.copy(this._editScaleRot,this._editLocal),this._editScaleRot[12]=this._editScaleRot[13]=this._editScaleRot[14]=0,Vt.invert(this._editLocalInv,this._editLocal),Vt.invert(this._editTransInv,this._editTrans),Vt.invert(this._editScaleRotInv,this._editScaleRot)}},{key:"_startRotateEdit",value:function(){var e=this._main,t=e.getCamera(),r=[0,0,0];this._computeCenterGizmo(r),Nt.copy(r,t.project(r));var i=this._editLineDirection,a=0===this._selected._nbAxis?-1:1,n=this._selected._lastInter;Nt.set(i,-a*n[2],-a*n[1],a*n[0]),Nt.transformMat4(i,i,this._selected._finalMatrix),Nt.copy(i,t.project(i)),Ct.normalize(i,Ct.sub(i,i,r)),Ct.set(this._editLineOrigin,e._mouseX,e._mouseY)}},{key:"_startTranslateEdit",value:function(){var e=this._main,t=e.getCamera(),r=this._editLineOrigin,i=this._editLineDirection;this._computeCenterGizmo(r);var a=this._selected._nbAxis;a!==-1&&(Nt.set(i,0,0,0)[a]=1),Nt.add(i,r,i),Nt.copy(r,t.project(r)),Nt.copy(i,t.project(i)),Ct.normalize(i,Ct.sub(i,i,r));var n=this._editOffset;n[0]=e._mouseX-r[0],n[1]=e._mouseY-r[1]}},{key:"_startPlaneEdit",value:function(){var e=this._main,t=e.getCamera(),r=this._editLineOrigin;this._computeCenterGizmo(r),Nt.copy(r,t.project(r));var i=this._editOffset;i[0]=e._mouseX-r[0],i[1]=e._mouseY-r[1],Ct.set(this._editLineOrigin,e._mouseX,e._mouseY)}},{key:"_startScaleEdit",value:function(){this._startTranslateEdit()}},{key:"_updateRotateEdit",value:function(){var e=this._main,t=e.getMesh(),r=this._editLineOrigin,i=this._editLineDirection,a=[e._mouseX,e._mouseY,0];Ct.sub(a,a,r);var n=Ct.dot(a,i);this._updateLineHelper(r[0],r[1],r[0]+i[0]*n,r[1]+i[1]*n);var s=7*n/Math.min(e.getCanvasWidth(),e.getCanvasHeight());s%=2*Math.PI;var o=this._selected._nbAxis,l=t.getEditMatrix();Vt.identity(l),0===o?Vt.rotateX(l,l,-s):1===o?Vt.rotateY(l,l,-s):2===o&&Vt.rotateZ(l,l,-s),this._scaleRotateEditMatrix(l),e.render()}},{key:"_updateTranslateEdit",value:function(){var e=this._main,t=e.getCamera(),r=e.getMesh(),i=this._editLineOrigin,a=this._editLineDirection,n=[e._mouseX,e._mouseY,0];Ct.sub(n,n,i),Ct.sub(n,n,this._editOffset),Ct.scaleAndAdd(n,i,a,Ct.dot(n,a)),this._updateLineHelper(i[0],i[1],n[0],n[1]);var s=t.unproject(n[0],n[1],0),o=t.unproject(n[0],n[1],.1);Nt.transformMat4(s,s,this._editTransInv),Nt.transformMat4(o,o,this._editTransInv),Nt.normalize(n,Nt.sub(n,o,s));var l=[0,0,0];
l[this._selected._nbAxis]=1;var u=-Nt.dot(n,l),h=Nt.dot(s,n),c=Math.abs(1-u*u),d=-Nt.dot(s,l);l[this._selected._nbAxis]=(u*h-d)/c,Nt.transformMat4(l,l,this._editScaleRotInv);var g=r.getEditMatrix();Vt.identity(g),Vt.translate(g,g,l),e.render()}},{key:"_updatePlaneEdit",value:function(){var e=this._main,t=e.getCamera(),r=e.getMesh(),i=[e._mouseX,e._mouseY,0];Ct.sub(i,i,this._editOffset),this._updateLineHelper(this._editLineOrigin[0],this._editLineOrigin[1],e._mouseX,e._mouseY);var a=t.unproject(i[0],i[1],0),n=t.unproject(i[0],i[1],.1);Nt.transformMat4(a,a,this._editTransInv),Nt.transformMat4(n,n,this._editTransInv);var s=[0,0,0];s[this._selected._nbAxis]=1;var o=Nt.dot(a,s),l=Nt.dot(n,s);if(o===l)return!1;var u=-o/(l-o);s[0]=a[0]+(n[0]-a[0])*u,s[1]=a[1]+(n[1]-a[1])*u,s[2]=a[2]+(n[2]-a[2])*u,Nt.transformMat4(s,s,this._editScaleRotInv);var h=r.getEditMatrix();Vt.identity(h),Vt.translate(h,h,s),e.render()}},{key:"_updateScaleEdit",value:function(){var e=this._main,t=e.getMesh(),r=this._editLineOrigin,i=this._editLineDirection,a=this._selected._nbAxis,n=[e._mouseX,e._mouseY,0];a!==-1&&(Ct.sub(n,n,r),Ct.scaleAndAdd(n,r,i,Ct.dot(n,i))),this._updateLineHelper(r[0],r[1],n[0],n[1]);var s=Nt.len(this._editOffset),o=[1,1,1],l=Math.max(-.99,(Ct.dist(r,n)-s)/s);a===-1?(o[0]+=l,o[1]+=l,o[2]+=l):o[a]+=l;var u=t.getEditMatrix();Vt.identity(u),Vt.scale(u,u,o),this._scaleRotateEditMatrix(u),e.render()}},{key:"_scaleRotateEditMatrix",value:function(e){Vt.mul(e,this._editTrans,e),Vt.mul(e,e,this._editTransInv),Vt.mul(e,this._editLocalInv,e),Vt.mul(e,e,this._editLocal)}},{key:"addGizmoToScene",value:function(e){return e.push(this._transX._drawGeo),e.push(this._transY._drawGeo),e.push(this._transZ._drawGeo),e.push(this._planeX._drawGeo),e.push(this._planeY._drawGeo),e.push(this._planeZ._drawGeo),e.push(this._rotX._drawGeo),e.push(this._rotY._drawGeo),e.push(this._rotZ._drawGeo),e.push(this._rotW._drawGeo),e.push(this._scaleX._drawGeo),e.push(this._scaleY._drawGeo),e.push(this._scaleZ._drawGeo),e.push(this._scaleW._drawGeo),e}},{key:"render",value:function(){this._updateMatrices();var e=this._isEditing&&this._selected?this._selected._type:this._activatedType;e&sr&&this._drawGizmo(this._rotW),e&er&&this._drawGizmo(this._transX),e&tr&&this._drawGizmo(this._transY),e&rr&&this._drawGizmo(this._transZ),e&or&&this._drawGizmo(this._planeX),e&lr&&this._drawGizmo(this._planeY),e&ur&&this._drawGizmo(this._planeZ),e&ir&&this._drawGizmo(this._rotX),e&ar&&this._drawGizmo(this._rotY),e&nr&&this._drawGizmo(this._rotZ),e&hr&&this._drawGizmo(this._scaleX),e&cr&&this._drawGizmo(this._scaleY),e&dr&&this._drawGizmo(this._scaleZ),e&gr&&this._drawGizmo(this._scaleW),this._isEditing&&this._lineHelper.render(this._main)}},{key:"onMouseOver",value:function(){if(this._isEditing){var e=this._selected._type;return e&vr?this._updateRotateEdit():e&fr?this._updateTranslateEdit():e&mr?this._updatePlaneEdit():e&pr&&this._updateScaleEdit(),!0}var t=this._main,r=t.getPicking(),i=t._mouseX,a=t._mouseY,n=this._pickables;r.intersectionMouseMeshes(n,i,a),this._selected&&(this._selected._isSelected=!1);var s=r.getMesh();return s?(this._selected=s._gizmo,this._selected._isSelected=!0,Nt.copy(this._selected._lastInter,r.getIntersectionPoint()),!0):(this._selected=null,!1)}},{key:"onMouseDown",value:function(){var e=this._selected;if(!e)return!1;this._isEditing=!0;var t=e._type;return this._saveEditMatrices(),t&vr?this._startRotateEdit():t&fr?this._startTranslateEdit():t&mr?this._startPlaneEdit():t&pr&&this._startScaleEdit(),!0}},{key:"onMouseUp",value:function(){this._isEditing=!1}}]),e}(),yr=i.vec3,Mr=i.mat4,Tr=function(e){function t(e){y(this,t);var r=b(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return r._gizmo=new _r(e),r}return S(t,e),M(t,[{key:"isIdentity",value:function(e){return 1===e[0]&&1===e[5]&&1===e[10]&&1===e[15]&&(0===e[1]&&0===e[2]&&0===e[3]&&0===e[4]&&(0===e[6]&&0===e[7]&&0===e[8]&&0===e[9]&&(0===e[11]&&0===e[12]&&0===e[13]&&0===e[14])))}},{key:"preUpdate",value:function(){var e=this._main.getPicking(),t=e.getMesh();this._gizmo.onMouseOver(),e._mesh=t,this._main.setCanvasCursor("default")}},{key:"start",value:function(e){var t=this._main,r=this.getMesh(),i=t.getPicking();return r&&this._gizmo.onMouseDown()?(this.pushState(),i._mesh=r,!0):!!i.intersectionMouseMeshes(t.getMeshes(),t._mouseX,t._mouseY)&&(!!t.setOrUnsetMesh(i.getMesh(),e)&&(this._lastMouseX=t._mouseX,this._lastMouseY=t._mouseY,!1))}},{key:"end",value:function(){this._gizmo.onMouseUp();var e=this.getMesh();if(e&&!this.isIdentity(e.getEditMatrix())){var t=this.getUnmaskedVertices();this._main.getStateManager().pushVertices(t),this.applyEditMatrix(t),0!==t.length&&this.updateMeshBuffers()}}},{key:"applyEditMatrix",value:function(e){for(var t=this.getMesh(),r=t.getEditMatrix(),i=t.getMaterials(),a=t.getVertices(),n=[0,0,0],s=0,o=e.length;s<o;++s){var l=3*e[s],u=i[l+2],h=n[0]=a[l],c=n[1]=a[l+1],d=n[2]=a[l+2];yr.transformMat4(n,n,r);var g=1-u;a[l]=h*g+n[0]*u,a[l+1]=c*g+n[1]*u,a[l+2]=d*g+n[2]*u}yr.transformMat4(t.getCenter(),t.getCenter(),r),Mr.identity(r),e.length===t.getNbVertices()?t.updateGeometry():t.updateGeometry(t.getFacesFromVertices(e),e)}},{key:"update",value:function(){}},{key:"postRender",value:function(){this.getMesh()&&this._gizmo.render()}},{key:"addSculptToScene",value:function(e){this.getMesh()&&this._gizmo.addGizmoToScene(e)}}]),t}(_e),Sr=[];Sr[o.Tools.BRUSH]=Te,Sr[o.Tools.INFLATE]=Se,Sr[o.Tools.TWIST]=Ee,Sr[o.Tools.SMOOTH]=Re,Sr[o.Tools.FLATTEN]=ye,Sr[o.Tools.PINCH]=Fe,Sr[o.Tools.CREASE]=De,Sr[o.Tools.DRAG]=Ne,Sr[o.Tools.PAINT]=Pe,Sr[o.Tools.MOVE]=Be,Sr[o.Tools.MASKING]=et,Sr[o.Tools.LOCALSCALE]=tt,Sr[o.Tools.TRANSFORM]=Tr,Sr[o.Tools.BRUSH].uiName="sculptBrush",Sr[o.Tools.INFLATE].uiName="sculptInflate",Sr[o.Tools.TWIST].uiName="sculptTwist",Sr[o.Tools.SMOOTH].uiName="sculptSmooth",Sr[o.Tools.FLATTEN].uiName="sculptFlatten",Sr[o.Tools.PINCH].uiName="sculptPinch",Sr[o.Tools.CREASE].uiName="sculptCrease",Sr[o.Tools.DRAG].uiName="sculptDrag",Sr[o.Tools.PAINT].uiName="sculptPaint",Sr[o.Tools.MOVE].uiName="sculptMove",Sr[o.Tools.MASKING].uiName="sculptMasking",Sr[o.Tools.LOCALSCALE].uiName="sculptLocalScale",Sr[o.Tools.TRANSFORM].uiName="sculptTransform";var br=function(){function e(t){y(this,e),this._main=t,this._toolIndex=o.Tools.BRUSH,this._tools=[],this._symmetry=!0,this._continuous=!1,this._sculptTimer=-1,this._selection=new me(t._gl),this.init()}return M(e,[{key:"setToolIndex",value:function(e){this._toolIndex=e}},{key:"getToolIndex",value:function(){return this._toolIndex}},{key:"getCurrentTool",value:function(){return this._tools[this._toolIndex]}},{key:"getSymmetry",value:function(){return this._symmetry}},{key:"getTool",value:function(e){return this._tools[e]}},{key:"getSelection",value:function(){return this._selection}},{key:"init",value:function(){for(var e=this._main,t=this._tools,r=0,i=Sr.length;r<i;++r)Sr[r]&&(t[r]=new Sr[r](e))}},{key:"canBeContinuous",value:function(){switch(this._toolIndex){case o.Tools.TWIST:case o.Tools.MOVE:case o.Tools.DRAG:case o.Tools.LOCALSCALE:case o.Tools.TRANSFORM:return!1;default:return!0}}},{key:"isUsingContinuous",value:function(){return this._continuous&&this.canBeContinuous()}},{key:"start",value:function(e){var t=this.getCurrentTool(),r=t.start(e);return this._main.getPicking().getMesh()&&this.isUsingContinuous()&&(this._sculptTimer=window.setInterval(t._cbContinuous,16.6)),r}},{key:"end",value:function(){this.getCurrentTool().end(),this._sculptTimer!==-1&&(clearInterval(this._sculptTimer),this._sculptTimer=-1)}},{key:"preUpdate",value:function(){this.getCurrentTool().preUpdate(this.canBeContinuous())}},{key:"update",value:function(){this.isUsingContinuous()||this.getCurrentTool().update()}},{key:"postRender",value:function(){this.getCurrentTool().postRender(this._selection)}},{key:"addSculptToScene",value:function(e){return this.getCurrentTool().addSculptToScene(e)}}]),e}(),Ar={};Ar.LINEAR=!1;var xr=function(){function e(t,r,i,a){y(this,e),this._vArOut=r,this._cArOut=i,this._mArOut=a,this._vAr=t.getVertices(),this._cAr=t.getColors(),this._mAr=t.getMaterials(),this._eAr=t.getEdges(),this._nbVertices=t.getNbVertices(),this._tagEdges=new Int32Array(t.getNbEdges())}return M(e,[{key:"computeTriangleEdgeVertex",value:function(e,t,r,i){var a=this._vAr,n=this._cAr,s=this._mAr,o=this._eAr,l=this._vArOut,u=this._cArOut,h=this._mArOut,c=this._tagEdges,d=3*e,g=3*t,f=3*r,v=c[i]-1,m=v===-1?this._nbVertices++:v,p=3*m,_=o[i];if(1===_||_>=3||Ar.LINEAR){if(v!==-1)return m;c[i]=m+1,l[p]=.5*(a[d]+a[g]),l[p+1]=.5*(a[d+1]+a[g+1]),l[p+2]=.5*(a[d+2]+a[g+2]),u[p]=.5*(n[d]+n[g]),u[p+1]=.5*(n[d+1]+n[g+1]),u[p+2]=.5*(n[d+2]+n[g+2]),h[p]=.5*(s[d]+s[g]),h[p+1]=.5*(s[d+1]+s[g+1]),h[p+2]=.5*(s[d+2]+s[g+2])}else v===-1?(c[i]=m+1,l[p]=.125*a[f]+.375*(a[d]+a[g]),l[p+1]=.125*a[f+1]+.375*(a[d+1]+a[g+1]),l[p+2]=.125*a[f+2]+.375*(a[d+2]+a[g+2]),u[p]=.125*n[f]+.375*(n[d]+n[g]),u[p+1]=.125*n[f+1]+.375*(n[d+1]+n[g+1]),u[p+2]=.125*n[f+2]+.375*(n[d+2]+n[g+2]),h[p]=.125*s[f]+.375*(s[d]+s[g]),h[p+1]=.125*s[f+1]+.375*(s[d+1]+s[g+1]),h[p+2]=.125*s[f+2]+.375*(s[d+2]+s[g+2])):(l[p]+=.125*a[f],l[p+1]+=.125*a[f+1],l[p+2]+=.125*a[f+2],u[p]+=.125*n[f],u[p+1]+=.125*n[f+1],u[p+2]+=.125*n[f+2],h[p]+=.125*s[f],h[p+1]+=.125*s[f+1],h[p+2]+=.125*s[f+2]);return m}},{key:"computeQuadEdgeVertex",value:function(e,t,r,i,a){var n=this._vAr,s=this._cAr,o=this._mAr,l=this._eAr,u=this._vArOut,h=this._cArOut,c=this._mArOut,d=this._tagEdges,g=3*e,f=3*t,v=3*r,m=3*i,p=d[a]-1,_=p===-1?this._nbVertices++:p,y=3*_,M=l[a];if(1===M||M>=3||Ar.LINEAR){if(p!==-1)return _;d[a]=_+1,u[y]=.5*(n[g]+n[f]),u[y+1]=.5*(n[g+1]+n[f+1]),u[y+2]=.5*(n[g+2]+n[f+2]),h[y]=.5*(s[g]+s[f]),h[y+1]=.5*(s[g+1]+s[f+1]),h[y+2]=.5*(s[g+2]+s[f+2]),c[y]=.5*(o[g]+o[f]),c[y+1]=.5*(o[g+1]+o[f+1]),c[y+2]=.5*(o[g+2]+o[f+2])}else p===-1?(d[a]=_+1,u[y]=.0625*(n[v]+n[m])+.375*(n[g]+n[f]),u[y+1]=.0625*(n[v+1]+n[m+1])+.375*(n[g+1]+n[f+1]),u[y+2]=.0625*(n[v+2]+n[m+2])+.375*(n[g+2]+n[f+2]),h[y]=.0625*(s[v]+s[m])+.375*(s[g]+s[f]),h[y+1]=.0625*(s[v+1]+s[m+1])+.375*(s[g+1]+s[f+1]),h[y+2]=.0625*(s[v+2]+s[m+2])+.375*(s[g+2]+s[f+2]),c[y]=.0625*(o[v]+o[m])+.375*(o[g]+o[f]),c[y+1]=.0625*(o[v+1]+o[m+1])+.375*(o[g+1]+o[f+1]),c[y+2]=.0625*(o[v+2]+o[m+2])+.375*(o[g+2]+o[f+2])):(u[y]+=.0625*(n[v]+n[m]),u[y+1]+=.0625*(n[v+1]+n[m+1]),u[y+2]+=.0625*(n[v+2]+n[m+2]),h[y]+=.0625*(s[v]+s[m]),h[y+1]+=.0625*(s[v+1]+s[m+1]),h[y+2]+=.0625*(s[v+2]+s[m+2]),c[y]+=.0625*(o[v]+o[m]),c[y+1]+=.0625*(o[v+1]+o[m+1]),c[y+2]+=.0625*(o[v+2]+o[m+2]));return _}},{key:"computeFaceVertex",value:function(e,t,r,i){var a=3*e,n=3*t,s=3*r,o=3*i,l=this._vAr,u=this._cAr,h=this._mAr,c=this._vArOut,d=this._cArOut,g=this._mArOut,f=this._nbVertices++,v=3*f;return c[v]=.25*(l[a]+l[n]+l[s]+l[o]),c[v+1]=.25*(l[a+1]+l[n+1]+l[s+1]+l[o+1]),c[v+2]=.25*(l[a+2]+l[n+2]+l[s+2]+l[o+2]),d[v]=.25*(u[a]+u[n]+u[s]+u[o]),d[v+1]=.25*(u[a+1]+u[n+1]+u[s+1]+u[o+1]),d[v+2]=.25*(u[a+2]+u[n+2]+u[s+2]+u[o+2]),g[v]=.25*(h[a]+h[n]+h[s]+h[o]),g[v+1]=.25*(h[a+1]+h[n+1]+h[s+1]+h[o+1]),g[v+2]=.25*(h[a+2]+h[n+2]+h[s+2]+h[o+2]),f}}]),e}(),kr=function(e,t,r,i){r.set(e.getColors()),i.set(e.getMaterials());for(var a=e.getVertices(),s=e.getFaces(),o=e.getEdges(),l=e.getFaceEdges(),u=e.getVerticesOnEdge(),h=e.getVerticesRingVertStartCount(),c=e.getVerticesRingVert(),d=e.getVerticesRingFaceStartCount(),g=e.getVerticesRingFace(),f=e.hasOnlyTriangles(),v=e.getNbVertices(),m=0;m<v;++m){var p=3*m,_=0,y=0,M=0,T=0,S=0,b=0,A=0;if(u[m]||Ar.LINEAR){var x=d[2*m],k=x+d[2*m+1];for(b=x;b<k;++b){var w=4*g[b],E=s[w],R=s[w+1],F=s[w+2],D=s[w+3],I=D===n.TRI_INDEX;A=n.TRI_INDEX,E===m?1===o[l[w]]?A=R:1===o[l[I?w+2:w+3]]&&(A=I?F:D):R===m?1===o[l[w]]?A=E:1===o[l[w+1]]&&(A=F):F===m?1===o[l[w+1]]?A=R:1===o[l[w+2]]&&(A=I?E:D):D===m&&(1===o[l[w+2]]?A=F:1===o[l[w+3]]&&(A=E)),A!==n.TRI_INDEX&&(A*=3,_+=a[A],y+=a[A+1],M+=a[A+2],T++)}T<2?(t[p]=a[p],t[p+1]=a[p+1],t[p+2]=a[p+2]):(T=.25/T,S=.75,t[p]=a[p]*S+_*T,t[p+1]=a[p+1]*S+y*T,t[p+2]=a[p+2]*S+M*T)}else{var C=h[2*m],N=h[2*m+1],V=C+N;for(b=C;b<V;++b)A=3*c[b],_+=a[A],y+=a[A+1],M+=a[A+2];if(f)6===N?(T=.0625,S=.625):3===N?(T=.1875,S=.4375):(T=.375/N,S=.625),t[p]=a[p]*S+_*T,t[p+1]=a[p+1]*S+y*T,t[p+2]=a[p+2]*S+M*T;else{var P=0,L=0,U=0,B=0,O=d[2*m],G=O+d[2*m+1],z=0;for(b=O;b<G;++b){A=4*g[b];var X=s[A+3];if(X!==n.TRI_INDEX){z++;var W=s[A],Y=s[A+1],H=s[A+2],j=0;j=W===m?3*H:Y===m?3*X:H===m?3*W:3*Y,P+=a[j],L+=a[j+1],U+=a[j+2]}}z!==G-O?0!==z?(S=1/(1+.5*N+.25*z),T=.5*S,B=.25*S,t[p]=a[p]*S+_*T+P*B,t[p+1]=a[p+1]*S+y*T+L*B,t[p+2]=a[p+2]*S+M*T+U*B):(6===N?(T=.0625,S=.625):3===N?(T=.1875,S=.4375):(T=.375/N,S=.625),t[p]=a[p]*S+_*T,t[p+1]=a[p+1]*S+y*T,t[p+2]=a[p+2]*S+M*T):(4===N?(S=.5625,T=.09375,B=.015625):(T=1.5/(N*N),B=.25/(N*N),S=1-(T+B)*N),t[p]=a[p]*S+_*T+P*B,t[p+1]=a[p+1]*S+y*T+L*B,t[p+2]=a[p+2]*S+M*T+U*B)}}}},wr=function(e,t,r,i,a){for(var s=e.getFaces(),o=e.getFaceEdges(),l=new xr(e,t,r,i),u=0,h=e.getNbFaces();u<h;++u){var c,d,g,f,v,m=4*u,p=s[m],_=s[m+1],y=s[m+2],M=s[m+3],T=M!==n.TRI_INDEX;T?(c=l.computeQuadEdgeVertex(p,_,y,M,o[m]),d=l.computeQuadEdgeVertex(_,y,M,p,o[m+1]),g=l.computeQuadEdgeVertex(y,M,p,_,o[m+2]),f=l.computeQuadEdgeVertex(M,p,_,y,o[m+3]),v=l.computeFaceVertex(p,_,y,M)):(c=l.computeTriangleEdgeVertex(p,_,y,o[m]),d=l.computeTriangleEdgeVertex(_,y,p,o[m+1]),g=l.computeTriangleEdgeVertex(y,p,_,o[m+2])),a&&(m*=4,T?(a[m+1]=a[m+4]=c,a[m+6]=a[m+9]=d,a[m+11]=a[m+14]=g,a[m+3]=a[m+12]=f,a[m+2]=a[m+7]=a[m+8]=a[m+13]=v,a[m]=p,a[m+5]=_,a[m+10]=y,a[m+15]=M):(a[m]=a[m+5]=a[m+8]=c,a[m+1]=a[m+10]=a[m+12]=d,a[m+2]=a[m+6]=a[m+14]=g,a[m+3]=a[m+7]=a[m+11]=a[m+15]=n.TRI_INDEX,a[m+4]=p,a[m+9]=_,a[m+13]=y))}return l._tagEdges},Er=function(e,t,r){for(var i=e.getFacesTexCoord(),a=t.getFaces(),s=new Uint32Array(a.length),o=e.getFaceEdges(),l=e.getNbVertices(),u=t.getNbVertices()-l,h=t.getVerticesDuplicateStartCount(),c=t.getTexCoords(),d=0,g=e.getNbFaces();d<g;++d){var f=4*d,v=i[f],m=i[f+1],p=i[f+2],_=i[f+3];v>=l&&(v+=u),m>=l&&(m+=u),p>=l&&(p+=u),_!==n.TRI_INDEX&&_>=l&&(_+=u);var y=o[f],M=r[y]-1;M<0?M=h[2*(-M-1)]:h[2*M]>0&&(r[y]=-M),y=o[f+1];var T=r[y]-1;T<0?T=h[2*(-T-1)]:h[2*T]>0&&(r[y]=-T),y=o[f+2];var S=r[y]-1;if(S<0?S=h[2*(-S-1)]:h[2*S]>0&&(r[y]=-S),f*=4,_!==n.TRI_INDEX){y=o[4*d+3];var b=r[y]-1;b<0?b=h[2*(-b-1)]:h[2*b]>0&&(r[y]=-b),s[f+1]=s[f+4]=M,s[f+6]=s[f+9]=T,s[f+11]=s[f+14]=S,s[f+3]=s[f+12]=b,s[f+2]=s[f+7]=s[f+8]=s[f+13]=a[f+2],s[f]=v,s[f+5]=m,s[f+10]=p,s[f+15]=_;var A=2*a[f+2];c[A]=.25*(c[2*v]+c[2*m]+c[2*p]+c[2*_]),c[A+1]=.25*(c[2*v+1]+c[2*m+1]+c[2*p+1]+c[2*_+1])}else s[f]=s[f+5]=s[f+8]=M,s[f+1]=s[f+10]=s[f+12]=T,s[f+2]=s[f+6]=s[f+14]=S,s[f+3]=s[f+7]=s[f+11]=s[f+15]=n.TRI_INDEX,s[f+4]=v,s[f+9]=m,s[f+13]=p}t.setFacesTexCoord(s)},Rr=function(e,t,r){var i=t.getNbVertices(),a=new Uint32Array(2*i);a.set(e.getVerticesDuplicateStartCount());var s=e.getFaces(),o=e.getFacesTexCoord(),l=3*t.getNbFaces(),u=e.getTexCoords(),h=new Float32Array(n.getMemory(4*l*2),0,2*l),c=0,d=e.getNbVertices(),g=i-d;for(c=0;c<d;++c){var f=a[2*c];f>0&&(a[2*c]=f+g)}h.set(u),h.set(u.subarray(2*d),2*(d+g));var v=e.getNbTexCoords(),m=g+v,p=e.getFaceEdges(),_=new Uint32Array(r.length),y=new Uint32Array(r.length);for(d=s.length,c=0;c<d;++c){var M=p[c];if(M!==n.TRI_INDEX){var T=(c+1)%4===0?c-3:c+1,S=o[c],b=o[T];b===n.TRI_INDEX&&(b=o[c-2]);var A=r[M]-1,x=y[M],k=S>b?S:b,w=S<b?S:b;0!==x?x===k&&_[M]===w||(h[2*m]=.5*(u[2*S]+u[2*b]),h[2*m+1]=.5*(u[2*S+1]+u[2*b+1]),a[2*A]=m++,a[2*A+1]=1):(h[2*A]=.5*(u[2*S]+u[2*b]),h[2*A+1]=.5*(u[2*S+1]+u[2*b+1]),_[M]=w,y[M]=k)}}var E=new Float32Array(2*m);E.set(h.subarray(0,2*m)),t.setTexCoords(E),t.setVerticesDuplicateStartCount(a),Er(e,t,r)};Ar.fullSubdivision=function(e,t){var r=e.getNbVertices()+e.getNbEdges()+e.getNbQuads();t.setVertices(new Float32Array(3*r)),t.setColors(new Float32Array(3*r)),t.setMaterials(new Float32Array(3*r)),t.setFaces(new Uint32Array(4*e.getNbFaces()*4)),kr(e,t.getVertices(),t.getColors(),t.getMaterials());var i=wr(e,t.getVertices(),t.getColors(),t.getMaterials(),t.getFaces());e.hasUV()&&Rr(e,t,i),t.allocateArrays()},Ar.partialSubdivision=function(e,t,r,i){kr(e,t,r,i),wr(e,t,r,i)};var Fr={};Fr.importOBJ=function(e,t){for(var r=[],i=[],a=[],s=[],o=[],l=[],u=[],h=[],c=[],d=0,g=0,f=0,v=0,m=e.split("\n"),p=[],_=1/255,y=m.length,M=0;M<y;++M){var T=m[M].trim();if(0!==T.length){var S,b=T[0];if("v"===b)S=T[1]," "===S?(p=T.split(/\s+/),i.push(parseFloat(p[1]),parseFloat(p[2]),parseFloat(p[3])),p[4]&&a.push(parseFloat(p[4]),parseFloat(p[5]),parseFloat(p[6])),++f):"t"===S&&(p=T.split(/\s+/),u.push(parseFloat(p[1]),parseFloat(p[2])),++v);else if("f"===b){p=T.split(/\s+/);var A=p.length-1;if(A<3)continue;for(var x=Math.ceil(A/2)-1,k=0;k<x;++k){var w=k+1,E=k+2,R=A-w,F=A-k;R===E&&(R=F,F=n.TRI_INDEX);var D,I=p[w].split("/"),C=p[E].split("/"),N=p[R].split("/"),V=F!==n.TRI_INDEX;V&&(D=p[F].split("/"));var P=parseInt(I[0],10),L=parseInt(C[0],10),U=parseInt(N[0],10),B=V?parseInt(D[0],10):void 0;if((!V||B!==P&&B!==L&&B!==U)&&P!==L&&P!==U&&L!==U)if(P=(P<0?P+f:P-1)-d,L=(L<0?L+f:L-1)-d,U=(U<0?U+f:U-1)-d,V&&(B=(B<0?B+f:B-1)-d),h.push(P,L,U,V?B:n.TRI_INDEX),I[1]){var O=parseInt(I[1],10),G=parseInt(C[1],10),z=parseInt(N[1],10),X=V?parseInt(D[1],10):void 0;O=(O<0?O+v:O-1)-g,G=(G<0?G+v:G-1)-g,z=(z<0?z+v:z-1)-g,V&&(X=(X<0?X+v:X-1)-g),c.push(O,G,z,V?X:n.TRI_INDEX)}else c.length>0&&c.push(P,L,U,V?B:n.TRI_INDEX)}}else if("#"===b){if("M"!==T[1])continue;if(T.startsWith("#MRGB ")){p=T.split(/\s+/);for(var W=p[1],Y=2,H=W.length;Y<H;Y+=8){var j=parseInt(W.substr(Y,6),16);s.push((j>>16)*_,(j>>8&255)*_,(255&j)*_)}}else if(T.startsWith("#MAT ")){p=T.split(/\s+/);for(var q=p[1],K=0,Z=q.length;K<Z;K+=6){var Q=parseInt(q.substr(K,6),16);l.push((Q>>16)*_,(Q>>8&255)*_,(255&Q)*_)}}}else T.startsWith("o ")&&(r.length>0&&(Fr.initMeshOBJ(r[r.length-1],i,h,a,o,u,c,s,l),d=f,g=v),r.push(new Qe(t)))}}return 0===r.length&&(r[0]=new Qe(t)),Fr.initMeshOBJ(r[r.length-1],i,h,a,o,u,c,s,l),r},Fr.initMeshOBJ=function(e,t,r,i,a,n,s,o,l){e.setVertices(new Float32Array(t)),e.setFaces(new Uint32Array(r)),o.length===t.length?e.setColors(new Float32Array(o)):i.length===t.length&&e.setColors(new Float32Array(i)),l.length===t.length?e.setMaterials(new Float32Array(l)):a.length===t.length&&e.setMaterials(new Float32Array(a)),n.length>0&&s.length===r.length&&e.initTexCoordsDataFromOBJData(n,s),t.length=r.length=0,o.length=i.length=0,l.length=a.length=0,n.length=s.length=0};var Dr={};Dr.VERSION=3,Dr.exportSGLAsArrayBuffer=function(e,t){return Dr.exportSGL(e,t,!0)},Dr.exportSGL=function(e,t,r){var i,a=e.length,n=31,s=4*(9+a*n),o=0;for(o=0;o<a;++o)i=e[o],s+=4*i.getNbVertices()*3,i.getColors()&&(s+=4*i.getNbVertices()*3),i.getMaterials()&&(s+=4*i.getNbVertices()*3),s+=4*i.getNbFaces()*4,i.hasUV()&&(s+=4*i.getNbTexCoords()*2,s+=4*i.getNbFaces()*4);var l=new ArrayBuffer(s),u=new Float32Array(l),h=new Uint32Array(l),c=0;h[c++]=Dr.VERSION,h[c++]=t._showGrid,h[c++]=R.showSymmetryLine,h[c++]=t._showContour;var d=t.getCamera();for(h[c++]=d.getProjectionType(),h[c++]=d.getMode(),u[c++]=d.getFov(),h[c++]=d.getUsePivot(),h[c++]=a,o=0;o<a;++o){i=e[o],h[c++]=i.getShaderType(),h[c++]=i.getMatcap(),h[c++]=i.getShowWireframe(),h[c++]=i.getFlatShading(),u[c++]=i.getOpacity(),u.set(i.getCenter(),c),c+=3,u.set(i.getMatrix(),c),c+=16,u[c++]=i.getScale();var g=i.getNbVertices();h[c++]=g,u.set(i.getVertices().subarray(0,3*g),c),c+=3*g;var f=i.getColors()?g:0;h[c++]=f,f>0&&u.set(i.getColors().subarray(0,3*g),c),c+=3*f;var v=i.getMaterials()?g:0;h[c++]=v,v>0&&u.set(i.getMaterials().subarray(0,3*g),c),c+=3*v;var m=i.getNbFaces();h[c++]=m,h.set(i.getFaces().subarray(0,4*m),c),c+=4*m;var p=i.hasUV(),_=i.getNbTexCoords();h[c++]=p?_:0,p&&(u.set(i.getTexCoords().subarray(0,2*_),c),c+=2*_),h[c++]=p?m:0,p&&(h.set(i.getFacesTexCoord().subarray(0,4*m),c),c+=4*m)}if(r)return l;var y=new DataView(l,0,4*c);return new Blob([y])};var Ir={},Cr=function(e){for(var t=new Uint32Array(e),r=t.length/4,i=0;i<r;++i){var a=4*i+3;e[a]<0&&(t[a]=n.TRI_INDEX)}return t};Ir.importSGL=function(e,t,r){var i=new Float32Array(e),a=new Uint32Array(e),n=new Int32Array(e),s=0,o=a[s++];if(o>Dr.VERSION)return[];if(o>=2){r._showGrid=a[s++],R.showSymmetryLine=a[s++],r._showContour=a[s++];var l=r.getCamera();l.setProjectionType(a[s++]),l.setMode(a[s++]),l.setFov(i[s++]),l.setUsePivot(a[s++])}for(var u=a[s++],h=new Array(u),c=0;c<u;++c){var d=h[c]=new Qe(t);if(o>=2){var g=d.getRenderData();g._shaderType=a[s++],g._matcap=a[s++],g._showWireframe=a[s++],g._flatShading=a[s++],g._alpha=i[s++]}d.getCenter().set(i.subarray(s,s+3)),s+=3,d.getMatrix().set(i.subarray(s,s+16)),s+=16,s++;var f=a[s++];d.setVertices(i.subarray(s,s+3*f)),s+=3*f,f=a[s++],f>0&&d.setColors(i.subarray(s,s+3*f)),s+=3*f,f=a[s++],f>0&&d.setMaterials(i.subarray(s,s+3*f)),s+=3*f,f=a[s++],o<=2?d.setFaces(Cr(n.subarray(s,s+4*f))):d.setFaces(a.subarray(s,s+4*f)),s+=4*f,f=a[s++];var v=null;f&&(v=i.subarray(s,s+2*f)),s+=2*f,f=a[s++];var m=null;f&&(m=o<=2?Cr(n.subarray(s,s+4*f)):a.subarray(s,s+4*f)),s+=4*f,v&&m&&d.initTexCoordsDataFromOBJData(v,m)}return h};var Nr={},Vr=function(e){switch(e){case"uchar":case"char":case"int8":case"uint8":return 1;case"ushort":case"short":case"int16":case"uint16":return 2;case"uint":case"int":case"float":case"int32":case"uint32":case"float32":return 4;case"double":case"float64":return 8;default:return 0}},Pr=function(e,t){var r=t?1/255:1;switch(e){case"char":case"uchar":case"short":case"ushort":case"int":case"uint":case"int8":case"uint8":case"int16":case"uint16":case"int32":case"uint32":return function(e){return parseInt(e,10)*r};case"float":case"double":case"float32":case"float64":return parseFloat;default:return function(e){return e}}},Lr=function(e,t,r){var i=r?1/255:1,a=t.offsetOctet;switch(t.type){case"int8":case"char":return function(t){return e.getInt8(t+a)*i};case"uint8":case"uchar":return function(t){return e.getUint8(t+a)*i};case"int16":case"short":return function(t){return e.getInt16(t+a,!0)*i};case"uint16":case"ushort":return function(t){return e.getUint16(t+a,!0)*i};case"int32":case"int":return function(t){return e.getInt32(t+a,!0)*i};case"uint32":case"uint":return function(t){return e.getUint32(t+a,!0)*i};case"float32":case"float":return function(t){return e.getFloat32(t+a,!0)};case"float64":case"double":return function(t){return e.getFloat64(t+a,!0)}}},Ur=function(e){for(var t,r=n.ab2str(e),i=r.split("\n"),a={isBinary:!1,start:0,elements:[],lines:i,buffer:e,vertices:null,faces:null,colors:null,offsetLine:0,offsetOctet:0},s=0;;){var o=i[s++];if(a.offsetOctet+=o.length+1,a.offsetLine=s,o=o.trim(),o.startsWith("format binary"))a.isBinary=!0;else if(o.startsWith("element"))t=o.split(/\s+/),a.elements.push({name:t[1],count:parseInt(t[2],10),properties:[]});else if(o.startsWith("property")){t=o.split(/\s+/);var l="list"===t[1];a.elements[a.elements.length-1].properties.push({type:t[l?2:1],type2:l?t[3]:void 0,name:t[l?4:2]})}else if(o.startsWith("end_header"))break}return a},Br=function(e,t){var r=e.properties,i=e.objProperties={};e.offsetOctet=0;for(var a=0,n=r.length;a<n;++a){var s=r[a],o=i[s.name]={};o.type=s.type,o.type2=s.type2,t.isBinary?(o.offsetOctet=e.offsetOctet,e.offsetOctet+=Vr(s.type)):o.id=a}},Or=function(e,t,r,i){var a,n,s,o=e.count,l=t.lines,u=e.objProperties,h=t.offsetLine,c=Pr(u.x.type,!0),d=Pr(u.y.type,!0),g=Pr(u.z.type,!0),f=u.x.id,v=u.y.id,m=u.z.id;u.red&&(a=Pr(u.red.type,!0)),u.green&&(n=Pr(u.green.type,!0)),u.blue&&(s=Pr(u.blue.type,!0));var p,_,y;u.red&&(p=u.red.id),u.green&&(_=u.green.id),u.blue&&(y=u.blue.id);for(var M=0;M<o;++M){var T=3*M,S=l[h+M].trim().split(/\s+/);r[T]=c(S[f]),r[T+1]=d(S[v]),r[T+2]=g(S[m]),a&&(i[T]=a(S[p])),n&&(i[T+1]=n(S[_])),s&&(i[T+2]=s(S[y]))}t.offsetLine+=o},Gr=function(e,t,r,i){var a,n,s,o=e.count,l=e.objProperties,u=e.offsetOctet,h=u*o,c=new DataView(t.buffer,t.offsetOctet,h),d=Lr(c,l.x,!0),g=Lr(c,l.y,!0),f=Lr(c,l.z,!0);l.red&&(a=Lr(c,l.red,!0)),l.green&&(n=Lr(c,l.green,!0)),l.blue&&(s=Lr(c,l.blue,!0));for(var v=0;v<o;++v){var m=3*v,p=v*u;r[m]=d(p),r[m+1]=g(p),r[m+2]=f(p),a&&(i[m]=a(p)),n&&(i[m+1]=n(p)),s&&(i[m+2]=s(p))}t.offsetOctet+=h},zr=function(e,t){Br(e,t);var r,i=t.vertices=new Float32Array(3*e.count),a=e.objProperties;(a.red||a.green||a.blue)&&(r=t.colors=new Float32Array(3*e.count)),t.isBinary?Gr(e,t,i,r):Or(e,t,i,r)},Xr=function(e,t,r){for(var i=e.count,a=t.lines,s=e.objProperties,o=t.offsetLine,l=s.vertex_index||s.vertex_indices,u=Pr(l.type),h=Pr(l.type2),c=l.id,d=0,g=0;g<i;++g){var f=a[o+g].trim().split(/\s+/),v=u(f[0]);3!==v&&4!==v||(r[d]=h(f[c+1]),r[d+1]=h(f[c+2]),r[d+2]=h(f[c+3]),r[d+3]=4===v?h(f[c+4]):n.TRI_INDEX,d+=4)}t.offsetLine+=i},Wr=function(e,t,r,i){for(var a=e.count,s=e.objProperties,o=s.vertex_index||s.vertex_indices||e.properties[0],l=new DataView(t.buffer,t.offsetOctet),u=Lr(l,o),h=Lr(l,{type:o.type2,offsetOctet:o.offsetOctet+Vr(o.type)}),c=Vr(o.type2),d=e.offsetOctet,g=0,f=0,v=0;v<a;++v){var m=u(g);3!==m&&4!==m||(r[f++]=h(g),r[f++]=h(g+c),r[f++]=h(g+2*c),r[f++]=3===m?n.TRI_INDEX:h(g+3*c)),g+=m*c+d}i||(t.faces=r.subarray(0,f)),t.offsetOctet+=g},Yr=function(e,t){Br(e,t);var r=t.faces=new Uint32Array(4*e.count);t.isBinary?Wr(e,t,r):Xr(e,t,r)},Hr=function(e,t){var r=e.count;t.isBinary?Wr(e,t,[],!0):t.offsetLine+=r};Nr.importPLY=function(e,t){for(var r=Ur(e),i=r.elements,a=0,n=i.length;a<n;++a){var s=i[a];"vertex"===s.name?zr(s,r):"face"===s.name?Yr(s,r):Hr(s,r)}var o=new Qe(t);return o.setVertices(r.vertices),o.setFaces(r.faces),o.setColors(r.colors),[o]};var jr={};jr.importSTL=function(e,t){var r,i=new Uint32Array(e,80,1)[0]||0,a=84+50*i===e.byteLength,s=a?jr.importBinarySTL(e,i):jr.importAsciiSTL(n.ab2str(e));a&&(r=s[1],s=s[0]),i=s.length/9;for(var o=new Map,l=[0],u=new Uint32Array(4*i),h=0;h<i;++h){var c=4*h,d=9*h;u[c]=jr.detectNewVertex(o,s,r,d,l),u[c+1]=jr.detectNewVertex(o,s,r,d+3,l),u[c+2]=jr.detectNewVertex(o,s,r,d+6,l),u[c+3]=n.TRI_INDEX}var g=new Qe(t);return g.setVertices(s.subarray(0,3*l[0])),r&&g.setColors(r.subarray(0,3*l[0])),g.setFaces(u),[g]},jr.detectNewVertex=function(e,t,r,i,a){var n=t[i],s=t[i+1],o=t[i+2],l=n+"+"+s+"+"+o,u=e.get(l);if(void 0===u){u=a[0],e.set(l,u);var h=3*u;t[h]=n,t[h+1]=s,t[h+2]=o,r&&(r[h]=r[i],r[h+1]=r[i+1],r[h+2]=r[i+2]),a[0]++}return u},jr.importAsciiSTL=function(e){for(var t=e.split("\n"),r=t.length,i=new Float32Array(Math.ceil(9*r/7)),a=0,n=0;n<r;++n){var s=t[n].trim();if(s.startsWith("facet")){var o=t[n+2].trim().split(/\s+/);i[a++]=parseFloat(o[1]),i[a++]=parseFloat(o[2]),i[a++]=parseFloat(o[3]),o=t[n+3].trim().split(/\s+/),i[a++]=parseFloat(o[1]),i[a++]=parseFloat(o[2]),i[a++]=parseFloat(o[3]),o=t[n+4].trim().split(/\s+/),i[a++]=parseFloat(o[1]),i[a++]=parseFloat(o[2]),i[a++]=parseFloat(o[3])}}return i.subarray(0,a)},jr.importBinarySTL=function(e,t){var r=new Uint8Array(e),i=0,a=new Uint8Array(36*t),n=new Uint8Array(2*t),s=96,o=0,l=0;for(i=0;i<t;i++){for(var u=0;u<36;++u)a[o++]=r[s++];n[l++]=r[s++],n[l++]=r[s++],s+=12}var h=new Uint16Array(n.buffer);n=new Float32Array(9*t);var c=1/31;for(i=0;i<t;++i){o=9*i;var d=h[i],g=32768&d;n[o]=n[o+3]=n[o+6]=g?(d>>10&31)*c:1,n[o+1]=n[o+4]=n[o+7]=g?(d>>5&31)*c:1,n[o+2]=n[o+5]=n[o+8]=g?(31&d)*c:1}return[new Float32Array(a.buffer),n]};var qr={importOBJ:Fr.importOBJ,importSGL:Ir.importSGL,importPLY:Nr.importPLY,importSTL:jr.importSTL};!function(){var e,t,r;return function(i){function a(e,t){return M.call(e,t)}function n(e,t){var r,i,a,n,s,o,l,u,h,c,d,g=t&&t.split("/"),f=_.map,v=f&&f["*"]||{};if(e&&"."===e.charAt(0))if(t){for(g=g.slice(0,g.length-1),e=e.split("/"),s=e.length-1,_.nodeIdCompat&&S.test(e[s])&&(e[s]=e[s].replace(S,"")),e=g.concat(e),h=0;h<e.length;h+=1)if(d=e[h],"."===d)e.splice(h,1),h-=1;else if(".."===d){if(1===h&&(".."===e[2]||".."===e[0]))break;h>0&&(e.splice(h-1,2),h-=2)}e=e.join("/")}else 0===e.indexOf("./")&&(e=e.substring(2));if((g||v)&&f){for(r=e.split("/"),h=r.length;h>0;h-=1){if(i=r.slice(0,h).join("/"),g)for(c=g.length;c>0;c-=1)if(a=f[g.slice(0,c).join("/")],a&&(a=a[i])){n=a,o=h;break}if(n)break;!l&&v&&v[i]&&(l=v[i],u=h)}!n&&l&&(n=l,o=u),n&&(r.splice(0,o,n),e=r.join("/"))}return e}function s(e,t){return function(){return g.apply(i,T.call(arguments,0).concat([e,t]))}}function o(e){return function(t){return n(t,e)}}function l(e){return function(t){m[e]=t}}function u(e){if(a(p,e)){var t=p[e];delete p[e],y[e]=!0,d.apply(i,t)}if(!a(m,e)&&!a(y,e))throw new Error("No "+e);return m[e]}function h(e){var t,r=e?e.indexOf("!"):-1;return r>-1&&(t=e.substring(0,r),e=e.substring(r+1,e.length)),[t,e]}function c(e){return function(){return _&&_.config&&_.config[e]||{}}}var d,g,f,v,m={},p={},_={},y={},M=Object.prototype.hasOwnProperty,T=[].slice,S=/\.js$/;f=function(e,t){var r,i=h(e),a=i[0];return e=i[1],a&&(a=n(a,t),r=u(a)),a?e=r&&r.normalize?r.normalize(e,o(t)):n(e,t):(e=n(e,t),i=h(e),a=i[0],e=i[1],a&&(r=u(a))),{f:a?a+"!"+e:e,n:e,pr:a,p:r}},v={require:function(e){return s(e)},exports:function(e){var t=m[e];return"undefined"!=typeof t?t:m[e]={}},module:function(e){return{id:e,uri:"",exports:m[e],config:c(e)}}},d=function(e,t,r,n){var o,h,c,d,g,_,M=[],T=typeof r;if(n=n||e,"undefined"===T||"function"===T){for(t=!t.length&&r.length?["require","exports","module"]:t,g=0;g<t.length;g+=1)if(d=f(t[g],n),h=d.f,"require"===h)M[g]=v.require(e);else if("exports"===h)M[g]=v.exports(e),_=!0;else if("module"===h)o=M[g]=v.module(e);else if(a(m,h)||a(p,h)||a(y,h))M[g]=u(h);else{if(!d.p)throw new Error(e+" missing "+h);d.p.load(d.n,s(n,!0),l(h),{}),M[g]=m[h]}c=r?r.apply(m[e],M):void 0,e&&(o&&o.exports!==i&&o.exports!==m[e]?m[e]=o.exports:c===i&&_||(m[e]=c))}else e&&(m[e]=r)},e=t=g=function(e,t,r,a,n){if("string"==typeof e)return v[e]?v[e](t):u(f(e,t).f);if(!e.splice){if(_=e,_.deps&&g(_.deps,_.callback),!t)return;t.splice?(e=t,t=r,r=null):e=i}return t=t||function(){},"function"==typeof r&&(r=a,a=n),a?d(i,e,t,r):setTimeout(function(){d(i,e,t,r)},4),g},g.config=function(e){return g(e)},e._defined=m,r=function(e,t,r){t.splice||(r=t,t=[]),a(m,e)||a(p,e)||(p[e]=[e,t,r])},r.amd={jQuery:!0}}(),r("../tools/almond",function(){}),r("utils/GuiUtils",["require","exports","module"],function(e,t,r){var i={};i.makeProxy=function(e,t,r){for(var i=e.prototype,a=t.prototype,n=Object.keys(i),s=0,o=n.length;s<o;++s){var l=n[s];a[l]||(a[l]=r?r(i[l]):i[l])}},i.rgbToHsv=function(e){var t=e[0],r=e[1],i=e[2],a=Math.max(t,r,i),n=Math.min(t,r,i);if(n===a)return[0,0,n];var s=t===n?r-i:i===n?t-r:i-t,o=t===n?3:i===n?1:5;return[(o-s/(a-n))/6,(a-n)/a,a]},i.hsvToRgb=function(e){var t=6*e[0],r=e[1],i=e[2],a=Math.floor(t),n=t-a,s=i*(1-r),o=i*(1-n*r),l=i*(1-(1-n)*r),u=a%6;return 0===u?[i,l,s]:1===u?[o,i,s]:2===u?[s,i,l]:3===u?[s,o,i]:4===u?[l,s,i]:[i,s,o]},i.getValidColor=function(e){for(var t=0,r=e.length;t<r;++t)e[t]=Math.max(0,Math.min(1,e[t]));return e},i.getStrColor=function(e){return 3===e.length?i.rgbToHex(e):"rgba("+Math.round(255*e[0])+","+Math.round(255*e[1])+","+Math.round(255*e[2])+","+e[3]+")"},i.getColorMult=function(e,t){var r=[e[0]*t,e[1]*t,e[2]*t];return 4===e.length&&r.push(e[3]),i.getValidColor(r)},i.getColorAdd=function(e,t){var r=[e[0]+t,e[1]+t,e[2]+t];return 4===e.length&&r.push(e[3]),i.getValidColor(r)},i.rgbToHex=function(e){for(var t="#",r=0;r<3;++r){var i=Math.round(255*e[r]).toString(16);t+=1===i.length?"0"+i:i}return t},i.hexToRgb=function(e){var t=0;"#"===e[0]&&(e=e.slice(1));var r=e;if(e.length>6)r=e.slice(0,6);else if(e.length<6)for(r="",t=0;t<3;++t)r+=e[t]?e[t]+e[t]:"00";var i=[0,0,0];for(t=0;t<3;++t){var a=parseInt(r[2*t]+r[2*t+1],16);i[t]=(a!==a?0:a)/255}return i},r.exports=i}),r("widgets/BaseWidget",["require","exports","module"],function(e,t,r){var i=function(){};i.prototype={_getInitialValue:function(e,t){return"string"!=typeof t?e:e[t]},_getCheckCallback:function(e,t){return"string"!=typeof t?t:function(r){e[t]=r}},_setDomContainer:function(e){this.domContainer=e},setCallback:function(e){this.callback=e},setVisibility:function(e){this.domContainer&&(this.domContainer.hidden=!e)}},r.exports=i}),r("widgets/Button",["require","exports","module","utils/GuiUtils","widgets/BaseWidget"],function(e,t,r){var i=e("utils/GuiUtils"),a=e("widgets/BaseWidget"),n=function(e,t,r){var i=r?t[r].bind(t):t;this.domButton=document.createElement("button"),this.domButton.className="gui-button",this.domButton.innerHTML=e||"",
this.domButton.addEventListener("click",this._onClick.bind(this)),this.setCallback(i)};n.prototype={setEnable:function(e){this.domButton.disabled=void 0!==e&&!e},_onClick:function(){this.callback&&this.callback()}},i.makeProxy(a,n),r.exports=n}),r("widgets/Checkbox",["require","exports","module","utils/GuiUtils","widgets/BaseWidget"],function(e,t,r){var i=e("utils/GuiUtils"),a=e("widgets/BaseWidget"),n=function(e,t){var r=this._getInitialValue(e,t),i=this._getCheckCallback(e,t);this.domCheckbox=document.createElement("input"),this.domCheckbox.className="gui-input-checkbox",this.domCheckbox.type="checkbox",this.domLabelCheckbox=document.createElement("label"),this.setValue(void 0===r||r),this.setCallback(i)};n.prototype={_onMouseDown:function(){this.setValue(!this.domCheckbox.checked)},setValue:function(e,t){this.domCheckbox.checked=e,!t&&this.callback&&this.callback(e)},getValue:function(){return this.domCheckbox.checked}},i.makeProxy(a,n),r.exports=n}),r("widgets/Color",["require","exports","module","utils/GuiUtils","widgets/BaseWidget"],function(e,t,r){var i=e("utils/GuiUtils"),a=e("widgets/BaseWidget"),n=["-moz-","-o-","-webkit-","-ms-",""],s='url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAIAAABLbSncAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAChJREFUeNpiPHPmDAMMGBsbw9lMDDgA6RKM%2F%2F%2F%2Fh3POnj1LCzsAAgwAQtYIcFfEyzkAAAAASUVORK5CYII%3D")',o=function(e,t){var r=this._getInitialValue(e,t),a=this._getCheckCallback(e,t);r?this.color=i.getValidColor(r.slice()):this.color=[1,0,0],this.domColor=document.createElement("div"),this.domColor.className="gui-widget-color",this.domInputColor=document.createElement("input"),this.domPopup=document.createElement("div"),this.domHue=document.createElement("div"),this.domHue.className="gui-color-hue",this.domHueKnob=document.createElement("div"),this.domHueKnob.className="gui-knob-hue",this.domSaturation=document.createElement("div"),this.domSaturation.className="gui-color-saturation";var n=document.createElement("div");this.domSaturation.appendChild(n),this.domSaturationKnob=document.createElement("div"),this.domSaturationKnob.className="gui-knob-saturation",this.domHue.appendChild(this.domHueKnob),this.domPopup.appendChild(this.domSaturationKnob),this.domPopup.appendChild(this.domSaturation),this.domPopup.appendChild(this.domHue),this.domColor.appendChild(this.domInputColor),this.domColor.appendChild(this.domPopup),this._hueGradient(this.domHue),this._linearGradient(n,"top","rgba(0,0,0,0)","#000"),this.domColor.addEventListener("keydown",this._onInputDown.bind(this)),this.domSaturation.addEventListener("mousedown",this._onSaturationDown.bind(this)),this.domHue.addEventListener("mousedown",this._onHueDown.bind(this)),window.addEventListener("mouseup",this._onMouseUp.bind(this)),window.addEventListener("mouseout",this._onMouseUp.bind(this)),window.addEventListener("mousemove",this._onMouseMove.bind(this)),this.hasAlpha=4===this.color.length,this.alpha=1,this.hasAlpha&&(this.domPopup.style.width="142px",this.domAlpha=document.createElement("div"),this.domAlpha.className="gui-color-alpha",this.domAlphaKnob=document.createElement("div"),this.domAlphaKnob.className="gui-knob-alpha",this._alphaGradient(this.domAlpha,"top","rgba(0,0,0,1.0)","rgba(0,0,0,0.0)"),this.domAlpha.addEventListener("mousedown",this._onAlphaDown.bind(this)),this.domAlpha.appendChild(this.domAlphaKnob),this.domPopup.appendChild(this.domAlpha)),this.editHue=this.editSaturation=this.editAlpha=!1,this.widgetHeight=this.widgetWidth=100,this.setValue(this.color),this.setCallback(a)};o.prototype={_onInputDown:function(e){e.stopPropagation(),13===e.keyCode&&this.setValue(i.hexToRgb(e.target.value))},_onUpdateSaturation:function(e){var t=this.domSaturation.getBoundingClientRect(),r=i.rgbToHsv(this.getValue());r[1]=Math.min(1,Math.max(0,(e.clientX-t.left)/t.width)),r[2]=Math.min(1,Math.max(0,1-(e.clientY-t.top)/t.width)),this.setValue(i.hsvToRgb(r),!1,!0),this._updateGui()},_onUpdateHue:function(e){var t=this.domHue.getBoundingClientRect(),r=i.rgbToHsv(this.getValue());r[0]=Math.min(1,Math.max(0,1-(e.clientY-t.top)/t.height)),this.setValue(i.hsvToRgb(r),!1,!0),this._updateGui()},_onUpdateAlpha:function(e){var t=this.domAlpha.getBoundingClientRect(),r=this.getValue();r[3]=this.alpha=Math.min(1,Math.max(0,1-(e.clientY-t.top)/t.height)),this.setValue(r,!1,!0),this._updateGui()},_updateGui:function(){var e=this.getValue(),t=i.rgbToHsv(e);this.domSaturationKnob.style.marginLeft=this.widgetWidth*t[1]-7+"px",this.domSaturationKnob.style.marginTop=this.widgetHeight*(1-t[2])-7+"px",t[1]=t[2]=1,this._linearGradient(this.domSaturation,"left","#fff",i.getStrColor(i.hsvToRgb(t))),this.domHueKnob.style.marginTop=(1-t[0])*this.widgetHeight+"px",this.hasAlpha&&void 0!==e[3]&&(this.domAlphaKnob.style.marginTop=(1-this.alpha)*this.widgetHeight+"px")},_onMouseMove:function(e){if(this.editSaturation||this.editHue||this.editAlpha)return this.editSaturation?this._onUpdateSaturation(e):this.editHue?this._onUpdateHue(e):this.editAlpha?this._onUpdateAlpha(e):void 0},_onSaturationDown:function(e){this.editSaturation=!0,this._onMouseMove(e)},_onHueDown:function(e){this.editHue=!0,this._onMouseMove(e)},_onAlphaDown:function(e){this.editAlpha=!0,this._onMouseMove(e)},_onMouseUp:function(){this.editHue=this.editSaturation=this.editAlpha=!1},_hueGradient:function(e){e.style.background="";for(var t=0,r=n.length;t<r;++t)e.style.cssText+="background: "+n[t]+"linear-gradient(top,  #ff0000 0%, #ff00ff 17%, #0000ff 34%, #00ffff 50%, #00ff00 67%, #ffff00 84%, #ff0000 100%);"},_alphaGradient:function(e,t,r,i){e.style.background="";for(var a=0,o=n.length;a<o;++a)e.style.cssText+="background: "+n[a]+"linear-gradient("+t+", "+r+","+i+"),"+s+";"},_linearGradient:function(e,t,r,i){e.style.background="";for(var a=0,s=n.length;a<s;++a)e.style.cssText+="background: "+n[a]+"linear-gradient("+t+", "+r+" 0%, "+i+" 100%);"},setValue:function(e,t,r){for(var a=this.color,n=0,s=e.length;n<s;++n)a[n]=e[n];var o=i.rgbToHex(e);if(this.domInputColor.value=o,this.hasAlpha){e.length>=4?this.alpha=e[3]:e.push(this.alpha);var l="rgba("+parseInt(255*e[0],10)+","+parseInt(255*e[1],10)+","+parseInt(255*e[2],10)+","+this.alpha+")";this._alphaGradient(this.domInputColor,"0deg",l,l)}else this.domInputColor.style.background=o;var u=i.rgbToHsv(e);this.domSaturationKnob.style.borderColor=u[2]<.5||u[1]>.5?"#fff":"#000",this.domInputColor.style.color=this.alpha>.2&&(u[2]<.5||u[1]>.5)?"#fff":"#000",r||this._updateGui(),!t&&this.callback&&this.callback(e)},getValue:function(){return this.color}},i.makeProxy(a,o),r.exports=o}),r("widgets/Combobox",["require","exports","module","utils/GuiUtils","widgets/BaseWidget"],function(e,t,r){var i=e("utils/GuiUtils"),a=e("widgets/BaseWidget"),n=function(e,t,r){var i=this._getInitialValue(e,t),a=this._getCheckCallback(e,t);r=r||{},i=void 0!==i?i:r[0],this.isArray=void 0!==r.length,this.domSelect=document.createElement("select"),this.domSelect.className="gui-select",this.addOptions(r),this.domSelect.addEventListener("change",this._onChange.bind(this)),this.setValue(i),this.setCallback(a)};n.prototype={_parseValue:function(e){return this.isArray?parseInt(e,10):e},_onChange:function(e){this.setValue(e.target.value)},addOptions:function(e){for(var t=Object.keys(e),r=0;r<t.length;++r){var i=document.createElement("option");i.innerHTML=e[t[r]],i.value=t[r],this.domSelect.appendChild(i)}},setValue:function(e,t){this.domSelect.value=e,!t&&this.callback&&this.callback(this._parseValue(e))},getValue:function(){return this._parseValue(this.domSelect.value)}},i.makeProxy(a,n),r.exports=n}),r("widgets/Slider",["require","exports","module","utils/GuiUtils","widgets/BaseWidget"],function(e,t,r){var i=e("utils/GuiUtils"),a=e("widgets/BaseWidget"),n=function(e,t,r,i,a){var n=this._getInitialValue(e,t),s=this._getCheckCallback(e,t);n=void 0!==n?n:100,r=void 0!==r?r:0,i=void 0!==i?i:200,a=void 0!==a?a:1,this.domSlider=document.createElement("div"),this.domSlider.className="gui-slider",this.domSliderFill=document.createElement("div"),this.domSlider.appendChild(this.domSliderFill),this.domInputText=document.createElement("input"),this.domInputText.className="gui-input-number",this.domInputText.type="number",this.min=this.domInputText.min=r,this.max=this.domInputText.max=i,this.step=this.domInputText.step=a,this.domInputText.addEventListener("keydown",this._onKeyDown.bind(this)),this.domInputText.addEventListener("change",this._onInputText.bind(this)),this.domInputText.addEventListener("blur",this._onInputText.bind(this)),this.domSlider.addEventListener("mousedown",this._onMouseDown.bind(this)),window.addEventListener("mouseup",this._onMouseUp.bind(this),!0),window.addEventListener("mousemove",this._onMouseMove.bind(this)),this.lastValue=n,this.isDown=!1,this.setValue(n),this.setCallback(s)};n.prototype={_onInputText:function(e){var t=parseFloat(e.target.value);t===t&&t!==this.lastValue&&this.setValue(t)},_onKeyDown:function(e){e.stopPropagation(),13===e.which&&this.domInputText.blur()},_onMouseMove:function(e){if(e.preventDefault(),this.isDown){var t=this.domSlider.getBoundingClientRect(),r=this.min+(this.max-this.min)*((e.clientX-t.left)/t.width);this.setValue(r)}},_onMouseDown:function(e){this.isDown=!0,this._onMouseMove(e)},_onMouseUp:function(){this.isDown=!1},_setDomContainer:function(e){this.domContainer=e},getValue:function(){return parseFloat(this.domInputText.value)},setValue:function(e,t){this.lastValue=e,e=Math.max(Math.min(e,this.max),this.min),e=Math.round(e/this.step)*this.step,this.domInputText.value=e;var r=this.min;this.max!==this.min&&(r=(e-this.min)/(this.max-this.min)),this.domSliderFill.style.width=100*r+"%",!t&&this.callback&&this.callback(e)},setMax:function(e){return this.domInputText.max=this.max=e,this},setMin:function(e){return this.min=e,this}},i.makeProxy(a,n),r.exports=n}),r("widgets/Title",["require","exports","module","utils/GuiUtils","widgets/BaseWidget"],function(e,t,r){var i=e("utils/GuiUtils"),a=e("widgets/BaseWidget"),n=function(e){this.domText=document.createElement("div"),this.domText.innerHTML=e||"",this.domText.className="group-title"};n.prototype={setText:function(e){this.domText.innerHTML=e},setVisibility:function(e){this.domText.hidden=!e}},i.makeProxy(a,n),r.exports=n}),r("containers/BaseContainer",["require","exports","module","widgets/Button","widgets/Checkbox","widgets/Color","widgets/Combobox","widgets/Slider","widgets/Title"],function(e,t,r){var i=e("widgets/Button"),a=e("widgets/Checkbox"),n=e("widgets/Color"),s=e("widgets/Combobox"),o=e("widgets/Slider"),l=e("widgets/Title"),u=function(){};u.prototype={_addLine:function(e){var t=document.createElement("li");return t.innerHTML=e||"",this.domUl.appendChild(t),t},_createLabel:function(e){var t=document.createElement("label");return t.className="gui-label-side",t.innerHTML=e||"",t},_setDomContainer:function(e){this.domContainer=e},addTitle:function(e){var t=new l(e);return this.domUl.appendChild(t.domText),t},addCheckbox:function(e,t,r){var i=new a(t,r),n=this._addLine();n.className+=" gui-pointerOnHover gui-glowOnHover";var s=this._createLabel(e);return s.style.overflow="visible",s.className+=" gui-pointerOnHover",n.appendChild(s),n.appendChild(i.domCheckbox),n.appendChild(i.domLabelCheckbox),n.addEventListener("mousedown",i._onMouseDown.bind(i)),i._setDomContainer(n),i},addCombobox:function(e,t,r,i){var a=new s(t,r,i),n=this._addLine();return e?n.appendChild(this._createLabel(e)):a.domSelect.style.width="100%",n.appendChild(a.domSelect),a._setDomContainer(n),a},addSlider:function(e,t,r,i,a,n){var s=new o(t,r,i,a,n),l=this._addLine();return e&&l.appendChild(this._createLabel(e)),l.appendChild(s.domInputText),l.appendChild(s.domSlider),s._setDomContainer(l),s},addColor:function(e,t,r){var i=new n(t,r),a=this._addLine();return e?a.appendChild(this._createLabel(e)):i.domColor.style.width="100%",a.appendChild(i.domColor),i._setDomContainer(a),i},addButton:function(e,t,r){var a=new i(e,t,r),n=this._addLine();return n.appendChild(a.domButton),a._setDomContainer(n),a},addDualButton:function(e,t,r,a,n,s){var o=new i(e,r,n),l=new i(t,a,s),u=this._addLine();u.appendChild(l.domButton),u.appendChild(o.domButton);var h=o.domButton.style,c=l.domButton.style;return h.width=c.width="49%",h.marginRight=c.marginLeft="1%",o._setDomContainer(u),l._setDomContainer(u),[o,l]},setVisibility:function(e){this.domContainer&&(this.domContainer.hidden=!e)}},r.exports=u}),r("containers/Folder",["require","exports","module","utils/GuiUtils","containers/BaseContainer"],function(e,t,r){var i=e("utils/GuiUtils"),a=e("containers/BaseContainer"),n=function(e){this.domUl=document.createElement("ul"),this.domUl.setAttribute("opened",!0);var t=document.createElement("label");t.innerHTML=e||"",t.addEventListener("mousedown",this._onMouseDown.bind(this)),this.domUl.appendChild(t),this.isOpen=!0};n.prototype={_onMouseDown:function(){this.isOpen=!this.isOpen,this.domUl.setAttribute("opened",this.isOpen)},open:function(){this.isOpen=!0,this.domUl.setAttribute("opened",!0)},close:function(){this.isOpen=!1,this.domUl.setAttribute("opened",!1)},setVisibility:function(e){e?this.isOpen&&this.domUl.setAttribute("opened",!0):this.domUl.setAttribute("opened",!1),this.domUl.style.height=e?"auto":"0px"}},i.makeProxy(a,n),r.exports=n}),r("containers/Sidebar",["require","exports","module","containers/Folder"],function(e,t,r){var i=e("containers/Folder"),a=function(e){this.domSidebar=document.createElement("div"),this.domSidebar.className="gui-sidebar",this.domResize=document.createElement("div"),this.domResize.className="gui-resize",this.isDragging=!1,this.mouseX=0,this.domResize.addEventListener("mousedown",this._onMouseDown.bind(this)),window.addEventListener("mousemove",this._onMouseMove.bind(this)),window.addEventListener("mouseup",this._onMouseUp.bind(this)),this.callbackResize=e,this.isOnTheRight=!1};a.prototype={_setTop:function(e){this.domSidebar.style.top=this.domResize.style.top=e+"px"},_onTheRight:function(){this.isOnTheRight=!0,this.domSidebar.style.right=0,this.domSidebar.style.borderRight=0,this.domSidebar.style.borderLeft="double",this.domSidebar.style.borderColor="rgba(255,255,255,0.3)",this.domResize.style.left="auto",this.domResize.style.right=this.domSidebar.offsetWidth+"px",this.domResize.style.marginRight="-3px"},_onMouseDown:function(e){this.isDragging=!0,this.mouseX=e.clientX},_updateViewportPosition:function(e){var t=this.domSidebar.hidden?0:this.domSidebar.offsetWidth;this.isOnTheRight?e.style.width=e.clientWidth-t+"px":(e.style.left=this.domSidebar.offsetLeft+t+"px",e.style.width=e.clientWidth-t+"px")},_onMouseMove:function(e){if(this.isDragging!==!1){var t=e.clientX,r=t-this.mouseX;this.isOnTheRight&&(r=-r);var i=Math.max(50,this.domSidebar.offsetWidth+r),a=i+"px";this.domSidebar.style.width=a,this.isOnTheRight?this.domResize.style.right=this.domSidebar.offsetWidth+"px":this.domResize.style.left=a,this.mouseX=t,this.callbackResize()}},_onMouseUp:function(){this.isDragging=!1},addMenu:function(e){var t=new i(e);return this.domSidebar.appendChild(t.domUl),t},setVisibility:function(e){this.domSidebar.hidden=!e,this.domResize.hidden=!e,this.callbackResize()}},r.exports=a}),r("widgets/MenuButton",["require","exports","module","utils/GuiUtils","widgets/BaseWidget"],function(e,t,r){var i=e("utils/GuiUtils"),a=e("widgets/BaseWidget"),n=function(e,t,r){var i=e;i&&"function"!=typeof i?i=e[t].bind(e):r=t,this.domSpan=document.createElement("span"),this.domSpan.className="shortcut",this.domSpan.innerHTML=r||"",this.setCallback(i)};n.prototype={_setDomContainer:function(e){this.domContainer=e,e.addEventListener("click",this._onClick.bind(this))},_onClick:function(){this.callback&&this.callback()}},i.makeProxy(a,n),r.exports=n}),r("containers/Menu",["require","exports","module","utils/GuiUtils","containers/BaseContainer","widgets/MenuButton"],function(e,t,r){var i=e("utils/GuiUtils"),a=e("containers/BaseContainer"),n=e("widgets/MenuButton"),s=function(){this.domUl=document.createElement("ul")};s.prototype={addButton:function(e,t,r,i){var a=new n(t,r,i),s=this._addLine(e);return s.appendChild(a.domSpan),a._setDomContainer(s),a},addSlider:function(e,t,r,i,n,s){var o=a.prototype.addSlider.call(this,e,t,r,i,n,s);return o.domInputText.style.width="18%",o.domSlider.style.width=e?"44%":"80%",o}},i.makeProxy(a,s),r.exports=s}),r("utils/EditStyle",["require","exports","module","utils/GuiUtils"],function(e,t,r){var i=e("utils/GuiUtils"),a={};a.refRules={};var n,s=function(){if(n)return n;for(var e=document.styleSheets,t=0,r=e.length;t<r;++t){var i=e[t].href;if(i&&i.indexOf("yagui.css")!==-1)return n=e[t]}},o=function(e,t,r){var i=s();if(i){var n=i.cssRules||i.rules,o=a.refRules[e];if(!o){var l=0,u=n.length;for(l=0;l<u&&n[l].selectorText!==e;++l);if(l===u)return!1;o=a.refRules[e]=n[l]}o&&(o.style[t]=r)}};a.changeWidgetsColor=function(e){var t=i.getStrColor(e);o(".gui-button","background",t),o(".gui-select","background",t),o(".gui-slider > div","background",t),a._curWidgetColor=e},a.changeDisplayBoorder=function(e){var t=e?"1px solid #000":"0";o(".gui-button","border",t),o(".gui-select","border",t),o(".gui-slider","border",t),o(".gui-input-number","border",t),o(".gui-sidebar > ul > label","borderTop",t),o(".gui-sidebar > ul > label","borderBottom",t),o(".gui-sidebar","borderLeft",t),o(".gui-sidebar","borderRight",t),o(".gui-topbar","borderBottom",t),a._curShowBorder=e},a.changeBackgroundColor=function(e){o(".gui-sidebar","background",i.getStrColor(e));var t=i.getStrColor(i.getColorMult(e,.5));o(".gui-topbar","background",t),o(".gui-topbar ul > li > ul","background",t),a._curBackgroundColor=e},a.changeTextColor=function(e){var t=i.getStrColor(e);o("*","color",t),o(".gui-sidebar > ul > label","color",t),a._curTextColor=e},a.changeOverallColor=function(e){a.changeWidgetsColor(e);var t=i.getColorMult(e,.5);t.length=3,a.changeBackgroundColor(t);for(var r=i.getColorAdd(e,.5),n=0;n<3;++n)r[n]=Math.min(.8,r[n]);a.changeTextColor(r),a._curWidgetColor=e,a._curBackgroundColor=t,a._curTextColor=r},a._curTextColor=[.73,.73,.73,1],a._curWidgetColor=[.32,.37,.39,1],a._curBackgroundColor=[.24,.24,.24],a._curShowBorder=!1,a.changeOverallColor([.3,.34,.4,1]),r.exports=a}),r("containers/Topbar",["require","exports","module","containers/Menu","utils/EditStyle"],function(e,t,r){var i=e("containers/Menu"),a=e("utils/EditStyle"),n=function(e){this.domTopbar=document.createElement("div"),this.domTopbar.className="gui-topbar",this.domUl=document.createElement("ul"),this.domTopbar.appendChild(this.domUl),this.callbackResize=e,this.uiExtra={}};n.prototype={_updateViewportPosition:function(e){var t=this.domTopbar.hidden?0:this.domTopbar.offsetHeight;e.style.top=t+"px",e.style.height=e.clientHeight-t+"px"},_onChangeColor:function(e,t){e(t),this.uiExtra.overallColor.setValue(a._curWidgetColor,!0),this.uiExtra.widgetColor.setValue(a._curWidgetColor,!0),this.uiExtra.backColor.setValue(a._curBackgroundColor,!0),this.uiExtra.textColor.setValue(a._curTextColor,!0)},addMenu:function(e){var t=new i,r=document.createElement("li");return r.innerHTML=e||"",this.domUl.appendChild(r),r.appendChild(t.domUl),t._setDomContainer(r),t},addExtra:function(){var e=this._onChangeColor,t=this.addMenu("Extra UI"),r=this.uiExtra;return t.addTitle("Overall"),r.overallColor=t.addColor("",a._curWidgetColor,e.bind(this,a.changeOverallColor)),t.addTitle("Advanced"),r.widgetColor=t.addColor("Widget",a._curWidgetColor,e.bind(this,a.changeWidgetsColor)),r.backColor=t.addColor("Back",a._curBackgroundColor,e.bind(this,a.changeBackgroundColor)),r.textColor=t.addColor("Text",a._curTextColor,e.bind(this,a.changeTextColor)),r.showBorder=t.addCheckbox("Border",a._curShowBorder,a.changeDisplayBoorder),t},setVisibility:function(e){this.domTopbar.hidden=!e,this.callbackResize()}},r.exports=n}),r("GuiMain",["require","exports","module","containers/Sidebar","containers/Topbar"],function(e,t,r){var i=e("containers/Sidebar"),a=e("containers/Topbar"),n=function(e,t){this.domMain=document.createElement("div"),this.viewport=e,this.callbackResize=t,this.viewport&&(this.viewport.style.width=document.documentElement.clientWidth+"px",this.viewport.style.height=document.documentElement.clientHeight+"px"),this.cbResize_=this._onWindowResize.bind(this),document.body.appendChild(this.domMain),this.leftSidebar=void 0,this.rightSidebar=void 0,this.topbar=void 0,window.addEventListener("resize",this._onWindowResize.bind(this),!1)};n.prototype={_onWindowResize:function(){this.viewport&&(this.viewport.style.width=document.documentElement.clientWidth+"px",this.viewport.style.height=document.documentElement.clientHeight+"px",this.viewport.style.left="0px",this.viewport.style.top="0px",this.leftSidebar&&this.leftSidebar._updateViewportPosition(this.viewport),this.rightSidebar&&this.rightSidebar._updateViewportPosition(this.viewport),this.topbar&&this.topbar._updateViewportPosition(this.viewport)),this._updateSidebarsPosition(),this.callbackResize&&this.callbackResize()},_updateSidebarsPosition:function(){if(this.topbar){var e=this.topbar.domTopbar.offsetHeight;this.leftSidebar&&this.leftSidebar._setTop(e),this.rightSidebar&&this.rightSidebar._setTop(e)}},addLeftSidebar:function(){this.leftSidebar=new i(this.cbResize_);var e=this.leftSidebar.domSidebar;return this.domMain.appendChild(e),this.domMain.appendChild(this.leftSidebar.domResize),this._updateSidebarsPosition(),this.leftSidebar._updateViewportPosition(this.viewport),this.leftSidebar},addRightSidebar:function(){this.rightSidebar=new i(this.cbResize_);var e=this.rightSidebar.domSidebar;return this.domMain.appendChild(e),this.domMain.appendChild(this.rightSidebar.domResize),this.rightSidebar._onTheRight(),this._updateSidebarsPosition(),this.rightSidebar._updateViewportPosition(this.viewport),this.rightSidebar},addTopbar:function(){return this.topbar=new a(this.cbResize_),this.domMain.appendChild(this.topbar.domTopbar),this._updateSidebarsPosition(),this.topbar._updateViewportPosition(this.viewport),this.topbar},setVisibility:function(e){this.domMain.hidden=!e,this._onWindowResize()}},r.exports=n}),r("yagui",["require","exports","module","GuiMain"],function(e,t,r){var i=e("GuiMain"),a={};a.GuiMain=i,window.yagui=a,r.exports=a}),t("yagui")}();var Kr=window.yagui,Zr=function(){function e(t,r){y(this,e),this._main=r._main,this._menu=null,this.init(t)}return M(e,[{key:"init",value:function(e){var t=this._menu=e.addMenu(B("backgroundTitle"));t.addButton(B("backgroundReset"),this,"resetBackground"),t.addButton(B("backgroundImport"),this,"importBackground"),t.addCheckbox(B("backgroundFill"),this._main.getBackground()._fill,this.updateFill.bind(this))}},{key:"updateFill",value:function(e){this._main.getBackground()._fill=e,this._main.onCanvasResize()}},{key:"resetBackground",value:function(){this._main.getBackground().deleteTexture(),this._main.render()}},{key:"importBackground",value:function(){document.getElementById("backgroundopen").click()}}]),e}(),Qr=function(){function e(t,r){y(this,e),this._main=r._main,this._menu=null,this._camera=this._main.getCamera(),this._cameraTimer=-1,this._cbTranslation=this.cbOnTranslation.bind(this),this.init(t)}return M(e,[{key:"init",value:function(e){var t=this._camera,r=this._menu=e.addMenu(B("cameraTitle"));r.addTitle(B("cameraReset")),r.addDualButton(B("cameraCenter"),B("cameraFront"),this.resetCamera.bind(this),this.resetFront.bind(this)),r.addDualButton(B("cameraLeft"),B("cameraTop"),this.resetLeft.bind(this),this.resetTop.bind(this)),this._ctrlProjectionTitle=r.addTitle(B("cameraProjection"));var i=[];i[o.Projection.PERSPECTIVE]=B("cameraPerspective"),i[o.Projection.ORTHOGRAPHIC]=B("cameraOrthographic"),this._ctrlProjection=r.addCombobox("",t.getProjectionType(),this.onCameraTypeChange.bind(this),i),this._ctrlFov=r.addSlider(B("cameraFov"),t.getFov(),this.onFovChange.bind(this),10,90,1),this._ctrlFov.setVisibility(t.getProjectionType()===o.Projection.PERSPECTIVE),r.addTitle(B("cameraMode"));var a=[];a[o.CameraMode.ORBIT]=B("cameraOrbit"),a[o.CameraMode.SPHERICAL]=B("cameraSpherical"),a[o.CameraMode.PLANE]=B("cameraPlane"),r.addCombobox("",t.getMode(),this.onCameraModeChange.bind(this),a),this._ctrlPivot=r.addCheckbox(B("cameraPivot"),t.getUsePivot(),this.onPivotChange.bind(this))}},{key:"onCameraModeChange",value:function(e){this._camera.setMode(e),this._main.render()}},{key:"onCameraTypeChange",value:function(e){this._camera.setProjectionType(e),this._ctrlFov.setVisibility(e===o.Projection.PERSPECTIVE),this._main.render()}},{key:"onFovChange",value:function(e){this._camera.setFov(e),this._main.render()}},{key:"onKeyDown",value:function(e){if(e.handled!==!0&&(e.stopPropagation(),!this._main._focusGui)){e.preventDefault();var t=this._main,r=t.getCamera();switch(e.handled=!0,e.shiftKey&&t._action===o.Action.CAMERA_ROTATE&&(r.snapClosestRotation(),t.render()),_.getShortKey(e.which)){case o.KeyAction.STRIFE_LEFT:r._moveX=-1;break;case o.KeyAction.STRIFE_RIGHT:r._moveX=1;break;case o.KeyAction.STRIFE_UP:r._moveZ=-1;break;case o.KeyAction.STRIFE_DOWN:r._moveZ=1;break;default:e.handled=!1}e.handled===!0&&this._cameraTimer===-1&&(this._cameraTimer=window.setInterval(this._cbTranslation,16.6))}}},{key:"cbOnTranslation",value:function(){var e=this._main;e.getCamera().updateTranslation(),e.render()}},{key:"onKeyUp",value:function(e){if(e.handled!==!0&&(e.stopPropagation(),!this._main._focusGui)){e.preventDefault(),e.handled=!0;var t=this._camera;switch(_.getShortKey(e.which)){case o.KeyAction.STRIFE_LEFT:case o.KeyAction.STRIFE_RIGHT:t._moveX=0;break;case o.KeyAction.STRIFE_UP:case o.KeyAction.STRIFE_DOWN:t._moveZ=0;break;case o.KeyAction.CAMERA_RESET:this.resetCamera();break;case o.KeyAction.CAMERA_FRONT:this.resetFront();break;case o.KeyAction.CAMERA_TOP:this.resetTop();break;case o.KeyAction.CAMERA_LEFT:this.resetLeft()}this._cameraTimer!==-1&&0===t._moveX&&0===t._moveZ&&(clearInterval(this._cameraTimer),this._cameraTimer=-1)}}},{key:"resetCamera",value:function(){this._camera.resetView(),this._main.render()}},{key:"resetFront",value:function(){this._camera.toggleViewFront(),this._main.render()}},{key:"resetLeft",value:function(){this._camera.toggleViewLeft(),this._main.render()}},{key:"resetTop",value:function(){this._camera.toggleViewTop(),this._main.render()}},{key:"onPivotChange",value:function(){this._camera.toggleUsePivot(),this._main.render()}}]),e}(),Jr=function(){function e(t,r){y(this,e),this._ctrlGui=r,this._menu=null,this.init(t)}return M(e,[{key:"init",value:function(e){this._langs=Object.keys(B.languages),this._menu=e.addMenu("Language"),this._menu.addCombobox("",this._langs.indexOf(B.select),this.onLangChange.bind(this),this._langs)}},{key:"onLangChange",value:function(e){B.select=this._langs[parseInt(e,10)],this._ctrlGui.initGui()}}]),e}(),$r=$r||function(e){if(!("undefined"==typeof e||"undefined"!=typeof navigator&&/MSIE [1-9]\./.test(navigator.userAgent))){var t=e.document,r=function(){return e.URL||e.webkitURL||e},i=t.createElementNS("http://www.w3.org/1999/xhtml","a"),a="download"in i,n=function(e){var t=new MouseEvent("click");e.dispatchEvent(t)},s=/constructor/i.test(e.HTMLElement),o=/CriOS\/[\d]+/.test(navigator.userAgent),l=function(t){(e.setImmediate||e.setTimeout)(function(){throw t},0)},u="application/octet-stream",h=4e4,c=function(e){var t=function(){"string"==typeof e?r().revokeObjectURL(e):e.remove()};setTimeout(t,h)},d=function(e,t,r){t=[].concat(t);for(var i=t.length;i--;){var a=e["on"+t[i]];if("function"==typeof a)try{a.call(e,r||e)}catch(e){l(e)}}},g=function(e){return/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(e.type)?new Blob([String.fromCharCode(65279),e],{type:e.type}):e},f=function(t,l,h){h||(t=g(t));var f,v=this,m=t.type,p=m===u,_=function(){d(v,"writestart progress write writeend".split(" "))},y=function(){if((o||p&&s)&&e.FileReader){var i=new FileReader;return i.onloadend=function(){var t=o?i.result:i.result.replace(/^data:[^;]*;/,"data:attachment/file;"),r=e.open(t,"_blank");r||(e.location.href=t),t=void 0,v.readyState=v.DONE,_()},i.readAsDataURL(t),void(v.readyState=v.INIT)}if(f||(f=r().createObjectURL(t)),p)e.location.href=f;else{var a=e.open(f,"_blank");a||(e.location.href=f)}v.readyState=v.DONE,_(),c(f)};return v.readyState=v.INIT,a?(f=r().createObjectURL(t),void setTimeout(function(){i.href=f,i.download=l,n(i),_(),c(f),v.readyState=v.DONE})):void y()},v=f.prototype,m=function(e,t,r){return new f(e,t||e.name||"download",r)};return"undefined"!=typeof navigator&&navigator.msSaveOrOpenBlob?function(e,t,r){return t=t||e.name||"download",r||(e=g(e)),navigator.msSaveOrOpenBlob(e,t)}:(v.abort=function(){},v.readyState=v.INIT=0,v.WRITING=1,v.DONE=2,v.error=v.onwritestart=v.onprogress=v.onwrite=v.onabort=v.onerror=v.onwriteend=null,e.saveAs=m,m)}}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||self.content);"undefined"!=typeof module&&module.exports?module.exports.saveAs=$r:"undefined"!=typeof define&&null!==define&&null!==define.amd&&define("FileSaver.js",function(){return $r});var ei=window.saveAs,ti=i.vec3,ri={};ri.exportOBJ=function(e,t){for(var r="s 0\n",i=[1,1],a=0,n=e.length;a<n;++a)r+="o mesh_"+a+"\n",r=ri.addMesh(e[a],r,i,t);return new Blob([r])};var ii=function(e,t,r){for(var i=0,a=t.length;i<a;i++)e[r++]=t.charCodeAt(i);return r};ri.addMesh=function(e,t,r,i){var a=e.getVertices(),s=e.getColors(),o=e.getMaterials(),l=e.getFaces(),u=e.getNbVertices(),h=e.getNbFaces(),c=e.getNbTexCoords(),d=e.getMatrix(),g=0,f=0,v="",m=0,p=20;m=i?u*(8+6*p):u*(5+3*p+8+6),m+=c*(5+2*p)+66*h;var _=new Uint8Array(Math.max(1e3,m)),y=0,M=[0,0,0];for(g=0;g<u;++g)f=3*g,M[0]=a[f],M[1]=a[f+1],M[2]=a[f+2],ti.transformMat4(M,M,d),v="v "+M[0]+" "+M[1]+" "+M[2],v+=i?" "+s[f]+" "+s[f+1]+" "+s[f+2]+"\n":"\n",y=ii(_,v,y);if(!i){var T=Math.ceil(u/64);for(g=0;g<T;++g){v="#MRGB ",f=64*g;for(var S=f+(g===T-1?u%64:64);f<S;++f){v+="ff";var b=3*f,A=Math.round(255*s[b]).toString(16),x=Math.round(255*s[b+1]).toString(16),k=Math.round(255*s[b+2]).toString(16);v+=1===A.length?"0"+A:A,v+=1===x.length?"0"+x:x,v+=1===k.length?"0"+k:k}v+="\n",y=ii(_,v,y)}for(T=Math.ceil(u/46),g=0;g<T;++g){v="#MAT ",f=46*g;for(var w=f+(g===T-1?u%46:46);f<w;++f){var E=3*f,R=Math.round(255*o[E]).toString(16),F=Math.round(255*o[E+1]).toString(16),D=Math.round(255*o[E+2]).toString(16);v+=1===R.length?"0"+R:R,v+=1===F.length?"0"+F:F,v+=1===D.length?"0"+D:D}v+="\n",y=ii(_,v,y)}}var I=e.getFacesTexCoord(),C=e.getTexCoords(),N=e.hasUV();if(N)for(g=0;g<c;++g)f=2*g,v="vt "+C[f]+" "+C[f+1]+"\n",y=ii(_,v,y);var V=r[0],P=r[1];for(r[0]+=u,r[1]+=c,g=0;g<h;++g){f=4*g;var L=l[f+3];N?(v="f "+(V+l[f])+"/"+(P+I[f]),v+=" "+(V+l[f+1])+"/"+(P+I[f+1]),v+=" "+(V+l[f+2])+"/"+(P+I[f+2]),v+=L!==n.TRI_INDEX?" "+(V+L)+"/"+(P+I[f+3])+"\n":"\n"):(v="f "+(V+l[f]),v+=" "+(V+l[f+1]),v+=" "+(V+l[f+2]),v+=L!==n.TRI_INDEX?" "+(V+L)+"\n":"\n"),y=ii(_,v,y)}if(_=_.subarray(0,y),window.TextDecoder){var U=new TextDecoder;return t+U.decode(_)}for(g=0;g<y;++g)t+=String.fromCharCode(_[g]);return t};var ai={};ai.exportAsciiPLY=function(e){var t=e.getVertices(),r=e.getColors(),i=e.getFaces(),a="ply\nformat ascii 1.0\ncomment created by SculptGL\n",s=e.getNbVertices(),o=e.getNbFaces(),l=0,u=0;for(a+="element vertex "+s+"\n",a+="property float x\nproperty float y\nproperty float z\n",a+="property uchar red\nproperty uchar green\nproperty uchar blue\n",a+="element face "+o+"\n",a+="property list uchar uint vertex_indices\nend_header\n",l=0;l<s;++l)u=3*l,a+=t[u]+" "+t[u+1]+" "+t[u+2]+" "+(255*r[u]|0)+" "+(255*r[u+1]|0)+" "+(255*r[u+2]|0)+"\n";for(l=0;l<o;++l){u=4*l;var h=i[u+3],c=h!==n.TRI_INDEX;a+=(c?"4 ":"3 ")+i[u]+" "+i[u+1]+" "+i[u+2]+(c?" "+h+"\n":"\n")}return new Blob([a])},ai.exportBinaryPLY=function(e,t){var r=e.length?e:[e],i=r.length,a=0,s=0,o=0,l=0,u=0,h=0,c=0;for(a=0;a<i;++a)l+=r[a].getNbVertices(),u+=r[a].getNbFaces(),h+=r[a].getNbQuads(),c+=r[a].getNbTriangles();var d,g,f;if(t){var v={vertices:null,colors:null,faces:null};for(yt.mergeArrays(r,v),d=v.vertices,g=v.colors,f=v.faces,a=0;a<l;++a){
o=3*a;var m=d[o+1];d[o+1]=-d[o+2],d[o+2]=m}}else d=r[0].getVertices(),g=r[0].getColors(),f=r[0].getFaces();var p=n.littleEndian?"little":"big",_="ply\nformat binary_"+p+"_endian 1.0\ncomment created by SculptGL\n";_+="element vertex "+l+"\n",_+="property float x\nproperty float y\nproperty float z\n",_+="property uchar red\nproperty uchar green\nproperty uchar blue\n",_+="element face "+u+"\n",_+="property list uchar uint vertex_indices\nend_header\n";var y=4*d.length+g.length,M=4*(4*h+3*c)+u,T=_.length+y+2*M,S=new Uint8Array(T),b=new DataView(S.buffer);s=_.length;var A=0;for(A=0;A<s;++A)S[A]=_.charCodeAt(A);for(a=0;a<l;++a)s=3*a,b.setFloat32(A,d[s],!0),A+=4,b.setFloat32(A,d[s+1],!0),A+=4,b.setFloat32(A,d[s+2],!0),A+=4,b.setUint8(A,Math.round(255*g[s])),A+=1,b.setUint8(A,Math.round(255*g[s+1])),A+=1,b.setUint8(A,Math.round(255*g[s+2])),A+=1;for(a=0;a<u;++a){s=4*a;var x=f[s+3]!==n.TRI_INDEX;b.setUint8(A,x?4:3),A+=1,b.setUint32(A,f[s],!0),A+=4,b.setUint32(A,f[s+1],!0),A+=4,b.setUint32(A,f[s+2],!0),A+=4,x&&(b.setUint32(A,f[s+3],!0),A+=4)}return new Blob([S])};var ni={};ni.exportAsciiSTL=function(e){var t=e.getVertices(),r=e.getTriangles(),i=e.getFaceNormals(),a=new Float32Array(n.getMemory(4*i.length),0,i.length);n.normalizeArrayVec3(i,a);for(var s="solid mesh\n",o=e.getNbTriangles(),l=0;l<o;++l){var u=3*l;s+=" facet normal "+a[u]+" "+a[u+1]+" "+a[u+2]+"\n",s+="  outer loop\n";var h=3*r[u],c=3*r[u+1],d=3*r[u+2];s+="   vertex "+t[h]+" "+t[h+1]+" "+t[h+2]+"\n",s+="   vertex "+t[c]+" "+t[c+1]+" "+t[c+2]+"\n",s+="   vertex "+t[d]+" "+t[d+1]+" "+t[d+2]+"\n",s+="  endloop\n",s+=" endfacet\n"}return s+="endsolid mesh\n",new Blob([s])},ni.exportBinarySTL=function(e){var t=e.getVertices(),r=e.getColors(),i=e.getTriangles(),a=e.getFaceNormals(),s=new Float32Array(n.getMemory(4*a.length),0,a.length);n.normalizeArrayVec3(a,s);var o=e.getNbTriangles(),l=new Uint8Array(84+50*o),u=new Uint8Array(new Uint32Array([o]).buffer);l.set(u,80);for(var h=new Uint8Array(t.buffer),c=new Uint8Array(s.buffer),d=84,g=0,f=31/3,v=0;v<o;++v){var m=12*v;for(g=0;g<12;++g)l[d++]=c[m++];m=3*v;var p=3*i[m],_=3*i[m+1],y=3*i[m+2],M=4*p;for(g=0;g<12;++g)l[d++]=h[M++];var T=4*_;for(g=0;g<12;++g)l[d++]=h[T++];var S=4*y;for(g=0;g<12;++g)l[d++]=h[S++];var b=Math.round((r[p]+r[_]+r[y])*f)<<10,A=Math.round((r[p+1]+r[_+1]+r[y+1])*f)<<5,x=Math.round((r[p+2]+r[_+2]+r[y+2])*f),k=b+A+x+32768;l[d++]=255&k,l[d++]=k>>8}return new Blob([l])},function(e){function t(){this.crc=-1}function r(){}function i(e,t,r){if(t<0||r<0||t+r>e.size)throw new RangeError("offset:"+t+", length:"+r+", size:"+e.size);return e.slice?e.slice(t,t+r):e.webkitSlice?e.webkitSlice(t,t+r):e.mozSlice?e.mozSlice(t,t+r):e.msSlice?e.msSlice(t,t+r):void 0}function a(e,t){var r,i;return r=new ArrayBuffer(e),i=new Uint8Array(r),t&&i.set(t,0),{buffer:r,array:i,view:new DataView(r)}}function n(){}function s(e){function t(t,r){var n=new Blob([e],{type:G});i=new l(n),i.init(function(){a.size=i.size,t()},r)}function r(e,t,r,a){i.readUint8Array(e,t,r,a)}var i,a=this;a.size=0,a.init=t,a.readUint8Array=r}function o(t){function r(e){for(var r=t.length;"="==t.charAt(r-1);)r--;n=t.indexOf(",")+1,s.size=Math.floor(.75*(r-n)),e()}function i(r,i,s){var o,l=a(i),u=4*Math.floor(r/3),h=4*Math.ceil((r+i)/3),c=e.atob(t.substring(u+n,h+n)),d=r-3*Math.floor(u/4);for(o=d;o<d+i;o++)l.array[o-d]=c.charCodeAt(o);s(l.array)}var n,s=this;s.size=0,s.init=r,s.readUint8Array=i}function l(e){function t(t){a.size=e.size,t()}function r(t,r,a,n){var s=new FileReader;s.onload=function(e){a(new Uint8Array(e.target.result))},s.onerror=n;try{s.readAsArrayBuffer(i(e,t,r))}catch(e){n(e)}}var a=this;a.size=0,a.init=t,a.readUint8Array=r}function u(){}function h(e){function t(e){a=new Blob([],{type:G}),e()}function r(e,t){a=new Blob([a,F?e:e.buffer],{type:G}),t()}function i(t,r){var i=new FileReader;i.onload=function(e){t(e.target.result)},i.onerror=r,i.readAsText(a,e)}var a,n=this;n.init=t,n.writeUint8Array=r,n.getData=i}function c(t){function r(e){s+="data:"+(t||"")+";base64,",e()}function i(t,r){var i,a=o.length,n=o;for(o="",i=0;i<3*Math.floor((a+t.length)/3)-a;i++)n+=String.fromCharCode(t[i]);for(;i<t.length;i++)o+=String.fromCharCode(t[i]);n.length>2?s+=e.btoa(n):o=n,r()}function a(t){t(s+e.btoa(o))}var n=this,s="",o="";n.init=r,n.writeUint8Array=i,n.getData=a}function d(e){function t(t){a=new Blob([],{type:e}),t()}function r(t,r){a=new Blob([a,F?t:t.buffer],{type:e}),r()}function i(e){e(a)}var a,n=this;n.init=t,n.writeUint8Array=r,n.getData=i}function g(e,t,r,i,a,n,s,o,l,u){function h(){e.removeEventListener("message",c,!1),o(f,v)}function c(t){var r=t.data,a=r.data,o=r.error;if(o)return o.toString=function(){return"Error: "+this.message},void l(o);if(r.sn===p)switch("number"==typeof r.codecTime&&(e.codecTime+=r.codecTime),"number"==typeof r.crcTime&&(e.crcTime+=r.crcTime),r.type){case"append":a?(f+=a.length,i.writeUint8Array(a,function(){d()},u)):d();break;case"flush":v=r.crc,a?(f+=a.length,i.writeUint8Array(a,function(){h()},u)):h();break;case"progress":s&&s(g+r.loaded,n);break;case"importScripts":case"newTask":case"echo":break;default:console.warn("zip.js:launchWorkerProcess: unknown message: ",r)}}function d(){g=m*O,g<n?r.readUint8Array(a+g,Math.min(O,n-g),function(r){s&&s(g,n);var i=0===g?t:{sn:p};i.type="append",i.data=r,e.postMessage(i,[r.buffer]),m++},l):e.postMessage({sn:p,type:"flush"})}var g,f,v,m=0,p=t.sn;f=0,e.addEventListener("message",c,!1),d()}function f(e,r,i,a,n,s,o,l,u,h){function c(){var t;if(d=g*O,d<n)r.readUint8Array(a+d,Math.min(O,n-d),function(t){var r;try{r=e.append(t,function(e){o&&o(d+e,n)})}catch(e){return void u(e)}r?(f+=r.length,i.writeUint8Array(r,function(){g++,setTimeout(c,1)},h),m&&p.append(r)):(g++,setTimeout(c,1)),v&&p.append(t),o&&o(d,n)},u);else{try{t=e.flush()}catch(e){return void u(e)}t?(m&&p.append(t),f+=t.length,i.writeUint8Array(t,function(){l(f,p.get())},h)):l(f,p.get())}}var d,g=0,f=0,v="input"===s,m="output"===s,p=new t;c()}function v(t,r,i,a,n,s,o,l,u,h,c){var d=o?"output":"none";if(e.zip.useWebWorkers){var v={sn:r,codecClass:"Inflater",crcType:d};g(t,v,i,a,n,s,u,l,h,c)}else f(new e.zip.Inflater,i,a,n,s,d,u,l,h,c)}function m(t,r,i,a,n,s,o,l,u){var h="input";if(e.zip.useWebWorkers){var c={sn:r,options:{level:n},codecClass:"Deflater",crcType:h};g(t,c,i,a,0,i.size,o,s,l,u)}else f(new e.zip.Deflater,i,a,0,i.size,h,o,s,l,u)}function p(t,i,a,n,s,o,l,u,h,c,d){var v="input";if(e.zip.useWebWorkers&&l){var m={sn:i,codecClass:"NOOP",crcType:v};g(t,m,a,n,s,o,h,u,c,d)}else f(new r,a,n,s,o,v,h,u,c,d)}function _(e){var t,r,i="",a=["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","_","_","_","","","","","","","","","+","+","","","+","+","-","-","+","-","+","","","+","+","-","-","","-","+","","","","","","","i","","","","+","+","_","_","","","_","","","","","","","","","","","","","","","","","","","_","","","","","","","","","","","","_"," "];for(t=0;t<e.length;t++)r=255&e.charCodeAt(t),i+=r>127?a[r-128]:String.fromCharCode(r);return i}function y(e){return decodeURIComponent(escape(e))}function M(e){var t,r="";for(t=0;t<e.length;t++)r+=String.fromCharCode(e[t]);return r}function T(e){var t=(4294901760&e)>>16,r=65535&e;try{return new Date(1980+((65024&t)>>9),((480&t)>>5)-1,31&t,(63488&r)>>11,(2016&r)>>5,2*(31&r),0)}catch(e){}}function S(e,t,r,i,a){return e.version=t.view.getUint16(r,!0),e.bitFlag=t.view.getUint16(r+2,!0),e.compressionMethod=t.view.getUint16(r+4,!0),e.lastModDateRaw=t.view.getUint32(r+6,!0),e.lastModDate=T(e.lastModDateRaw),1===(1&e.bitFlag)?void a(C):((i||8!=(8&e.bitFlag))&&(e.crc32=t.view.getUint32(r+10,!0),e.compressedSize=t.view.getUint32(r+14,!0),e.uncompressedSize=t.view.getUint32(r+18,!0)),4294967295===e.compressedSize||4294967295===e.uncompressedSize?void a(N):(e.filenameLength=t.view.getUint16(r+22,!0),void(e.extraFieldLength=t.view.getUint16(r+24,!0))))}function b(t,r,i){function n(){}function s(e){function r(r,n){t.readUint8Array(t.size-r,r,function(t){for(var r=t.length-a;r>=0;r--)if(80===t[r]&&75===t[r+1]&&5===t[r+2]&&6===t[r+3])return void e(new DataView(t.buffer,r,a));n()},function(){i(V)})}var a=22;if(t.size<a)return void i(D);var n=65536,s=a+n;r(a,function(){r(Math.min(s,t.size),function(){i(D)})})}var o=0;n.prototype.getData=function(e,r,n,s){function l(e){var t=a(4);return t.view.setUint32(0,e),d.crc32==t.view.getUint32(0)}function u(t,a){s&&!l(a)?i(I):e.getData(function(e){r(e)})}function h(e){i(e||U)}function c(e){i(e||L)}var d=this;t.readUint8Array(d.offset,30,function(r){var l,g=a(r.length,r);return 1347093252!=g.view.getUint32(0)?void i(D):(S(d,g,4,!1,i),l=d.offset+30+d.filenameLength+d.extraFieldLength,void e.init(function(){0===d.compressionMethod?p(d._worker,o++,t,e,l,d.compressedSize,s,u,n,h,c):v(d._worker,o++,t,e,l,d.compressedSize,s,u,n,h,c)},c))},h)};var l={getEntries:function(e){var r=this._worker;s(function(s){var o,l;return o=s.getUint32(16,!0),l=s.getUint16(8,!0),o<0||o>=t.size?void i(D):void t.readUint8Array(o,t.size-o,function(t){var s,o,u,h,c=0,d=[],g=a(t.length,t);for(s=0;s<l;s++){if(o=new n,o._worker=r,1347092738!=g.view.getUint32(c))return void i(D);S(o,g,c+6,!0,i),o.commentLength=g.view.getUint16(c+32,!0),o.directory=16==(16&g.view.getUint8(c+38)),o.offset=g.view.getUint32(c+42,!0),u=M(g.array.subarray(c+46,c+46+o.filenameLength)),o.filename=2048===(2048&o.bitFlag)?y(u):_(u),o.directory||"/"!=o.filename.charAt(o.filename.length-1)||(o.directory=!0),h=M(g.array.subarray(c+46+o.filenameLength+o.extraFieldLength,c+46+o.filenameLength+o.extraFieldLength+o.commentLength)),o.comment=2048===(2048&o.bitFlag)?y(h):_(h),d.push(o),c+=46+o.filenameLength+o.extraFieldLength+o.commentLength}e(d)},function(){i(V)})})},close:function(e){this._worker&&(this._worker.terminate(),this._worker=null),e&&e()},_worker:null};e.zip.useWebWorkers?E("inflater",function(e){l._worker=e,r(l)},function(e){i(e)}):r(l)}function A(e){return unescape(encodeURIComponent(e))}function x(e){var t,r=[];for(t=0;t<e.length;t++)r.push(e.charCodeAt(t));return r}function k(t,r,i,n){function s(e){i(e||P)}function o(e){i(e||U)}var l={},u=[],h=0,c=0,d={add:function(e,r,d,g,f){function v(r){var i;S=f.lastModDate||new Date,M=a(26),l[e]={headerArray:M.array,directory:f.directory,filename:T,offset:h,comment:x(A(f.comment||""))},M.view.setUint32(0,335546376),f.version&&M.view.setUint8(0,f.version),n||0===f.level||f.directory||M.view.setUint16(4,2048),M.view.setUint16(6,(S.getHours()<<6|S.getMinutes())<<5|S.getSeconds()/2,!0),M.view.setUint16(8,(S.getFullYear()-1980<<4|S.getMonth()+1)<<5|S.getDate(),!0),M.view.setUint16(22,T.length,!0),i=a(30+T.length),i.view.setUint32(0,1347093252),i.array.set(M.array,4),i.array.set(T,30),h+=i.array.length,t.writeUint8Array(i.array,r,s)}function _(e,i){var n=a(16);h+=e||0,n.view.setUint32(0,1347094280),"undefined"!=typeof i&&(M.view.setUint32(10,i,!0),n.view.setUint32(4,i,!0)),r&&(n.view.setUint32(8,e,!0),M.view.setUint32(14,e,!0),n.view.setUint32(12,r.size,!0),M.view.setUint32(18,r.size,!0)),t.writeUint8Array(n.array,function(){h+=16,d()},s)}function y(){return f=f||{},e=e.trim(),f.directory&&"/"!=e.charAt(e.length-1)&&(e+="/"),l.hasOwnProperty(e)?void i(B):(T=x(A(e)),u.push(e),void v(function(){r?n||0===f.level?p(b,c++,r,t,0,r.size,!0,_,g,o,s):m(b,c++,r,t,f.level,_,g,o,s):_()},s))}var M,T,S,b=this._worker;r?r.init(y,o):y()},close:function(e){this._worker&&(this._worker.terminate(),this._worker=null);var r,i,n,o=0,c=0;for(i=0;i<u.length;i++)n=l[u[i]],o+=46+n.filename.length+n.comment.length;for(r=a(o+22),i=0;i<u.length;i++)n=l[u[i]],r.view.setUint32(c,1347092738),r.view.setUint16(c+4,5120),r.array.set(n.headerArray,c+6),r.view.setUint16(c+32,n.comment.length,!0),n.directory&&r.view.setUint8(c+38,16),r.view.setUint32(c+42,n.offset,!0),r.array.set(n.filename,c+46),r.array.set(n.comment,c+46+n.filename.length),c+=46+n.filename.length+n.comment.length;r.view.setUint32(c,1347093766),r.view.setUint16(c+8,u.length,!0),r.view.setUint16(c+10,u.length,!0),r.view.setUint32(c+12,o,!0),r.view.setUint32(c+16,h,!0),t.writeUint8Array(r.array,function(){t.getData(e)},s)},_worker:null};e.zip.useWebWorkers?E("deflater",function(e){d._worker=e,r(d)},function(e){i(e)}):r(d)}function w(e){var t=document.createElement("a");return e.map(function(e){return t.href=e,t.href})}function E(t,r,i){function a(e){var t=e.data;return t.error?(o.terminate(),void i(t.error)):void("importScripts"===t.type&&(o.removeEventListener("message",a),o.removeEventListener("error",n),r(o)))}function n(e){o.terminate(),i(e)}if(null!==e.zip.workerScripts&&null!==e.zip.workerScriptsPath)return void i(new Error("Either zip.workerScripts or zip.workerScriptsPath may be set, not both."));var s;if(e.zip.workerScripts){if(s=e.zip.workerScripts[t],!Array.isArray(s))return void i(new Error("zip.workerScripts."+t+" is not an array!"));s=w(s)}else s=z[t].slice(0),s[0]=(e.zip.workerScriptsPath||"")+s[0];var o=new Worker(s[0]);o.codecTime=o.crcTime=0,o.postMessage({type:"importScripts",scripts:s.slice(1)}),o.addEventListener("message",a),o.addEventListener("error",n)}function R(e){console.error(e)}var F,D="File format is not recognized.",I="CRC failed.",C="File contains encrypted entry.",N="File is using Zip64 (4gb+ file size).",V="Error while reading zip file.",P="Error while writing zip file.",L="Error while writing file data.",U="Error while reading file data.",B="File already exists.",O=524288,G="text/plain";try{F=0===new Blob([new DataView(new ArrayBuffer(0))]).size}catch(e){}t.prototype.append=function(e){for(var t=0|this.crc,r=this.table,i=0,a=0|e.length;i<a;i++)t=t>>>8^r[255&(t^e[i])];this.crc=t},t.prototype.get=function(){return~this.crc},t.prototype.table=function(){var e,t,r,i=[];for(e=0;e<256;e++){for(r=e,t=0;t<8;t++)1&r?r=r>>>1^3988292384:r>>>=1;i[e]=r}return i}(),r.prototype.append=function(e,t){return e},r.prototype.flush=function(){},s.prototype=new n,s.prototype.constructor=s,o.prototype=new n,o.prototype.constructor=o,l.prototype=new n,l.prototype.constructor=l,u.prototype.getData=function(e){e(this.data)},h.prototype=new u,h.prototype.constructor=h,c.prototype=new u,c.prototype.constructor=c,d.prototype=new u,d.prototype.constructor=d;var z={deflater:["z-worker.js","deflate.js"],inflater:["z-worker.js","inflate.js"]};e.zip={Reader:n,Writer:u,BlobReader:l,Data64URIReader:o,TextReader:s,BlobWriter:d,Data64URIWriter:c,TextWriter:h,createReader:function(e,t,r){r=r||R,e.init(function(){b(e,t,r)},r)},createWriter:function(e,t,r,i){r=r||R,i=!!i,e.init(function(){k(e,t,r,i)},r)},useWebWorkers:!0,workerScriptsPath:null,workerScripts:null}}(self);var si=window.zip,oi={};oi.exportSketchfab=function(e,t,r){var i=new XMLHttpRequest,a=r.domContainer;r.setVisibility(!0),r.sketchfab=!0,a.innerHTML="Uploading...",i.open("POST","https://api.sketchfab.com/v2/models",!0),i.onprogress=function(e){var t="~";e.lengthComputable&&e.total&&(t=Math.round(100*e.loaded/e.total)),a.innerHTML="Uploading : "+t+"%"};var n=function(){r.setVisibility(!1),r.sketchfab=!1};return i.onerror=n,i.onabort=n,i.onload=function(){n();var e=JSON.parse(i.responseText),r=e.uid;if(!r)return void window.alert(B("sketchfabUploadError",e.detail));window.prompt(B("sketchfabUploadProcessing"),"https://sketchfab.com/models/"+r);var a=function e(){var i=new XMLHttpRequest;i.open("GET","https://api.sketchfab.com/v2/models/"+r+"/status?token="+t,!0),i.onload=function(){var t=JSON.parse(i.responseText);"FAILED"===t.processing?window.alert(B("sketchfabUploadError",t.warning.generic.join("\n"))):"SUCCEEDED"===t.processing?window.prompt(B("sketchfabUploadSuccess"),"https://sketchfab.com/models/"+r):window.setTimeout(e,5e3)},i.send()};a()},si.useWebWorkers=!0,si.workerScriptsPath="worker/",si.createWriter(new si.BlobWriter("application/zip"),function(r){var a=ai.exportBinaryPLY(e.getMeshes(),!0);r.add("yourMesh.ply",new si.BlobReader(a),function(){r.close(oi.exportFileSketchfab.bind(this,e,t,i))})},onerror),i},oi.exportFileSketchfab=function(e,t,r,i){var a=new FormData;a.append("token",t),a.append("modelFile",i,"sculptglModel.zip"),a.append("name","My model"),a.append("tags","sculptgl"),r.send(a)};var li={};li.exportOBJ=ri.exportOBJ,li.exportSGL=Dr.exportSGL,li.exportAsciiPLY=ai.exportAsciiPLY,li.exportBinaryPLY=ai.exportBinaryPLY,li.exportAsciiSTL=ni.exportAsciiSTL,li.exportBinarySTL=ni.exportBinarySTL,li.exportSketchfab=oi.exportSketchfab;var ui=function(){function e(t,r){y(this,e),this._main=r._main,this._ctrlGui=r,this._menu=null,this._parent=t,this.init(t)}return M(e,[{key:"init",value:function(e){var t=this._menu=e.addMenu(B("fileTitle"));t.addTitle(B("fileImportTitle")),t.addButton(B("fileAdd"),this,"addFile"),t.addCheckbox(B("fileAutoMatrix"),this._main,"_autoMatrix"),t.addCheckbox(B("fileVertexSRGB"),this._main,"_vertexSRGB"),t.addTitle(B("fileExportSceneTitle")),t.addButton(B("fileExportSGL"),this,"saveFileAsSGL"),t.addButton(B("fileExportOBJ"),this,"saveFileAsOBJ"),t.addButton(B("sketchfabTitle"),this,"exportSketchfab"),t.addTitle(B("fileExportMeshTitle")),t.addButton(B("fileExportPLY"),this,"saveFileAsPLY"),t.addButton(B("fileExportSTL"),this,"saveFileAsSTL")}},{key:"addFile",value:function(){document.getElementById("fileopen").click()}},{key:"saveFileAsSGL",value:function(){if(0!==this._main.getMeshes().length){var e=li.exportSGL(this._main.getMeshes(),this._main);ei(e,"yourMesh.sgl")}}},{key:"saveFileAsOBJ",value:function(e){var t=this._main.getMeshes();if(0!==t.length&&(!e||(t=this._main.getSelectedMeshes(),t[0]))){var r=li.exportOBJ(t);ei(r,"yourMesh.obj")}}},{key:"saveFileAsPLY",value:function(){var e=this._main.getMesh();if(e){var t=li.exportBinaryPLY(e);ei(t,"yourMesh.ply")}}},{key:"saveFileAsSTL",value:function(){var e=this._main.getMesh();if(e){var t=li.exportBinarySTL(e);ei(t,"yourMesh.stl")}}},{key:"exportSketchfab",value:function(){var e=this._main.getMesh();if(e){var t=this._ctrlGui.getWidgetNotification();if(this._sketchfabXhr&&t.sketchfab===!0){if(!window.confirm(B("sketchfabAbort")))return;t.sketchfab=!1,this._sketchfabXhr.abort()}var r=window.prompt(B("sketchfabUploadMessage"),"guest");if(r){var i="guest"===r?"babc9a5cd4f343f9be0c7bd9cf93600c":r;this._sketchfabXhr=li.exportSketchfab(this._main,i,t)}}}},{key:"onKeyDown",value:function(e){if(e.handled!==!0){e.stopPropagation(),this._main._focusGui||e.preventDefault();var t=e.which;e.ctrlKey&&e.altKey&&78===t?(this._main.clearScene(),e.handled=!0):!e.ctrlKey||79!==t&&73!==t?e.ctrlKey&&69===t&&(this.saveFileAsOBJ(e.altKey),e.handled=!0):(this.addFile(),e.handled=!0)}}}]),e}(),hi=function(){function e(t,r){y(this,e),this._main=r._main,this.domVerts=null,this.domFaces=null,this.domUl=null,this.init(t)}return M(e,[{key:"init",value:function(e){this.domVerts=document.createElement("ul"),this.domVerts.innerHTML=B("meshNbVertices"),this.domFaces=document.createElement("ul"),this.domFaces.innerHTML=B("meshNbFaces"),this.domUl=document.createElement("span"),this.domUl.appendChild(this.domVerts),this.domUl.appendChild(this.domFaces);var t=this.domUl.style;t.cursor="default",void 0===t.float?t.cssFloat="right":t.float="right",e.domTopbar.appendChild(this.domUl)}},{key:"updateMeshInfo",value:function(){var e=this._main.getMesh();this.domVerts.innerHTML=B("meshNbVertices")+(e?e.getNbVertices():0),this.domFaces.innerHTML=B("meshNbFaces")+(e?e.getNbFaces():0)}}]),e}(),ci=function(e){function t(e,r){y(this,t);var i=b(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return i.setID(e.getID()),i.setMeshData(r?e.getMeshData():Ze()),i.setRenderData(e.getRenderData()),i.setTransformData(e.getTransformData()),i._detailsXYZ=null,i._detailsRGB=null,i._detailsPBR=null,i._vertMapping=null,i._evenMapping=!1,i}return S(t,e),M(t,[{key:"optimize",value:function(){}},{key:"getEvenMapping",value:function(){return this._evenMapping}},{key:"getVerticesMapping",value:function(){return this._vertMapping}},{key:"setVerticesMapping",value:function(e){this._vertMapping=e}},{key:"setEvenMapping",value:function(e){this._evenMapping=e}},{key:"higherSynthesis",value:function(e){e.computePartialSubdivision(this.getVertices(),this.getColors(),this.getMaterials(),this.getNbVertices()),this.applyDetails()}},{key:"lowerAnalysis",value:function(e){this.copyDataFromHigherRes(e);var t=e.getNbVertices(),r=new Float32Array(3*t),i=new Float32Array(3*t),a=new Float32Array(3*t);this.computePartialSubdivision(r,i,a,t),e.computeDetails(r,i,a,t)}},{key:"copyDataFromHigherRes",value:function(e){var t=this.getVertices(),r=this.getColors(),i=this.getMaterials(),a=this.getNbVertices(),n=e.getVertices(),s=e.getColors(),o=e.getMaterials();if(this.getEvenMapping()===!1)t.set(n.subarray(0,3*a)),r.set(s.subarray(0,3*a)),i.set(o.subarray(0,3*a));else for(var l=this.getVerticesMapping(),u=0;u<a;++u){var h=3*u,c=3*l[u];t[h]=n[c],t[h+1]=n[c+1],t[h+2]=n[c+2],r[h]=s[c],r[h+1]=s[c+1],r[h+2]=s[c+2],i[h]=o[c],i[h+1]=o[c+1],i[h+2]=o[c+2]}}},{key:"computePartialSubdivision",value:function(e,t,r,i){var a=this.getVerticesMapping();if(!a)return void Ar.partialSubdivision(this,e,t,r);var n=new Float32Array(3*i),s=new Float32Array(3*i),o=new Float32Array(3*i);Ar.partialSubdivision(this,n,s,o);var l=this.getEvenMapping()===!0?0:this.getNbVertices();l>0&&(e.set(n.subarray(0,3*l)),t.set(s.subarray(0,3*l)),r.set(o.subarray(0,3*l)));for(var u=l;u<i;++u){var h=3*u,c=3*a[u];e[c]=n[h],e[c+1]=n[h+1],e[c+2]=n[h+2],t[c]=s[h],t[c+1]=s[h+1],t[c+2]=s[h+2],r[c]=o[h],r[c+1]=o[h+1],r[c+2]=o[h+2]}}},{key:"applyDetails",value:function(){var e=this.getVerticesRingVertStartCount(),t=this.getVerticesRingVert(),r=this.getVertices(),i=this.getNormals(),a=this.getColors(),s=this.getMaterials(),o=this.getNbVertices(),l=new Float32Array(n.getMemory(3*o*4),0,3*o);l.set(r.subarray(0,3*o));for(var u=this._detailsXYZ,h=this._detailsRGB,c=this._detailsPBR,d=Math.min,g=Math.max,f=0;f<o;++f){var v=3*f;a[v]=d(1,g(0,a[v]+h[v])),a[v+1]=d(1,g(0,a[v+1]+h[v+1])),a[v+2]=d(1,g(0,a[v+2]+h[v+2])),s[v]=d(1,g(0,s[v]+c[v])),s[v+1]=d(1,g(0,s[v+1]+c[v+1])),s[v+2]=d(1,g(0,s[v+2]+c[v+2]));var m=l[v],p=l[v+1],_=l[v+2],y=i[v],M=i[v+1],T=i[v+2],S=y*y+M*M+T*T;if(0!==S){S=1/Math.sqrt(S),y*=S,M*=S,T*=S;var b=3*t[e[2*f]],A=l[b]-m,x=l[b+1]-p,k=l[b+2]-_;if(S=A*y+x*M+k*T,A-=y*S,x-=M*S,k-=T*S,S=A*A+x*x+k*k,0!==S){S=1/Math.sqrt(S),A*=S,x*=S,k*=S;var w=M*k-T*x,E=T*A-y*k,R=y*x-M*A,F=u[v],D=u[v+1],I=u[v+2];r[v]=m+y*F+A*D+w*I,r[v+1]=p+M*F+x*D+E*I,r[v+2]=_+T*F+k*D+R*I}}}}},{key:"computeDetails",value:function(e,t,r,i){for(var a=this.getVerticesRingVertStartCount(),n=this.getVerticesRingVert(),s=this.getVertices(),o=this.getNormals(),l=this.getColors(),u=this.getMaterials(),h=this.getNbVertices(),c=this._detailsXYZ=new Float32Array(3*i),d=this._detailsRGB=new Float32Array(3*i),g=this._detailsPBR=new Float32Array(3*i),f=0;f<h;++f){var v=3*f;d[v]=l[v]-t[v],d[v+1]=l[v+1]-t[v+1],d[v+2]=l[v+2]-t[v+2],g[v]=u[v]-r[v],g[v+1]=u[v+1]-r[v+1],g[v+2]=u[v+2]-r[v+2];var m=o[v],p=o[v+1],_=o[v+2],y=m*m+p*p+_*_;if(0!==y){y=1/Math.sqrt(y),m*=y,p*=y,_*=y;var M=3*n[a[2*f]],T=e[M]-e[v],S=e[M+1]-e[v+1],b=e[M+2]-e[v+2];if(y=T*m+S*p+b*_,T-=m*y,S-=p*y,b-=_*y,y=T*T+S*S+b*b,0!==y){y=1/Math.sqrt(y),T*=y,S*=y,b*=y;var A=p*b-_*S,x=_*T-m*b,k=m*S-p*T,w=s[v]-e[v],E=s[v+1]-e[v+1],R=s[v+2]-e[v+2];c[v]=m*w+p*E+_*R,c[v+1]=T*w+S*E+b*R,c[v+2]=A*w+x*E+k*R}}}}}]),t}(Ye),di={},gi=function(e){for(var t=e.getNbVertices(),r=e.getFaces(),i=e.getVerticesOnEdge(),a=e.getVerticesRingVertStartCount(),s=e.getVerticesRingFace(),o=e.getVerticesRingFaceStartCount(),l=new Int8Array(t),u=0;u<t;++u){for(var h=2*u,c=a[h+1],d=o[h],g=o[h+1],f=i[u],v=0,m=d,p=d+g;m<p;++m)v+=r[4*s[m]+3]===n.TRI_INDEX?0:1;0===v?(!f&&6!==c||f&&4!==c)&&(l[u]=1):v===g?(!f&&4!==c||f&&3!==c)&&(l[u]=1):(f||5!==c)&&(l[u]=1)}return l},fi=function(e,t,r){var i=0,a=e.getNbVertices();for(i=0;i<a;++i)if(0===t[i]&&1===r[i])return i;var n=e.getVerticesOnEdge();for(i=0;i<a&&(0!==t[i]||1===n[i]);++i);if(i===a)return-1;for(i=0;i<a;++i)if(0===t[i])return i;return-1},vi=function(e,t,r){var i=++n.TAG_FLAG,a=e.getVerticesTagFlags(),s=e.getVerticesRingVertStartCount(),o=e.getVerticesRingVert(),l=e.getVerticesOnEdge(),u=fi(e,r,t);if(u<0)return!1;r[u]=1;var h=new Uint32Array(n.getMemory(4*e.getNbVertices()),0,e.getNbVertices());h[0]=u;for(var c=1;c>0;){var d=h[--c],g=s[2*d],f=g+s[2*d+1],v=0,m=++i;for(v=g;v<f;++v){var p=o[v];if(a[p]=m,1===r[p])return n.TAG_FLAG=i,!1;r[p]=-1,a[p]=m}for(m=++i,v=g;v<f;++v){var _=o[v];if(0!==t[_]&&!l[_])return n.TAG_FLAG=i,!1;for(var y=s[2*_],M=y+s[2*_+1],T=y;T<M;++T){var S=o[T];if(S!==d&&!(a[S]>=m-1)&&(a[S]=m,0===r[S])){for(var b=s[2*S],A=b+s[2*S+1],x=0,k=b;k<A;++k)a[o[k]]===m-1&&x++;2===x?r[S]=-1:(r[S]=1,h[c++]=S)}}}}return n.TAG_FLAG=i,!0},mi=function(e,t){for(var r=e.getNbVertices(),i=gi(e),a=!0;a;){if(!vi(e,i,t))return!1;a=!1;for(var n=0;n<r;++n)if(0===t[n]){a=!0;break}}return!0},pi=function(e,t,r,i){var a=e.getFaceEdges(),s=e.getFaces(),o=new Int32Array(e.getNbEdges()),l=0,u=e.getNbFaces(),h=0,c=new Uint32Array(e.getNbVertices()),d=new Uint32Array(u);for(l=0;l<u;++l)d[l]=n.TRI_INDEX;for(l=0;l<u;++l){var g=4*l,f=s[g],v=s[g+1],m=s[g+2],p=s[g+3],_=r[f],y=r[v],M=r[m];if(p!==n.TRI_INDEX){var T=0,S=0,b=0;1===_?(T=f,S=m,b=o[a[g+1]]-1,o[a[g+2]]=f+1):1===y?(T=v,S=p,b=o[a[g+2]]-1,o[a[g+3]]=v+1):1===M?(T=m,S=f,b=o[a[g+3]]-1,o[a[g]]=m+1):(T=p,S=v,b=o[a[g]]-1,o[a[g+1]]=p+1);var A=c[S]-1;if(A<0)i[h]=-S-1,d[4*h+3]=T,c[S]=++h;else{var x=4*A;b<0?d[x+2]>=n.TRI_INDEX-1?(d[x+2]=T,d[x]=n.TRI_INDEX-1):d[x]===n.TRI_INDEX?d[x+1]=T:(d[x+1]=d[x+2],d[x+2]=T):d[x+1]===b?d[x]=T:(d[x]=d[x+1],d[x+2]===b?d[x+1]=T:(d[x+1]=d[x+2],d[x+2]=T))}}else{if(_+y+M===-3){i[h++]=l;continue}1===_?o[a[g+1]]=f+1:1===y?o[a[g+2]]=v+1:1===M&&(o[a[g]]=m+1)}}for(u/=4,l=0;l<u;++l){var k=i[l],w=4*l;if(k<0){var E=n.TRI_INDEX-1;if(d[w]>=E||d[w+1]>=n.TRI_INDEX||d[w+2]>=n.TRI_INDEX)return!1}else{var R=4*k;d[w]=o[a[R]]-1,d[w+1]=o[a[R+1]]-1,d[w+2]=o[a[R+2]]-1}}return t.setFaces(d),!0},_i=function(e,t,r){var i=0,a=new Uint32Array(e.getNbVertices());t.setVerticesMapping(a);var s=t.getFaces(),o=new Int32Array(e.getNbVertices()),l=0,u=4*t.getNbFaces();for(l=0;l<u;++l){var h=s[l];if(h!==n.TRI_INDEX){var c=o[h]-1;c===-1&&(c=i++,o[h]=c+1,a[c]=h),s[l]=c}}t.setVertices(new Float32Array(3*i));var d=e.getFaces(),g=e.getVerticesRingFace(),f=e.getVerticesRingFaceStartCount(),v=new Uint8Array(e.getNbVertices());for(u/=4,l=0;l<u;++l){var m,p,_,y,M,T,S,b,A,x,k=r[l];if(k>=0){var w=4*k;m=d[w+1],p=d[w+2],_=d[w],y=n.TRI_INDEX,M=n.TRI_INDEX}else{M=-k-1;for(var E=4*l,R=a[s[E]],F=a[s[E+1]],D=a[s[E+2]],I=a[s[E+3]],C=f[2*M],N=C+4,V=C;V<N;++V){var P=4*g[V],L=d[P],U=d[P+1],B=d[P+2],O=d[P+3];L===R?m=U:U===R?m=B:B===R?m=O:O===R&&(m=L),L===F?p=U:U===F?p=B:B===F?p=O:O===F&&(p=L),L===D?_=U:U===D?_=B:B===D?_=O:O===D&&(_=L),L===I?y=U:U===I?y=B:B===I?y=O:O===I&&(y=L)}}T=v[m],S=v[p],b=v[_],A=y!==n.TRI_INDEX?v[y]:-1,x=M!==n.TRI_INDEX?v[M]:-1,0===T&&(v[m]=1,a[i++]=m),0===S&&(v[p]=1,a[i++]=p),0===b&&(v[_]=1,a[i++]=_),0===A&&(v[y]=1,a[i++]=y),0===x&&(v[M]=1,a[i++]=M)}},yi=function(e,t){var r=e.getVertices(),i=e.getColors(),a=e.getMaterials(),s=t.getVertices(),o=new Float32Array(s.length),l=new Float32Array(s.length);t.setColors(o),t.setMaterials(l);var u=t.getVerticesMapping(),h=0,c=t.getNbVertices();for(h=0;h<c&&!(u[h]>=c);++h);if(h===c){var d=t.getFaces(),g=d.length;for(h=0;h<g;++h){var f=d[h];f!==n.TRI_INDEX&&(d[h]=u[f])}for(h=0;h<c;++h)u[h]=h;s.set(r.subarray(0,3*c)),o.set(i.subarray(0,3*c)),l.set(a.subarray(0,3*c))}else for(t.setEvenMapping(!0),h=0;h<c;++h){var v=3*h,m=3*u[h];s[v]=r[m],s[v+1]=r[m+1],s[v+2]=r[m+2],o[v]=i[m],o[v+1]=i[m+1],o[v+2]=i[m+2],l[v]=a[m],l[v+1]=a[m+1],l[v+2]=a[m+2]}},Mi=function(e,t,r,i){for(var a=e.getFaces(),s=e.getFacesTexCoord(),o=e.getVerticesRingFaceStartCount(),l=e.getVerticesRingFace(),u=e.getVerticesDuplicateStartCount(),h=t.getFaces(),c=new Uint32Array(h),d=t.getVerticesMapping(),g=0,f=h.length;g<f;++g){var v=h[g];if(v!==n.TRI_INDEX){var m=d[v];if(0!==u[2*m]){var p=g%4,_=r[(g-p)/4],y=n.TRI_INDEX;if(_>=0){var M,T,S=4*_;0===p?(M=a[S+1],T=a[S]):1===p?(M=a[S+2],T=a[S+1]):(M=a[S],T=a[S+2]);for(var b=o[2*m],A=b+o[2*m+1],x=b;x<A;++x){var k=4*l[x],w=a[k],E=a[k+1],R=a[k+2];if(w===M?E===T&&(y=s[k+2]):E===M?R===T&&(y=s[k]):R===M&&w===T&&(y=s[k+1]),y!==n.TRI_INDEX)break}}else{_=-_-1;for(var F=o[2*_],D=F+4,I=F;I<D;++I){var C=4*l[I];if(a[C]===m?y=s[C]:a[C+1]===m?y=s[C+1]:a[C+2]===m?y=s[C+2]:a[C+3]===m&&(y=s[C+3]),y!==n.TRI_INDEX)break}}c[g]=y===m?y:y-i[v]}}}t.setFacesTexCoord(c)},Ti=function(e,t,r){for(var i=e.getVerticesDuplicateStartCount(),a=t.getNbVertices(),s=new Uint32Array(2*a),o=t.getVerticesMapping(),l=e.getTexCoords(),u=new Float32Array(n.getMemory(4*e.getNbTexCoords()*2),0,2*e.getNbTexCoords()),h=new Uint32Array(a),c=a,d=0;d<a;++d){var g=o[d],f=i[2*g];if(u[2*d]=l[2*g],u[2*d+1]=l[2*g+1],0!==f){for(var v=h[d]=f-c,m=i[2*g+1],p=c,_=c+m;p<_;++p)u[2*p]=l[2*(v+p)],u[2*p+1]=l[2*(v+p)+1];s[2*d]=c,s[2*d+1]=m,c+=m}}t.setTexCoords(new Float32Array(u.subarray(0,2*c))),t.setVerticesDuplicateStartCount(s),Mi(e,t,r,h)};di.computeReverse=function(e,t){var r=e.getNbFaces();if(r%4!==0)return!1;var i=new Int8Array(e.getNbVertices());if(!mi(e,i))return!1;var a=new Int32Array(r/4);return!!pi(e,t,i,a)&&(_i(e,t,a),yi(e,t),e.hasUV()&&Ti(e,t,a),t.allocateArrays(),!0)};var Si=function(e){function t(e){y(this,t);var r=b(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));r.setID(e.getID()),r.setRenderData(e.getRenderData()),r.setTransformData(e.getTransformData()),r._meshes=[new ci(e,!0)],r.setSelection(0);var i=e.getGL();return r._indexBuffer=new A(i,i.ELEMENT_ARRAY_BUFFER,i.STATIC_DRAW),r._wireframeBuffer=new A(i,i.ELEMENT_ARRAY_BUFFER,i.STATIC_DRAW),r}return S(t,e),M(t,null,[{key:"NONE",get:function(){return 0}},{key:"SCULPT",get:function(){return 1}},{key:"CAMERA",get:function(){return 2}},{key:"PICKING",get:function(){return 3}}]),M(t,[{key:"getCurrentMesh",value:function(){return this._meshes[this._sel]}},{key:"setSelection",value:function(e){this._sel=e,this.setMeshData(this.getCurrentMesh().getMeshData())}},{key:"addLevel",value:function(){if(this._meshes.length-1!==this._sel)return this.getCurrentMesh();var e=this.getCurrentMesh(),t=new ci(e);return e.setVerticesMapping(void 0),Ar.fullSubdivision(e,t),t.initTopology(),this.pushMesh(t),this.initRender(),t}},{key:"computeReverse",value:function(){if(0!==this._sel)return this.getCurrentMesh();var e=this.getCurrentMesh(),t=new ci(e),r=di.computeReverse(e,t);return r?(t.initTopology(),this.unshiftMesh(t),this.initRender(),t):void 0}},{key:"lowerLevel",value:function(){return 0===this._sel?this._meshes[0]:(this._meshes[this._sel-1].lowerAnalysis(this.getCurrentMesh()),this.setSelection(this._sel-1),this.updateResolution(),this.getCurrentMesh())}},{key:"higherLevel",value:function(){return this._sel===this._meshes.length-1?this.getCurrentMesh():(this._meshes[this._sel+1].higherSynthesis(this.getCurrentMesh()),this.setSelection(this._sel+1),this.updateResolution(),this.getCurrentMesh())}},{key:"updateResolution",value:function(){this.updateGeometry(),this.updateDuplicateColorsAndMaterials(),this.updateBuffers();var e=this._meshes[this.getLowIndexRender()];this._indexBuffer.update(e.getTriangles()),this._wireframeBuffer.update(e.getWireframe())}},{key:"selectResolution",value:function(e){for(;this._sel>e;)this.lowerLevel();for(;this._sel<e;)this.higherLevel()}},{key:"findIndexFromMesh",value:function(e){for(var t=this._meshes,r=0,i=t.length;r<i;++r)if(e===t[r])return r}},{key:"selectMesh",value:function(e){var t=this.findIndexFromMesh(e);this.selectResolution(t)}},{key:"pushMesh",value:function(e){this._meshes.push(e),this.setSelection(this._meshes.length-1),this.updateResolution()}},{key:"unshiftMesh",value:function(e){this._meshes.unshift(e),this.setSelection(1),this.lowerLevel()}},{key:"popMesh",value:function(){this._meshes.pop(),this.setSelection(this._meshes.length-1),this.updateResolution()}},{key:"shiftMesh",value:function(){this._meshes.shift(),this.setSelection(0),this.updateResolution()}},{key:"deleteLower",value:function(){
this._meshes.splice(0,this._sel),this.setSelection(0)}},{key:"deleteHigher",value:function(){this._meshes.splice(this._sel+1)}},{key:"getLowIndexRender",value:function(){for(var e=5e5,t=this._sel;t>=0;){var r=this._meshes[t];if(r.getEvenMapping()===!0)return t===this._sel?t:t+1;if(r.getNbTriangles()<e)return t;--t}return 0}},{key:"_renderLow",value:function(e){var r=this.getRenderData(),i=this._sel,a=this.getIndexBuffer();this.setSelection(this.getLowIndexRender()),r._indexBuffer=this._indexBuffer,T(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"render",this).call(this,e),r._indexBuffer=a,this.setSelection(i)}},{key:"_renderWireframeLow",value:function(e){var r=this.getRenderData(),i=this._sel,a=this.getWireframeBuffer();this.setSelection(this.getLowIndexRender()),r._wireframeBuffer=this._wireframeBuffer,T(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"renderWireframe",this).call(this,e),r._wireframeBuffer=a,this.setSelection(i)}},{key:"_canUseLowRender",value:function(e){return!this.isUsingTexCoords()&&!this.isUsingDrawArrays()&&(t.RENDER_HINT!==t.PICKING&&t.RENDER_HINT!==t.NONE&&((e.getMesh()!==this||t.RENDER_HINT===t.CAMERA)&&this.getLowIndexRender()!==this._sel))}},{key:"render",value:function(e){return this._canUseLowRender(e)?this._renderLow(e):T(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"render",this).call(this,e)}},{key:"renderWireframe",value:function(e){return this._canUseLowRender(e)?this._renderWireframeLow(e):T(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"renderWireframe",this).call(this,e)}}]),t}(Ye);Si.RENDER_HINT=0;var bi=i.vec3,Ai={_mesh:null,_linear:!1,_verticesMap:new Map,_states:null,_center:[0,0,0],_radius2:0,_edgeMax2:0},xi=function(e,t,r,i,a){var s=Ai._mesh,o=s.getVerticesRingVert(),l=s.getVerticesRingFace(),u=s.getFacePosInLeaf(),h=s.getFaceLeaf(),c=s.getFacesStateFlags(),d=s.getFaces(),g=4*e;d[g]=t,d[g+1]=a,d[g+2]=i,d[g+3]=n.TRI_INDEX;var f=h[e],v=f._iFaces;o[a].push(i),o[i].push(a);var m=s.getNbTriangles();l[a].push(e,m),g=4*m,d[g]=a,d[g+1]=r,d[g+2]=i,d[g+3]=n.TRI_INDEX,c[m]=n.STATE_FLAG,h[m]=f,u[m]=v.length,l[i].push(m),n.replaceElement(l[r],e,m),v.push(m),s.addNbFace(1)},ki=function(e){for(var t=Ai._mesh,r=t.getVerticesRingVert(),i=t.getFaces(),a=e.length,s=new Uint32Array(n.getMemory(8*a),0,2*a),o=0,l=Ai._verticesMap,u=0;u<a;++u){var h=e[u],c=4*h,d=i[c],g=i[c+1],f=i[c+2],v=l.get(Math.min(d,g)+"+"+Math.max(d,g)),m=l.get(Math.min(g,f)+"+"+Math.max(g,f)),p=l.get(Math.min(d,f)+"+"+Math.max(d,f)),_=r[d].length,y=r[g].length,M=r[f].length,T=0;if(v?T=m?p?_<y&&_<M?2:y<M?3:1:_<M?2:1:p&&y<M?3:1:m?T=p&&y<_?3:2:p&&(T=3),1===T)xi(h,d,g,f,v);else if(2===T)xi(h,g,f,d,m);else{if(3!==T)continue;xi(h,f,d,g,p)}s[o++]=h,s[o++]=t.getNbTriangles()-1}return new Uint32Array(s.subarray(0,o))},wi=function(e,t,r,i){var a=Ai._mesh,s=a.getVertices(),o=a.getNormals(),l=a.getColors(),u=a.getMaterials(),h=a.getFaces(),c=a.getFacePosInLeaf(),d=a.getFaceLeaf(),g=a.getVerticesRingVert(),f=a.getVerticesRingFace(),v=a.getFacesStateFlags(),m=a.getVerticesStateFlags(),p=Ai._verticesMap,_=Math.min(t,r)+"+"+Math.max(t,r),y=!1,M=p.get(_);void 0===M&&(M=a.getNbVertices(),y=!0,p.set(_,M)),g[i].push(M);var T=4*e;h[T]=t,h[T+1]=M,h[T+2]=i,h[T+3]=n.TRI_INDEX;var S=a.getNbTriangles();T=4*S,h[T]=M,h[T+1]=r,h[T+2]=i,h[T+3]=n.TRI_INDEX,v[S]=n.STATE_FLAG,f[i].push(S),n.replaceElement(f[r],e,S);var b=d[e],A=b._iFaces;if(d[S]=b,c[S]=A.length,A.push(S),!y)return g[M].push(i),f[M].push(e,S),void a.addNbFace(1);var x=3*t,k=s[x],w=s[x+1],E=s[x+2],R=o[x],F=o[x+1],D=o[x+2],I=3*r,C=s[I],N=s[I+1],V=s[I+2],P=o[I],L=o[I+1],U=o[I+2],B=R+P,O=F+L,G=D+U;if(T=3*M,o[T]=.5*B,o[T+1]=.5*O,o[T+2]=.5*G,l[T]=.5*(l[x]+l[I]),l[T+1]=.5*(l[x+1]+l[I+1]),l[T+2]=.5*(l[x+2]+l[I+2]),u[T]=.5*(u[x]+u[I]),u[T+1]=.5*(u[x+1]+u[I+1]),u[T+2]=.5*(u[x+2]+u[I+2]),Ai._linear)s[T]=.5*(k+C),s[T+1]=.5*(w+N),s[T+2]=.5*(E+V);else{var z=R*R+F*F+D*D;0===z?R=1:(z=1/Math.sqrt(z),R*=z,F*=z,D*=z),z=P*P+L*L+U*U,0===z?P=1:(z=1/Math.sqrt(z),P*=z,L*=z,U*=z);var X=R*P+F*L+D*U,W=0;W=X<=-1?Math.PI:X>=1?0:Math.acos(X);var Y=k-C,H=w-N,j=E-V,q=.12*W;q*=Math.sqrt(Y*Y+H*H+j*j),z=B*B+O*O+G*G,z>0&&(q/=Math.sqrt(z)),Y*(R-P)+H*(F-L)+j*(D-U)<0&&(q=-q),s[T]=.5*(k+C)+B*q,s[T+1]=.5*(w+N)+O*q,s[T+2]=.5*(E+V)+G*q}m[M]=n.STATE_FLAG,g[M]=[t,r,i],f[M]=[e,S],n.replaceElement(g[t],r,M),n.replaceElement(g[r],t,M),a.addNbVertice(1),a.addNbFace(1)},Ei=function(){var e=[0,0,0],t=[0,0,0],r=[0,0,0],i=Ae.triangleInsideSphere,a=Ae.pointInsideTriangle;return function(n,s){var o=Ai._mesh,l=o.getVertices(),u=o.getFaces(),h=4*n,c=3*u[h],d=3*u[h+1],g=3*u[h+2];if(e[0]=l[c],e[1]=l[c+1],e[2]=l[c+2],t[0]=l[d],t[1]=l[d+1],t[2]=l[d+2],r[0]=l[g],r[1]=l[g+1],r[2]=l[g+2],s&&!i(Ai._center,Ai._radius2,e,t,r)&&!a(Ai._center,e,t,r))return 0;var f=bi.sqrDist(e,t),v=bi.sqrDist(t,r),m=bi.sqrDist(e,r);return f>v&&f>m?f>Ai._edgeMax2?1:0:v>m?v>Ai._edgeMax2?2:0:m>Ai._edgeMax2?3:0}}(),Ri=function(e,t){for(var r=Ai._mesh.getFaces(),i=e.length,a=0;a<i;++a){var n=e[a],s=t[a];0===s&&(s=Ei(n));var o=4*n;1===s?wi(n,r[o],r[o+1],r[o+2]):2===s?wi(n,r[o+1],r[o+2],r[o]):3===s&&wi(n,r[o+2],r[o],r[o+1])}},Fi=function(e){for(var t=e.length,r=n.getMemory(5*t),i=new Uint32Array(r,0,t),a=new Uint8Array(r,4*t,t),s=0,o=0;o<t;++o){var l=e[o],u=Ei(l,!0);0!==u&&(a[s]=u,i[s++]=l)}return[new Uint32Array(i.subarray(0,s)),new Uint8Array(a.subarray(0,s))]},Di=function(e){var t=Ai._mesh,r=t.getNbVertices(),i=t.getNbTriangles();Ai._verticesMap=new Map;var a=Fi(e),s=a[0],o=a[1];s.length>5&&(s=t.expandsFaces(s,3),o=new Uint8Array(s.length),o.set(a[1])),Ai._states.pushVertices(t.getVerticesFromFaces(s)),Ai._states.pushFaces(s),t.reAllocateArrays(o.length),Ri(s,o);var l=0,u=t.getNbTriangles()-i,h=new Uint32Array(u);for(l=0;l<u;++l)h[l]=i+l;h=t.expandsFaces(h,1),s=h.subarray(u),Ai._states.pushVertices(t.getVerticesFromFaces(s)),Ai._states.pushFaces(s);var c=e,d=e.length;e=new Uint32Array(d+h.length),e.set(c),e.set(h,d);var g=t.getFacesTagFlags(),f=e.length,v=new Uint32Array(n.getMemory(4*f),0,f),m=0,p=++n.TAG_FLAG;for(l=0;l<f;++l){var _=e[l];g[_]!==p&&(g[_]=p,v[m++]=_)}v=new Uint32Array(v.subarray(0,m));for(var y=t.getNbTriangles();h.length>0;)t.reAllocateArrays(h.length),h=ki(h);for(u=t.getNbTriangles()-y,c=v,v=new Uint32Array(m+u),v.set(c),l=0;l<u;++l)v[m+l]=y+l;var M=t.getNbVertices()-r,T=new Uint32Array(M);for(l=0;l<M;++l)T[l]=r+l;if(T=t.expandsVertices(T,1),!Ai._linear){var S=T.subarray(M),b=new Re;b.setToolMesh(t),b.smoothTangent(S,1)}var A=t.getVertices(),x=t.getVerticesSculptFlags(),k=Ai._center,w=k[0],E=k[1],R=k[2],F=n.SCULPT_FLAG;for(M=T.length,l=0;l<M;++l){var D=T[l],I=3*D,C=A[I]-w,N=A[I+1]-E,V=A[I+2]-R;x[D]=C*C+N*N+V*V<Ai._radius2?F:F-1}return v},Ii={};Ii.subdivision=function(e,t,r,i,a,n,s){Ai._mesh=e,Ai._linear=s,bi.copy(Ai._center,r),Ai._radius2=i,Ai._edgeMax2=a,Ai._states=n;for(var o=0;o!==e.getNbTriangles();)o=e.getNbTriangles(),t=Di(t);return t};var Ci={_mesh:null,_states:null,_iTrisToDelete:[],_iVertsToDelete:[],_iVertsDecimated:[]},Ni=function(e,t){return e-t},Vi=function(e,t){var r=Ci._mesh,i=r.getFacesTagFlags(),a=r.getNbTriangles(),s=r.getFacesFromVertices(e),o=t,l=t.length;t=new Uint32Array(l+s.length),t.set(o),t.set(s,l);var u=++n.TAG_FLAG;l=t.length;for(var h=new Uint32Array(n.getMemory(4*l),0,l),c=0,d=0;d<l;++d){var g=t[d];g>=a||i[g]!==u&&(i[g]=u,h[c++]=g)}return new Uint32Array(h.subarray(0,c))},Pi=function(){for(var e=Ci._mesh,t=e.getVerticesTagFlags(),r=e.getNbVertices(),i=++n.TAG_FLAG,a=Ci._iVertsDecimated,s=a.length,o=new Uint32Array(n.getMemory(4*s),0,s),l=0,u=0;u<s;++u){var h=a[u];h>=r||t[h]!==i&&(t[h]=i,o[l++]=h)}return new Uint32Array(o.subarray(0,l))},Li=function(e){var t=Ci._mesh,r=t.getVerticesRingFace(),i=t.getFacesTagFlags(),a=t.getFaces(),s=t.getFacePosInLeaf(),o=t.getFaceLeaf(),l=t.getFacesStateFlags(),u=s[e],h=o[e]._iFaces,c=h[h.length-1];e!==c&&(h[u]=c,s[c]=u),h.pop();var d=t.getNbTriangles()-1;if(d===e)return void t.addNbFace(-1);var g=4*d,f=a[g],v=a[g+1],m=a[g+2];Ci._states.pushVertices([f,v,m]),Ci._states.pushFaces([d]),n.replaceElement(r[f],d,e),n.replaceElement(r[v],d,e),n.replaceElement(r[m],d,e);var p=o[d],_=s[d];p._iFaces[_]=e,o[e]=p,s[e]=_,i[e]=i[d],l[e]=l[d],e*=4,a[e]=f,a[e+1]=v,a[e+2]=m,a[e+3]=n.TRI_INDEX,Ci._iVertsDecimated.push(f,v,m),t.addNbFace(-1)},Ui=function(e){var t=Ci._mesh,r=t.getVerticesRingVert(),i=t.getVerticesRingFace(),a=t.getVertices(),s=t.getNormals(),o=t.getColors(),l=t.getMaterials(),u=t.getFaces(),h=t.getVerticesTagFlags(),c=t.getVerticesStateFlags(),d=t.getVerticesSculptFlags(),g=t.getNbVertices()-1;if(e===g)return void t.addNbVertice(-1);var f=0,v=Ci._states;v.pushVertices([g]);var m=i[g],p=r[g],_=m.length,y=p.length,M=0;for(M=0;M<_;++M)f=m[M],v.pushFaces([f]),f*=4,u[f]===g?u[f]=e:u[f+1]===g?u[f+1]=e:u[f+2]=e;for(M=0;M<y;++M)f=p[M],v.pushVertices([f]),n.replaceElement(r[f],g,e);r[e]=r[g].slice(),i[e]=i[g].slice(),h[e]=h[g],c[e]=c[g],d[e]=d[g];var T=3*g;f=3*e,a[f]=a[T],a[f+1]=a[T+1],a[f+2]=a[T+2],s[f]=s[T],s[f+1]=s[T+1],s[f+2]=s[T+2],o[f]=o[T],o[f+1]=o[T+1],o[f+2]=o[T+2],l[f]=l[T],l[f+1]=l[T+1],l[f+2]=l[T+2],t.addNbVertice(-1)},Bi=function(){var e=Ci._iTrisToDelete;n.tidy(e);var t=e.length,r=0;for(r=t-1;r>=0;--r)Li(e[r]);var i=Ci._iVertsToDelete;n.tidy(i);var a=i.length;for(r=a-1;r>=0;--r)Ui(i[r])},Oi=function(e,t,r,i,a,s,o){var l=Ci._mesh,u=l.getVertices(),h=l.getNormals(),c=l.getColors(),d=l.getMaterials(),g=l.getFaces(),f=l.getVerticesTagFlags(),v=l.getFacesTagFlags(),m=l.getVerticesRingVert(),p=l.getVerticesRingFace(),_=m[r],y=m[i],M=p[r],T=p[i];if(_.length===M.length&&y.length===T.length){var S=m[a],b=m[s],A=p[a],x=p[s];if(S.length===A.length&&b.length===x.length){Ci._iVertsDecimated.push(r,i),Ci._states.pushVertices(_),Ci._states.pushVertices(y),Ci._states.pushFaces(M),Ci._states.pushFaces(T),_.sort(Ni),y.sort(Ni);var k=0;if(n.intersectionArrays(_,y).length>=3)return n.removeElement(M,t),n.removeElement(T,e),A.push(t),x.push(e),k=4*e,g[k]===i?g[k]=s:g[k+1]===i?g[k+1]=s:g[k+2]=s,k=4*t,g[k]===r?g[k]=a:g[k+1]===r?g[k+1]=a:g[k+2]=a,l.computeRingVertices(r),l.computeRingVertices(i),l.computeRingVertices(a),void l.computeRingVertices(s);k=3*r;var w=3*i,E=h[k]+h[w],R=h[k+1]+h[w+1],F=h[k+2]+h[w+2],D=E*E+R*R+F*F;0===D?E=1:(D=1/Math.sqrt(D),E*=D,R*=D,F*=D),h[k]=E,h[k+1]=R,h[k+2]=F,c[k]=.5*(c[k]+c[w]),c[k+1]=.5*(c[k+1]+c[w+1]),c[k+2]=.5*(c[k+2]+c[w+2]),d[k]=.5*(d[k]+d[w]),d[k+1]=.5*(d[k+1]+d[w+1]),d[k+2]=.5*(d[k+2]+d[w+2]),n.removeElement(M,e),n.removeElement(M,t),n.removeElement(T,e),n.removeElement(T,t),n.removeElement(A,e),n.removeElement(x,t);var I=T.length,C=0;for(C=0;C<I;++C){var N=T[C];M.push(N);var V=4*N;g[V]===i?g[V]=r:g[V+1]===i?g[V+1]=r:g[V+2]=r}for(I=y.length,C=0;C<I;++C)_.push(y[C]);l.computeRingVertices(r);var P=0,L=0,U=0,B=_.length;for(C=0;C<B;++C){var O=_[C];l.computeRingVertices(O),O*=3,P+=u[O],L+=u[O+1],U+=u[O+2]}P/=B,L/=B,U/=B;var G=E*(P-u[k])+R*(L-u[k+1])+F*(U-u[k+2]);for(u[k]=P-E*G,u[k+1]=L-R*G,u[k+2]=U-F*G,f[i]=v[e]=v[t]=-1,Ci._iVertsToDelete.push(i),Ci._iTrisToDelete.push(e,t),I=M.length,C=0;C<I;++C)o.push(M[C])}}},Gi=function(e,t,r){if(t!==-1){var i=Ci._mesh.getFaces(),a=4*e,n=i[a],s=i[a+1],o=i[a+2];a=4*t;var l=i[a],u=i[a+1],h=i[a+2];n===l?s===h?Oi(e,t,n,s,o,u,r):Oi(e,t,n,o,s,h,r):n===u?s===l?Oi(e,t,n,s,o,h,r):Oi(e,t,n,o,s,l,r):n===h?s===u?Oi(e,t,n,s,o,l,r):Oi(e,t,n,o,s,u,r):s===l?Oi(e,t,o,s,n,u,r):s===u?Oi(e,t,o,s,n,h,r):Oi(e,t,o,s,n,l,r)}},zi=function(e,t,r){var i=Ci._mesh.getVerticesRingFace(),a=i[t],s=i[r];a.sort(Ni),s.sort(Ni);var o=n.intersectionArrays(a,s);return 2!==o.length?-1:o[0]===e?o[1]:o[0]},Xi={};Xi.decimation=function(e,t,r,i,a,n){Ci._mesh=e,Ci._states=n,Ci._iVertsDecimated.length=0,Ci._iTrisToDelete.length=0,Ci._iVertsToDelete.length=0;var s=Math.sqrt(i),o=e.getFacesTagFlags(),l=e.getVertices(),u=e.getFaces(),h=r[0],c=r[1],d=r[2],g=0,f=t.length,v=new Array(f);for(g=0;g<f;++g)v[g]=t[g];for(g=0;g<v.length;++g){var m=v[g];if(!(o[m]<0)){var p=4*m,_=u[p],y=u[p+1],M=u[p+2];p=3*_;var T=l[p],S=l[p+1],b=l[p+2];p=3*y;var A=l[p],x=l[p+1],k=l[p+2];p=3*M;var w=l[p],E=l[p+1],R=l[p+2],F=(T+A+w)/3-h,D=(S+x+E)/3-c,I=(b+k+R)/3-d,C=F*F+D*D+I*I;if(C<i)C=1;else{if(!(C<2*i))continue;C=(Math.sqrt(C)-s)/(s*Math.SQRT2-s);var N=C*C;C=3*N*N-4*N*C+1}F=A-T,D=x-S,I=k-b;var V=F*F+D*D+I*I;F=A-w,D=x-E,I=k-R;var P=F*F+D*D+I*I;F=T-w,D=S-E,I=b-R;var L=F*F+D*D+I*I;V<P&&V<L?V<a*C&&Gi(m,zi(m,_,y),v):P<L?P<a*C&&Gi(m,zi(m,y,M),v):L<a*C&&Gi(m,zi(m,_,M),v)}}return Bi(),t=Vi(Pi(),v)};var Wi=function(e){function t(e){y(this,t);var r=b(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return r.setID(e.getID()),r._meshData=Ze(),r.setRenderData(e.getRenderData()),r.setTransformData(e.getTransformData()),r._facesStateFlags=null,r._wireframe=null,r.init(e),e.isUsingTexCoords()&&r.setShaderType(o.Shader.MATCAP),r.initRender(),r.isDynamic=!0,r}return S(t,e),M(t,[{key:"subdivide",value:function(e,r,i,a,n){return Ii.subdivision(this,e,r,i,a,n,t.LINEAR)}},{key:"decimate",value:function(e,t,r,i,a){return Xi.decimation(this,e,t,r,i,a)}},{key:"getSubdivisionFactor",value:function(){return.01*t.SUBDIVISION_FACTOR}},{key:"getDecimationFactor",value:function(){return.01*t.DECIMATION_FACTOR}},{key:"getVerticesProxy",value:function(){return this.getVertices()}},{key:"addNbVertice",value:function(e){this._meshData._nbVertices+=e}},{key:"getNbTriangles",value:function(){return this.getNbFaces()}},{key:"addNbFace",value:function(e){this._meshData._nbFaces+=e}},{key:"getNbEdges",value:function(){return 3*this.getNbTriangles()}},{key:"getFacesStateFlags",value:function(){return this._facesStateFlags}},{key:"init",value:function(e){this._meshData._vertRingVert=[],this._meshData._vertRingFace=[];var t=e.getNbVertices();this.setVertices(new Float32Array(e.getVertices().subarray(0,3*t))),this.setColors(new Float32Array(e.getColors().subarray(0,3*t))),this.setMaterials(new Float32Array(e.getMaterials().subarray(0,3*t))),this.setFaces(new Uint32Array(4*e.getNbTriangles())),this.setNbFaces(e.getNbTriangles()),this.setNbVertices(t),this.allocateArrays(),this.initTriangles(e),this.initVerticesTopology(e),this.updateFacesAabbAndNormal(),this.updateVerticesNormal(),this.updateOctree()}},{key:"updateTopology",value:function(e,t){this.updateRenderTriangles(e),this.updateVerticesOnEdge(t),this.getShowWireframe()&&this.updateWireframe(e),this.isUsingDrawArrays()&&this.updateDrawArrays(e)}},{key:"getWireframe",value:function(){return this._wireframe||(this._wireframe=new Uint32Array(2*this.getTriangles().length),this.updateWireframe()),this._wireframe}},{key:"setShowWireframe",value:function(e){this._wireframe=null,T(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"setShowWireframe",this).call(this,e)}},{key:"updateWireframe",value:function(e){for(var t=this._wireframe,r=this.getTriangles(),i=void 0===e,a=this.isUsingDrawArrays(),n=i?this.getNbTriangles():e.length,s=0;s<n;++s){var o=i?s:e[s],l=6*o,u=3*o;a?(t[l]=t[l+5]=u,t[l+1]=t[l+2]=u+2,t[l+3]=t[l+4]=u+1):(t[l]=t[l+5]=r[u],t[l+1]=t[l+2]=r[u+1],t[l+3]=t[l+4]=r[u+2])}}},{key:"updateRenderTriangles",value:function(e){for(var t=this.getTriangles(),r=this.getFaces(),i=void 0===e,a=i?this.getNbFaces():e.length,n=0;n<a;++n){var s=i?n:e[n],o=3*s,l=4*s;t[o]=r[l],t[o+1]=r[l+1],t[o+2]=r[l+2]}}},{key:"updateVerticesOnEdge",value:function(e){for(var t=this.getVerticesOnEdge(),r=this.getVerticesRingVert(),i=this.getVerticesRingFace(),a=void 0===e,n=a?this.getNbVertices():e.length,s=0;s<n;++s){var o=a?s:e[s];t[o]=r[o].length!==i[o].length?1:0}}},{key:"resizeArray",value:function(e,t){if(!e)return null;if(e.length>=t)return e.subarray(0,2*t);var r=new e.constructor(2*t);return r.set(e),r}},{key:"reAllocateArrays",value:function(e){var t=this._meshData,r=this._facesStateFlags.length,i=this.getNbTriangles(),a=i+e;(r<a||r>4*a)&&(this._facesStateFlags=this.resizeArray(this._facesStateFlags,a),this.getShowWireframe()&&(this._wireframe=this.resizeArray(this._wireframe,6*a)),t._facesABCD=this.resizeArray(t._facesABCD,4*a),t._trianglesABC=this.resizeArray(t._trianglesABC,3*a),t._faceBoxes=this.resizeArray(t._faceBoxes,6*a),t._faceNormalsXYZ=this.resizeArray(t._faceNormalsXYZ,3*a),t._faceCentersXYZ=this.resizeArray(t._faceCentersXYZ,3*a),t._facesTagFlags=this.resizeArray(t._facesTagFlags,a),t._facePosInLeaf=this.resizeArray(t._facePosInLeaf,a)),r=t._verticesXYZ.length/3;var n=this.getNbVertices();if(a=n+e,(r<a||r>4*a)&&(t._verticesXYZ=this.resizeArray(t._verticesXYZ,3*a),t._normalsXYZ=this.resizeArray(t._normalsXYZ,3*a),t._colorsRGB=this.resizeArray(t._colorsRGB,3*a),t._materialsPBR=this.resizeArray(t._materialsPBR,3*a),t._vertOnEdge=this.resizeArray(t._vertOnEdge,a),t._vertTagFlags=this.resizeArray(t._vertTagFlags,a),t._vertSculptFlags=this.resizeArray(t._vertSculptFlags,a),t._vertStateFlags=this.resizeArray(t._vertStateFlags,a)),this.isUsingDrawArrays()){var s=10;r=t._verticesXYZ.length/9,a=i+e*s,(r<a||r>4*a)&&(t._verticesXYZ=this.resizeArray(t._verticesXYZ,9*a),t._normalsXYZ=this.resizeArray(t._normalsXYZ,9*a),t._colorsRGB=this.resizeArray(t._colorsRGB,9*a),t._materialsPBR=this.resizeArray(t._materialsPBR,9*a))}}},{key:"initTriangles",value:function(e){var t=e.getTriangles(),r=this.getNbTriangles(),i=this.getFaces();this._meshData._trianglesABC=new Uint32Array(t.subarray(0,3*r)),this._facesStateFlags=new Int32Array(r);for(var a=0;a<r;++a){var s=3*a,o=4*a;i[o]=t[s],i[o+1]=t[s+1],i[o+2]=t[s+2],i[o+3]=n.TRI_INDEX}}},{key:"initVerticesTopology",value:function(e){var t=this.getVerticesRingVert(),r=this.getVerticesRingFace(),i=0,a=this.getNbVertices();for(t.length=r.length=a,i=0;i<a;++i)t[i]=[],r[i]=[];var n=this.getNbTriangles(),s=this.getTriangles();for(i=0;i<n;++i){var o=3*i;r[s[o]].push(i),r[s[o+1]].push(i),r[s[o+2]].push(i)}for(i=0;i<a;++i)this.computeRingVertices(i);this.getVerticesOnEdge().set(e.getVerticesOnEdge().subarray(0,a))}},{key:"computeRingVertices",value:function(e){var t=++n.TAG_FLAG,r=this.getFaces(),i=this.getVerticesTagFlags(),a=this._meshData._vertRingVert[e],s=this._meshData._vertRingFace[e];a.length=0;for(var o=s.length,l=0;l<o;++l){var u=4*s[l],h=r[u],c=r[u+1];h===e?h=r[u+2]:c===e&&(c=r[u+2]),i[h]!==t&&(i[h]=t,a.push(h)),i[c]!==t&&(i[c]=t,a.push(c))}}}]),t}(Ye);Wi.SUBDIVISION_FACTOR=75,Wi.DECIMATION_FACTOR=0,Wi.LINEAR=!1;var Yi=function(){function e(t,r,i,a){switch(y(this,e),this._main=t,this._multimesh=r,this._mesh=r.getCurrentMesh(),this._type=i,this._sel=r._sel,i){case e.DELETE_LOWER:this._deletedMeshes=r._meshes.slice(0,r._sel);break;case e.DELETE_HIGHER:this._deletedMeshes=r._meshes.slice(r._sel+1),a||(this._vMappingState=this._mesh.getVerticesMapping());break;case e.SUBDIVISION:case e.REVERSION:a||(this._vArState=new Float32Array(this._mesh.getVertices()),this._cArState=new Float32Array(this._mesh.getColors()),this._mArState=new Float32Array(this._mesh.getMaterials()))}}return M(e,null,[{key:"SUBDIVISION",get:function(){return 0}},{key:"REVERSION",get:function(){return 1}},{key:"SELECTION",get:function(){return 2}},{key:"DELETE_LOWER",get:function(){return 3}},{key:"DELETE_HIGHER",get:function(){return 4}}]),M(e,[{key:"isNoop",value:function(){return!1}},{key:"undo",value:function(){var t=this._multimesh;switch(this._type){case e.SELECTION:t.selectMesh(this._mesh);break;case e.DELETE_LOWER:Array.prototype.unshift.apply(t._meshes,this._deletedMeshes);break;case e.DELETE_HIGHER:Array.prototype.push.apply(t._meshes,this._deletedMeshes),this._mesh.setVerticesMapping(this._vMappingState);break;case e.SUBDIVISION:this._mesh.setVertices(new Float32Array(this._vArState)),this._mesh.setColors(new Float32Array(this._cArState)),this._mesh.setMaterials(new Float32Array(this._mArState)),t.popMesh();break;case e.REVERSION:this._mesh.setVertices(new Float32Array(this._vArState)),this._mesh.setColors(new Float32Array(this._cArState)),this._mesh.setMaterials(new Float32Array(this._mArState)),t.shiftMesh()}this._main.setMesh(t)}},{key:"redo",value:function(){var t=this._multimesh;switch(this._type){case e.SELECTION:t.selectMesh(this._mesh);break;case e.DELETE_LOWER:t.deleteLower();break;case e.DELETE_HIGHER:t.deleteHigher();break;case e.SUBDIVISION:t.pushMesh(this._mesh);break;case e.REVERSION:t.unshiftMesh(this._mesh)}this._main.setMesh(t)}},{key:"createRedo",value:function(){return new e(this._main,this._multimesh,this._type,!0)}}]),e}(),Hi=function(){function e(t,r){y(this,e),this._ctrlGui=r,this._main=r._main,this._menu=null,this._ctrlResolution=null,this._ctrlDynamic=null,this.init(t)}return M(e,[{key:"init",value:function(e){var t=this._menu=e.addMenu(B("topologyTitle"));t.close(),t.addTitle(B("multiresTitle")),this._ctrlResolution=t.addSlider(B("multiresResolution"),1,this.onResolutionChanged.bind(this),1,1,1);var r=t.addDualButton(B("multiresReverse"),B("multiresSubdivide"),this,this,"reverse","subdivide");this._ctrlReverse=r[0],this._ctrlSubdivide=r[1],r=this._dualButtonDel=t.addDualButton(B("multiresDelLower"),B("multiresDelHigher"),this,this,"deleteLower","deleteHigher"),this._ctrlDelLower=r[0],this._ctrlDelHigher=r[1],this._ctrlDelLower.domButton.style.background=this._ctrlDelHigher.domButton.style.background="rgba(230,53,59,0.35)",t.addTitle(B("remeshTitle")),t.addSlider(B("remeshResolution"),yt,"RESOLUTION",8,400,1),t.addCheckbox(B("remeshBlock"),yt,"BLOCK"),t.addButton(B("remeshRemesh"),this,"remesh"),t.addTitle(B("dynamicTitle")),this._ctrlDynamic=t.addCheckbox(B("dynamicActivated"),!1,this.dynamicToggleActivate.bind(this)),this._ctrlDynSubd=t.addSlider(B("dynamicSubdivision"),Wi,"SUBDIVISION_FACTOR",0,100,1),this._ctrlDynDec=t.addSlider(B("dynamicDecimation"),Wi,"DECIMATION_FACTOR",0,100,1),this._ctrlDynLin=t.addCheckbox(B("dynamicLinear"),Wi,"LINEAR"),this.updateDynamicVisibility(!1)}},{key:"updateDynamicVisibility",value:function(e){this._ctrlDynSubd.setVisibility(e),this._ctrlDynDec.setVisibility(e),this._ctrlDynLin.setVisibility(e)}},{key:"dynamicToggleActivate",value:function(){var e=this._main,t=e.getMesh();if(t){var r=t.isDynamic?this.convertToStaticMesh(t):new Wi(t);this.updateDynamicVisibility(!t.isDynamic),e.replaceMesh(t,r),e.getStateManager().pushStateAddRemove(r,t)}}},{key:"remesh",value:function(){var e=this._main,t=e.getMesh();if(t){for(var r=e.getMeshes(),i=e.getSelectedMeshes().slice(),a=0,n=i.length;a<n;++a){var s=i[a];r.splice(e.getIndexMesh(s),1),i[a]=this.convertToStaticMesh(s),s===t&&(t=i[a])}var o=yt.remesh(i,t);e.getStateManager().pushStateAddRemove(o,e.getSelectedMeshes().slice()),e.getMeshes().push(o),e.setMesh(o)}}},{key:"isMultimesh",value:function(e){return!(!e||!e._meshes)}},{key:"convertToStaticMesh",value:function(e){if(!e.isDynamic)return e;var t=new Qe(e.getGL());return t.setID(e.getID()),t.setTransformData(e.getTransformData()),t.setVertices(e.getVertices().subarray(0,3*e.getNbVertices())),t.setColors(e.getColors().subarray(0,3*e.getNbVertices())),t.setMaterials(e.getMaterials().subarray(0,3*e.getNbVertices())),t.setFaces(e.getFaces().subarray(0,4*e.getNbFaces())),t.init(),t.setRenderData(e.getRenderData()),t.initRender(),t}},{key:"convertToMultimesh",value:function(e){if(this.isMultimesh(e))return e;var t=new Si(this.convertToStaticMesh(e));return t}},{key:"subdivide",value:function(){var e=this._main,t=e.getMesh();if(t){var r=this.convertToMultimesh(t);return r._sel!==r._meshes.length-1?void window.alert(B("multiresSelectHighest")):void(r.getNbTriangles()>4e5&&!window.confirm(B("multiresWarnBigMesh",4*r.getNbFaces()))||(t!==r&&(e.replaceMesh(t,r),e.getStateManager().pushStateAddRemove(r,t,!0)),e.getStateManager().pushState(new Yi(e,r,Yi.SUBDIVISION)),r.addLevel(),e.setMesh(r),e.render()))}}},{key:"reverse",value:function(){var e=this._main,t=e.getMesh();if(t){var r=this.convertToMultimesh(t);if(0!==r._sel)return void window.alert(B("multiresSelectLowest"));var i=new Yi(e,r,Yi.REVERSION),a=r.computeReverse();if(!a)return void window.alert(B("multiresNotReversible"));t!==r&&(e.replaceMesh(t,r),e.getStateManager().pushStateAddRemove(r,t,!0)),e.getStateManager().pushState(i),e.setMesh(r),e.render()}}},{key:"deleteLower",value:function(){var e=this._main,t=e._mesh;return this.isMultimesh(t)&&0!==t._sel?(e.getStateManager().pushState(new Yi(e,t,Yi.DELETE_LOWER)),t.deleteLower(),void this.updateMeshResolution()):void window.alert(B("multiresNoLower"))}},{key:"deleteHigher",value:function(){var e=this._main,t=e.getMesh();return this.isMultimesh(t)&&t._sel!==t._meshes.length-1?(e.getStateManager().pushState(new Yi(e,t,Yi.DELETE_HIGHER)),t.deleteHigher(),void this.updateMeshResolution()):void window.alert(B("multiresNoHigher"))}},{key:"onResolutionChanged",value:function(e){var t=e-1,r=this._main,i=r.getMesh();if(i){var a=this.isMultimesh(i),n=a&&i._meshes.length-1===t;this._ctrlReverse.setEnable(!a||0===t),this._ctrlSubdivide.setEnable(!a||n),this._ctrlDelLower.setEnable(a&&0!==t),this._ctrlDelHigher.setEnable(a&&!n),a&&i._sel!==t&&(r.getStateManager().pushState(new Yi(r,i,Yi.SELECTION)),i.selectResolution(t),this._ctrlGui.updateMeshInfo(),r.render())}}},{key:"updateMeshResolution",value:function(){var e=this._main.getMesh();return e&&this.isMultimesh(e)?(this._ctrlResolution.setMax(e._meshes.length),void this._ctrlResolution.setValue(e._sel+1)):(this._ctrlResolution.setMax(1),void this._ctrlResolution.setValue(0))}},{key:"updateMesh",value:function(){if(!this._main.getMesh())return void this._menu.setVisibility(!1);this._menu.setVisibility(!0),this.updateMeshResolution();var e=this._main.getMesh().isDynamic;this.updateDynamicVisibility(e),this._ctrlDynamic.setValue(e,!0)}}]),e}(),ji=ne[o.Shader.MERGE],qi=ne[o.Shader.UV],Ki=ne[o.Shader.PBR],Zi=ne[o.Shader.MATCAP],Qi=function(){function e(t,r){y(this,e),this._main=r._main,this._menu=null,this._ctrlFlatShadizfng=null,this._ctrlShowWireframe=null,this._ctrlShaders=null,this._ctrlMatcap=null,this._ctrlUV=null,this.init(t)}return M(e,[{key:"init",value:function(e){var t=this._menu=e.addMenu(B("renderingTitle"));t.close();var r=[];r[o.Shader.MATCAP]=B("renderingMatcap"),r[o.Shader.PBR]=B("renderingPBR"),r[o.Shader.NORMAL]=B("renderingNormal"),r[o.Shader.UV]=B("renderingUV"),t.addTitle(B("renderingShader")),this._ctrlShaders=t.addCombobox("",o.Shader.MATCAP,this.onShaderChanged.bind(this),r),this._ctrlCurvature=t.addSlider(B("renderingCurvature"),20,this.onCurvatureChanged.bind(this),0,100,1),this._ctrlFilmic=t.addCheckbox(B("renderingFilmic"),ji.FILMIC,this.onFilmic.bind(this));for(var i={},a=0,n=Ki.environments,s=n.length;a<s;++a)i[a]=n[a].name;this._ctrlEnvTitle=t.addTitle(B("renderingEnvironment")),this._ctrlEnv=t.addCombobox("",Ki.idEnv,this.onEnvironmentChanged.bind(this),i);for(var l={},u=0,h=Zi.matcaps,c=h.length;u<c;++u)l[u]=h[u].name;this._ctrlMatcapTitle=t.addTitle(B("renderingMaterial")),this._ctrlMatcap=t.addCombobox(B("renderingMatcap"),0,this.onMatcapChanged.bind(this),l),this._ctrlImportMatcap=t.addButton(B("renderingImportMatcap"),this,"importMatcap"),this._ctrlUV=t.addButton(B("renderingImportUV"),this,"importTexture"),this._ctrlExposure=t.addSlider(B("renderingExposure"),20,this.onExposureChanged.bind(this),0,100,1),t.addTitle(B("renderingExtra")),this._ctrlTransparency=t.addSlider(B("renderingTransparency"),0,this.onTransparencyChanged.bind(this),0,100,1),this._ctrlFlatShading=t.addCheckbox(B("renderingFlat"),!1,this.onFlatShading.bind(this)),this._ctrlShowWireframe=t.addCheckbox(B("renderingWireframe"),!1,this.onShowWireframe.bind(this)),Ge.ONLY_DRAW_ARRAYS&&this._ctrlShowWireframe.setVisibility(!1),this.addEvents()}},{key:"onFilmic",value:function(e){ji.FILMIC=e,this._main.render()}},{key:"onCurvatureChanged",value:function(e){this._main.getMesh()&&(this._main.getMesh().setCurvature(e/20),this._main.render())}},{key:"onEnvironmentChanged",value:function(e){Ki.idEnv=e,this._main.render()}},{key:"onExposureChanged",value:function(e){Ki.exposure=e/20,this._main.render()}},{key:"onTransparencyChanged",value:function(e){for(var t=this._main.getSelectedMeshes(),r=0,i=t.length;r<i;++r)t[r].setOpacity(1-e/100);this._main.render()}},{key:"onShaderChanged",value:function(e){for(var t=this._main,r=!1,i=this._main.getSelectedMeshes(),a=0,n=i.length;a<n;++a){var s=i[a];s&&(e!==o.Shader.UV||s.hasUV()?(s.setShaderType(e),t.render()):(r||window.alert("No UV on the mesh."),r=!0),r&&this.updateMesh())}this.updateVisibility()}},{key:"onMatcapChanged",value:function(e){for(var t=this._main.getSelectedMeshes(),r=0,i=t.length;r<i;++r){var a=t[r];a.getShaderType()!==o.Shader.MATCAP&&a.setShaderType(o.Shader.MATCAP),a.setMatcap(e)}this._main.render()}},{key:"onFlatShading",value:function(e){for(var t=this._main.getSelectedMeshes(),r=0,i=t.length;r<i;++r)t[r].setFlatShading(e);this._main.render()}},{key:"onShowWireframe",value:function(e){for(var t=this._main.getSelectedMeshes(),r=0,i=t.length;r<i;++r)t[r].setShowWireframe(e);this._main.render()}},{key:"addEvents",value:function(){var e=this.loadTextureUV.bind(this),t=this.loadMatcap.bind(this);document.getElementById("textureopen").addEventListener("change",e,!1),document.getElementById("matcapopen").addEventListener("change",t,!1),this.removeCallback=function(){document.getElementById("textureopen").removeEventListener("change",e,!1),document.getElementById("matcapopen").removeEventListener("change",t,!1)}}},{key:"removeEvents",value:function(){this.removeCallback&&this.removeCallback()}},{key:"updateMesh",value:function(){var e=this._main.getMesh();return e?(this._menu.setVisibility(!0),this._ctrlShaders.setValue(e.getShaderType(),!0),this._ctrlFlatShading.setValue(e.getFlatShading(),!0),this._ctrlShowWireframe.setValue(e.getShowWireframe(),!0),this._ctrlMatcap.setValue(e.getMatcap(),!0),this._ctrlTransparency.setValue(100-100*e.getOpacity(),!0),this._ctrlCurvature.setValue(20*e.getCurvature(),!0),void this.updateVisibility()):void this._menu.setVisibility(!1)}},{key:"updateVisibility",value:function(){var e=this._main.getMesh();if(e){var t=e.getShaderType();this._ctrlMatcapTitle.setVisibility(t===o.Shader.MATCAP),this._ctrlMatcap.setVisibility(t===o.Shader.MATCAP),this._ctrlImportMatcap.setVisibility(t===o.Shader.MATCAP),this._ctrlExposure.setVisibility(t===o.Shader.PBR),this._ctrlEnvTitle.setVisibility(t===o.Shader.PBR),this._ctrlEnv.setVisibility(t===o.Shader.PBR),this._ctrlUV.setVisibility(t===o.Shader.UV)}}},{key:"getFlatShading",value:function(){return this._ctrlFlatShading.getValue()}},{key:"getWireframe",value:function(){return this._ctrlShowWireframe.getValue()}},{key:"getShaderName",value:function(){return this._ctrlShaders.getValue()}},{key:"importTexture",value:function(){document.getElementById("textureopen").click()}},{key:"loadTextureUV",value:function(e){if(0!==e.target.files.length){var t=e.target.files[0];if(t.type.match("image.*")){var r=new FileReader,i=this._main;r.onload=function(e){qi.texture0=void 0,qi.texPath=e.target.result,i.render()},document.getElementById("textureopen").value="",r.readAsDataURL(t)}}}},{key:"loadMatcap",value:function(e){if(0!==e.target.files.length){var t=e.target.files[0];if(t.type.match("image.*")){var r=new FileReader,i=this._main,a=this._ctrlMatcap;r.onload=function(e){var r=new Image;r.src=e.target.result,r.onload=function(){var e=Zi.matcaps.length;Zi.matcaps.push({name:t.name}),Zi.createTexture(i._gl,r,e);var n={};n[e]=t.name,a.addOptions(n),a.setValue(e),i.render()}},document.getElementById("matcapopen").value="",r.readAsDataURL(t)}}}},{key:"importMatcap",value:function(){document.getElementById("matcapopen").click()}},{key:"onKeyUp",value:function(e){_.getShortKey(e.which)!==o.KeyAction.WIREFRAME||e.ctrlKey||this._ctrlShowWireframe.setValue(!this._ctrlShowWireframe.getValue())}}]),e}(),Ji=function(){function e(t,r){y(this,e),this._main=r._main,this._menu=null,this._hideMeshes=[],this._cbToggleShowHide=this.toggleShowHide.bind(this,!0),this.init(t)}return M(e,[{key:"init",value:function(e){var t=this._menu=e.addMenu(B("sceneTitle"));t.addButton(B("sceneReset"),this._main,"clearScene"),t.addButton(B("sceneAddSphere"),this._main,"addSphere"),t.addButton(B("sceneAddCube"),this._main,"addCube"),t.addButton(B("sceneAddCylinder"),this._main,"addCylinder"),t.addButton(B("sceneAddTorus"),this._main,"addTorus"),t.addTitle(B("sceneSelection")),
this._ctrlIsolate=t.addCheckbox(B("renderingIsolate"),!1,this.showHide.bind(this)),this._ctrlIsolate.setVisibility(!1),this._ctrlMerge=t.addButton(B("sceneMerge"),this,"merge"),this._ctrlMerge.setVisibility(!1),t.addTitle(B("renderingExtra")),t.addCheckbox(B("darkenUnselected"),R.darkenUnselected,this.onDarkenUnselected.bind(this)),t.addCheckbox(B("contourShow"),this._main._showContour,this.onShowContour.bind(this)),t.addCheckbox(B("renderingGrid"),this._main._showGrid,this.onShowGrid.bind(this)),t.addCheckbox(B("renderingSymmetryLine"),R.showSymmetryLine,this.onShowSymmetryLine.bind(this))}},{key:"validatePreview",value:function(){this._main._meshPreview||this._main.addTorus(!0),this._main._meshPreview.setShowWireframe(!1),this._main.addNewMesh(this._main._meshPreview),this._main._meshPreview=null,this.ctrlDiscard.setVisibility(!1),this.ctrlValidate.setVisibility(!1),this._main.render()}},{key:"discardPreview",value:function(){this._main._meshPreview=null,this.ctrlDiscard.setVisibility(!1),this.ctrlValidate.setVisibility(!1),this._main.render()}},{key:"updateTorusRadius",value:function(e){this._main._torusRadius=e,this.updateTorus()}},{key:"updateTorusRadial",value:function(e){this._main._torusRadial=e,this.updateTorus()}},{key:"updateTorusTubular",value:function(e){this._main._torusTubular=e,this.updateTorus()}},{key:"updateTorusWidth",value:function(e){return this._main._torusWidth=e,this._main._torusLength<this._main._torusWidth?void this.ctrlLE.setValue(e):void this.updateTorus()}},{key:"updateTorusLength",value:function(e){return this._main._torusLength=e,this._main._torusLength<this._main._torusWidth?void this.ctrlWI.setValue(e):void this.updateTorus()}},{key:"updateTorus",value:function(){this._main.addTorus(!0),this.ctrlDiscard.setVisibility(!0),this.ctrlValidate.setVisibility(!0),this._main.render()}},{key:"updateMesh",value:function(){var e=this._main.getMeshes().length,t=this._main.getSelectedMeshes().length;this._ctrlIsolate.setVisibility(this._hideMeshes.length>0||e!==t&&t>=1),this._ctrlMerge.setVisibility(t>1)}},{key:"merge",value:function(){var e=this._main,t=e.getSelectedMeshes();if(!(t.length<2)){var r=yt.mergeMeshes(t,e.getMesh()||t[0]);e.removeMeshes(t),e.getStateManager().pushStateAddRemove(r,t.slice()),e.getMeshes().push(r),e.setMesh(r)}}},{key:"toggleShowHide",value:function(e){this._ctrlIsolate.setValue(!this._ctrlIsolate.getValue(),!!e)}},{key:"showHide",value:function(e){e?this.isolate():this.showAll(),this.updateMesh()}},{key:"isolate",value:function(){var e=this._main,t=e.getSelectedMeshes(),r=e.getMeshes();if(r.length===t.length||r.length<2)return void this._ctrlIsolate.setValue(!1,!0);var i=this._hideMeshes;i.length=0;for(var a=0;a<r.length;++a){var n=e.getIndexSelectMesh(r[a]);n<0&&(i.push(r[a]),r.splice(a--,1))}e.getStateManager().pushStateRemove(i.slice()),e.getStateManager().pushStateCustom(this._cbToggleShowHide,this._cbToggleShowHide,!0),e.render()}},{key:"showAll",value:function(){for(var e=this._main,t=e.getMeshes(),r=this._hideMeshes,i=0,a=r.length;i<a;++i)t.push(r[i]);e.getStateManager().pushStateAdd(r.slice()),e.getStateManager().pushStateCustom(this._cbToggleShowHide,this._cbToggleShowHide,!0),r.length=0,e.render()}},{key:"onDarkenUnselected",value:function(e){R.darkenUnselected=e,this._main.render()}},{key:"onShowSymmetryLine",value:function(e){R.showSymmetryLine=e,this._main.render()}},{key:"onShowGrid",value:function(e){var t=this._main;t._showGrid=e,t.render()}},{key:"onShowContour",value:function(e){var t=this._main;t._showContour=e,t.render()}},{key:"onKeyDown",value:function(e){e.handled!==!0&&(e.stopPropagation(),this._main._focusGui||e.preventDefault(),73===e.which&&(this.toggleShowHide(),e.handled=!0))}}]),e}(),$i=i.vec3,ea=i.mat4,ta=[0,0,0],ra=[0,0,0],ia=[0,0,0],aa=ea.create(),na=[0,0,0],sa=[0,0,0],oa=[0,0,0],la=[0,0,0],ua=[0,0,0],ha=function(){function e(t,r){y(this,e),this._mesh=null,this._main=t,this._pickedFace=-1,this._pickedVertices=[],this._interPoint=[0,0,0],this._rLocal2=0,this._rWorld2=0,this._eyeDir=[0,0,0],this._xSym=!!r,this._pickedNormal=[0,0,0],this._alphaOrigin=[0,0,0],this._alphaSide=0,this._alphaLookAt=ea.create(),this._alpha=null}return M(e,null,[{key:"addAlpha",value:function(t,r,i,a){var n={};n._name=a,n._texture=t,n._ratioX=Math.max(1,r/i),n._ratioY=Math.max(1,i/r),n._ratioMax=Math.max(n._ratioX,n._ratioY),n._width=r,n._height=i;for(var s=1;e.ALPHAS[n._name];)n._name=a+s++;return e.ALPHAS[n._name]=n,e.ALPHAS_NAMES[n._name]=n._name,n}}]),M(e,[{key:"setIdAlpha",value:function(t){this._alpha=e.ALPHAS[t]}},{key:"getAlpha",value:function(e,t,r){var i=this._alpha;if(!i||!i._texture)return 1;var a=this._alphaLookAt,n=this._alphaSide,s=i._ratioY*(a[0]*e+a[4]*t+a[8]*r+a[12])/(this._xSym?-n:n);if(Math.abs(s)>1)return 0;var o=i._ratioX*(a[1]*e+a[5]*t+a[9]*r+a[13])/n;if(Math.abs(o)>1)return 0;var l=i._width;return s=(.5-.5*s)*l,o=(.5-.5*o)*i._height,i._texture[(0|s)+l*(0|o)]/255}},{key:"updateAlpha",value:function(e){var t=oa,r=la,i=Math.sqrt(this._rLocal2);if(this._alphaSide=i*Math.SQRT1_2,$i.sub(t,this._interPoint,this._alphaOrigin),0!==$i.len(t)){$i.normalize(t,t);var a=this._pickedNormal;$i.scaleAndAdd(t,t,a,-$i.dot(t,a)),$i.normalize(t,t),e||$i.copy(this._alphaOrigin,this._interPoint),$i.scaleAndAdd(r,this._alphaOrigin,a,i),ea.lookAt(this._alphaLookAt,this._alphaOrigin,r,t)}}},{key:"initAlpha",value:function(){this.computePickedNormal(),this.updateAlpha()}},{key:"getMesh",value:function(){return this._mesh}},{key:"setLocalRadius2",value:function(e){this._rLocal2=e}},{key:"getLocalRadius2",value:function(){return this._rLocal2}},{key:"getLocalRadius",value:function(){return Math.sqrt(this._rLocal2)}},{key:"getWorldRadius2",value:function(){return this._rWorld2}},{key:"getWorldRadius",value:function(){return Math.sqrt(this._rWorld2)}},{key:"setIntersectionPoint",value:function(e){this._interPoint=e}},{key:"getEyeDirection",value:function(){return this._eyeDir}},{key:"getIntersectionPoint",value:function(){return this._interPoint}},{key:"getPickedVertices",value:function(){return this._pickedVertices}},{key:"getPickedFace",value:function(){return this._pickedFace}},{key:"getPickedNormal",value:function(){return this._pickedNormal}},{key:"intersectionMouseMeshes",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._main.getMeshes(),t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this._main._mouseX,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this._main._mouseY,i=this.unproject(t,r,0),a=this.unproject(t,r,.1),n=1/0,s=null,o=-1,l=0,u=e.length;l<u;++l){var h=e[l];if(ea.invert(aa,h.getMatrix()),$i.transformMat4(ra,i,aa),$i.transformMat4(ia,a,aa),this.intersectionRayMesh(h,ra,ia)){var c=this.getIntersectionPoint(),d=$i.dist(ra,c)*h.getScale();d<n&&(n=d,s=h,$i.copy(sa,c),o=this.getPickedFace())}}return this._mesh=s,$i.copy(this._interPoint,sa),this._pickedFace=o,o!==-1&&this.updateLocalAndWorldRadius2(),!!s}},{key:"intersectionMouseMesh",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._main.getMesh(),t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this._main._mouseX,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this._main._mouseY,i=this.unproject(t,r,0),a=this.unproject(t,r,.1),n=ea.create();return ea.invert(n,e.getMatrix()),$i.transformMat4(i,i,n),$i.transformMat4(a,a,n),this.intersectionRayMesh(e,i,a)}},{key:"intersectionRayMesh",value:function(e,t,r){if(this._mesh=null,this._pickedFace=-1,$i.copy(ta,t),$i.copy(ia,r),this._xSym){var i=e.getSymmetryOrigin(),a=e.getSymmetryNormal();Ae.mirrorPoint(ta,i,a),Ae.mirrorPoint(ia,i,a)}var s=e.getVertices(),o=e.getFaces(),l=this.getEyeDirection();$i.sub(l,ia,ta),$i.normalize(l,l);for(var u=e.intersectRay(ta,l),h=1/0,c=u.length,d=0;d<c;++d){var g=4*u[d],f=3*o[g],v=3*o[g+1],m=3*o[g+2];oa[0]=s[f],oa[1]=s[f+1],oa[2]=s[f+2],la[0]=s[v],la[1]=s[v+1],la[2]=s[v+2],ua[0]=s[m],ua[1]=s[m+1],ua[2]=s[m+2];var p=Ae.intersectionRayTriangle(ta,l,oa,la,ua,na);p<0&&(v=o[g+3],v!==n.TRI_INDEX&&(v*=3,la[0]=s[v],la[1]=s[v+1],la[2]=s[v+2],p=Ae.intersectionRayTriangle(ta,l,oa,ua,la,na))),p>=0&&p<h&&(h=p,$i.copy(this._interPoint,na),this._pickedFace=u[d])}return this._pickedFace!==-1?(this._mesh=e,this.updateLocalAndWorldRadius2(),!0):(this._rLocal2=0,!1)}},{key:"pickVerticesInSphere",value:function(e){for(var t=this._mesh,r=t.getVertices(),i=t.getVerticesSculptFlags(),a=this.getIntersectionPoint(),s=t.intersectSphere(a,e,!0),o=t.getVerticesFromFaces(s),l=o.length,u=++n.SCULPT_FLAG,h=new Uint32Array(n.getMemory(4*l),0,l),c=0,d=a[0],g=a[1],f=a[2],v=0;v<l;++v){var m=o[v],p=3*m,_=d-r[p],y=g-r[p+1],M=f-r[p+2];_*_+y*y+M*M<e&&(i[m]=u,h[c++]=m)}return this._pickedVertices=new Uint32Array(h.subarray(0,c)),this._pickedVertices}},{key:"_isInsideSphere",value:function(e,t,r){if(e===n.TRI_INDEX)return!1;var i=3*e;return $i.sqrDist(t,this._mesh.getVertices().subarray(i,i+3))<=r}},{key:"pickVerticesInSphereTopological",value:function(e){var t=this._mesh,r=t.getNbVertices(),i=t.getVertices(),a=t.getFaces(),s=t.getVerticesRingVertStartCount(),o=t.getVerticesRingVert(),l=o instanceof Array?o:null,u=t.getVerticesSculptFlags(),h=t.getVerticesTagFlags(),c=++n.SCULPT_FLAG,d=++n.TAG_FLAG,g=this.getIntersectionPoint(),f=g[0],v=g[1],m=g[2],p=new Uint32Array(n.getMemory(4*r),0,r),_=4*this.getPickedFace(),y=1;this._isInsideSphere(a[_],g,e)?p[0]=a[_]:this._isInsideSphere(a[_+1],g,e)?p[0]=a[_+1]:this._isInsideSphere(a[_+2],g,e)?p[0]=a[_+2]:this._isInsideSphere(a[_+3],g,e)?p[0]=a[_+3]:y=0,1===y&&(u[p[0]]=c,h[p[0]]=d);for(var M=0;M<y;++M){var T,S,b=p[M];l?(o=l[b],T=0,S=o.length):(T=s[2*b],S=T+s[2*b+1]);for(var A=T;A<S;++A){var x=o[A];if(h[x]!==d){h[x]=d;var k=3*x,w=f-i[k],E=v-i[k+1],R=m-i[k+2];w*w+E*E+R*R>e||(u[x]=c,p[y++]=x)}}}return this._pickedVertices=new Uint32Array(p.subarray(0,y)),this._pickedVertices}},{key:"computeWorldRadius2",value:function(e){$i.transformMat4(na,this.getIntersectionPoint(),this._mesh.getMatrix());var t=this._main.getSculptManager().getCurrentTool().getScreenRadius();e||(t*=pe.getPressureRadius());var r=this.project(na);return $i.sqrDist(na,this.unproject(r[0]+t,r[1],r[2]))}},{key:"updateLocalAndWorldRadius2",value:function(){this._mesh&&(this._rWorld2=this.computeWorldRadius2(),this._rLocal2=this._rWorld2/this._mesh.getScale2())}},{key:"unproject",value:function(e,t,r){return this._main.getCamera().unproject(e,t,r)}},{key:"project",value:function(e){return this._main.getCamera().project(e)}},{key:"computePickedNormal",value:function(){if(this._mesh&&!(this._pickedFace<0))return this.polyLerp(this._mesh.getNormals(),this._pickedNormal),$i.normalize(this._pickedNormal,this._pickedNormal)}},{key:"polyLerp",value:function(e,t){var r=this._mesh.getVertices(),i=this._mesh.getFaces(),a=4*this._pickedFace,s=3*i[a],o=3*i[a+1],l=3*i[a+2],u=i[a+3],h=u!==n.TRI_INDEX;h&&(u*=3);var c=1/$i.dist(this._interPoint,r.subarray(s,s+3)),d=1/$i.dist(this._interPoint,r.subarray(o,o+3)),g=1/$i.dist(this._interPoint,r.subarray(l,l+3)),f=h?1/$i.dist(this._interPoint,r.subarray(u,u+3)):0,v=1/(c+d+g+f);return $i.set(t,0,0,0),$i.scaleAndAdd(t,t,e.subarray(s,s+3),c*v),$i.scaleAndAdd(t,t,e.subarray(o,o+3),d*v),$i.scaleAndAdd(t,t,e.subarray(l,l+3),g*v),h&&$i.scaleAndAdd(t,t,e.subarray(u,u+3),f*v),t}}]),e}();ha.INIT_ALPHAS_NAMES=[B("alphaSquare"),B("alphaSkin")],ha.INIT_ALPHAS_PATHS=["square.jpg","skin.jpg"];var ca=B("alphaNone");ha.ALPHAS_NAMES={},ha.ALPHAS_NAMES[ca]=ca,ha.ALPHAS={},ha.ALPHAS[ca]=null;var da=i.vec3,ga={};ga.tools=[];var fa=ga.tools;ga.initGuiTools=function(e,t,r){for(var i=0,a=Sr.length;i<a;++i)if(Sr[i]){var n=fa[i];n||(console.error("No gui for tool index : "+i),ga[i]={_ctrls:[],init:function(){}}),n.init(e.getTool(i),t,r),ga.hide(i)}},ga.hide=function(e){for(var t=0,r=fa[e]._ctrls,i=r.length;t<i;++t)r[t].setVisibility(!1)},ga.show=function(e){for(var t=0,r=fa[e]._ctrls,i=r.length;t<i;++t)r[t].setVisibility(!0)};var va=function(e,t,r){this[e]=t?r/t:r},ma=function(e,t,r,i){var a=t.addSlider(B("sculptRadius"),e._radius,function(t){va.call(e,"_radius",1,t),i.getSculptManager().getSelection().setIsEditMode(!0),i.renderSelectOverRtt()},5,500,1);return r._ctrlRadius=a,a},pa=function(e,t,r){var i=t.addSlider(B("sculptIntensity"),100*e._intensity,va.bind(e,"_intensity",100),0,100,1);return r._ctrlIntensity=i,i},_a=function(e,t){return t.addSlider(B("sculptHardness"),100*e._hardness,va.bind(e,"_hardness",100),0,100,1)},ya=function(e,t){return t.addCheckbox(B("sculptCulling"),e,"_culling")},Ma=function(e,t,r,i){var a=t.addCheckbox(i||B("sculptNegative"),e,"_negative");return r.toggleNegative=function(){a.setValue(!a.getValue())},a},Ta=function(){document.getElementById("alphaopen").click()},Sa=function(e,t,r,i){e.push(t.addTitle(B("sculptAlphaTitle"))),void 0!==r._lockPosition&&e.push(t.addCheckbox(B("sculptLockPositon"),r,"_lockPosition")),i._ctrlAlpha=t.addCombobox(B("sculptAlphaTex"),r,"_idAlpha",ha.ALPHAS_NAMES),e.push(i._ctrlAlpha),e.push(t.addButton(B("sculptImportAlpha"),Ta))};fa[o.Tools.BRUSH]={_ctrls:[],init:function(e,t,r){this._ctrls.push(ma(e,t,this,r)),this._ctrls.push(pa(e,t,this)),this._ctrls.push(Ma(e,t,this)),this._ctrls.push(t.addCheckbox(B("sculptClay"),e,"_clay")),this._ctrls.push(t.addCheckbox(B("sculptAccumulate"),e,"_accumulate")),this._ctrls.push(ya(e,t)),Sa(this._ctrls,t,e,this)}},fa[o.Tools.CREASE]={_ctrls:[],init:function(e,t,r){this._ctrls.push(ma(e,t,this,r)),this._ctrls.push(pa(e,t,this)),this._ctrls.push(Ma(e,t,this)),this._ctrls.push(ya(e,t)),Sa(this._ctrls,t,e,this)}},fa[o.Tools.DRAG]={_ctrls:[],init:function(e,t,r){this._ctrls.push(ma(e,t,this,r)),Sa(this._ctrls,t,e,this)}},fa[o.Tools.FLATTEN]={_ctrls:[],init:function(e,t,r){this._ctrls.push(ma(e,t,this,r)),this._ctrls.push(pa(e,t,this)),this._ctrls.push(Ma(e,t,this)),this._ctrls.push(ya(e,t)),Sa(this._ctrls,t,e,this)}},fa[o.Tools.INFLATE]={_ctrls:[],init:function(e,t,r){this._ctrls.push(ma(e,t,this,r)),this._ctrls.push(pa(e,t,this)),this._ctrls.push(Ma(e,t,this)),this._ctrls.push(ya(e,t)),Sa(this._ctrls,t,e,this)}},fa[o.Tools.PAINT]={_ctrls:[],onMaterialChanged:function(e,t,r){da.copy(t._color,r[0].getValue()),t._material[0]=r[1].getValue()/100,t._material[1]=r[2].getValue()/100;var i=e.getMesh();i&&(i.setAlbedo(t._color),i.setRoughness(t._material[0]),i.setMetallic(t._material[1]),e.render())},resetMaterialOverride:function(e,t){this._ctrlPicker.getValue()!==t._pickColor&&this._ctrlPicker.setValue(t._pickColor);var r=e.getMesh();r&&r.getAlbedo&&(r.getAlbedo()[0]=-1,r.setRoughness(-1),r.setMetallic(-1),e.render())},onPickedMaterial:function(e,t,r,i,a,s){r.setCanvasCursor(n.cursors.dropper),e[0].setValue(i,!0),e[1].setValue(100*a,!0),e[2].setValue(100*s,!0),da.copy(t._color,i),t._material[0]=a,t._material[1]=s},onColorPick:function(e,t,r){e._pickColor=r,t.setCanvasCursor(r?n.cursors.dropper:"default"),t._action=r?o.Action.SCULPT_EDIT:o.Action.NOTHING,t.renderSelectOverRtt()},init:function(e,t,r){this._ctrls.push(ma(e,t,this,r)),this._ctrls.push(pa(e,t,this)),this._ctrls.push(_a(e,t,this)),this._ctrls.push(ya(e,t)),this._ctrls.push(t.addTitle(B("sculptPBRTitle"))),this._ctrls.push(t.addButton(B("sculptPaintAll"),e,"paintAll")),this._ctrlPicker=t.addCheckbox(B("sculptPickColor"),e._pickColor,this.onColorPick.bind(this,e,r)),this._ctrls.push(this._ctrlPicker);var i=[],a=this.onMaterialChanged.bind(this,r,e,i),n=t.addColor(B("sculptColor"),e._color,a),s=t.addSlider(B("sculptRoughness"),100*e._material[0],a,0,100,1),o=t.addSlider(B("sculptMetallic"),100*e._material[1],a,0,100,1);i.push(n,s,o),window.addEventListener("keyup",this.resetMaterialOverride.bind(this,r,e)),window.addEventListener("mouseup",this.resetMaterialOverride.bind(this,r,e)),e.setPickCallback(this.onPickedMaterial.bind(this,i,e,r)),this._ctrls.push(n,s,o),Sa(this._ctrls,t,e,this)}},fa[o.Tools.PINCH]={_ctrls:[],init:function(e,t,r){this._ctrls.push(ma(e,t,this,r)),this._ctrls.push(pa(e,t,this)),this._ctrls.push(Ma(e,t,this)),this._ctrls.push(ya(e,t)),Sa(this._ctrls,t,e,this)}},fa[o.Tools.TWIST]={_ctrls:[],init:function(e,t,r){this._ctrls.push(ma(e,t,this,r)),this._ctrls.push(ya(e,t)),Sa(this._ctrls,t,e,this)}},fa[o.Tools.LOCALSCALE]={_ctrls:[],init:function(e,t,r){this._ctrls.push(ma(e,t,this,r)),this._ctrls.push(ya(e,t)),Sa(this._ctrls,t,e,this)}},fa[o.Tools.MOVE]={_ctrls:[],init:function(e,t,r){this._ctrls.push(ma(e,t,this,r)),this._ctrls.push(pa(e,t,this)),this._ctrls.push(t.addCheckbox(B("sculptTopologicalCheck"),e,"_topoCheck")),this._ctrls.push(Ma(e,t,this,B("sculptMoveAlongNormal"))),Sa(this._ctrls,t,e,this)}},fa[o.Tools.SMOOTH]={_ctrls:[],init:function(e,t,r){this._ctrls.push(ma(e,t,this,r)),this._ctrls.push(pa(e,t,this)),this._ctrls.push(t.addCheckbox(B("sculptTangentialSmoothing"),e,"_tangent")),this._ctrls.push(ya(e,t)),Sa(this._ctrls,t,e,this)}},fa[o.Tools.MASKING]={_ctrls:[],init:function(e,t,r){this._ctrls.push(ma(e,t,this,r)),this._ctrls.push(pa(e,t,this)),this._ctrls.push(_a(e,t,this)),this._ctrls.push(Ma(e,t,this)),this._ctrls.push(ya(e,t)),this._main=r,this._tool=e;var i=t.addDualButton(B("sculptMaskingClear"),B("sculptMaskingInvert"),e,e,"clear","invert"),a=t.addDualButton(B("sculptMaskingBlur"),B("sculptMaskingSharpen"),e,e,"blur","sharpen");this._ctrls.push(i[0],i[1],a[0],a[1]),this._ctrls.push(t.addTitle(B("sculptExtractTitle"))),this._ctrls.push(t.addSlider(B("sculptExtractThickness"),e,"_thickness",-5,5,.001)),this._ctrls.push(t.addButton(B("sculptExtractAction"),e,"extract")),Sa(this._ctrls,t,e,this)}},fa[o.Tools.TRANSFORM]={_ctrls:[],init:function(){}};var ba=ga.tools,Aa=function(){function e(t,r){y(this,e),this._main=r._main,this._ctrlGui=r,this._sculptManager=r._main.getSculptManager(),this._toolOnRelease=-1,this._invertSign=!1,this._modalBrushRadius=!1,this._modalBrushIntensity=!1,this._lastPageX=0,this._lastPageY=0,this._refX=0,this._refY=0,this._menu=null,this._ctrlSculpt=null,this._ctrlSymmetry=null,this._ctrlContinuous=null,this._ctrlTitleCommon=null,this.init(t)}return M(e,[{key:"init",value:function(e){var t=this._menu=e.addMenu(B("sculptTitle"));t.open(),t.addTitle(B("sculptTool"));for(var r=[],i=0,a=Sr.length;i<a;++i)Sr[i]&&(r[i]=B(Sr[i].uiName));this._ctrlSculpt=t.addCombobox(B("sculptTool"),this._sculptManager.getToolIndex(),this.onChangeTool.bind(this),r),ga.initGuiTools(this._sculptManager,this._menu,this._main),this._ctrlTitleCommon=t.addTitle(B("sculptCommon")),this._ctrlSymmetry=t.addCheckbox(B("sculptSymmetry"),this._sculptManager._symmetry,this.onSymmetryChange.bind(this)),this._ctrlContinuous=t.addCheckbox(B("sculptContinuous"),this._sculptManager,"_continuous"),ga.show(this._sculptManager.getToolIndex()),this.addEvents(),this.onChangeTool(this._sculptManager.getToolIndex())}},{key:"onSymmetryChange",value:function(e){this._sculptManager._symmetry=e,this._main.render()}},{key:"addEvents",value:function(){var e=this.loadAlpha.bind(this);document.getElementById("alphaopen").addEventListener("change",e,!1),this.removeCallback=function(){document.getElementById("alphaopen").removeEventListener("change",e,!1)}}},{key:"removeEvents",value:function(){this.removeCallback&&this.removeCallback()}},{key:"getSelectedTool",value:function(){return this._ctrlSculpt.getValue()}},{key:"releaseInvertSign",value:function(){if(this._invertSign){this._invertSign=!1;var e=ba[this.getSelectedTool()];e.toggleNegative&&e.toggleNegative()}}},{key:"onChangeTool",value:function(e){ga.hide(this._sculptManager.getToolIndex()),this._sculptManager.setToolIndex(e),ga.show(e);var t=this._sculptManager.canBeContinuous()===!0;this._ctrlContinuous.setVisibility(t);var r=e!==o.Tools.TRANSFORM;this._ctrlSymmetry.setVisibility(r),this._ctrlTitleCommon.setVisibility(t||r),this._main.getPicking().updateLocalAndWorldRadius2()}},{key:"loadAlpha",value:function(e){if(0!==e.target.files.length){var t=e.target.files[0];if(t.type.match("image.*")){var r=new FileReader,i=this._main,a=ba[this._sculptManager.getToolIndex()];r.onload=function(e){var r=new Image;r.src=e.target.result,r.onload=i.onLoadAlphaImage.bind(i,r,t.name||"new alpha",a)},document.getElementById("alphaopen").value="",r.readAsDataURL(t)}}}},{key:"addAlphaOptions",value:function(e){for(var t=0,r=ba.length;t<r;++t){var i=ba[t];i&&i._ctrlAlpha&&i._ctrlAlpha.addOptions(e)}}},{key:"updateMesh",value:function(){this._menu.setVisibility(!!this._main.getMesh())}},{key:"_startModalBrushRadius",value:function(e,t){this._refX=e,this._refY=t;var r=ba[this.getSelectedTool()];if(r._ctrlRadius){var i=r._ctrlRadius.getValue();this._refX-=i,this._main.getSculptManager().getSelection().setOffsetX(-i*this._main.getPixelRatio()),this._main.renderSelectOverRtt()}}},{key:"_checkModifierKey",value:function(e){var t=this.getSelectedTool();if(this._main._action===o.Action.NOTHING&&(!e.shiftKey||e.altKey||e.ctrlKey||t!==o.Tools.SMOOTH&&(this._toolOnRelease=t,this._ctrlSculpt.setValue(o.Tools.SMOOTH)),!e.ctrlKey||e.shiftKey||e.altKey||t!==o.Tools.MASKING&&(this._toolOnRelease=t,this._ctrlSculpt.setValue(o.Tools.MASKING))),e.altKey){if(this._invertSign||e.shiftKey)return!0;this._invertSign=!0;var r=ba[t];return r.toggleNegative&&r.toggleNegative(),!0}return!1}},{key:"onKeyDown",value:function(e){if(e.handled!==!0){var t=this._main,r=_.getShortKey(e.which);if(e.stopPropagation(),t._focusGui&&r!==o.KeyAction.RADIUS&&r!==o.KeyAction.INTENSITY||e.preventDefault(),e.handled=!0,!this._checkModifierKey(e)&&t._action===o.Action.NOTHING){if(void 0!==r&&Sr[r])return this._ctrlSculpt.setValue(r);var i=ba[this.getSelectedTool()];switch(r){case o.KeyAction.DELETE:t.deleteCurrentSelection();break;case o.KeyAction.INTENSITY:this._modalBrushIntensity=t._focusGui=!0;break;case o.KeyAction.RADIUS:this._modalBrushRadius||this._startModalBrushRadius(this._lastPageX,this._lastPageY),this._modalBrushRadius=t._focusGui=!0;break;case o.KeyAction.NEGATIVE:i.toggleNegative&&i.toggleNegative();break;case o.KeyAction.PICKER:var a=i._ctrlPicker;a&&!a.getValue()&&a.setValue(!0);break;default:e.handled=!1}}}}},{key:"onKeyUp",value:function(e){var t=this._main._action===o.Action.NOTHING&&this._toolOnRelease!==-1&&!e.ctrlKey&&!e.shiftKey;e.altKey&&!t||this.releaseInvertSign(),t&&(this._ctrlSculpt.setValue(this._toolOnRelease),this._toolOnRelease=-1);var r=this._main;switch(_.getShortKey(e.which)){case o.KeyAction.RADIUS:this._modalBrushRadius=r._focusGui=!1;var i=this._main.getSculptManager().getSelection();i.setOffsetX(0),e.pageX=this._lastPageX,e.pageY=this._lastPageY,r.setMousePosition(e),r.getPicking().intersectionMouseMeshes(),r.renderSelectOverRtt();break;case o.KeyAction.PICKER:var a=ba[this.getSelectedTool()],n=a._ctrlPicker;n&&n.getValue()&&n.setValue(!1);break;case o.KeyAction.INTENSITY:this._modalBrushIntensity=r._focusGui=!1}}},{key:"onMouseUp",value:function(e){this._toolOnRelease===-1||e.ctrlKey||e.shiftKey||(this.releaseInvertSign(),this._ctrlSculpt.setValue(this._toolOnRelease),this._toolOnRelease=-1)}},{key:"onMouseMove",value:function(e){var t=ba[this.getSelectedTool()];if(this._modalBrushRadius&&t._ctrlRadius){var r=e.pageX-this._refX,i=e.pageY-this._refY;t._ctrlRadius.setValue(Math.sqrt(r*r+i*i)),this._main.renderSelectOverRtt()}this._modalBrushIntensity&&t._ctrlIntensity&&t._ctrlIntensity.setValue(t._ctrlIntensity.getValue()+e.pageX-this._lastPageX),this._lastPageX=e.pageX,this._lastPageY=e.pageY}},{key:"onMouseOver",value:function(e){this._modalBrushRadius&&this._startModalBrushRadius(e.pageX,e.pageY)}}]),e}(),xa=function(){function e(t,r,i){y(this,e),this._main=t,this._addedMeshes=void 0!==r.length?r:[r],this._removedMeshes=void 0!==i.length?i:[i],this._selectMeshes=t.getSelectedMeshes().slice()}return M(e,[{key:"isNoop",value:function(){return 0===this._addedMeshes.length&&0===this._removedMeshes.length}},{key:"undo",value:function(){var e,t,r=this._main,i=r.getMeshes(),a=this._addedMeshes;for(e=0,t=a.length;e<t;++e)i.splice(r.getIndexMesh(a[e]),1);var n=this._removedMeshes;for(e=0,t=n.length;e<t;++e)i.push(n[e]);for(e=0,t=i.length;e<t;++e)i[e].initRender();var s=this._selectMeshes;r.setMesh(s[0]?s[0]:null);var o=r.getSelectedMeshes();for(o.length=0,e=0,t=s.length;e<t;++e)o.push(s[e])}},{key:"redo",value:function(){this.undo()}},{key:"createRedo",value:function(){return new e(this._main,this._removedMeshes,this._addedMeshes)}}]),e}(),ka=function(){function e(t,r){y(this,e),this._main=t,this._mesh=r,this._idVertState=[],this._cArState=[],this._mArState=[]}return M(e,[{key:"isNoop",value:function(){return 0===this._idVertState.length}},{key:"undo",value:function(){this.pullVertices();var e=this._mesh;e.updateDuplicateColorsAndMaterials(),e.updateDrawArrays(),e.updateColorBuffer(),e.updateMaterialBuffer(),this._main.setMesh(e)}},{key:"redo",value:function(){this.undo()}},{key:"createRedo",value:function(){var t=new e(this._main,this._mesh);return this.pushRedoVertices(t),t}},{key:"pushVertices",value:function(e){for(var t=this._idVertState,r=this._cArState,i=this._mArState,a=this._mesh,s=a.getColors(),o=a.getMaterials(),l=a.getVerticesStateFlags(),u=n.STATE_FLAG,h=e.length,c=0;c<h;++c){var d=e[c];l[d]!==u&&(l[d]=u,t.push(d),d*=3,r.push(s[d],s[d+1],s[d+2]),i.push(o[d],o[d+1],o[d+2]))}}},{key:"pushRedoVertices",value:function(e){for(var t=e._mesh,r=t.getColors(),i=t.getMaterials(),a=this._idVertState,n=a.length,s=e._cArState=new Float32Array(3*n),o=e._mArState=new Float32Array(3*n),l=e._idVertState=new Uint32Array(n),u=0;u<n;++u){var h=l[u]=a[u];h*=3;var c=3*u;s[c]=r[h],s[c+1]=r[h+1],s[c+2]=r[h+2],o[c]=i[h],o[c+1]=i[h+1],o[c+2]=i[h+2]}}},{key:"pullVertices",value:function(){for(var e=this._cArState,t=this._mArState,r=this._idVertState,i=r.length,a=this._mesh,n=a.getColors(),s=a.getMaterials(),o=0;o<i;++o){var l=3*r[o],u=3*o;n[l]=e[u],n[l+1]=e[u+1],n[l+2]=e[u+2],s[l]=t[u],s[l+1]=t[u+1],s[l+2]=t[u+2]}}}]),e}(),wa=i.vec3,Ea=function(){function e(t,r){y(this,e),this._main=t,this._mesh=r,this._center=wa.copy([0,0,0],r.getCenter()),this._idVertState=[],this._vArState=[]}return M(e,[{key:"isNoop",value:function(){return 0===this._idVertState.length}},{key:"undo",value:function(){this.pullVertices();var e=this._mesh;e.updateGeometry(e.getFacesFromVertices(this._idVertState),this._idVertState),e.updateGeometryBuffers(),wa.copy(e.getCenter(),this._center),this._main.setMesh(e)}},{key:"redo",value:function(){this.undo()}},{key:"createRedo",value:function(){var t=new e(this._main,this._mesh);return this.pushRedoVertices(t),t}},{key:"pushVertices",value:function(e){for(var t=this._idVertState,r=this._vArState,i=this._mesh,a=i.getVertices(),s=i.getVerticesStateFlags(),o=n.STATE_FLAG,l=e.length,u=0;u<l;++u){var h=e[u];s[h]!==o&&(s[h]=o,t.push(h),h*=3,r.push(a[h],a[h+1],a[h+2]))}}},{key:"pushRedoVertices",value:function(e){for(var t=e._mesh,r=t.getVertices(),i=this._idVertState,a=i.length,n=e._vArState=new Float32Array(3*a),s=e._idVertState=new Uint32Array(a),o=0;o<a;++o){var l=s[o]=i[o];l*=3;var u=3*o;n[u]=r[l],n[u+1]=r[l+1],n[u+2]=r[l+2]}}},{key:"pullVertices",value:function(){for(var e=this._vArState,t=this._idVertState,r=t.length,i=this._mesh,a=i.getVertices(),n=0;n<r;++n){var s=3*t[n],o=3*n;a[s]=e[o],a[s+1]=e[o+1],a[s+2]=e[o+2]}}}]),e}(),Ra=i.vec3,Fa=function(){function e(t,r){y(this,e),this._main=t,this._mesh=r,this._center=Ra.copy([0,0,0],r.getCenter()),this._nbFacesState=r.getNbFaces(),this._nbVerticesState=r.getNbVertices(),this._idVertState=[],this._fRingState=[],this._vRingState=[],this._vArState=[],this._cArState=[],this._mArState=[],this._idFaceState=[],this._fArState=[]}return M(e,[{key:"isNoop",value:function(){return 0===this._idVertState.length&&0===this._idFaceState.length}},{key:"undo",value:function(){this.pullVertices(),this.pullFaces();var e=this._mesh;e.setNbVertices(this._nbVerticesState),e.setNbFaces(this._nbFacesState),e.updateTopology(),e.updateGeometry(),e.updateDuplicateColorsAndMaterials(),e.updateDrawArrays(),e.updateColorBuffer(),e.updateMaterialBuffer(),e.updateBuffers(),Ra.copy(e.getCenter(),this._center),this._main.setMesh(e)}},{key:"redo",value:function(){this.undo()}},{key:"createRedo",value:function(){var t=new e(this._main,this._mesh);return this.pushRedoVertices(t),this.pushRedoFaces(t),t}},{key:"pushVertices",value:function(e){for(var t=this._idVertState,r=this._fRingState,i=this._vRingState,a=this._vArState,s=this._cArState,o=this._mArState,l=this._mesh,u=l.getVerticesRingFace(),h=l.getVerticesRingVert(),c=l.getVertices(),d=l.getColors(),g=l.getMaterials(),f=l.getVerticesStateFlags(),v=n.STATE_FLAG,m=e.length,p=0;p<m;++p){var _=e[p];f[_]!==v&&(f[_]=v,r.push(u[_].slice()),i.push(h[_].slice()),t.push(_),_*=3,a.push(c[_],c[_+1],c[_+2]),s.push(d[_],d[_+1],d[_+2]),o.push(g[_],g[_+1],g[_+2]))}}},{key:"pushFaces",value:function(e){for(var t=this._idFaceState,r=this._fArState,i=this._mesh,a=i.getFaces(),s=i.getFacesStateFlags(),o=n.STATE_FLAG,l=e.length,u=0;u<l;++u){var h=e[u];s[h]!==o&&(s[h]=o,t.push(h),h*=4,r.push(a[h],a[h+1],a[h+2],a[h+3]))}}},{key:"pushRedoVertices",value:function(e){var t=e._mesh,r=t.getNbVertices(),i=t.getVerticesRingFace(),a=t.getVerticesRingVert(),s=t.getVertices(),o=t.getColors(),l=t.getMaterials(),u=0,h=0,c=0,d=this._idVertState,g=d.length,f=this._nbVerticesState,v=Math.min(f,r),m=new Uint32Array(n.getMemory(4*r),0,r);for(u=0;u<g;++u)h=d[u],h<v&&(m[c++]=h);for(u=f;u<r;++u)m[c++]=u;g=c,m=e._idVertState=new Uint32Array(m.subarray(0,g));var p=e._fRingState=new Array(g),_=e._vRingState=new Array(g),y=e._vArState=new Float32Array(3*g),M=e._cArState=new Float32Array(3*g),T=e._mArState=new Float32Array(3*g);for(u=0;u<g;++u){h=m[u],p[u]=i[h].slice(),_[u]=a[h].slice(),h*=3;var S=3*u;y[S]=s[h],y[S+1]=s[h+1],y[S+2]=s[h+2],M[S]=o[h],M[S+1]=o[h+1],M[S+2]=o[h+2],T[S]=l[h],T[S+1]=l[h+1],T[S+2]=l[h+2]}}},{key:"pushRedoFaces",value:function(e){var t=e._mesh,r=t.getNbFaces(),i=t.getFaces(),a=0,s=0,o=0,l=this._idFaceState,u=l.length,h=this._nbFacesState,c=Math.min(h,r),d=new Uint32Array(n.getMemory(4*r),0,r);for(a=0;a<u;++a)s=l[a],s<c&&(d[o++]=s);for(a=h;a<r;++a)d[o++]=a;u=o,d=e._idFaceState=new Uint32Array(d.subarray(0,u));var g=e._fArState=new Int32Array(4*u);for(a=0;a<u;++a){s=d[a],s*=4;var f=4*a;g[f]=i[s],g[f+1]=i[s+1],g[f+2]=i[s+2],g[f+3]=i[s+3]}}},{key:"pullVertices",value:function(){for(var e=this._nbVerticesState,t=this._fRingState,r=this._vRingState,i=this._vArState,a=this._cArState,n=this._mArState,s=this._idVertState,o=s.length,l=this._mesh,u=l.getVerticesRingFace(),h=l.getVerticesRingVert(),c=l.getVertices(),d=l.getColors(),g=l.getMaterials(),f=0;f<o;++f){var v=s[f];if(!(v>=e)){u[v]=t[f].slice(),h[v]=r[f].slice(),v*=3;var m=3*f;c[v]=i[m],c[v+1]=i[m+1],c[v+2]=i[m+2],d[v]=a[m],d[v+1]=a[m+1],d[v+2]=a[m+2],g[v]=n[m],g[v+1]=n[m+1],g[v+2]=n[m+2]}}}},{key:"pullFaces",value:function(){for(var e=this._nbFacesState,t=this._fArState,r=this._idFaceState,i=r.length,a=this._mesh,n=a.getFaces(),s=0;s<i;++s){var o=r[s];if(!(o>=e)){o*=4;var l=4*s;n[o]=t[l],n[o+1]=t[l+1],n[o+2]=t[l+2],n[o+3]=t[l+3]}}}}]),e}(),Da=function(){function e(t,r){y(this,e),this._undocb=t,this._redocb=r?r:t}return M(e,[{key:"isNoop",value:function(){return!this._undocb}},{key:"undo",value:function(){this._undocb()}},{key:"redo",value:function(){this._redocb()}},{key:"createRedo",value:function(){return new e(this._undocb,this._redocb)}}]),e}(),Ia=function(){function e(t){y(this,e),this._main=t,this._undos=[],this._redos=[],this._curUndoIndex=-1}return M(e,[{key:"pushStateCustom",value:function(e,t,r){var i=new Da(e,t);i.squash=r,this.pushState(i)}},{key:"pushStateAddRemove",value:function(e,t,r){var i=new xa(this._main,e,t);i.squash=r,this.pushState(i)}},{key:"pushStateRemove",value:function(e){this.pushState(new xa(this._main,[],e))}},{key:"pushStateAdd",value:function(e){this.pushState(new xa(this._main,e,[]))}},{key:"pushStateColorAndMaterial",value:function(e){e.isDynamic?this.pushState(new Fa(this._main,e)):this.pushState(new ka(this._main,e))}},{key:"pushStateGeometry",value:function(e){e.isDynamic?this.pushState(new Fa(this._main,e)):this.pushState(new Ea(this._main,e))}},{key:"pushStateMultiresolution",value:function(e,t){this.pushState(new Yi(this._main,e,t));
}},{key:"setNewMaxStack",value:function(t){e.STACK_LENGTH=t;for(var r=this._undos,i=this._redos;this._curUndoIndex>=t;)r.shift(),--this._curUndoIndex;for(;r.length>t;)r.pop(),i.shift()}},{key:"pushState",value:function(t){++n.STATE_FLAG;var r=this._undos;this._curUndoIndex===-1?r.length=0:r.length>=e.STACK_LENGTH&&(r.shift(),--this._curUndoIndex),this._redos.length=0,++this._curUndoIndex,r.length>0&&(r.length=this._curUndoIndex),r.push(t)}},{key:"getCurrentState",value:function(){return this._undos[this._curUndoIndex]}},{key:"pushVertices",value:function(e){e&&e.length>0&&this.getCurrentState().pushVertices(e)}},{key:"pushFaces",value:function(e){e&&e.length>0&&this.getCurrentState().pushFaces(e)}},{key:"undo",value:function(){if(this._undos.length&&!(this._curUndoIndex<0)){var e=this.getCurrentState(),t=e.createRedo();t.squash=e.squash,this._redos.push(t),e.undo(),this._curUndoIndex--,e.squash===!0&&this.undo()}}},{key:"redo",value:function(){if(this._redos.length){var e=this._redos[this._redos.length-1];e.redo(),this._curUndoIndex++,this._redos.pop(),e.squash===!0&&this.redo()}}},{key:"reset",value:function(){this._undos.length=0,this._redos.length=0,this._curUndoIndex=-1}},{key:"cleanNoop",value:function(){for(;this._curUndoIndex>=0&&this.getCurrentState().isNoop();)this._undos.length--,this._curUndoIndex--,this._redos.length=0}}]),e}();Ia.STACK_LENGTH=15;var Ca=function(){function e(t,r){y(this,e),this._ctrlGui=r,this._main=r._main,this._menu=null,this.init(t)}return M(e,[{key:"init",value:function(e){var t=this._menu=e.addMenu(B("stateTitle"));t.addButton(B("stateUndo"),this,"onUndo","CTRL+Z"),t.addButton(B("stateRedo"),this,"onRedo","CTRL+Y"),t.addTitle(B("stateMaxStack"));var r=this._main.getStateManager();t.addSlider("",Ia.STACK_LENGTH,r.setNewMaxStack.bind(r),3,50,1)}},{key:"onUndo",value:function(){this._main._action=o.Action.NOTHING,this._main.getSculptManager().end(),this._main.getStateManager().undo(),this._main.render(),this._ctrlGui.updateMesh()}},{key:"onRedo",value:function(){this._main.getStateManager().redo(),this._main.render(),this._ctrlGui.updateMesh()}},{key:"onKeyDown",value:function(e){if(e.handled!==!0){e.stopPropagation(),this._main._focusGui||e.preventDefault();var t=e.which;e.ctrlKey&&90===t?(this.onUndo(),e.handled=!0):e.ctrlKey&&89===t&&(this.onRedo(),e.handled=!0)}}}]),e}(),Na=function(){function e(t){y(this,e),this._menu=null,this.init(t)}return M(e,[{key:"init",value:function(e){var t=this._menu=e.addMenu(B("wacomTitle"));t.addCheckbox(B("wacomRadius"),pe,"useOnRadius"),t.addCheckbox(B("wacomIntensity"),pe,"useOnIntensity")}}]),e}(),Va=function(){function e(t){y(this,e),this._main=t,this._guiMain=null,this._sidebar=null,this._topbar=null,this._ctrlTablet=null,this._ctrlFiles=null,this._ctrlScene=null,this._ctrlStates=null,this._ctrlCamera=null,this._ctrlBackground=null,this._ctrlSculpting=null,this._ctrlTopology=null,this._ctrlRendering=null,this._ctrlNotification=null,this._ctrls=[]}return M(e,[{key:"initGui",value:function(){this.deleteGui(),this._guiMain=new Kr.GuiMain(this._main.getViewport(),this._main.onCanvasResize.bind(this._main));var e=this._ctrls;e.length=0;var t=0;this._topbar=this._guiMain.addTopbar(),e[t++]=this._ctrlFiles=new ui(this._topbar,this),e[t++]=this._ctrlScene=new Ji(this._topbar,this),e[t++]=this._ctrlStates=new Ca(this._topbar,this),e[t++]=this._ctrlBackground=new Zr(this._topbar,this),e[t++]=this._ctrlCamera=new Qr(this._topbar,this),_().wacom&&(e[t++]=this._ctrlTablet=new Na(this._topbar,this)),e[t++]=this._ctrlConfig=new Jr(this._topbar,this),e[t++]=this._ctrlMesh=new hi(this._topbar,this),this._sidebar=this._guiMain.addRightSidebar(),e[t++]=this._ctrlRendering=new Qi(this._sidebar,this),e[t++]=this._ctrlTopology=new Hi(this._sidebar,this),e[t++]=this._ctrlSculpting=new Aa(this._sidebar,this);var r=this._topbar.addExtra();r.addTitle(B("contour")),r.addColor(B("contourColor"),ae.color,this.onContourColor.bind(this)),r.addTitle(B("resolution")),r.addSlider("",this._main._pixelRatio,this.onPixelRatio.bind(this),.5,2,.02),this.addAboutButton(),this.updateMesh(),this.setVisibility(!0)}},{key:"onPixelRatio",value:function(e){this._main._pixelRatio=e,this._main.onCanvasResize()}},{key:"onContourColor",value:function(e){ae.color[0]=e[0],ae.color[1]=e[1],ae.color[2]=e[2],ae.color[3]=e[3],this._main.render()}},{key:"addAboutButton",value:function(){var e=this._topbar.addMenu();e.domContainer.innerHTML=B("about"),e.domContainer.addEventListener("mousedown",function(){window.open("http://stephaneginier.com","_blank")})}},{key:"getWidgetNotification",value:function(){return this._ctrlNotification||(this._ctrlNotification=this._topbar.addMenu(),this._ctrlNotification.setVisibility(!1)),this._ctrlNotification}},{key:"updateMesh",value:function(){this._ctrlRendering.updateMesh(),this._ctrlTopology.updateMesh(),this._ctrlSculpting.updateMesh(),this._ctrlScene.updateMesh(),this.updateMeshInfo()}},{key:"updateMeshInfo",value:function(){this._ctrlMesh.updateMeshInfo()}},{key:"getFlatShading",value:function(){return this._ctrlRendering.getFlatShading()}},{key:"getWireframe",value:function(){return this._ctrlRendering.getWireframe()}},{key:"getShaderType",value:function(){return this._ctrlRendering.getShaderType()}},{key:"addAlphaOptions",value:function(e){this._ctrlSculpting.addAlphaOptions(e)}},{key:"deleteGui",value:function(){this._guiMain&&this._guiMain.domMain.parentNode&&(this.callFunc("removeEvents"),this.setVisibility(!1),this._guiMain.domMain.parentNode.removeChild(this._guiMain.domMain))}},{key:"setVisibility",value:function(e){this._guiMain.setVisibility(e)}},{key:"callFunc",value:function(e,t){for(var r=0,i=this._ctrls,a=i.length;r<a;++r){var n=i[r];n&&n[e]&&n[e](t)}}}]),e}(),Pa=i.vec2,La=i.vec3,Ua=i.mat3,Ba=i.mat4,Oa=i.quat,Ga=function(e){return e=Math.min(1,e)-1,-(e*e*e*e-1)},za=200,Xa=-1,Wa=-1,Ya=200,Ha=[0,0],ja=[0,0,0],qa=[0,0,0],Ka=[0,1,0],Za=[0,0,0,1],Qa=Ba.create(),Ja=Math.SQRT1_2,$a=.5,en=[Oa.fromValues(1,0,0,0),Oa.fromValues(0,1,0,0),Oa.fromValues(0,0,1,0),Oa.fromValues(0,0,0,1),Oa.fromValues(Ja,Ja,0,0),Oa.fromValues(Ja,-Ja,0,0),Oa.fromValues(Ja,0,Ja,0),Oa.fromValues(Ja,0,-Ja,0),Oa.fromValues(Ja,0,0,Ja),Oa.fromValues(Ja,0,0,-Ja),Oa.fromValues(0,Ja,Ja,0),Oa.fromValues(0,Ja,-Ja,0),Oa.fromValues(0,Ja,0,Ja),Oa.fromValues(0,Ja,0,-Ja),Oa.fromValues(0,0,Ja,Ja),Oa.fromValues(0,0,Ja,-Ja),Oa.fromValues($a,$a,$a,$a),Oa.fromValues($a,$a,$a,-$a),Oa.fromValues($a,$a,-$a,$a),Oa.fromValues($a,$a,-$a,-$a),Oa.fromValues($a,-$a,$a,$a),Oa.fromValues($a,-$a,$a,-$a),Oa.fromValues($a,-$a,-$a,$a),Oa.fromValues(-$a,$a,$a,$a)],tn=function(){function e(t){y(this,e),this._main=t;var r=_();this._mode=r.cameramode||o.CameraMode.ORBIT,this._projectionType=r.projection||o.Projection.PERSPECTIVE,this._quatRot=[0,0,0,1],this._view=Ba.create(),this._proj=Ba.create(),this._viewport=Ba.create(),this._lastNormalizedMouseXY=[0,0],this._width=0,this._height=0,this._speed=0,this._fov=Math.min(r.fov,150),this._trans=[0,0,30],this._moveX=0,this._moveZ=0,this._usePivot=r.pivot,this._center=[0,0,0],this._offset=[0,0,0],this._rotX=0,this._rotY=0,this._near=.05,this._far=5e3,this._timers={},this.resetView()}return M(e,[{key:"setProjectionType",value:function(e){this._projectionType=e,this.updateProjection(),this.updateView()}},{key:"setMode",value:function(e){this._mode=e,e===o.CameraMode.ORBIT&&this.resetViewFront()}},{key:"setFov",value:function(e){this._fov=e,this.updateView(),this.optimizeNearFar()}},{key:"setUsePivot",value:function(e){this._usePivot=e}},{key:"toggleUsePivot",value:function(){this._usePivot=!this._usePivot}},{key:"getView",value:function(){return this._view}},{key:"getProjection",value:function(){return this._proj}},{key:"getProjectionType",value:function(){return this._projectionType}},{key:"isOrthographic",value:function(){return this._projectionType===o.Projection.ORTHOGRAPHIC}},{key:"getMode",value:function(){return this._mode}},{key:"getFov",value:function(){return this._fov}},{key:"getUsePivot",value:function(){return this._usePivot}},{key:"getConstantScreen",value:function(){var e=this._main.getCanvas().clientWidth;return this._projectionType===o.Projection.ORTHOGRAPHIC?e/this.getOrthoZoom():e*this._proj[0]}},{key:"start",value:function(e,t){if(this._lastNormalizedMouseXY=Ae.normalizedMouse(e,t,this._width,this._height),this._usePivot){var r=this._main,i=r.getPicking();i.intersectionMouseMeshes(r.getMeshes(),e,t),i.getMesh()&&(La.transformMat4(ja,i.getIntersectionPoint(),i.getMesh().getMatrix()),this.setPivot(ja))}}},{key:"setPivot",value:function(e){if(La.transformQuat(this._offset,this._offset,Oa.invert(Za,this._quatRot)),La.sub(this._offset,this._offset,this._center),La.copy(this._center,e),La.add(this._offset,this._offset,this._center),La.transformQuat(this._offset,this._offset,this._quatRot),this._projectionType===o.Projection.PERSPECTIVE){var t=this.getTransZ();this._trans[2]=La.dist(this.computePosition(),this._center)*this._fov/45,this._offset[2]+=this.getTransZ()-t}else this._offset[2]=0}},{key:"rotate",value:function(e,t){var r=ja,i=Ha,a=Ae.normalizedMouse(e,t,this._width,this._height);if(this._mode===o.CameraMode.ORBIT)Pa.sub(i,a,this._lastNormalizedMouseXY),this.setOrbit(this._rotX-2*i[1],this._rotY+2*i[0]),this.rotateDelay([6*-i[1],6*i[0]],Xa);else if(this._mode===o.CameraMode.PLANE){var n=Pa.dist(this._lastNormalizedMouseXY,a);Pa.sub(i,a,this._lastNormalizedMouseXY),La.normalize(r,La.set(r,-i[1],i[0],0)),Oa.mul(this._quatRot,Oa.setAxisAngle(Za,r,2*n),this._quatRot),this.rotateDelay([r[0],r[1],r[2],6*n],Xa)}else if(this._mode===o.CameraMode.SPHERICAL){var s=Ae.mouseOnUnitSphere(this._lastNormalizedMouseXY),l=Ae.mouseOnUnitSphere(a),u=Math.acos(Math.min(1,La.dot(s,l)));La.normalize(r,La.cross(r,s,l)),Oa.mul(this._quatRot,Oa.setAxisAngle(Za,r,2*u),this._quatRot),this.rotateDelay([r[0],r[1],r[2],6*u],Xa)}this._lastNormalizedMouseXY=a,this.updateView()}},{key:"setOrbit",value:function(e,t){var r=.49*Math.PI;this._rotX=Math.max(Math.min(e,r),-r),this._rotY=t;var i=this._quatRot;Oa.identity(i),Oa.rotateX(i,i,this._rotX),Oa.rotateY(i,i,this._rotY)}},{key:"getTransZ",value:function(){return this._projectionType===o.Projection.PERSPECTIVE?45*this._trans[2]/this._fov:1e3}},{key:"updateView",value:function(){var e=ja,t=this._view,r=this._trans[0],i=this._trans[1],a=this._offset;La.set(qa,r-a[0],i-a[1],this.getTransZ()-a[2]),La.set(e,r-a[0],i-a[1],-a[2]),Ba.lookAt(t,qa,e,Ka),Ba.mul(t,t,Ba.fromQuat(Qa,this._quatRot)),Ba.translate(t,t,La.negate(ja,this._center))}},{key:"optimizeNearFar",value:function(e){if(e||(e=this._lastBBox),e){this._lastBBox=e,La.set(qa,this._trans[0],this._trans[1],this.getTransZ());var t=La.dist(e,La.set(ja,e[3],e[4],e[5])),r=La.dist(qa,La.set(ja,.5*(e[0]+e[3]),.5*(e[1]+e[4]),.5*(e[2]+e[5])));this._near=Math.max(.01,r-t),this._far=t+r,this.updateProjection()}}},{key:"updateProjection",value:function(){this._projectionType===o.Projection.PERSPECTIVE?(Ba.perspective(this._proj,this._fov*Math.PI/180,this._width/this._height,this._near,this._far),this._proj[10]=-1,this._proj[14]=-2*this._near):this.updateOrtho()}},{key:"updateTranslation",value:function(){var e=this._trans;e[0]+=this._moveX*this._speed*e[2]/50/400,e[2]=Math.max(1e-5,e[2]+this._moveZ*this._speed/400),this._projectionType===o.Projection.ORTHOGRAPHIC&&this.updateOrtho(),this.updateView()}},{key:"translate",value:function(e,t){var r=this._speed*this._trans[2]/54,i=[-e*r,t*r,0];this.setTrans(La.add(this._trans,this._trans,i)),La.scale(i,i,5),this.translateDelay(i,Wa)}},{key:"zoom",value:function(e){var t=[0,0,0];La.sub(t,this._offset,this._trans),La.scale(t,t,e*this._speed/54),e<0&&(t[0]=t[1]=0),this.setTrans(La.add(this._trans,this._trans,t)),La.scale(t,t,5),this.translateDelay(t,Wa)}},{key:"setAndFocusOnPivot",value:function(e,t){this.setPivot(e),this.moveToDelay(this._offset[0],this._offset[1],this._offset[2]+t)}},{key:"moveToDelay",value:function(e,t,r){var i=[e,t,r];this.translateDelay(La.sub(i,i,this._trans),Ya)}},{key:"setTrans",value:function(e){La.copy(this._trans,e),this._projectionType===o.Projection.ORTHOGRAPHIC&&this.updateOrtho(),this.updateView()}},{key:"getOrthoZoom",value:function(){return 55e-5*Math.abs(this._trans[2])}},{key:"updateOrtho",value:function(){var e=this.getOrthoZoom(),t=this._width*e,r=this._height*e;Ba.ortho(this._proj,-t,t,-r,r,-this._near,this._far)}},{key:"computePosition",value:function(){var e=this._view,t=[-e[12],-e[13],-e[14]],r=Ua.create();return Ua.fromMat4(r,e),La.transformMat3(t,t,Ua.transpose(r,r))}},{key:"resetView",value:function(){this._speed=1.5*n.SCALE,this.centerDelay([0,0,0],Ya),this.offsetDelay([0,0,0],Ya);var e=[0,0,30+this._speed/3];La.sub(e,e,this._trans),this.translateDelay(e,Ya),this.quatDelay([0,0,0,1],Ya)}},{key:"resetViewFront",value:function(){this.quatDelay([0,0,0,1],za)}},{key:"resetViewBack",value:function(){this.quatDelay([0,1,0,0],za)}},{key:"resetViewTop",value:function(){this.quatDelay([Math.SQRT1_2,0,0,Math.SQRT1_2],za)}},{key:"resetViewBottom",value:function(){this.quatDelay([-Math.SQRT1_2,0,0,Math.SQRT1_2],za)}},{key:"resetViewLeft",value:function(){this.quatDelay([0,-Math.SQRT1_2,0,Math.SQRT1_2],za)}},{key:"resetViewRight",value:function(){this.quatDelay([0,Math.SQRT1_2,0,Math.SQRT1_2],za)}},{key:"toggleViewFront",value:function(){Math.abs(this._quatRot[3])>.99?this.resetViewBack():this.resetViewFront()}},{key:"toggleViewTop",value:function(){var e=this._quatRot[0]*Math.SQRT1_2+this._quatRot[3]*Math.SQRT1_2;e*e>.99?this.resetViewBottom():this.resetViewTop()}},{key:"toggleViewLeft",value:function(){var e=-this._quatRot[1]*Math.SQRT1_2+this._quatRot[3]*Math.SQRT1_2;e*e>.99?this.resetViewRight():this.resetViewLeft()}},{key:"computeWorldToScreenMatrix",value:function(e){return e=e||Ba.create(),Ba.mul(e,Ba.mul(e,this._viewport,this._proj),this._view)}},{key:"unproject",value:function(e,t,r){var i=[0,0,0];return Ba.invert(Qa,this.computeWorldToScreenMatrix(Qa)),La.transformMat4(i,La.set(i,e,this._height-t,r),Qa)}},{key:"project",value:function(e){var t=[0,0,0];return La.transformMat4(t,e,this.computeWorldToScreenMatrix(Qa)),t[1]=this._height-t[1],t}},{key:"onResize",value:function(e,t){this._width=e,this._height=t;var r=this._viewport;Ba.identity(r),Ba.scale(r,r,La.set(ja,.5*e,.5*t,.5)),Ba.translate(r,r,La.set(ja,1,1,1)),this.updateProjection()}},{key:"snapClosestRotation",value:function(){for(var e=this._quatRot,t=1/0,r=0,i=en.length,a=0;a<i;++a){var n=Oa.dot(e,en[a]);n=1-n*n,t<n||(t=n,r=a)}this.quatDelay(en[r],za)}},{key:"clearTimerN",value:function(e){window.clearInterval(this._timers[e]),this._timers[e]=0}},{key:"delay",value:function(e,t,r){var i=r||"default";if(this._timers[i]&&this.clearTimerN(i),0===t)return e(1);if(!(t<0)){var a=0,n=(new Date).getTime();this._timers[i]=window.setInterval(function(){var r=((new Date).getTime()-n)/t;r=Ga(r),e(r-a,r),a=r,r>=1&&this.clearTimerN(i)}.bind(this),16.6)}}},{key:"_translateDelta",value:function(e,t){var r=this._trans;La.scaleAndAdd(r,r,e,t),this.setTrans(r),this._main.render()}},{key:"translateDelay",value:function(e,t){var r=this._translateDelta.bind(this,e);this.delay(r,t,"translate")}},{key:"_rotDelta",value:function(e,t){if(this._mode===o.CameraMode.ORBIT){var r=this._rotX+e[0]*t,i=this._rotY+e[1]*t;this.setOrbit(r,i)}else Oa.mul(this._quatRot,Oa.setAxisAngle(Za,e,e[3]*t),this._quatRot);this.updateView(),this._main.render()}},{key:"rotateDelay",value:function(e,t){var r=this._rotDelta.bind(this,e);this.delay(r,t,"rotate")}},{key:"_quatDelta",value:function(e,t){Oa.identity(Za),Oa.slerp(Za,Za,e,t);var r=this._quatRot;if(Oa.mul(this._quatRot,this._quatRot,Za),this._mode===o.CameraMode.ORBIT){var i=r[0],a=r[1],n=r[2],s=r[3];this._rotY=Math.atan2(2*(s*a+n*i),1-2*(a*a+n*n)),this._rotX=Math.atan2(2*(s*i+a*n),1-2*(n*n+i*i))}this.updateView(),this._main.render()}},{key:"quatDelay",value:function(e,t){var r=[0,0,0,0];Oa.conjugate(r,this._quatRot),Oa.mul(r,r,e),Oa.normalize(r,r);var i=this._quatDelta.bind(this,r);this.delay(i,t,"quat")}},{key:"_centerDelta",value:function(e,t){La.scaleAndAdd(this._center,this._center,e,t),this.updateView(),this._main.render()}},{key:"centerDelay",value:function(e,t){var r=[0,0,0];La.sub(r,e,this._center);var i=this._centerDelta.bind(this,r);this.delay(i,t,"center")}},{key:"_offsetDelta",value:function(e,t){La.scaleAndAdd(this._offset,this._offset,e,t),this.updateView(),this._main.render()}},{key:"offsetDelay",value:function(e,t){var r=[0,0,0];La.sub(r,e,this._offset);var i=this._offsetDelta.bind(this,r);this.delay(i,t,"offset")}},{key:"computeFrustumFit",value:function(){var e,t=this._near;if(this._projectionType===o.Projection.ORTHOGRAPHIC)return e=Math.min(this._width,this._height)/t*.5,Math.sqrt(1+e*e)/e;var r=this._proj,i=t*(r[8]-1)/r[0],a=t*(1+r[8])/r[0],n=t*(1+r[9])/r[5],s=t*(r[9]-1)/r[5],l=Math.abs(a-i),u=Math.abs(n-s);return e=Math.min(u,l)/t*.5,this._fov/45*Math.sqrt(1+e*e)/e}}]),e}(),rn=function(){function e(t,r){y(this,e),this._main=r,this._gl=t,this._vertexBuffer=new A(t,t.ARRAY_BUFFER,t.STATIC_DRAW),this._texCoordBuffer=new A(t,t.ARRAY_BUFFER,t.STATIC_DRAW),this._fill=!0,this._monoTex=null,this._texture=null,this._texWidth=1,this._texHeight=1,this.init()}return M(e,[{key:"init",value:function(){this.getTexCoordBuffer().update(new Float32Array([0,0,1,0,0,1,1,1])),this._monoTex=this.createOnePixelTexture(50,50,50,255),document.getElementById("backgroundopen").addEventListener("change",this.loadBackground.bind(this),!1)}},{key:"loadBackground",value:function(e){if(0!==e.target.files.length){var t=e.target.files[0];if(t.type.match("image.*")){var r=this,i=new FileReader;i.onload=function(e){var t=new Image;t.src=e.target.result,t.onload=function(){var e=r._main.getCanvas();r.loadBackgroundTexture(t),r.onResize(e.width,e.height),r._main.render()}},document.getElementById("backgroundopen").value="",i.readAsDataURL(t)}}}},{key:"getGL",value:function(){return this._gl}},{key:"getVertexBuffer",value:function(){return this._vertexBuffer}},{key:"getTexCoordBuffer",value:function(){return this._texCoordBuffer}},{key:"release",value:function(){this.deleteTexture(),this.getVertexBuffer().release(),this.getTexCoordBuffer().release()}},{key:"onResize",value:function(e,t){var r=e/t/(this._texWidth/this._texHeight),i=this._fill?1/r:r,a=i<1?1:1/r,n=i<1?r:1;this.getVertexBuffer().update(new Float32Array([-a,-n,a,-n,-a,n,a,n]))}},{key:"getTexture",value:function(){return this._texture?this._texture:this._monoTex}},{key:"createOnePixelTexture",value:function(e,t,r,i){var a=this._gl,n=a.createTexture();return a.bindTexture(a.TEXTURE_2D,n),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,1,1,0,a.RGBA,a.UNSIGNED_BYTE,new Uint8Array([e,t,r,i])),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST),a.bindTexture(a.TEXTURE_2D,null),n}},{key:"loadBackgroundTexture",value:function(e){var t=this._gl;this.deleteTexture(),this._texWidth=e.width,this._texHeight=e.height,this._texture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this._texture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.bindTexture(t.TEXTURE_2D,null)}},{key:"deleteTexture",value:function(){this._texture&&(this._texWidth=this._texHeight=1,this._gl.deleteTexture(this._texture),this._texture=null)}},{key:"render",value:function(){ne[o.Shader.BACKGROUND].getOrCreate(this._gl).draw(this)}}]),e}(),an={};an._gl=null,an._checkRTT={},an._webGLExtensions={},an.HALF_FLOAT=an.HALF_FLOAT_OES=36193,an.checkRTTSupport=function(e,t){var r=an._gl;if(void 0===r)return!1;var i=e+","+t;if(void 0!==an._checkRTT[i])return an._checkRTT[i];var a=r.createTexture();r.bindTexture(r.TEXTURE_2D,a),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,2,2,0,r.RGBA,e,null),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,t),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,t);var n=r.createFramebuffer();r.bindFramebuffer(r.FRAMEBUFFER,n),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,a,0);var s=an._checkRTT[i]=r.checkFramebufferStatus(r.FRAMEBUFFER)===r.FRAMEBUFFER_COMPLETE;return r.deleteTexture(a),r.deleteFramebuffer(n),r.bindTexture(r.TEXTURE_2D,null),r.bindFramebuffer(r.FRAMEBUFFER,null),s},an.hasRTTLinearHalfFloat=function(){return an._webGLExtensions.OES_texture_half_float_linear&&an.checkRTTSupport(an.HALF_FLOAT,an._gl.LINEAR)},an.hasRTTLinearFloat=function(){return an._webGLExtensions.OES_texture_float_linear&&an.checkRTTSupport(an._gl.FLOAT,an._gl.LINEAR)},an.hasRTTHalfFloat=function(){return an._webGLExtensions.OES_texture_half_float&&an.checkRTTSupport(an.HALF_FLOAT,an._gl.NEAREST)},an.hasRTTFloat=function(){return an._webGLExtensions.OES_texture_float&&an.checkRTTSupport(an._gl.FLOAT,an._gl.NEAREST)},an.getWebGLExtension=function(e){return an._webGLExtensions[e]},an.getWebGLExtensions=function(){return an._webGLExtensions},an.initWebGLExtensions=function(e){an._gl=e;for(var t=e.getSupportedExtensions(),r=an._webGLExtensions,i=0,a=t.length;i<a;++i){var n=t[i];r[n]=e.getExtension(n)}};var nn,sn=function(){function e(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t.createRenderbuffer(),a=arguments.length>3&&void 0!==arguments[3]&&arguments[3];y(this,e),this._gl=t,this._texture=t.createTexture(),this._depth=i,this._framebuffer=t.createFramebuffer(),this._shaderType=r,this._invSize=new Float32Array(2),this._vertexBuffer=null,a&&an.hasRTTHalfFloat()?this._type=an.HALF_FLOAT_OES:a&&an.hasRTTFloat()?this._type=t.FLOAT:this._type=t.UNSIGNED_BYTE,this.init()}return M(e,[{key:"getGL",value:function(){return this._gl}},{key:"getVertexBuffer",value:function(){return this._vertexBuffer}},{key:"getFramebuffer",value:function(){return this._framebuffer}},{key:"getTexture",value:function(){return this._texture}},{key:"getDepth",value:function(){return this._depth}},{key:"getInverseSize",value:function(){return this._invSize}},{key:"init",value:function(){var e=this._gl;nn||(nn=new A(e,e.ARRAY_BUFFER,e.STATIC_DRAW),nn.update(new Float32Array([-1,-1,4,-1,-1,4]))),this._vertexBuffer=nn}},{key:"onResize",value:function(e,t){var r=this._gl;this._invSize[0]=1/e,this._invSize[1]=1/t,r.bindTexture(r.TEXTURE_2D,this._texture),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,e,t,0,r.RGBA,this._type,null),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),this._depth&&(r.bindRenderbuffer(r.RENDERBUFFER,this._depth),r.renderbufferStorage(r.RENDERBUFFER,r.DEPTH_COMPONENT16,e,t)),r.bindFramebuffer(r.FRAMEBUFFER,this._framebuffer),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,this._texture,0),r.framebufferRenderbuffer(r.FRAMEBUFFER,r.DEPTH_ATTACHMENT,r.RENDERBUFFER,this._depth),r.bindTexture(r.TEXTURE_2D,null)}},{key:"release",value:function(){this._texture&&this._gl.deleteTexture(this._texture),this.getVertexBuffer().release()}},{key:"render",value:function(e){ne[this._shaderType].getOrCreate(this._gl).draw(this,e)}}]),e}(),on=i.vec3,ln=i.mat4,un=function(){function e(){y(this,e),this._gl=null,this._pixelRatio=1,this._viewport=document.getElementById("viewport"),this._canvas=document.getElementById("canvas"),this._canvasWidth=0,this._canvasHeight=0,this._canvasOffsetLeft=0,this._canvasOffsetTop=0,this._stateManager=new Ia(this),this._sculptManager=null,this._camera=new tn(this),this._picking=new ha(this),this._pickingSym=new ha(this,!0),this._meshPreview=null,this._torusLength=.5,this._torusWidth=.1,this._torusRadius=2*Math.PI,this._torusRadial=32,this._torusTubular=128;var t=_();this._showContour=t.outline,this._showGrid=t.grid,this._grid=null,this._background=null,this._meshes=[],this._selectMeshes=[],this._mesh=null,this._rttContour=null,this._rttMerge=null,this._rttOpaque=null,this._rttTransparent=null,this._focusGui=!1,this._gui=new Va(this),this._preventRender=!1,this._drawFullScene=!1,this._autoMatrix=t.scalecenter,this._vertexSRGB=!0}return M(e,[{key:"start",value:function(){if(this.initWebGL(),this._gl){this._sculptManager=new br(this),this._background=new rn(this._gl,this),this._rttContour=new sn(this._gl,o.Shader.CONTOUR,null),this._rttMerge=new sn(this._gl,o.Shader.MERGE,null),this._rttOpaque=new sn(this._gl,o.Shader.FXAA),this._rttTransparent=new sn(this._gl,null,this._rttOpaque.getDepth(),!0),this._grid=xt.createGrid(this._gl),this.initGrid(),this.loadTextures(),this._gui.initGui(),this.onCanvasResize();var e=_().modelurl;e?this.addModelURL(e):this.addSphere()}}},{key:"addModelURL",value:function(e){var t=this.getFileType(e);if(t){var r=new XMLHttpRequest;r.open("GET",e,!0),r.responseType="obj"===t?"text":"arraybuffer",r.onload=function(){200===r.status&&this.loadScene(r.response,t)}.bind(this),r.send(null)}}},{key:"getBackground",value:function(){return this._background}},{key:"getViewport",value:function(){return this._viewport}},{key:"getCanvas",value:function(){return this._canvas}},{key:"getPixelRatio",value:function(){return this._pixelRatio}},{key:"getCanvasWidth",value:function(){return this._canvasWidth}},{key:"getCanvasHeight",value:function(){return this._canvasHeight}},{key:"getCamera",value:function(){return this._camera}},{key:"getGui",value:function(){return this._gui}},{key:"getMeshes",value:function(){return this._meshes}},{key:"getMesh",value:function(){return this._mesh}},{key:"getSelectedMeshes",value:function(){return this._selectMeshes}},{key:"getPicking",value:function(){return this._picking}},{key:"getPickingSymmetry",value:function(){return this._pickingSym}},{key:"getSculptManager",value:function(){return this._sculptManager}},{key:"getStateManager",value:function(){return this._stateManager}},{key:"setMesh",value:function(e){return this.setOrUnsetMesh(e)}},{key:"setCanvasCursor",value:function(e){this._canvas.style.cursor=e}},{key:"initGrid",value:function(){var e=this._grid;e.normalizeSize();var t=e.getMatrix();ln.translate(t,t,[0,-.45,0]);var r=2.5;ln.scale(t,t,[r,r,r]),this._grid.setShaderType(o.Shader.FLAT),e.setFlatColor([.04,.04,.04])}},{key:"setOrUnsetMesh",value:function(e,t){if(e)if(t){var r=this.getIndexSelectMesh(e);r>=0?this._selectMeshes.length>1&&(this._selectMeshes.splice(r,1),e=this._selectMeshes[0]):this._selectMeshes.push(e)}else this._selectMeshes.length=0,this._selectMeshes.push(e);else this._selectMeshes.length=0;return this._mesh=e,this.getGui().updateMesh(),this.render(),e}},{key:"renderSelectOverRtt",value:function(){this._requestRender()&&(this._drawFullScene=!1)}},{key:"_requestRender",value:function(){return this._preventRender!==!0&&(window.requestAnimationFrame(this.applyRender.bind(this)),this._preventRender=!0,!0)}},{key:"render",value:function(){this._drawFullScene=!0,this._requestRender()}},{key:"applyRender",value:function(){this._preventRender=!1,this.updateMatricesAndSort();var e=this._gl;e&&(this._drawFullScene&&this._drawScene(),e.disable(e.DEPTH_TEST),e.bindFramebuffer(e.FRAMEBUFFER,this._rttMerge.getFramebuffer()),this._rttMerge.render(this),e.bindFramebuffer(e.FRAMEBUFFER,null),this._rttOpaque.render(this),e.enable(e.DEPTH_TEST),this._sculptManager.postRender())}},{key:"_drawScene",value:function(){var e=this._gl,t=0,r=this._meshes,i=r.length;e.disable(e.DEPTH_TEST);var a=this._selectMeshes.length>0&&this._showContour&&ne[o.Shader.CONTOUR].color[3]>0;if(a){e.bindFramebuffer(e.FRAMEBUFFER,this._rttContour.getFramebuffer()),e.clear(e.COLOR_BUFFER_BIT);for(var n=0,s=this._selectMeshes,l=s.length;n<l;++n)s[n].renderFlatColor(this)}for(e.enable(e.DEPTH_TEST),e.bindFramebuffer(e.FRAMEBUFFER,this._rttOpaque.getFramebuffer()),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),this._showGrid&&this._grid.render(this),t=0;t<i&&!r[t].isTransparent();++t)r[t].render(this);var u=t;for(this._meshPreview&&this._meshPreview.render(this),this._background.render(),e.bindFramebuffer(e.FRAMEBUFFER,this._rttTransparent.getFramebuffer()),e.clear(e.COLOR_BUFFER_BIT),e.enable(e.BLEND),e.depthFunc(e.LESS),t=0;t<i;++t)r[t].getShowWireframe()&&r[t].renderWireframe(this);for(e.depthFunc(e.LEQUAL),e.depthMask(!1),e.enable(e.CULL_FACE),t=u;t<i;++t)e.cullFace(e.FRONT),r[t].render(this),e.cullFace(e.BACK),r[t].render(this);e.disable(e.CULL_FACE),a&&this._rttContour.render(this),e.depthMask(!0),e.disable(e.BLEND)}},{key:"updateMatricesAndSort",value:function(){var e=this._meshes,t=this._camera;e.length>0&&t.optimizeNearFar(this.computeBoundingBoxScene());for(var r=0,i=e.length;r<i;++r)e[r].updateMatrices(t);e.sort(Ye.sortFunction),this._meshPreview&&this._meshPreview.updateMatrices(t),this._grid&&this._grid.updateMatrices(t)}},{key:"initWebGL",value:function(){var e={antialias:!1,stencil:!0},t=document.getElementById("canvas"),r=this._gl=t.getContext("webgl",e)||t.getContext("experimental-webgl",e);return r?(an.initWebGLExtensions(r),an.getWebGLExtension("OES_element_index_uint")||(Ge.ONLY_DRAW_ARRAYS=!0),r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,!0),r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),r.pixelStorei(r.UNPACK_COLORSPACE_CONVERSION_WEBGL,r.NONE),r.disable(r.CULL_FACE),r.frontFace(r.CCW),r.cullFace(r.BACK),r.disable(r.BLEND),r.blendFunc(r.ONE,r.ONE_MINUS_SRC_ALPHA),r.disable(r.DEPTH_TEST),r.depthFunc(r.LEQUAL),r.depthMask(!0),r.clearColor(0,0,0,0),void r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT)):void window.alert("Could not initialise WebGL. No WebGL, no SculptGL. Sorry.")}},{key:"loadTextures",value:function(){for(var e=this,t=this._gl,r=ne[o.Shader.MATCAP],i=function(i,a){var n=new Image;n.src=i,n.onload=function(){r.createTexture(t,n,a),e.render()}},a=0,n=r.matcaps,s=n.length;a<s;++a)i(n[a].path,a);this.initAlphaTextures()}},{key:"initAlphaTextures",value:function(){for(var e=ha.INIT_ALPHAS_PATHS,t=ha.INIT_ALPHAS_NAMES,r=0,i=e.length;r<i;++r){var a=new Image;a.src="resources/alpha/"+e[r],a.onload=this.onLoadAlphaImage.bind(this,a,t[r])}}},{key:"onCanvasResize",value:function(){var e=this._viewport,t=e.clientWidth*this._pixelRatio,r=e.clientHeight*this._pixelRatio;this._canvasOffsetLeft=e.offsetLeft,this._canvasOffsetTop=e.offsetTop,this._canvasWidth=t,this._canvasHeight=r,this._canvas.width=t,this._canvas.height=r,this._gl.viewport(0,0,t,r),this._camera.onResize(t,r),this._background.onResize(t,r),this._rttContour.onResize(t,r),this._rttMerge.onResize(t,r),this._rttOpaque.onResize(t,r),this._rttTransparent.onResize(t,r),this.render()}},{key:"computeBoundingBoxMeshes",value:function(e){for(var t=[1/0,1/0,1/0,-(1/0),-(1/0),-(1/0)],r=0,i=e.length;r<i;++r){var a=e[r].computeWorldBound();a[0]<t[0]&&(t[0]=a[0]),a[1]<t[1]&&(t[1]=a[1]),a[2]<t[2]&&(t[2]=a[2]),a[3]>t[3]&&(t[3]=a[3]),a[4]>t[4]&&(t[4]=a[4]),a[5]>t[5]&&(t[5]=a[5])}return t}},{key:"computeBoundingBoxScene",value:function(){var e=this._meshes.slice();return e.push(this._grid),this._sculptManager.addSculptToScene(e),this.computeBoundingBoxMeshes(e)}},{key:"normalizeAndCenterMeshes",value:function(e){var t=this.computeBoundingBoxMeshes(e),r=n.SCALE/on.dist([t[0],t[1],t[2]],[t[3],t[4],t[5]]),i=ln.create();ln.scale(i,i,[r,r,r]),ln.translate(i,i,[.5*-(t[0]+t[3]),.5*-(t[1]+t[4]),.5*-(t[2]+t[5])]);for(var a=0,s=e.length;a<s;++a){var o=e[a].getMatrix();ln.mul(o,i,o)}}},{key:"addSphere",value:function(){var e=new Si(xt.createCube(this._gl));return e.normalizeSize(),this.subdivideClamp(e),this.addNewMesh(e)}},{key:"addCube",value:function(){var e=new Si(xt.createCube(this._gl));return e.normalizeSize(),ln.scale(e.getMatrix(),e.getMatrix(),[.7,.7,.7]),this.subdivideClamp(e,!0),this.addNewMesh(e)}},{key:"addCylinder",value:function(){var e=new Si(xt.createCylinder(this._gl));return e.normalizeSize(),ln.scale(e.getMatrix(),e.getMatrix(),[.7,.7,.7]),this.subdivideClamp(e),this.addNewMesh(e)}},{key:"addTorus",value:function(e){var t=new Si(xt.createTorus(this._gl,this._torusLength,this._torusWidth,this._torusRadius,this._torusRadial,this._torusTubular));
if(e){t.setShowWireframe(!0);var r=.3*n.SCALE;return ln.scale(t.getMatrix(),t.getMatrix(),[r,r,r]),void(this._meshPreview=t)}t.normalizeSize(),this.subdivideClamp(t),this.addNewMesh(t)}},{key:"subdivideClamp",value:function(e,t){for(Ar.LINEAR=!!t;e.getNbFaces()<5e4;)e.addLevel();e._meshes.splice(0,Math.min(e._meshes.length-4,4)),e._sel=e._meshes.length-1,Ar.LINEAR=!1}},{key:"addNewMesh",value:function(e){return this._meshes.push(e),this._stateManager.pushStateAdd(e),this.setMesh(e),e}},{key:"loadScene",value:function(e,t){var r;"obj"===t?r=qr.importOBJ(e,this._gl):"sgl"===t?r=qr.importSGL(e,this._gl,this):"stl"===t?r=qr.importSTL(e,this._gl):"ply"===t&&(r=qr.importPLY(e,this._gl));var i=r.length;if(0!==i){for(var a=this._meshes,s=0;s<i;++s){var o=r[s]=new Si(r[s]);this._vertexSRGB||n.convertArrayVec3toSRGB(o.getColors()),o.init(),o.initRender(),a.push(o)}return this._autoMatrix&&this.normalizeAndCenterMeshes(r),this._stateManager.pushStateAdd(r),this.setMesh(a[a.length-1]),this._camera.resetView(),r}}},{key:"clearScene",value:function(){this.getStateManager().reset(),this.getMeshes().length=0,this.getCamera().resetView(),this.setMesh(null),this._action=o.Action.NOTHING}},{key:"deleteCurrentSelection",value:function(){this._mesh&&(this.removeMeshes(this._selectMeshes),this._stateManager.pushStateRemove(this._selectMeshes.slice()),this._selectMeshes.length=0,this.setMesh(null))}},{key:"removeMeshes",value:function(e){for(var t=this._meshes,r=0;r<e.length;++r)t.splice(this.getIndexMesh(e[r]),1)}},{key:"getIndexMesh",value:function(e,t){for(var r=t?this._selectMeshes:this._meshes,i=e.getID(),a=0,n=r.length;a<n;++a){var s=r[a];if(s===e||s.getID()===i)return a}return-1}},{key:"getIndexSelectMesh",value:function(e){return this.getIndexMesh(e,!0)}},{key:"replaceMesh",value:function(e,t){var r=this.getIndexMesh(e);r>=0&&(this._meshes[r]=t),this._mesh===e&&this.setMesh(t)}},{key:"onLoadAlphaImage",value:function(e,t,r){var i=document.createElement("canvas");i.width=e.width,i.height=e.height;var a=i.getContext("2d");a.drawImage(e,0,0);for(var n=a.getImageData(0,0,e.width,e.height).data,s=n.subarray(0,n.length/4),o=0,l=0,u=s.length;o<u;++o,l+=4)s[o]=Math.round((n[l]+n[l+1]+n[l+2])/3);t=ha.addAlpha(s,e.width,e.height,t)._name;var h={};h[t]=t,this.getGui().addAlphaOptions(h),r&&r._ctrlAlpha&&r._ctrlAlpha.setValue(t)}}]),e}(),hn=i.vec3,cn=1,dn=2,gn=3,fn=function(e){function t(){y(this,t);var e=b(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e._mouseX=0,e._mouseY=0,e._lastMouseX=0,e._lastMouseY=0,e._lastScale=0,e._action=o.Action.NOTHING,e._lastNbPointers=0,e._isWheelingIn=!1,e._maskX=0,e._maskY=0,e._hammer=new a.Manager(e._canvas),e._eventProxy={},e.initHammer(),e.addEvents(),e}return S(t,e),M(t,[{key:"addEvents",value:function(){var e=this._canvas,t=this.onMouseWheel.bind(this);e.addEventListener("mousedown",this.onMouseDown.bind(this),!1),e.addEventListener("mouseup",this.onMouseUp.bind(this),!1),e.addEventListener("mouseout",this.onMouseOut.bind(this),!1),e.addEventListener("mouseover",this.onMouseOver.bind(this),!1),e.addEventListener("mousemove",n.throttle(this.onMouseMove.bind(this),16.66),!1),e.addEventListener("mousewheel",t,!1),e.addEventListener("DOMMouseScroll",t,!1),window.addEventListener("keydown",this.onKeyDown.bind(this),!1),window.addEventListener("keyup",this.onKeyUp.bind(this),!1);var r=this.loadFiles.bind(this),i=this.stopAndPrevent.bind(this);e.addEventListener("webglcontextlost",this.onContextLost.bind(this),!1),e.addEventListener("webglcontextrestored",this.onContextRestored.bind(this),!1),window.addEventListener("dragenter",i,!1),window.addEventListener("dragover",i,!1),window.addEventListener("drop",r,!1),document.getElementById("fileopen").addEventListener("change",r,!1)}},{key:"initHammer",value:function(){this._hammer.options.enable=!0,this._initHammerRecognizers(),this._initHammerEvents()}},{key:"_initHammerRecognizers",value:function(){var e=this._hammer;e.add(new a.Tap({event:"doubletap",pointers:1,taps:2,time:250,interval:450,threshold:5,posThreshold:50})),e.add(new a.Tap({event:"doubletap2fingers",pointers:2,taps:2,time:250,interval:450,threshold:5,posThreshold:50})),e.add(new a.Pan({event:"pan",pointers:0,threshold:0})),e.add(new a.Pinch({event:"pinch",pointers:2,threshold:.1})),e.get("pinch").recognizeWith(e.get("pan"))}},{key:"_initHammerEvents",value:function(){var e=this._hammer;e.on("panstart",this.onPanStart.bind(this)),e.on("panmove",this.onPanMove.bind(this)),e.on("panend pancancel",this.onPanEnd.bind(this)),e.on("doubletap",this.onDoubleTap.bind(this)),e.on("doubletap2fingers",this.onDoubleTap2Fingers.bind(this)),e.on("pinchstart",this.onPinchStart.bind(this)),e.on("pinchin pinchout",this.onPinchInOut.bind(this))}},{key:"stopAndPrevent",value:function(e){e.stopPropagation(),e.preventDefault()}},{key:"onContextLost",value:function(){window.alert("Oops... WebGL context lost.")}},{key:"onContextRestored",value:function(){window.alert("Wow... Context is restored.")}},{key:"onKeyDown",value:function(e){this._gui.callFunc("onKeyDown",e)}},{key:"onKeyUp",value:function(e){this._gui.callFunc("onKeyUp",e)}},{key:"onPanStart",value:function(e){if("mouse"!==e.pointerType){this._focusGui=!1;var t=this._eventProxy;t.pageX=e.center.x,t.pageY=e.center.y,this._lastNbPointers=t.which=Math.min(2,e.pointers.length),this.onDeviceDown(t)}}},{key:"onPanMove",value:function(e){if("mouse"!==e.pointerType){var t=this._eventProxy;t.pageX=e.center.x,t.pageY=e.center.y;var r=Math.min(2,e.pointers.length);r!==this._lastNbPointers&&(this.onDeviceUp(),t.which=r,this.onDeviceDown(t),this._lastNbPointers=r),this.onDeviceMove(t)}}},{key:"onPanEnd",value:function(e){"mouse"!==e.pointerType&&this.onDeviceUp()}},{key:"onDoubleTap",value:function(e){if(!this._focusGui){var t=this._eventProxy;t.pageX=e.center.x,t.pageY=e.center.y,this.setMousePosition(t);var r=this._picking,i=r.intersectionMouseMeshes(),a=this._camera,n=[0,0,0];if(!i)return this.resetCameraScene();hn.transformMat4(n,r.getIntersectionPoint(),r.getMesh().getMatrix());var s=a._trans[2];a.isOrthographic()||(s=Math.min(s,hn.dist(n,a.computePosition()))),a.setAndFocusOnPivot(n,s),this.render()}}},{key:"onDoubleTap2Fingers",value:function(){this._focusGui||this.resetCameraScene()}},{key:"onPinchStart",value:function(e){this._focusGui=!1,this._lastScale=e.scale}},{key:"onPinchInOut",value:function(e){var t=25*(e.scale-this._lastScale);this._lastScale=e.scale,this.onDeviceWheel(t)}},{key:"resetCameraScene",value:function(){if(this._meshes.length>0){var e=[0,0,0],t=this.computeBoundingBoxMeshes(this._meshes),r=.4*hn.dist([t[0],t[1],t[2]],[t[3],t[4],t[5]]);r*=this._camera.computeFrustumFit(),hn.set(e,.5*(t[0]+t[3]),.5*(t[1]+t[4]),.5*(t[2]+t[5])),this._camera.setAndFocusOnPivot(e,r)}else this._camera.resetView();this.render()}},{key:"getFileType",value:function(e){var t=e.toLowerCase();return t.endsWith(".obj")?"obj":t.endsWith(".sgl")?"sgl":t.endsWith(".stl")?"stl":t.endsWith(".ply")?"ply":void 0}},{key:"loadFiles",value:function(e){e.stopPropagation(),e.preventDefault();for(var t=e.dataTransfer?e.dataTransfer.files:e.target.files,r=0,i=t.length;r<i;++r){var a=t[r],n=this.getFileType(a.name);this.readFile(a,n)}}},{key:"readFile",value:function(e,t){var r=t||this.getFileType(e.name);if(r){var i=new FileReader,a=this;i.onload=function(e){a.loadScene(e.target.result,r),document.getElementById("fileopen").value=""},"obj"===r?i.readAsText(e):i.readAsArrayBuffer(e)}}},{key:"onMouseDown",value:function(e){e.stopPropagation(),e.preventDefault(),this._gui.callFunc("onMouseDown",e),this.onDeviceDown(e)}},{key:"onMouseMove",value:function(e){e.stopPropagation(),e.preventDefault(),this._gui.callFunc("onMouseMove",e),this.onDeviceMove(e)}},{key:"onMouseOver",value:function(e){this._focusGui=!1,this._gui.callFunc("onMouseOver",e)}},{key:"onMouseOut",value:function(e){this._focusGui=!0,this._gui.callFunc("onMouseOut",e),this.onMouseUp(e)}},{key:"onMouseUp",value:function(e){e.preventDefault(),this._gui.callFunc("onMouseUp",e),this.onDeviceUp()}},{key:"onMouseWheel",value:function(e){e.stopPropagation(),e.preventDefault(),this._gui.callFunc("onMouseWheel",e);var t=void 0===e.wheelDelta?-e.detail:e.wheelDelta;this.onDeviceWheel(t>0?1:-1)}},{key:"onDeviceUp",value:function(){this.setCanvasCursor("default"),Si.RENDER_HINT=Si.NONE,this._sculptManager.end(),this._action===o.Action.MASK_EDIT&&this._mesh&&(this._lastMouseX===this._maskX&&this._lastMouseY===this._maskY?this.getSculptManager().getTool(o.Tools.MASKING).invert():this.getSculptManager().getTool(o.Tools.MASKING).clear()),this._action=o.Action.NOTHING,this.render(),this._stateManager.cleanNoop()}},{key:"onDeviceWheel",value:function(e){e>0&&!this._isWheelingIn&&(this._isWheelingIn=!0,this._camera.start(this._mouseX,this._mouseY)),this._camera.zoom(.02*e),Si.RENDER_HINT=Si.CAMERA,this.render(),this._timerEndWheel&&window.clearTimeout(this._timerEndWheel),this._timerEndWheel=window.setTimeout(this._endWheel.bind(this),300)}},{key:"_endWheel",value:function(){Si.RENDER_HINT=Si.NONE,this._isWheelingIn=!1,this.render()}},{key:"setMousePosition",value:function(e){this._mouseX=this._pixelRatio*(e.pageX-this._canvasOffsetLeft),this._mouseY=this._pixelRatio*(e.pageY-this._canvasOffsetTop)}},{key:"onDeviceDown",value:function(e){if(!this._focusGui){this.setMousePosition(e);var t=this._mouseX,r=this._mouseY,i=e.which,a=!1;i===cn&&(a=this._sculptManager.start(e.shiftKey)),i===cn&&a&&this.setCanvasCursor("none"),i===gn&&e.ctrlKey?this._action=o.Action.CAMERA_ZOOM:i===dn?this._action=o.Action.CAMERA_PAN:!a&&e.ctrlKey?(this._maskX=t,this._maskY=r,this._action=o.Action.MASK_EDIT):a&&i!==gn||!e.altKey?i===gn||i===cn&&!a?this._action=o.Action.CAMERA_ROTATE:this._action=o.Action.SCULPT_EDIT:this._action=o.Action.CAMERA_PAN_ZOOM_ALT,this._action!==o.Action.CAMERA_ROTATE&&this._action!==o.Action.CAMERA_ZOOM||this._camera.start(t,r),this._lastMouseX=t,this._lastMouseY=r}}},{key:"onDeviceMove",value:function(e){if(!this._focusGui){this.setMousePosition(e);var t=this._mouseX,r=this._mouseY,i=this._action;i===o.Action.CAMERA_ZOOM||i===o.Action.CAMERA_PAN_ZOOM_ALT&&!e.altKey?(Si.RENDER_HINT=Si.CAMERA,this._camera.zoom((t-this._lastMouseX+r-this._lastMouseY)/1e3),this.render()):i===o.Action.CAMERA_PAN_ZOOM_ALT||i===o.Action.CAMERA_PAN?(Si.RENDER_HINT=Si.CAMERA,this._camera.translate((t-this._lastMouseX)/1e3,(r-this._lastMouseY)/1e3),this.render()):i===o.Action.CAMERA_ROTATE?(Si.RENDER_HINT=Si.CAMERA,e.shiftKey||this._camera.rotate(t,r),this.render()):(Si.RENDER_HINT=Si.PICKING,this._sculptManager.preUpdate(),i===o.Action.SCULPT_EDIT&&(Si.RENDER_HINT=Si.SCULPT,this._sculptManager.update(this),this.getMesh().isDynamic&&this._gui.updateMeshInfo())),this._lastMouseX=t,this._lastMouseY=r,this.renderSelectOverRtt()}}}]),t}(un);window.SculptGL=fn});
